"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[83781],{6369:(o,s,e)=>{e.d(s,{a:()=>p});var n=e(10467),i=e(99522),t=e(98870),r=e(15221),d=e(43411),u=e(16179),a=e(11945),c=e(2216),l=e(52749),m=e(55554);let p=(()=>{class AddonModForumDiscussionsSource extends i.F{constructor(o,s,e){super(),this.trackPosts=!1,this.usesGroups=!1,this.supportsChangeGroup=!1,this.selectedSortOrder=null,this.groupId=0,this.canAddDiscussionToGroup=!0,this.errorLoadingDiscussions=!1,this.DISCUSSIONS_PATH_PREFIX=e,this.COURSE_ID=o,this.CM_ID=s}isNewDiscussionForm(o){return"newDiscussion"in o}isOfflineDiscussion(o){return!this.isNewDiscussionForm(o)&&!this.isOnlineDiscussion(o)}isOnlineDiscussion(o){return"id"in o}getItemPath(o){return this.isOnlineDiscussion(o)?this.DISCUSSIONS_PATH_PREFIX+o.discussion:this.isOfflineDiscussion(o)?`${this.DISCUSSIONS_PATH_PREFIX}new/${o.timecreated}`:`${this.DISCUSSIONS_PATH_PREFIX}new/0`}getItemQueryParams(o){var s;const e={courseId:this.COURSE_ID,cmId:this.CM_ID,forumId:null===(s=this.forum)||void 0===s?void 0:s.id};return this.isOnlineDiscussion(o)?(e.discussion=o,e.trackPosts=this.trackPosts):this.isNewDiscussionForm(o)&&(e.groupId=this.usesGroups?this.groupId:void 0),e}getPagesLoaded(){if(null===this.items)return 0;const o=this.items.filter((o=>this.isOnlineDiscussion(o)));return Math.ceil(o.length/this.getPageLength())}getPageLength(){return c.eG}loadForum(){var o=this;return(0,n.A)((function*(){o.forum=yield u.AddonModForum.getForum(o.COURSE_ID,o.CM_ID),void 0!==o.forum.istracked&&(o.trackPosts=o.forum.istracked)}))()}loadGroupInfo(o){var s=this;return(0,n.A)((function*(){[s.groupInfo,s.allPartsPermissions]=yield Promise.all([r.CoreGroups.getActivityGroupInfo(s.CM_ID,!1),m.g.ignoreErrors(u.AddonModForum.canAddDiscussionToAll(o,{cmId:s.CM_ID}))]),s.supportsChangeGroup=u.AddonModForum.isGetDiscussionPostsAvailable(),s.usesGroups=!(!s.groupInfo.separateGroups&&!s.groupInfo.visibleGroups),s.groupId=r.CoreGroups.validateGroupId(s.groupId,s.groupInfo),yield s.loadSelectedGroupData()}))()}loadSelectedGroupData(){var o=this;return(0,n.A)((function*(){if(o.usesGroups)if(0===o.groupId)o.canAddDiscussionToGroup=!o.allPartsPermissions||o.allPartsPermissions.status;else if(o.forum){const s=yield u.AddonModForum.canAddDiscussion(o.forum.id,o.groupId,{cmId:o.CM_ID});o.canAddDiscussionToGroup=s.status}else o.canAddDiscussionToGroup=!0;else o.canAddDiscussionToGroup=!0}))()}loadPageItems(o){var s=this;return(0,n.A)((function*(){var e;const n=[];if(0===o){const o=yield s.loadOfflineDiscussions();n.push(AddonModForumDiscussionsSource.NEW_DISCUSSION),n.push(...o)}const{discussions:i,canLoadMore:t}=yield s.loadOnlineDiscussions(o);if(n.push(...i),s.canAddDiscussionToGroup&&"eachuser"===(null===(e=s.forum)||void 0===e?void 0:e.type)){const o=l.CoreSites.getCurrentSiteUserId();s.canAddDiscussionToGroup=!n.some((e=>s.isOfflineDiscussion(e)||!s.isNewDiscussionForm(e)&&e.userid===o))}return{items:n,hasMoreItems:t}}))()}loadOnlineDiscussions(o){var s=this;return(0,n.A)((function*(){if(!s.forum||!s.selectedSortOrder)throw new Error("Can't load discussions without a forum or selected sort order");let e=[],n=!1;try{const i=yield u.AddonModForum.getDiscussions(s.forum.id,{cmId:s.forum.cmid,sortOrder:s.selectedSortOrder.value,page:o,groupId:s.groupId});e=i.discussions,n=i.canLoadMore,s.errorLoadingDiscussions=!1}catch(e){if(o>0||d.CoreWSError.isWebServiceError(e))throw e;s.errorLoadingDiscussions=!0}if(s.usesGroups&&(e=yield u.AddonModForum.formatDiscussionsGroups(s.forum.cmid,e)),"single"===s.forum.type)for(const o of e)if(o.userfullname&&0===o.parent){o.userfullname=!1;break}if(void 0===s.forum.istracked&&!s.trackPosts)for(const o of e)if(o.numunread>0){s.trackPosts=!0;break}return{discussions:e,canLoadMore:n}}))()}loadOfflineDiscussions(){var o=this;return(0,n.A)((function*(){if(!o.forum)throw new Error("Can't load discussions without a forum");const s=o.forum;let e=yield a.p.getNewDiscussions(s.id);if(0===e.length)return[];o.usesGroups&&(e=yield u.AddonModForum.formatDiscussionsGroups(s.cmid,e));const i=e.map(function(){var e=(0,n.A)((function*(e){const n=e;if(0!==n.parent&&"single"!==s.type)try{const s=yield t.CoreUser.getProfile(n.userid,o.COURSE_ID,!0);n.userfullname=s.fullname,n.userpictureurl=s.profileimageurl}catch{}}));return function(o){return e.apply(this,arguments)}}());return yield Promise.all(i),e.sort(((o,s)=>s.timecreated-o.timecreated)),e}))()}invalidateCache(){var o=this;return(0,n.A)((function*(){const s=[];s.push(u.AddonModForum.invalidateForumData(o.COURSE_ID)),o.forum&&(s.push(u.AddonModForum.invalidateDiscussionsList(o.forum.id)),s.push(u.AddonModForum.invalidateCanAddDiscussion(o.forum.id)),s.push(r.CoreGroups.invalidateActivityGroupInfo(o.forum.cmid))),yield Promise.all(s)}))()}invalidateList(){var o=this;return(0,n.A)((function*(){o.forum&&(yield u.AddonModForum.invalidateDiscussionsList(o.forum.id))}))()}}return AddonModForumDiscussionsSource.NEW_DISCUSSION={newDiscussion:!0},AddonModForumDiscussionsSource})()},83781:(o,s,e)=>{e.r(s),e.d(s,{default:()=>B});var n=e(10467),i=e(89417),t=e(49882),r=e(15221),d=e(15324),u=e(16179),a=e(41450),c=e(86275),l=e(52749),m=e(79555),p=e(48966),f=e(11945),g=e(81690),_=e(93956),h=e(16082),I=e(75383),D=e(63153),w=e(16450),v=e(6369),A=e(83696),C=e(24742),M=e(22693),G=e(2216),b=e(51024),F=e(33014),T=e(55554),P=e(25572),N=e(86654),S=e(54438),y=e(21182),R=e(29492),E=e(60177),O=e(2910),j=e(95638),x=e(64422),k=e(86198),$=e(58197),V=e(28988),L=e(88246),U=e(43570),X=e(73955);const Y=["newDiscFormEl"],_c1=o=>({header:o});function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_1_Template(o,s){if(1&o){const o=S.RV6();S.j41(0,"ion-item",21)(1,"ion-toggle",24),S.mxI("ngModelChange",(function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_1_Template_ion_toggle_ngModelChange_1_listener(s){S.eBV(o);const e=S.XpG(3);return S.DH7(e.newDiscussion.postToAllGroups,s)||(e.newDiscussion.postToAllGroups=s),S.Njj(s)})),S.EFF(2),S.nI1(3,"translate"),S.k0s()()}if(2&o){const o=S.XpG(3);S.R7$(),S.R50("ngModel",o.newDiscussion.postToAllGroups),S.R7$(),S.SpI(" ",S.bMT(3,2,"addon.mod_forum.posttomygroups")," ")}}function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_2_ion_select_option_7_Template(o,s){if(1&o&&(S.j41(0,"ion-select-option",29),S.nrm(1,"core-format-text",30),S.k0s()),2&o){const o=s.$implicit,e=S.XpG(4);S.Y8G("value",o.id),S.R7$(),S.Y8G("text",o.name)("contextInstanceId",e.courseId)("wsNotFiltered",!0)}}function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_2_Template(o,s){if(1&o){const o=S.RV6();S.j41(0,"ion-item",25)(1,"ion-select",26),S.nI1(2,"translate"),S.nI1(3,"translate"),S.mxI("ngModelChange",(function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_2_Template_ion_select_ngModelChange_1_listener(s){S.eBV(o);const e=S.XpG(3);return S.DH7(e.newDiscussion.groupId,s)||(e.newDiscussion.groupId=s),S.Njj(s)})),S.bIt("ionChange",(function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_2_Template_ion_select_ionChange_1_listener(){S.eBV(o);const s=S.XpG(3);return S.Njj(s.calculateGroupName())})),S.j41(4,"p",27),S.EFF(5),S.nI1(6,"translate"),S.k0s(),S.DNE(7,AddonModForumNewDiscussionPage_form_15_div_19_ion_item_2_ion_select_option_7_Template,2,4,"ion-select-option",28),S.k0s()()}if(2&o){const o=S.XpG(3);S.R7$(),S.R50("ngModel",o.newDiscussion.groupId),S.Y8G("disabled",o.newDiscussion.postToAllGroups)("interfaceOptions",S.eq3(12,_c1,S.bMT(2,6,"addon.mod_forum.group")))("cancelText",S.bMT(3,8,"core.cancel")),S.R7$(4),S.JRh(S.bMT(6,10,"addon.mod_forum.group")),S.R7$(2),S.Y8G("ngForOf",o.groups)}}function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_7_Template(o,s){if(1&o){const o=S.RV6();S.j41(0,"ion-item",21)(1,"ion-toggle",31),S.mxI("ngModelChange",(function AddonModForumNewDiscussionPage_form_15_div_19_ion_item_7_Template_ion_toggle_ngModelChange_1_listener(s){S.eBV(o);const e=S.XpG(3);return S.DH7(e.newDiscussion.pin,s)||(e.newDiscussion.pin=s),S.Njj(s)})),S.EFF(2),S.nI1(3,"translate"),S.k0s()()}if(2&o){const o=S.XpG(3);S.R7$(),S.R50("ngModel",o.newDiscussion.pin),S.R7$(),S.SpI(" ",S.bMT(3,2,"addon.mod_forum.discussionpinned")," ")}}function AddonModForumNewDiscussionPage_form_15_div_19_core_attachments_8_Template(o,s){if(1&o&&S.nrm(0,"core-attachments",32),2&o){const o=S.XpG(3);S.Y8G("files",o.newDiscussion.files)("maxSize",o.forum.maxbytes)("maxSubmissions",o.forum.maxattachments)("component",o.component)("componentId",o.forum.cmid)("allowOffline",!0)("courseId",o.courseId)}}function AddonModForumNewDiscussionPage_form_15_div_19_Template(o,s){if(1&o){const o=S.RV6();S.j41(0,"div",18),S.DNE(1,AddonModForumNewDiscussionPage_form_15_div_19_ion_item_1_Template,4,4,"ion-item",19)(2,AddonModForumNewDiscussionPage_form_15_div_19_ion_item_2_Template,8,14,"ion-item",20),S.j41(3,"ion-item",21)(4,"ion-toggle",22),S.mxI("ngModelChange",(function AddonModForumNewDiscussionPage_form_15_div_19_Template_ion_toggle_ngModelChange_4_listener(s){S.eBV(o);const e=S.XpG(2);return S.DH7(e.newDiscussion.subscribe,s)||(e.newDiscussion.subscribe=s),S.Njj(s)})),S.EFF(5),S.nI1(6,"translate"),S.k0s()(),S.DNE(7,AddonModForumNewDiscussionPage_form_15_div_19_ion_item_7_Template,4,4,"ion-item",19)(8,AddonModForumNewDiscussionPage_form_15_div_19_core_attachments_8_Template,1,7,"core-attachments",23),S.k0s()}if(2&o){const o=S.XpG(2);S.R7$(),S.Y8G("ngIf",o.showGroups&&o.groupIds.length>1&&o.accessInfo.cancanposttomygroups),S.R7$(),S.Y8G("ngIf",o.showGroups),S.R7$(2),S.R50("ngModel",o.newDiscussion.subscribe),S.R7$(),S.SpI(" ",S.bMT(6,6,"addon.mod_forum.discussionsubscription")," "),S.R7$(2),S.Y8G("ngIf",o.canPin),S.R7$(),S.Y8G("ngIf",o.canCreateAttachments&&o.forum&&o.forum.maxattachments>0)}}function AddonModForumNewDiscussionPage_form_15_ion_item_20_Template(o,s){if(1&o&&(S.j41(0,"ion-item",33),S.nrm(1,"ion-icon",34),S.j41(2,"ion-label"),S.nrm(3,"core-format-text",30),S.k0s()()),2&o){const o=S.XpG(2);S.R7$(3),S.Y8G("text",o.postInGroupMessage)("contextInstanceId",o.courseId)("wsNotFiltered",!0)}}function AddonModForumNewDiscussionPage_form_15_ion_col_24_Template(o,s){if(1&o){const o=S.RV6();S.j41(0,"ion-col")(1,"ion-button",35),S.bIt("click",(function AddonModForumNewDiscussionPage_form_15_ion_col_24_Template_ion_button_click_1_listener(){S.eBV(o);const s=S.XpG(2);return S.Njj(s.discard())})),S.EFF(2),S.nI1(3,"translate"),S.k0s()()}2&o&&(S.R7$(2),S.JRh(S.bMT(3,1,"core.discard")))}function AddonModForumNewDiscussionPage_form_15_Template(o,s){if(1&o){const o=S.RV6();S.j41(0,"form",null,0)(2,"ion-item")(3,"ion-input",9),S.nI1(4,"translate"),S.nI1(5,"translate"),S.mxI("ngModelChange",(function AddonModForumNewDiscussionPage_form_15_Template_ion_input_ngModelChange_3_listener(s){S.eBV(o);const e=S.XpG();return S.DH7(e.newDiscussion.subject,s)||(e.newDiscussion.subject=s),S.Njj(s)})),S.k0s()(),S.j41(6,"ion-item")(7,"ion-label",10),S.EFF(8),S.nI1(9,"translate"),S.k0s(),S.j41(10,"core-rich-text-editor",11),S.nI1(11,"translate"),S.bIt("contentChanged",(function AddonModForumNewDiscussionPage_form_15_Template_core_rich_text_editor_contentChanged_10_listener(s){S.eBV(o);const e=S.XpG();return S.Njj(e.onMessageChange(s))})),S.k0s()(),S.j41(12,"ion-item",12),S.nI1(13,"translate"),S.bIt("click",(function AddonModForumNewDiscussionPage_form_15_Template_ion_item_click_12_listener(){S.eBV(o);const s=S.XpG();return S.Njj(s.toggleAdvanced())})),S.nrm(14,"ion-icon",13),S.j41(15,"ion-label")(16,"h2"),S.EFF(17),S.nI1(18,"translate"),S.k0s()()(),S.DNE(19,AddonModForumNewDiscussionPage_form_15_div_19_Template,9,8,"div",14)(20,AddonModForumNewDiscussionPage_form_15_ion_item_20_Template,4,3,"ion-item",15),S.j41(21,"ion-item",16)(22,"ion-label")(23,"ion-row"),S.DNE(24,AddonModForumNewDiscussionPage_form_15_ion_col_24_Template,4,3,"ion-col",8),S.j41(25,"ion-col")(26,"ion-button",17),S.bIt("click",(function AddonModForumNewDiscussionPage_form_15_Template_ion_button_click_26_listener(){S.eBV(o);const s=S.XpG();return S.Njj(s.add())})),S.EFF(27),S.nI1(28,"translate"),S.k0s()()()()()()}if(2&o){const o=S.XpG();S.R7$(3),S.R50("ngModel",o.newDiscussion.subject),S.Y8G("placeholder",S.bMT(4,21,"addon.mod_forum.subject"))("label",S.bMT(5,23,"addon.mod_forum.subject")),S.R7$(5),S.JRh(S.bMT(9,25,"addon.mod_forum.message")),S.R7$(2),S.Y8G("control",o.messageControl)("placeholder",S.bMT(11,27,"addon.mod_forum.message"))("component",o.component)("componentId",o.forum.cmid)("autoSave",!0)("contextInstanceId",o.forum.cmid),S.R7$(2),S.Y8G("detail",!1),S.BMQ("aria-expanded",o.advanced)("aria-label",S.bMT(13,29,o.advanced?"core.hideadvanced":"core.showadvanced")),S.R7$(2),S.AVh("expandable-status-icon-expanded",o.advanced),S.R7$(3),S.JRh(S.bMT(18,31,"addon.mod_forum.advanced")),S.R7$(2),S.Y8G("ngIf",o.advanced),S.R7$(),S.Y8G("ngIf",o.showGroups&&o.postInGroupMessage&&!o.newDiscussion.postToAllGroups),S.R7$(4),S.Y8G("ngIf",o.hasOffline),S.R7$(2),S.Y8G("disabled",""===o.newDiscussion.subject||null===o.newDiscussion.message),S.R7$(),S.SpI(" ",S.bMT(28,33,"addon.mod_forum.posttoforum")," ")}}let B=(()=>{var o;class AddonModForumNewDiscussionPage{constructor(o,s,e){this.route=o,this.splitView=s,this.courseContentsPage=e,this.component=G.CT,this.messageControl=new i.MJ(null),this.groupsLoaded=!1,this.showGroups=!1,this.hasOffline=!1,this.canCreateAttachments=!0,this.canPin=!1,this.showForm=!1,this.groups=[],this.groupIds=[],this.newDiscussion={subject:"",message:null,postToAllGroups:!1,groupId:0,subscribe:!0,pin:!1,files:[]},this.advanced=!1,this.accessInfo={},this.isDestroyed=!1,this.forceLeave=!1,this.logView=C.j.once((()=>{M.OF.logEvent({type:M.qr.VIEW_ITEM,ws:"mod_forum_add_discussion",name:m.HT.instant("addon.mod_forum.addanewdiscussion"),data:{id:this.forumId,category:"forum"},url:"/mod/forum/post.php"})}))}ngOnInit(){var o=this;return(0,n.A)((function*(){try{var s;const n=d.CoreNavigator.getRouteData(o.route);if(o.courseId=d.CoreNavigator.getRequiredRouteNumberParam("courseId"),o.cmId=d.CoreNavigator.getRequiredRouteNumberParam("cmId"),o.forumId=d.CoreNavigator.getRequiredRouteNumberParam("forumId"),o.timeCreated=d.CoreNavigator.getRequiredRouteNumberParam("timeCreated"),o.initialGroupId=d.CoreNavigator.getRouteNumberParam("groupId"),o.initialGroupId=0===o.initialGroupId?G.lL:o.initialGroupId,0!==o.timeCreated&&(null===(s=n.swipeEnabled)||void 0===s||s)){var e;const s=A.u.getOrCreateSource(v.a,[o.courseId,o.cmId,null!==(e=n.discussionsPathPrefix)&&void 0!==e?e:""]);o.discussions=new AddonModForumNewDiscussionDiscussionsSwipeManager(s),yield o.discussions.start()}}catch(s){return P.CoreAlerts.showError(s),o.goBack(),void 0}o.fetchDiscussionData().finally((()=>{o.groupsLoaded=!0}))}))()}ionViewDidEnter(){this.syncObserver||(this.syncObserver=t.z.on(G.D7,(o=>{o.forumId==this.forumId&&o.userId==l.CoreSites.getCurrentSiteUserId()&&(P.CoreAlerts.show({header:m.HT.instant("core.notice"),message:m.HT.instant("core.contenteditingsynced")}),this.returnToDiscussions())}),l.CoreSites.getCurrentSiteId()))}fetchDiscussionData(o){var s=this;return(0,n.A)((function*(){try{const e=yield r.CoreGroups.getActivityGroupMode(s.cmId),i=[];e===r.CoreGroupsProvider.SEPARATEGROUPS||e===r.CoreGroupsProvider.VISIBLEGROUPS?i.push(r.CoreGroups.instance.getActivityAllowedGroups(s.cmId).then((o=>{let i;return i=e===r.CoreGroupsProvider.VISIBLEGROUPS?s.validateVisibleGroups(o.groups):s.addAllParticipantsOption(o.groups,!0),i.then(function(){var o=(0,n.A)((function*(o){if(o.length>0)return s.groups=o,s.groupIds=o.map((o=>o.id)).filter((o=>o>0)),s.newDiscussion.groupId=s.newDiscussion.groupId||s.getInitialGroupId(),s.showGroups=!0,yield s.calculateGroupName(),s.groupIds.length<=1&&(s.newDiscussion.postToAllGroups=!1),void 0;throw new Error(m.HT.instant(e===r.CoreGroupsProvider.SEPARATEGROUPS?"addon.mod_forum.cannotadddiscussionall":"addon.mod_forum.cannotadddiscussion"))}));return function(s){return o.apply(this,arguments)}}())}))):(s.showGroups=!1,s.newDiscussion.postToAllGroups=!1,i.push(T.g.ignoreErrors(u.AddonModForum.instance.canAddDiscussionToAll(s.forumId,{cmId:s.cmId}).then((o=>{s.canPin=!!o.canpindiscussions,s.canCreateAttachments=!!o.cancreateattachment}))))),i.push(u.AddonModForum.getForum(s.courseId,s.cmId).then((o=>s.forum=o))),i.push(u.AddonModForum.instance.getAccessInformation(s.forumId,{cmId:s.cmId}).then((o=>s.accessInfo=o))),yield Promise.all(i),s.timeCreated&&!o&&(s.syncId=c.F.getForumSyncId(s.forumId),yield c.F.waitForSync(s.syncId).then((()=>(s.isDestroyed||p.CoreSync.blockOperation(G.Ep,s.syncId),f.p.instance.getNewDiscussion(s.forumId,s.timeCreated).then(function(){var o=(0,n.A)((function*(o){if(s.hasOffline=!0,o.options=o.options||{},o.groupid==G.pQ?(s.newDiscussion.groupId=s.groups[0].id,s.newDiscussion.postToAllGroups=!0):(s.newDiscussion.groupId=o.groupid,s.newDiscussion.postToAllGroups=!1),s.newDiscussion.subject=o.subject,s.newDiscussion.message=o.message,s.newDiscussion.subscribe=!!o.options.discussionsubscribe,s.newDiscussion.pin=!!o.options.discussionpinned,s.messageControl.setValue(o.message),yield s.calculateGroupName(),"object"==typeof o.options.attachmentsid&&o.options.attachmentsid.offline){const o=yield _.i.getNewDiscussionStoredFiles(s.forumId,s.timeCreated);s.newDiscussion.files=o}(!s.newDiscussion.subscribe||s.newDiscussion.pin||s.newDiscussion.files.length||s.groups.length>0&&s.newDiscussion.groupId!=s.groups[0].id||s.newDiscussion.postToAllGroups)&&(s.advanced=!0)}));return function(s){return o.apply(this,arguments)}}()))))),s.originalData||(s.originalData={subject:s.newDiscussion.subject,message:s.newDiscussion.message,files:s.newDiscussion.files.slice()}),s.showForm=!0,s.logView()}catch(o){P.CoreAlerts.showError(o,{default:m.HT.instant("addon.mod_forum.errorgetgroups")}),s.showForm=!1}}))()}validateVisibleGroups(o){var s=this;return(0,n.A)((function*(){let e;try{e=yield u.AddonModForum.canAddDiscussionToAll(s.forumId,{cmId:s.cmId})}catch(o){e={status:!1,canpindiscussions:!1,cancreateattachment:!0}}if(s.canPin=!!e.canpindiscussions,s.canCreateAttachments=!!e.cancreateattachment,e.status)return s.addAllParticipantsOption(o,!1);const n=[],i=[];return o.forEach((o=>{n.push(u.AddonModForum.instance.canAddDiscussion(s.forumId,o.id,{cmId:s.cmId}).catch((()=>({status:!0}))).then((s=>{s.status&&i.push(o)})))})),yield Promise.all(n),i}))()}filterGroups(o,s){const e=s.map((o=>o.id));return o.filter((o=>e.indexOf(o.id)>-1))}getInitialGroupId(){return this.initialGroupId&&this.groups.find((o=>o.id===this.initialGroupId))?this.initialGroupId:this.groups[0].id}addAllParticipantsOption(o,s){let e;return e=s?u.AddonModForum.canAddDiscussionToAll(this.forumId,{cmId:this.cmId}).then((o=>(this.canPin=!!o.canpindiscussions,this.canCreateAttachments=!!o.cancreateattachment,o.status))).catch((()=>!1)):Promise.resolve(!0),e.then((s=>(s&&o.unshift({courseid:this.courseId,id:G.lL,name:m.HT.instant("core.allparticipants")}),o)))}refreshGroups(o){const s=[r.CoreGroups.invalidateActivityGroupMode(this.cmId),r.CoreGroups.invalidateActivityAllowedGroups(this.cmId),u.AddonModForum.invalidateCanAddDiscussion(this.forumId)];Promise.all(s).finally((()=>{this.fetchDiscussionData(!0).finally((()=>{null==o||o.complete()}))}))}returnToDiscussions(o,s){var e;this.forceLeave=!0,h.CoreFileUploader.clearTmpFiles(this.newDiscussion.files),t.z.trigger(G.p8,{forumId:this.forumId,cmId:this.cmId,discussionIds:o,discTimecreated:s,groupId:this.showGroups&&!this.newDiscussion.postToAllGroups?this.newDiscussion.groupId:void 0},l.CoreSites.getCurrentSiteId()),null!==(e=this.splitView)&&void 0!==e&&e.outletActivated?(this.hasOffline=!1,this.newDiscussion.subject="",this.newDiscussion.message=null,this.newDiscussion.files=[],this.newDiscussion.postToAllGroups=!1,this.messageEditor.clearText(),this.originalData=g.j.clone(this.newDiscussion)):d.CoreNavigator.back()}onMessageChange(o){this.newDiscussion.message=null!=o?o:null}add(){var o=this;return(0,n.A)((function*(){const s=o.forum.name,e=o.newDiscussion.subject;let n=o.newDiscussion.message||"";const i=o.newDiscussion.pin,r=o.newDiscussion.files,d=o.timeCreated||Date.now(),u={discussionsubscribe:!!o.newDiscussion.subscribe};if(!e)return P.CoreAlerts.showError(m.HT.instant("addon.mod_forum.erroremptysubject")),void 0;if(!n)return P.CoreAlerts.showError(m.HT.instant("addon.mod_forum.erroremptymessage")),void 0;const a=yield F.CoreLoadings.show("core.sending",!0);n=I.Ni.formatHtmlLines(n),i&&(u.discussionpinned=!0);const c=o.newDiscussion.postToAllGroups?o.groupIds:[o.newDiscussion.groupId];try{const i=yield _.i.addNewDiscussion(o.forumId,s,o.courseId,e,n,r,u,c,d);i&&(_.i.deleteNewDiscussionStoredFiles(o.forumId,d),t.z.trigger(t.z.ACTIVITY_DATA_SENT,{module:"forum"})),i&&i.length<c.length&&P.CoreAlerts.showError(m.HT.instant("addon.mod_forum.errorposttoallgroups")),D.R.triggerFormSubmittedEvent(o.formElement,!!i,l.CoreSites.getCurrentSiteId()),o.returnToDiscussions(i,d)}catch(o){P.CoreAlerts.showError(o,{default:m.HT.instant("addon.mod_forum.cannotcreatediscussion")})}finally{a.dismiss()}}))()}discard(){var o=this;return(0,n.A)((function*(){try{yield P.CoreAlerts.confirm(m.HT.instant("core.areyousure"));const s=[];s.push(f.p.deleteNewDiscussion(o.forumId,o.timeCreated)),s.push(T.g.ignoreErrors(_.i.deleteNewDiscussionStoredFiles(o.forumId,o.timeCreated))),yield Promise.all(s),D.R.triggerFormCancelledEvent(o.formElement,l.CoreSites.getCurrentSiteId()),o.returnToDiscussions()}catch(o){}}))()}toggleAdvanced(){this.advanced=!this.advanced}calculateGroupName(){var o=this;return(0,n.A)((function*(){if(o.newDiscussion.groupId<=0)o.postInGroupMessage=void 0;else{var s;const e=null===(s=o.groups.find((s=>s.id===o.newDiscussion.groupId)))||void 0===s?void 0:s.name;o.postInGroupMessage=e&&m.HT.instant("addon.mod_forum.postingroup",{groupname:e})}}))()}canLeave(){var o=this;return(0,n.A)((function*(){return o.forceLeave||(_.i.hasPostDataChanged(o.newDiscussion,o.originalData)&&(yield P.CoreAlerts.confirmLeaveWithChanges()),h.CoreFileUploader.clearTmpFiles(o.newDiscussion.files),o.formElement&&D.R.triggerFormCancelledEvent(o.formElement,l.CoreSites.getCurrentSiteId())),!0}))()}ionViewWillLeave(){this.syncObserver&&this.syncObserver.off(),delete this.syncObserver}goBack(){var o;null!==(o=this.splitView)&&void 0!==o&&o.outletActivated?d.CoreNavigator.navigate((this.courseContentsPage?"../":"")+"../../"):d.CoreNavigator.back()}ngOnDestroy(){var o;this.syncId&&p.CoreSync.unblockOperation(G.Ep,this.syncId),this.isDestroyed=!0,null===(o=this.discussions)||void 0===o||o.destroy()}}return(o=AddonModForumNewDiscussionPage).ɵfac=function AddonModForumNewDiscussionPage_Factory(s){return new(s||o)(S.rXU(y.nX),S.rXU(R.M,8),S.rXU(b.A,8))},o.ɵcmp=S.VBU({type:o,selectors:[["page-addon-mod-forum-new-discussion"]],viewQuery:function AddonModForumNewDiscussionPage_Query(o,s){if(1&o&&(S.GBs(Y,5),S.GBs(a.CoreEditorRichTextEditorComponent,5)),2&o){let o;S.mGM(o=S.lsd())&&(s.formElement=o.first),S.mGM(o=S.lsd())&&(s.messageEditor=o.first)}},standalone:!0,features:[S.aNF],decls:16,vars:13,consts:[["newDiscFormEl",""],["slot","start"],[3,"text"],["slot","end"],[3,"core-swipe-navigation"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"hideUntil"],[4,"ngIf"],["labelPlacement","stacked","type","text","name","subject",3,"ngModelChange","ngModel","placeholder","label"],["position","stacked"],["name","addon_mod_forum_new_discussion","contextLevel","module","elementId","message",3,"contentChanged","control","placeholder","component","componentId","autoSave","contextInstanceId"],["button","","role","heading","aria-controls","addon-mod-forum-new-discussion-advanced",1,"divider","ion-text-wrap",3,"click","detail"],["name","fas-chevron-right","flip-rtl","","slot","start","aria-hidden","true",1,"expandable-status-icon"],["id","addon-mod-forum-new-discussion-advanced",4,"ngIf"],["class","addon-forum-group-info ion-text-wrap",4,"ngIf"],[1,"addon-forum-new-discussion-buttons"],["expand","block",3,"click","disabled"],["id","addon-mod-forum-new-discussion-advanced"],["class","ion-text-wrap",4,"ngIf"],["class","core-edit-set-group ion-text-wrap",4,"ngIf"],[1,"ion-text-wrap"],["name","subscribe",3,"ngModelChange","ngModel"],[3,"files","maxSize","maxSubmissions","component","componentId","allowOffline","courseId",4,"ngIf"],["name","postallgroups",3,"ngModelChange","ngModel"],[1,"core-edit-set-group","ion-text-wrap"],["interface","action-sheet","name","groupid",3,"ngModelChange","ionChange","ngModel","disabled","interfaceOptions","cancelText"],["slot","label",1,"item-heading"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["contextLevel","course",3,"text","contextInstanceId","wsNotFiltered"],["name","pin",3,"ngModelChange","ngModel"],[3,"files","maxSize","maxSubmissions","component","componentId","allowOffline","courseId"],[1,"addon-forum-group-info","ion-text-wrap"],["name","fas-circle-info","slot","start","aria-hidden","true"],["expand","block","fill","outline",3,"click"]],template:function AddonModForumNewDiscussionPage_Template(o,s){1&o&&(S.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),S.nrm(3,"ion-back-button",2),S.nI1(4,"translate"),S.k0s(),S.j41(5,"ion-title")(6,"h1"),S.EFF(7),S.nI1(8,"translate"),S.k0s()(),S.nrm(9,"ion-buttons",3),S.k0s()(),S.j41(10,"ion-content",4)(11,"ion-refresher",5),S.bIt("ionRefresh",(function AddonModForumNewDiscussionPage_Template_ion_refresher_ionRefresh_11_listener(o){return s.refreshGroups(o.target)})),S.nrm(12,"ion-refresher-content",6),S.nI1(13,"translate"),S.k0s(),S.j41(14,"core-loading",7),S.DNE(15,AddonModForumNewDiscussionPage_form_15_Template,29,35,"form",8),S.k0s()()),2&o&&(S.R7$(3),S.Y8G("text",S.bMT(4,7,"core.back")),S.R7$(4),S.JRh(S.bMT(8,9,"addon.mod_forum.addanewdiscussion")),S.R7$(3),S.Y8G("core-swipe-navigation",s.discussions),S.R7$(),S.Y8G("disabled",!s.groupsLoaded),S.R7$(),S.FS9("pullingText",S.bMT(13,11,"core.pulltorefresh")),S.R7$(2),S.Y8G("hideUntil",s.groupsLoaded),S.R7$(),S.Y8G("ngIf",s.showForm))},dependencies:[N.n,E.Sq,E.bT,i.qT,i.BC,i.cb,i.vS,i.cV,O.Jm,O.QW,O.hU,O.W9,O.eU,O.iq,O.$w,O.uz,O.he,O.To,O.Ki,O.ln,O.Nm,O.Ip,O.BC,O.BY,O.ai,O.hB,O.Je,O.Gw,O.el,j.V,x.R,k.t,$.B,V.n,L.i,U.T,X.D9,a.CoreEditorRichTextEditorComponent],styles:["[_nghost-%COMP%]   .addon-forum-group-info[_ngcontent-%COMP%] > ion-icon[slot][_ngcontent-%COMP%]{color:var(--ion-color-info);margin-inline-end:16px}[_nghost-%COMP%]   .addon-forum-new-discussion-buttons[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-top:0}[_nghost-%COMP%]   .addon-forum-new-discussion-buttons[_ngcontent-%COMP%]   ion-col[_ngcontent-%COMP%]{padding-top:0;padding-bottom:0}"]}),AddonModForumNewDiscussionPage})();class AddonModForumNewDiscussionDiscussionsSwipeManager extends w.c{getSelectedItemPathFromRoute(o){const s=d.CoreNavigator.getRouteParams(o);return`${this.getSource().DISCUSSIONS_PATH_PREFIX}new/${s.timeCreated}`}}}}]);