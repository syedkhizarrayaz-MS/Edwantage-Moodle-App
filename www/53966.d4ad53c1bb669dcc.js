"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[53966],{53966:(e,i,t)=>{t.r(i),t.d(i,{default:()=>R});var o=t(10467),r=t(75629),n=t(44682),d=t(15324),a=t(52749),s=t(48966),l=t(75383),c=t(55554),u=t(79555),g=t(49882),I=t(63153),k=t(67981),w=t(59379),p=t(22357),m=t(22693),h=t(51069),f=t(33014),b=t(88436),v=t(25572),y=t(41450),P=t(86654),C=t(54438),T=t(89417),_=t(60177),S=t(2910),E=t(64422),N=t(58197),A=t(88246),W=t(43570),F=t(73955);const M=["editPageForm"];function AddonModWikiEditPage_form_14_ion_item_2_Template(e,i){1&e&&(C.j41(0,"ion-item",13),C.nrm(1,"ion-input",14),C.nI1(2,"translate"),C.nI1(3,"translate"),C.k0s()),2&e&&(C.R7$(),C.Y8G("label",C.bMT(2,2,"addon.mod_wiki.newpagetitle"))("placeholder",C.bMT(3,4,"addon.mod_wiki.newpagetitle")))}function AddonModWikiEditPage_form_14_ion_item_9_Template(e,i){1&e&&(C.j41(0,"ion-item",15)(1,"ion-label")(2,"ion-badge",16),C.EFF(3),C.nI1(4,"translate"),C.k0s()()()),2&e&&(C.R7$(3),C.JRh(C.bMT(4,1,"addon.mod_wiki.wrongversionlock")))}function AddonModWikiEditPage_form_14_Template(e,i){if(1&e&&(C.j41(0,"form",8,0),C.DNE(2,AddonModWikiEditPage_form_14_ion_item_2_Template,4,6,"ion-item",9),C.j41(3,"ion-item")(4,"ion-label",10),C.EFF(5),C.nI1(6,"translate"),C.k0s(),C.nrm(7,"core-rich-text-editor",11),C.nI1(8,"translate"),C.k0s(),C.DNE(9,AddonModWikiEditPage_form_14_ion_item_9_Template,5,3,"ion-item",12),C.k0s()),2&e){const e=C.XpG();C.Y8G("formGroup",e.pageForm),C.R7$(2),C.Y8G("ngIf",e.canEditTitle),C.R7$(3),C.JRh(C.bMT(6,11,"core.content")),C.R7$(2),C.Y8G("control",e.contentControl)("placeholder",C.bMT(8,13,"core.content"))("component",e.component)("componentId",e.cmId)("autoSave",!0)("contextInstanceId",e.cmId)("draftExtraParams",e.editorExtraParams),C.R7$(2),C.Y8G("ngIf",e.wrongVersionLock)}}let R=(()=>{var e;class AddonModWikiEditPage{constructor(e){this.formBuilder=e,this.canEditTitle=!1,this.loaded=!1,this.component=h.dD,this.wrongVersionLock=!1,this.editorExtraParams={},this.editing=!1,this.editOffline=!1,this.subwikiFiles=[],this.forceLeave=!1,this.isDestroyed=!1,this.contentControl=this.formBuilder.control("",{nonNullable:!0}),this.pageForm=this.formBuilder.group({})}ngOnInit(){var e=this;return(0,o.A)((function*(){e.cmId=d.CoreNavigator.getRouteNumberParam("cmId")||void 0,e.courseId=d.CoreNavigator.getRouteNumberParam("courseId")||void 0,e.subwikiId=d.CoreNavigator.getRouteNumberParam("subwikiId"),e.wikiId=d.CoreNavigator.getRouteNumberParam("wikiId"),e.pageId=d.CoreNavigator.getRouteNumberParam("pageId"),e.section=d.CoreNavigator.getRouteParam("section"),e.groupId=d.CoreNavigator.getRouteNumberParam("groupId"),e.userId=d.CoreNavigator.getRouteNumberParam("userId");const i=d.CoreNavigator.getRouteParam("pageTitle");e.originalTitle=i?l.Ni.cleanTags(i.replace(/\+/g," "),{singleLine:!0}):"",e.canEditTitle=!e.originalTitle,e.title=e.originalTitle?u.HT.instant("addon.mod_wiki.editingpage",{$a:e.originalTitle}):u.HT.instant("addon.mod_wiki.newpagehdr"),e.blockId=p.i.getSubwikiBlockId(e.subwikiId,e.wikiId,e.userId,e.groupId),e.pageForm.addControl("title",e.formBuilder.control(e.originalTitle)),e.pageForm.addControl("text",e.contentControl),s.CoreSync.blockOperation(h.Rv,e.blockId),e.pageId?(e.editorExtraParams.pageid=e.pageId,e.section&&(e.editorExtraParams.section=e.section)):e.originalTitle&&(e.editorExtraParams.pagetitle=e.originalTitle);try{if((yield e.fetchWikiPageData())&&!e.isDestroyed){const i=p.i.getSubwikiBlockId(e.subwikiId,e.wikiId,e.userId,e.groupId);i!==e.blockId&&(s.CoreSync.unblockOperation(h.Rv,e.blockId),e.blockId=i,s.CoreSync.blockOperation(h.Rv,e.blockId)),e.logView()}}finally{e.loaded=!0}}))()}fetchWikiPageData(){var e=this;return(0,o.A)((function*(){let i=!1,t=!1;try{const t=e.blockId?yield p.i.waitForSync(e.blockId):void 0;if(e.pageId){e.canEditTitle=!1,e.editing=!0,e.editOffline=!1;const t=yield k.N.getPageContents(e.pageId,{cmId:e.cmId});e.pageForm.controls.title.setValue(t.title),e.wikiId=t.wikiid,e.subwikiId=t.subwikiid,e.title=u.HT.instant("addon.mod_wiki.editingpage",{$a:t.title}),e.originalTitle=t.title,e.groupId=t.groupid,e.userId=t.userid,i=t.caneditpage,yield e.fetchModuleAndCourseId(),e.subwikiFiles=yield k.N.getSubwikiFiles(e.wikiId,{groupId:e.groupId,userId:e.userId,cmId:e.cmId});const o=yield k.N.getPageForEditing(e.pageId,e.section),r=b.CoreFileHelper.replacePluginfileUrls(o.content||"",e.subwikiFiles);e.contentControl.setValue(r),e.originalContent=r,e.version=o.version,i&&(e.renewLockInterval=window.setInterval((()=>{e.renewLock()}),h.hD))}else{const o=e.pageForm.controls.title.value;if(e.editing=!1,i=!!e.blockId,yield e.fetchModuleAndCourseId(),!e.wikiId&&e.cmId&&e.courseId){const i=yield n.CoreCourse.getModule(e.cmId,e.courseId,void 0,!0);e.wikiId=i.instance}if(o){if(t){const i=t.created.find((e=>e.title==o));if(i&&i.pageId>0)return e.pageId=i.pageId,e.fetchWikiPageData()}const i=yield c.g.ignoreErrors(w.W.getNewPage(o,e.subwikiId,e.wikiId,e.userId,e.groupId));i?(e.contentControl.setValue(i.cachedcontent),e.originalContent=i.cachedcontent,e.editOffline=!0):e.editOffline=!1}else e.editOffline=!1}return!0}catch(i){return v.CoreAlerts.showError(i,{default:"Error getting wiki data."}),t=!0,e.forceLeavePage(),!1}finally{i||t||(v.CoreAlerts.show({header:u.HT.instant("core.notice"),message:u.HT.instant("addon.mod_wiki.cannoteditpage")}),e.forceLeavePage())}}))()}fetchModuleAndCourseId(){var e=this;return(0,o.A)((function*(){if(!e.wikiId||e.cmId&&e.courseId)return;const i=yield n.CoreCourse.getModuleBasicInfoByInstance(e.wikiId,h.Pe,{readingStrategy:1});e.cmId=i.id,e.courseId=i.course}))()}forceLeavePage(){this.forceLeave=!0,d.CoreNavigator.back()}goToPage(e){this.wikiId&&(k.N.setEditedPageData({cmId:this.cmId,courseId:this.courseId,pageId:this.pageId,pageTitle:e,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}),this.forceLeavePage())}hasDataChanged(){const e=this.pageForm.value;return!(this.originalContent==e.text||!this.editing&&!e.text&&!e.title)}canLeave(){var e=this;return(0,o.A)((function*(){return e.forceLeave||(e.hasDataChanged()&&(yield v.CoreAlerts.confirmLeaveWithChanges()),I.R.triggerFormCancelledEvent(e.formElement,a.CoreSites.getCurrentSiteId())),!0}))()}ionViewDidLeave(){setTimeout((()=>{k.N.consumeEditedPageData()}),200)}save(){var e=this;return(0,o.A)((function*(){var i;const t=e.pageForm.value,o=t.title;let n=null!==(i=t.text)&&void 0!==i?i:"";const d=yield f.CoreLoadings.show("core.sending",!0);n=b.CoreFileHelper.restorePluginfileUrls(n,e.subwikiFiles),n=l.Ni.formatHtmlLines(n);try{if(e.editing&&e.pageId)return yield k.N.editPage(e.pageId,n,e.section),I.R.triggerFormSubmittedEvent(e.formElement,!0,a.CoreSites.getCurrentSiteId()),yield k.N.invalidatePage(e.pageId),e.goToPage(o);if(!o)return d.dismiss(),v.CoreAlerts.show({header:u.HT.instant("core.notice"),message:u.HT.instant("addon.mod_wiki.titleshouldnotbeempty")}),void 0;if(!e.editOffline){if(yield c.g.ignoreErrors(w.W.getNewPage(o,e.subwikiId,e.wikiId,e.userId,e.groupId)))throw new r.CoreError(u.HT.instant("addon.mod_wiki.pageexists"))}const i=yield k.N.newPage(o,n,{subwikiId:e.subwikiId,wikiId:e.wikiId,userId:e.userId,groupId:e.groupId,cmId:e.cmId});if(I.R.triggerFormSubmittedEvent(e.formElement,i>0,a.CoreSites.getCurrentSiteId()),i<=0)return e.goToPage(o);g.z.trigger(g.z.ACTIVITY_DATA_SENT,{module:"wiki"}),e.pageId=i;const t=yield k.N.getPageContents(e.pageId,{cmId:e.cmId}),s=[];e.wikiId=t.wikiid,s.push(k.N.invalidateSubwikiPages(e.wikiId)),e.subwikiId||s.push(k.N.invalidateSubwikis(e.wikiId)),e.subwikiId=t.subwikiid,e.userId=t.userid,e.groupId=t.groupid,yield c.g.ignoreErrors(Promise.all(s)),g.z.trigger(h.PQ,{pageId:e.pageId,subwikiId:e.subwikiId,pageTitle:o},a.CoreSites.getCurrentSiteId()),e.goToPage(o)}catch(e){v.CoreAlerts.showError(e,{default:"Error saving wiki data."})}finally{d.dismiss()}}))()}renewLock(){var e=this;return(0,o.A)((function*(){if(!e.pageId)return;const i=yield k.N.getPageForEditing(e.pageId,e.section,!0);i.version&&e.version!=i.version&&(e.wrongVersionLock=!0)}))()}logView(){var e;let i;if(this.pageId)i=`/mod/wiki/edit.php?pageid=${this.pageId}`+(this.section?`&section=${this.section.replace(/ /g,"+")}`:"");else if(this.originalTitle){const e=this.originalTitle.replace(/ /g,"+");var t,o;if(this.subwikiId)i=`/mod/wiki/create.php?swid=${this.subwikiId}&title=${e}&action=new`;else i=`/mod/wiki/create.php?wid=${this.wikiId}&group=${null!==(t=this.groupId)&&void 0!==t?t:0}&uid=${null!==(o=this.userId)&&void 0!==o?o:0}&title=${e}`}else i=`/mod/wiki/create.php?action=new&wid=${this.wikiId}&swid=${this.subwikiId}`;m.OF.logEvent({type:m.qr.VIEW_ITEM,ws:this.pageId?"mod_wiki_edit_page":"mod_wiki_new_page",name:null!==(e=this.originalTitle)&&void 0!==e?e:u.HT.instant("addon.mod_wiki.newpagehdr"),data:{id:this.wikiId,subwiki:this.subwikiId,category:"wiki"},url:i})}ngOnDestroy(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&s.CoreSync.unblockOperation(h.Rv,this.blockId)}}return(e=AddonModWikiEditPage).ɵfac=function AddonModWikiEditPage_Factory(i){return new(i||e)(C.rXU(T.ok))},e.ɵcmp=C.VBU({type:e,selectors:[["page-addon-mod-wiki-edit"]],viewQuery:function AddonModWikiEditPage_Query(e,i){if(1&e&&C.GBs(M,5),2&e){let e;C.mGM(e=C.lsd())&&(i.formElement=e.first)}},standalone:!0,features:[C.aNF],decls:15,vars:11,consts:[["editPageForm",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["class","ion-text-wrap",4,"ngIf"],["position","stacked","for","wiki_page_content"],["name","wiki_page_content","contextLevel","module","elementId","newcontent_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["class","ion-text-center addon-mod_wiki-wrongversionlock",4,"ngIf"],[1,"ion-text-wrap"],["labelPlacement","stacked","name","title","type","text","formControlName","title",3,"label","placeholder"],[1,"ion-text-center","addon-mod_wiki-wrongversionlock"],["color","danger",1,"ion-padding"]],template:function AddonModWikiEditPage_Template(e,i){1&e&&(C.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),C.nrm(3,"ion-back-button",2),C.nI1(4,"translate"),C.k0s(),C.j41(5,"ion-title")(6,"h1"),C.nrm(7,"core-format-text",3),C.k0s()(),C.j41(8,"ion-buttons",4)(9,"ion-button",5),C.bIt("click",(function AddonModWikiEditPage_Template_ion_button_click_9_listener(){return i.save()})),C.EFF(10),C.nI1(11,"translate"),C.k0s()()()(),C.j41(12,"ion-content")(13,"core-loading",6),C.DNE(14,AddonModWikiEditPage_form_14_Template,10,15,"form",7),C.k0s()()),2&e&&(C.R7$(3),C.Y8G("text",C.bMT(4,7,"core.back")),C.R7$(4),C.Y8G("text",i.title)("contextInstanceId",i.cmId)("courseId",i.courseId),C.R7$(3),C.SpI(" ",C.bMT(11,9,"core.save")," "),C.R7$(3),C.Y8G("hideUntil",i.loaded),C.R7$(),C.Y8G("ngIf",i.loaded))},dependencies:[P.n,_.bT,T.qT,T.BC,T.cb,S.In,S.Jm,S.QW,S.W9,S.eU,S.$w,S.uz,S.he,S.BC,S.ai,S.Gw,S.el,T.j4,T.JD,E.R,N.B,A.i,W.T,F.D9,y.CoreEditorRichTextEditorComponent],encapsulation:2}),AddonModWikiEditPage})()},22357:(e,i,t)=>{t.d(i,{i:()=>b});var o=t(10467),r=t(42008),n=t(49446),d=t(97254),a=t(94455),s=t(15221),l=t(52749),c=t(48966),u=t(43411),g=t(79555),I=t(49882),k=t(67981),w=t(59379),p=t(51069),m=t(55554),h=t(54438);let f=(()=>{var e;class AddonModWikiSyncProvider extends r.l{constructor(){super("AddonModWikiSyncProvider"),this.componentTranslatableString="wiki"}getSubwikiBlockId(e,i,t,o){return(e=w.W.convertToPositiveNumber(e))&&e>0?String(e):`${i=w.W.convertToPositiveNumber(i)}:${t=w.W.convertToPositiveNumber(t)}:${o=w.W.convertToPositiveNumber(o)}`}syncAllWikis(e,i){return this.syncOnSites("all wikis",(e=>this.syncAllWikisFunc(!!i,e)),e)}syncAllWikisFunc(e,i){var t=this;return(0,o.A)((function*(){const r=yield w.W.getAllNewPages(i),n={};yield Promise.all(r.map(function(){var r=(0,o.A)((function*(o){const r=t.getSubwikiBlockId(o.subwikiid,o.wikiid,o.userid,o.groupid);if(n[r])return;n[r]=!0;const d=e?yield t.syncSubwiki(o.subwikiid,o.wikiid,o.userid,o.groupid,i):yield t.syncSubwikiIfNeeded(o.subwikiid,o.wikiid,o.userid,o.groupid,i);null!=d&&d.updated&&I.z.trigger(p.mb,{siteId:i,subwikiId:o.subwikiid,wikiId:o.wikiid,userId:o.userid,groupId:o.groupid,created:d.created,discarded:d.discarded,warnings:d.warnings})}));return function(e){return r.apply(this,arguments)}}()))}))()}syncSubwikiIfNeeded(e,i,t,r,n){var d=this;return(0,o.A)((function*(){const o=d.getSubwikiBlockId(e,i,t,r);if(yield d.isSyncNeeded(o,n))return d.syncSubwiki(e,i,t,r,n)}))()}syncSubwiki(e,i,t,o,n){n=n||l.CoreSites.getCurrentSiteId();const d=this.getSubwikiBlockId(e,i,t,o),a=this.getOngoingSync(d,n);if(a)return a;if(c.CoreSync.isBlocked(p.Rv,d,n))throw this.logger.debug(`Cannot sync subwiki ${d} because it is blocked.`),new r.D(g.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));return this.logger.debug(`Try to sync subwiki ${d}`),this.addOngoingSync(d,this.performSyncSubwiki(e,i,t,o,n),n)}performSyncSubwiki(e,i,t,r,d){var s=this;return(0,o.A)((function*(){const l={warnings:[],updated:!1,created:[],discarded:[]},c=s.getSubwikiBlockId(e,i,t,r),g=yield m.g.ignoreErrors(w.W.getSubwikiNewPages(e,i,t,r,d),[]);if(!g||!g.length)return yield m.g.ignoreErrors(s.setSyncTime(c,d)),l;if(!a.WE.isOnline())throw new n.CoreNetworkError;return yield Promise.all(g.map(function(){var n=(0,o.A)((function*(o){try{const n=yield k.N.newPageOnline(o.title,o.cachedcontent,{subwikiId:e,wikiId:i,userId:t,groupId:r,siteId:d});l.updated=!0,l.created.push({pageId:n,title:o.title}),yield w.W.deleteNewPage(o.title,e,i,t,r,d)}catch(n){if(!u.CoreWSError.isWebServiceError(n))throw n;yield w.W.deleteNewPage(o.title,e,i,t,r,d),l.updated=!0;const a=s.getOfflineDataDeletedWarning(o.title,n);l.discarded.push({title:o.title,warning:a}),l.warnings.push(a)}}));return function(e){return n.apply(this,arguments)}}())),yield m.g.ignoreErrors(s.setSyncTime(c,d)),l}))()}syncWiki(e,i,t,r){var n=this;return(0,o.A)((function*(){r=r||l.CoreSites.getCurrentSiteId(),yield m.g.ignoreErrors(d.CoreCourseLogHelper.syncActivity(p.dD,e,r));const a=yield k.N.getSubwikis(e,{cmId:t,siteId:r}),c={warnings:[],updated:!1,subwikis:{},siteId:r};if(yield Promise.all(a.map(function(){var e=(0,o.A)((function*(e){const i=yield n.syncSubwiki(e.id,e.wikiid,e.userid,e.groupid,r);i&&i.updated&&(c.warnings=c.warnings.concat(i.warnings),c.updated=!0,c.subwikis[e.id]={created:i.created,discarded:i.discarded})}));return function(i){return e.apply(this,arguments)}}())),c.updated){const o=[];e&&(o.push(k.N.invalidateSubwikis(e)),o.push(k.N.invalidateSubwikiPages(e)),o.push(k.N.invalidateSubwikiFiles(e))),i&&o.push(k.N.invalidateWikiData(i)),t&&(o.push(s.CoreGroups.invalidateActivityAllowedGroups(t)),o.push(s.CoreGroups.invalidateActivityGroupMode(t))),yield m.g.ignoreErrors(Promise.all(o))}return c}))()}}return(e=AddonModWikiSyncProvider).ɵfac=function AddonModWikiSyncProvider_Factory(i){return new(i||e)},e.ɵprov=h.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWikiSyncProvider})();const b=(0,g.Qd)(f)}}]);