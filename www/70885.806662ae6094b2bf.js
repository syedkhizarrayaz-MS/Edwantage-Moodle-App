"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[70885],{70885:(e,t,o)=>{o.r(t),o.d(t,{default:()=>U});var r=o(10467),n=o(86654),i=o(37184),a=o(23732),s=o(30270),l=o(85618),d=o(89417),c=o(75629),u=o(44682),m=o(94247),y=o(41450),f=o(16082),h=o(33014),g=o(15324),v=o(94455),b=o(52749),p=o(48966),E=o(43411),C=o(49882),I=o(63153),_=o(88436),F=o(24742),x=o(55554),M=o(25572),S=o(75383),N=o(54438),R=o(2910),k=o(95638),w=o(64422),O=o(7570),T=o(86198),j=o(58197),P=o(88246),A=o(43570),B=o(73955);const W=["editEntryForm"],_c1=(e,t)=>({modtype:e,modname:t}),_c2=e=>({$a:e}),_c3=e=>({coursename:e});function AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_1_Template(e,t){if(1&e&&(N.j41(0,"ion-toggle",17),N.nrm(1,"core-format-text",18),N.nI1(2,"translate"),N.k0s()),2&e){const e=N.XpG(3);N.R7$(),N.Y8G("text",N.i5U(2,4,"addon.blog.associatewithmodule",N.eq3(10,_c2,N.l_i(7,_c1,e.associatedModule.modname,e.associatedModule.name))))("contextLevel",e.moduleContext)("contextInstanceId",e.modId)("courseId",e.courseId)}}function AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_2_Template(e,t){if(1&e&&(N.j41(0,"ion-toggle",19),N.nrm(1,"core-format-text",18),N.nI1(2,"translate"),N.k0s()),2&e){const e=N.XpG(3);N.R7$(),N.Y8G("text",N.i5U(2,4,"addon.blog.associatewithcourse",N.eq3(9,_c2,N.eq3(7,_c3,e.associatedCourse.fullname))))("contextLevel",e.courseContext)("contextInstanceId",e.courseId)("courseId",e.courseId)}}function AddonBlogEditEntryPage_Conditional_35_Conditional_8_Template(e,t){if(1&e&&(N.j41(0,"ion-item"),N.DNE(1,AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_1_Template,3,12,"ion-toggle",17)(2,AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_2_Template,3,11),N.k0s()),2&e){const e=N.XpG(2);N.R7$(),N.vxM(1,e.associatedModule?1:e.associatedCourse?2:-1)}}function AddonBlogEditEntryPage_Conditional_35_Template(e,t){if(1&e){const e=N.RV6();N.j41(0,"ion-item",14),N.nI1(1,"translate"),N.bIt("click",(function AddonBlogEditEntryPage_Conditional_35_Template_ion_item_click_0_listener(){N.eBV(e);const t=N.XpG();return N.Njj(t.toggleAssociations())})),N.nrm(2,"ion-icon",15),N.j41(3,"ion-label")(4,"h2"),N.EFF(5),N.nI1(6,"translate"),N.k0s()()(),N.j41(7,"div",16),N.DNE(8,AddonBlogEditEntryPage_Conditional_35_Conditional_8_Template,3,1,"ion-item"),N.k0s()}if(2&e){const e=N.XpG();N.AVh("expandable-status-icon-expanded",e.associationsExpanded),N.Y8G("detail",!1),N.BMQ("aria-label",N.bMT(1,8,e.associationsExpanded?"core.collapse":"core.expand"))("aria-expanded",e.associationsExpanded),N.R7$(2),N.Y8G("name",e.associationsExpanded?"fas-chevron-down":"fas-chevron-right"),N.R7$(3),N.JRh(N.bMT(6,10,"addon.blog.associations")),N.R7$(3),N.vxM(8,e.associationsExpanded?8:-1)}}let U=(()=>{var e;class AddonBlogEditEntryPage{constructor(){this.publishState=a.F6,this.form=new d.gE({subject:new d.MJ("",{nonNullable:!0,validators:[d.k0.required]}),summary:new d.MJ("",{nonNullable:!0,validators:[d.k0.required]}),publishState:new d.MJ(a.F6.site,{nonNullable:!0,validators:[d.k0.required]}),associateWithCourse:new d.MJ(!1,{nonNullable:!0,validators:[d.k0.required]}),associateWithModule:new d.MJ(!1,{nonNullable:!0,validators:[d.k0.required]})}),this.loaded=!1,this.maxFiles=99,this.initialFiles=[],this.files=[],this.associationsExpanded=!1,this.moduleContext="module",this.courseContext="course",this.contextLevel="system",this.contextInstanceId=0,this.component=a.Ed.COMPONENT,this.forceLeave=!1,this.isOfflineEntry=!1}get hasDataChangedForEdit(){var e,t,o,r,n;const i=this.form.controls;return i.summary.value!==(null===(e=this.entry)||void 0===e?void 0:e.summary)||i.subject.value!==(null===(t=this.entry)||void 0===t?void 0:t.subject)||i.publishState.value!==(null===(o=this.entry)||void 0===o?void 0:o.publishstate)||f.CoreFileUploader.areFileListDifferent(this.files,this.initialFiles)||i.associateWithModule.value!==(0!==(null===(r=this.entry)||void 0===r?void 0:r.moduleid))||i.associateWithCourse.value!==(0!==(null===(n=this.entry)||void 0===n?void 0:n.courseid))}get hasDataChangedForNewEntry(){const e=this.form.controls;return""!==e.subject.value||""!==e.summary.value||e.publishState.value!==a.F6.site||f.CoreFileUploader.areFileListDifferent(this.files,this.initialFiles)}ngOnInit(){var e=this;return(0,r.A)((function*(){var t,o;const r=yield b.CoreSites.getSite(),n=yield a.hU.isEditingEnabled();if(!r||!n)return g.CoreNavigator.back();const s=g.CoreNavigator.getRouteParam("id"),d=g.CoreNavigator.getRouteNumberParam("lastModified"),y=g.CoreNavigator.getRouteParam("filters"),f=g.CoreNavigator.getRouteNumberParam("courseId"),h=g.CoreNavigator.getRouteNumberParam("cmId");e.userId=g.CoreNavigator.getRouteNumberParam("userId"),e.siteHomeId=b.CoreSites.getCurrentSiteHomeId(),e.isOfflineEntry=null!==(t=null==s?void 0:s.startsWith("new-"))&&void 0!==t&&t;const v=Number(s);if(0!==v){try{var E,C;if(yield l.a.waitForSync(i.mO),e.isOfflineEntry){if(e.entry=yield e.getFormattedBlogOfflineEntry({created:Number(null==s?void 0:s.slice(4))}),!e.entry)throw new c.CoreError("This offline entry no longer exists.")}else{const t={filters:y,lastModified:d,entryId:v},o=yield e.getFormattedBlogOfflineEntry({id:v},t);e.entry=null!=o?o:yield e.getEntry(t,!1)}if(e.files=[...null!==(E=e.entry.attachmentfiles)&&void 0!==E?E:[]],e.initialFiles=[...e.files],p.CoreSync.blockOperation(a.Ed.COMPONENT,null!==(C=e.entry.id)&&void 0!==C?C:e.entry.created),e.courseId=e.courseId||e.entry.courseid,e.modId=g.CoreNavigator.getRouteNumberParam("cmId")||e.entry.coursemoduleid,e.courseId){e.form.controls.associateWithCourse.setValue(!0);const{course:t}=yield m.CoreCourseHelper.getCourse(e.courseId);e.associatedCourse=t}e.modId&&(e.form.controls.associateWithModule.setValue(!0),e.associatedModule=yield u.CoreCourse.getModule(e.modId))}catch(t){return M.CoreAlerts.showError(t,{default:"Error retrieving data."}),e.forceLeave=!0,g.CoreNavigator.back(),void 0}e.form.setValue({subject:e.entry.subject,summary:_.CoreFileHelper.replacePluginfileUrls(e.entry.summary,e.entry.summaryfiles),publishState:null!==(o=e.entry.publishstate)&&void 0!==o?o:a.F6.site,associateWithCourse:e.form.controls.associateWithCourse.value,associateWithModule:e.form.controls.associateWithModule.value}),e.calculateContext(),e.loaded=!0}else{e.loaded=!0;try{if(h&&(e.modId=h,e.form.controls.associateWithModule.setValue(!0),e.associatedModule=yield u.CoreCourse.getModule(e.modId)),f){e.courseId=f,e.form.controls.associateWithCourse.setValue(!0);const{course:t}=yield m.CoreCourseHelper.getCourse(e.courseId);e.associatedCourse=t}}catch(e){M.CoreAlerts.showError(e,{default:"Error getting associations, they may not be displayed correctly."})}}}))()}ngOnDestroy(){var e;this.entry&&p.CoreSync.unblockOperation(a.Ed.COMPONENT,null!==(e=this.entry.id)&&void 0!==e?e:this.entry.created)}getEntry(e,t=!1){return(0,r.A)((function*(){try{const{entries:o}=yield a.hU.getEntries({entryid:e.entryId},{readingStrategy:t?0:2,filter:t}),r=o.find((t=>t.id===e.entryId));if(!r)throw new c.CoreError("Entry not found");if(e.filters&&e.lastModified&&r.lastmodified<e.lastModified)throw new c.CoreError("Entry is outdated");return r}catch(o){if(!e.filters||E.CoreWSError.isWebServiceError(o))throw o;const r=(yield a.hU.getEntries(e.filters,{readingStrategy:t?0:2,filter:t})).entries.find((t=>t.id===e.entryId));if(!r)throw o;return r}}))()}calculateContext(){!this.userId||this.courseId||this.modId?this.courseId&&this.courseId!=this.siteHomeId?(this.contextLevel="course",this.contextInstanceId=this.courseId):(this.contextLevel="system",this.contextInstanceId=0):(this.contextLevel="user",this.contextInstanceId=this.userId)}save(){var e=this;return(0,r.A)((function*(){var t,o,r;const{summary:n,subject:i,publishState:s}=e.form.value;if(!i||!n||!s)return;const l=yield h.CoreLoadings.show("core.sending",!0);if(null!==(t=e.entry)&&void 0!==t&&t.id)try{var d;if(!v.WE.isOnline()){const t=yield e.uploadOrStoreFiles({entryId:e.entry.id});return yield e.saveEntry({attachmentsId:t})}if(!f.CoreFileUploader.areFileListDifferent(e.files,e.initialFiles))return yield e.saveEntry({});const{attachmentsid:t}=yield a.hU.prepareEntryForEdition({entryid:e.entry.id}),o=g.CoreNavigator.getRouteNumberParam("lastModified"),r=g.CoreNavigator.getRouteParam("filters"),n=e.entry&&"attachment"in e.entry?e.entry:yield x.g.ignoreErrors(e.getEntry({filters:r,lastModified:o,entryId:e.entry.id},!0)),i=f.CoreFileUploader.getFilesToDelete(null!==(d=null==n?void 0:n.attachmentfiles)&&void 0!==d?d:[],e.files);return i.length&&(yield f.CoreFileUploader.deleteDraftFiles(t,i)),yield f.CoreFileUploader.uploadFiles(t,e.files),yield e.saveEntry({attachmentsId:t})}catch(t){if(E.CoreWSError.isWebServiceError(t))return M.CoreAlerts.showError(t,{default:"Error updating entry."}),void 0;const o=yield e.uploadOrStoreFiles({entryId:e.entry.id,forceStorage:!0});return yield e.saveEntry({attachmentsId:o,forceOffline:!0})}finally{yield l.dismiss()}const c=null!==(o=null===(r=e.entry)||void 0===r?void 0:r.created)&&void 0!==o?o:F.j.timestamp();try{if(!e.files.length)return yield e.saveEntry({created:c});const t=yield e.uploadOrStoreFiles({created:c});yield e.saveEntry({created:c,attachmentsId:t})}catch(t){if(E.CoreWSError.isWebServiceError(t))return M.CoreAlerts.showError(t,{default:"Error creating entry."}),void 0;const o=yield e.uploadOrStoreFiles({created:c,forceStorage:!0});return yield e.saveEntry({attachmentsId:o,forceOffline:!0})}finally{yield l.dismiss()}}))()}uploadOrStoreFiles(e){var t=this;return(0,r.A)((function*(){if(v.WE.isOnline()&&!e.forceStorage)return yield f.CoreFileUploader.uploadOrReuploadFiles(t.files,t.component);const o="entryId"in e?{id:e.entryId}:{created:e.created},r=yield s.Q.getOfflineEntryFilesFolderPath(o);return yield f.CoreFileUploader.storeFilesToUpload(r,t.files)}))()}toggleAssociations(){this.associationsExpanded=!this.associationsExpanded}canLeave(){var e=this;return(0,r.A)((function*(){return e.forceLeave||((!e.entry&&e.hasDataChangedForNewEntry||e.entry&&e.hasDataChangedForEdit)&&(yield M.CoreAlerts.confirmLeaveWithChanges()),I.R.triggerFormCancelledEvent(e.formElement,b.CoreSites.getCurrentSiteId())),!0}))()}saveEntry(e){var t=this;return(0,r.A)((function*(){var o;const{summary:r,subject:n,publishState:s}=t.form.value;if(!r||!n||!s)return;const l=[{name:"publishstate",value:s},{name:"courseassoc",value:t.form.controls.associateWithCourse.value&&t.courseId?t.courseId:0},{name:"modassoc",value:t.form.controls.associateWithModule.value&&t.modId?t.modId:0}];var d,c,u,m,y;(e.attachmentsId&&l.push({name:"attachmentsid",value:e.attachmentsId}),null!==(o=t.entry)&&void 0!==o&&o.id)?yield a.hU.updateEntry({subject:n,summary:_.CoreFileHelper.restorePluginfileUrls(r,null!==(d=null===(c=t.entry)||void 0===c?void 0:c.summaryfiles)&&void 0!==d?d:[]),summaryformat:S.C9,options:l,forceOffline:e.forceOffline,entryid:t.entry.id,created:t.entry.created}):yield a.hU.addEntry({subject:n,summary:_.CoreFileHelper.restorePluginfileUrls(r,null!==(u=null===(m=t.entry)||void 0===m?void 0:m.summaryfiles)&&void 0!==u?u:[]),summaryformat:S.C9,options:l,created:null!==(y=e.created)&&void 0!==y?y:F.j.timestamp(),forceOffline:e.forceOffline});return C.z.trigger(i.d4),t.forceLeave=!0,I.R.triggerFormSubmittedEvent(t.formElement,!0,b.CoreSites.getCurrentSiteId()),g.CoreNavigator.back()}))()}getFormattedBlogOfflineEntry(e,t){var o=this;return(0,r.A)((function*(){const r=yield s.Q.getOfflineEntry(e);if(!r)return;const n=t?yield x.g.ignoreErrors(o.getEntry(t,!0)):void 0;return yield a.hU.formatOfflineEntry(r,n)}))()}}return(e=AddonBlogEditEntryPage).ɵfac=function AddonBlogEditEntryPage_Factory(t){return new(t||e)},e.ɵcmp=N.VBU({type:e,selectors:[["addon-blog-edit-entry"]],viewQuery:function AddonBlogEditEntryPage_Query(e,t){if(1&e&&N.GBs(W,5),2&e){let e;N.mGM(e=N.lsd())&&(t.formElement=e.first)}},standalone:!0,features:[N.aNF],decls:40,vars:54,consts:[["editEntryForm",""],["slot","start"],[3,"text"],["slot","end"],[3,"hideUntil"],[3,"formGroup"],["labelPlacement","stacked","formControlName","subject","type","text","name","title",3,"placeholder","label"],["position","stacked","for","addon_blog_entry_body"],["name","addon_blog_entry_body",3,"control","placeholder","componentId","autoSave","contextInstanceId","contextLevel","elementId"],["lines","none"],["name","addon_blog_publish_to","formControlName","publishState",3,"label"],[1,"core-select-option-title",3,"value"],[3,"files","maxSubmissions","maxSize","component","allowOffline","componentId"],["expand","block",1,"ion-margin",3,"click","ariaLabel","disabled"],["button","","aria-controls","addon-blog-associations",1,"divider","section",3,"click","detail"],["flip-rtl","","slot","start",1,"expandable-status-icon",3,"name"],["id","addon-blog-associations"],["formControlName","associateWithModule"],[3,"text","contextLevel","contextInstanceId","courseId"],["formControlName","associateWithCourse"]],template:function AddonBlogEditEntryPage_Template(e,t){if(1&e){const e=N.RV6();N.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),N.nrm(3,"ion-back-button",2),N.nI1(4,"translate"),N.k0s(),N.j41(5,"ion-title")(6,"h1"),N.EFF(7),N.nI1(8,"translate"),N.k0s()(),N.nrm(9,"ion-buttons",3),N.k0s()(),N.j41(10,"ion-content")(11,"core-loading",4)(12,"form",5,0)(14,"ion-item"),N.nrm(15,"ion-input",6),N.nI1(16,"translate"),N.nI1(17,"translate"),N.k0s(),N.j41(18,"ion-item")(19,"ion-label",7),N.EFF(20),N.nI1(21,"translate"),N.k0s(),N.nrm(22,"core-rich-text-editor",8),N.nI1(23,"translate"),N.nI1(24,"translate"),N.k0s(),N.j41(25,"ion-item",9)(26,"core-combobox",10),N.nI1(27,"translate"),N.j41(28,"ion-select-option",11),N.EFF(29),N.nI1(30,"translate"),N.k0s(),N.j41(31,"ion-select-option",11),N.EFF(32),N.nI1(33,"translate"),N.k0s()()(),N.nrm(34,"core-attachments",12),N.DNE(35,AddonBlogEditEntryPage_Conditional_35_Template,9,12),N.j41(36,"ion-button",13),N.nI1(37,"translate"),N.bIt("click",(function AddonBlogEditEntryPage_Template_ion_button_click_36_listener(){return N.eBV(e),N.Njj(t.save())})),N.EFF(38),N.nI1(39,"translate"),N.k0s()()()()}if(2&e){let e,o;N.R7$(3),N.Y8G("text",N.bMT(4,30,"core.back")),N.R7$(4),N.JRh(t.entry?t.entry.subject:N.bMT(8,32,"addon.blog.addnewentry")),N.R7$(4),N.Y8G("hideUntil",t.loaded),N.R7$(),N.Y8G("formGroup",t.form),N.R7$(3),N.Y8G("placeholder",N.bMT(16,34,"addon.blog.entrytitle"))("label",N.bMT(17,36,"addon.blog.entrytitle")),N.R7$(5),N.JRh(N.bMT(21,38,"addon.blog.entrybody")),N.R7$(2),N.Y8G("control",t.form.controls.summary)("placeholder",N.bMT(23,40,"addon.blog.entrybody"))("componentId",t.component)("autoSave",!0)("contextInstanceId",t.contextInstanceId)("contextLevel",t.contextLevel)("elementId",null!==(e=null==t.entry?null:t.entry.id)&&void 0!==e?e:"new_entry"),N.BMQ("aria-label",N.bMT(24,42,"addon.blog.entrybody")),N.R7$(4),N.Y8G("label",N.bMT(27,44,"addon.blog.publishto")),N.R7$(2),N.Y8G("value",t.publishState.draft),N.R7$(),N.SpI(" ",N.bMT(30,46,"addon.blog.publishtonoone")," "),N.R7$(2),N.Y8G("value",t.publishState.site),N.R7$(),N.SpI(" ",N.bMT(33,48,"addon.blog.publishtosite")," "),N.R7$(2),N.Y8G("files",t.files)("maxSubmissions",t.maxFiles)("maxSize",0)("component",t.component)("allowOffline",!0)("componentId",null!==(o=null==t.entry?null:t.entry.id)&&void 0!==o?o:0),N.R7$(),N.vxM(35,t.courseId&&t.associatedCourse?35:-1),N.R7$(),N.Y8G("ariaLabel",N.bMT(37,50,"core.save"))("disabled",t.form.invalid||t.entry&&!t.hasDataChangedForEdit),N.R7$(2),N.SpI(" ",N.bMT(39,52,"core.save")," ")}},dependencies:[y.CoreEditorRichTextEditorComponent,n.n,d.qT,d.BC,d.cb,R.Jm,R.QW,R.W9,R.eU,R.iq,R.$w,R.uz,R.he,R.Ip,R.BC,R.BY,R.ai,R.hB,R.Gw,R.el,d.j4,d.JD,k.V,w.R,O._,T.t,j.B,P.i,A.T,B.D9],encapsulation:2}),AddonBlogEditEntryPage})()}}]);