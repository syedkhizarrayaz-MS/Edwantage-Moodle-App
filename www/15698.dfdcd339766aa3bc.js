"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[15698],{15698:(e,t,s)=>{s.r(t),s.d(t,{default:()=>A});var n=s(10467),o=s(98870),a=s(15324),i=s(52749),r=s(55554),d=s(35853),c=s(50638),g=s(22693),l=s(79555),_=s(24742),m=s(25572),u=s(86654),h=s(54438),p=s(60177),f=s(2910),C=s(64422),S=s(28042),M=s(86198),y=s(58197),I=s(88246),v=s(73955),b=s(59528);const _c0=e=>({$a:e});function AddonModChatSessionMessagesPage_ng_container_15_div_1_Template(e,t){if(1&e&&(h.j41(0,"div",10),h.EFF(1),h.nI1(2,"coreFormatDate"),h.k0s()),2&e){const e=h.XpG().$implicit;h.R7$(),h.SpI(" ",h.i5U(2,1,1e3*e.timestamp,"strftimedayshort")," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_1_Template(e,t){if(1&e&&(h.j41(0,"ion-badge",17)(1,"span"),h.nrm(2,"ion-icon",18),h.EFF(3),h.nI1(4,"coreFormatDate"),h.nI1(5,"translate"),h.k0s()()),2&e){const e=h.XpG(2).$implicit;h.R7$(3),h.Lme(" ",h.i5U(4,2,1e3*e.timestamp,"strftimetime")," ",h.i5U(5,5,"addon.mod_chat.messageenter",h.eq3(8,_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_2_Template(e,t){if(1&e&&(h.j41(0,"ion-badge",19)(1,"span"),h.nrm(2,"ion-icon",20),h.EFF(3),h.nI1(4,"coreFormatDate"),h.nI1(5,"translate"),h.k0s()()),2&e){const e=h.XpG(2).$implicit;h.R7$(3),h.Lme(" ",h.i5U(4,2,1e3*e.timestamp,"strftimetime")," ",h.i5U(5,5,"addon.mod_chat.messageexit",h.eq3(8,_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_3_Template(e,t){if(1&e&&(h.j41(0,"ion-badge",21)(1,"span"),h.nrm(2,"ion-icon",22),h.EFF(3),h.nI1(4,"coreFormatDate"),h.nI1(5,"translate"),h.k0s()()),2&e){const e=h.XpG(2).$implicit;h.R7$(3),h.Lme(" ",h.i5U(4,2,1e3*e.timestamp,"strftimetime")," ",h.i5U(5,5,"addon.mod_chat.messagebeepseveryone",h.eq3(8,_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_4_Template(e,t){if(1&e&&(h.j41(0,"ion-badge",21)(1,"span"),h.nrm(2,"ion-icon",22),h.EFF(3),h.nI1(4,"coreFormatDate"),h.nI1(5,"translate"),h.k0s()()),2&e){const e=h.XpG(2).$implicit;h.R7$(3),h.Lme(" ",h.i5U(4,2,1e3*e.timestamp,"strftimetime")," ",h.i5U(5,5,"addon.mod_chat.messagebeepsyou",h.eq3(8,_c0,e.userfullname))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_5_Template(e,t){if(1&e&&(h.j41(0,"ion-badge",23)(1,"span"),h.nrm(2,"ion-icon",22),h.EFF(3),h.nI1(4,"coreFormatDate"),h.nI1(5,"translate"),h.k0s()()),2&e){const e=h.XpG(2).$implicit;h.R7$(3),h.Lme(" ",h.i5U(4,2,1e3*e.timestamp,"strftimetime")," ",h.i5U(5,5,"addon.mod_chat.messageyoubeep",h.eq3(8,_c0,e.beepWho))," ")}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_6_Template(e,t){if(1&e&&(h.j41(0,"ion-badge",24)(1,"span"),h.nrm(2,"ion-icon",25),h.EFF(3),h.nI1(4,"coreFormatDate"),h.j41(5,"strong"),h.EFF(6),h.nrm(7,"core-format-text",26),h.k0s()()()),2&e){const e=h.XpG(2).$implicit,t=h.XpG();h.R7$(3),h.SpI(" ",h.i5U(4,5,1e3*e.timestamp,"strftimetime")," "),h.R7$(3),h.SpI(" ",e.userfullname," "),h.R7$(),h.Y8G("text",e.message)("contextInstanceId",t.cmId)("courseId",t.courseId)}}function AddonModChatSessionMessagesPage_ng_container_15_div_2_Template(e,t){if(1&e&&(h.j41(0,"div",11),h.DNE(1,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_1_Template,6,10,"ion-badge",12)(2,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_2_Template,6,10,"ion-badge",13)(3,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_3_Template,6,10,"ion-badge",14)(4,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_4_Template,6,10,"ion-badge",14)(5,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_5_Template,6,10,"ion-badge",15)(6,AddonModChatSessionMessagesPage_ng_container_15_div_2_ion_badge_6_Template,8,8,"ion-badge",16),h.k0s()),2&e){const e=h.XpG().$implicit,t=h.XpG();h.R7$(),h.Y8G("ngIf",e.issystem&&"enter"===e.message),h.R7$(),h.Y8G("ngIf",e.issystem&&"exit"===e.message),h.R7$(),h.Y8G("ngIf","all"===e.beep),h.R7$(),h.Y8G("ngIf",e.userid!==t.currentUserId&&e.beep===t.currentUserId),h.R7$(),h.Y8G("ngIf",e.userid===t.currentUserId&&e.beep&&"all"!==e.beep),h.R7$(),h.Y8G("ngIf",!e.issystem&&!e.beep)}}function AddonModChatSessionMessagesPage_ng_container_15_core_message_3_Template(e,t){if(1&e&&h.nrm(0,"core-message",27),2&e){const e=h.XpG().$implicit,t=h.XpG();h.Y8G("message",e)("user",e)("text",e.message)("time",1e3*e.timestamp)("instanceId",t.cmId)("courseId",t.courseId)}}function AddonModChatSessionMessagesPage_ng_container_15_Template(e,t){if(1&e&&(h.qex(0),h.DNE(1,AddonModChatSessionMessagesPage_ng_container_15_div_1_Template,3,4,"div",7)(2,AddonModChatSessionMessagesPage_ng_container_15_div_2_Template,7,6,"div",8)(3,AddonModChatSessionMessagesPage_ng_container_15_core_message_3_Template,1,6,"core-message",9),h.bVm()),2&e){const e=t.$implicit;h.R7$(),h.Y8G("ngIf",e.showDate),h.R7$(),h.Y8G("ngIf",e.special),h.R7$(),h.Y8G("ngIf",!e.special)}}let A=(()=>{var e;class AddonModChatSessionMessagesPage{constructor(){var e=this;this.messages=[],this.loaded=!1,this.logView=_.j.once((0,n.A)((function*(){yield r.g.ignoreErrors(d.V.logViewSessions(e.cmId,{start:e.sessionStart,end:e.sessionEnd})),g.OF.logEvent({type:g.qr.VIEW_ITEM,ws:"mod_chat_view_sessions",name:l.HT.instant("addon.mod_chat.messages"),data:{chatid:e.chatId,category:"chat",start:e.sessionStart,end:e.sessionEnd},url:`/mod/chat/report.php?id=${e.cmId}&start=${e.sessionStart}&end=${e.sessionEnd}`})})))}ngOnInit(){try{this.courseId=a.CoreNavigator.getRequiredRouteNumberParam("courseId"),this.cmId=a.CoreNavigator.getRequiredRouteNumberParam("cmId"),this.sessionStart=a.CoreNavigator.getRequiredRouteNumberParam("sessionStart"),this.sessionEnd=a.CoreNavigator.getRequiredRouteNumberParam("sessionEnd"),this.chatId=a.CoreNavigator.getRequiredRouteNumberParam("chatId"),this.groupId=a.CoreNavigator.getRouteNumberParam("groupId")||0}catch(e){return m.CoreAlerts.showError(e),a.CoreNavigator.back(),void 0}this.currentUserId=i.CoreSites.getCurrentSiteUserId(),this.fetchMessages()}fetchMessages(){var e=this;return(0,n.A)((function*(){try{const t=yield d.V.getSessionMessages(e.chatId,e.sessionStart,e.sessionEnd,e.groupId,{cmId:e.cmId});e.messages=yield d.V.getMessagesUserData(t,e.courseId);for(let t=0;t<e.messages.length;t++){e.messages[t]=c.H.formatMessage(e.currentUserId,e.messages[t],t>0?e.messages[t-1]:void 0);const s=e.messages[t];s.beep&&s.beep!==e.currentUserId&&e.loadMessageBeepWho(s)}e.messages[e.messages.length-1].showTail=!0}catch(e){m.CoreAlerts.showError(e,{default:l.HT.instant("core.errorloadingcontent")})}finally{e.loaded=!0}}))()}loadMessageBeepWho(e){var t=this;return(0,n.A)((function*(){e.beepWho=yield t.getUserFullname(e.beep)}))()}getUserFullname(e){var t=this;return(0,n.A)((function*(){const s=Number(e);if(isNaN(s))return String(e);try{return(yield o.CoreUser.getProfile(s,t.courseId,!0)).fullname}catch{return String(e)}}))()}refreshMessages(e){var t=this;return(0,n.A)((function*(){try{yield r.g.ignoreErrors(d.V.invalidateSessionMessages(t.chatId,t.sessionStart,t.groupId)),yield t.fetchMessages()}finally{e.complete()}}))()}}return(e=AddonModChatSessionMessagesPage).ɵfac=function AddonModChatSessionMessagesPage_Factory(t){return new(t||e)},e.ɵcmp=h.VBU({type:e,selectors:[["page-addon-mod-chat-session-messages"]],standalone:!0,features:[h.aNF],decls:16,vars:12,consts:[["slot","start"],[3,"text"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"hideUntil"],[1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["class","ion-text-center addon-messages-date",4,"ngIf"],["class","ion-text-center addon-mod_chat-notice",4,"ngIf"],["contextLevel","module",3,"message","user","text","time","instanceId","courseId",4,"ngIf"],[1,"ion-text-center","addon-messages-date"],[1,"ion-text-center","addon-mod_chat-notice"],["class","ion-text-wrap","color","success",4,"ngIf"],["class","ion-text-wrap","color","danger",4,"ngIf"],["class","ion-text-wrap","color","primary",4,"ngIf"],["class","ion-text-wrap","color","light",4,"ngIf"],["class","ion-text-wrap","color","info",4,"ngIf"],["color","success",1,"ion-text-wrap"],["name","fas-right-to-bracket","aria-hidden","true"],["color","danger",1,"ion-text-wrap"],["name","fas-right-from-bracket","aria-hidden","true"],["color","primary",1,"ion-text-wrap"],["name","fas-bell","aria-hidden","true"],["color","light",1,"ion-text-wrap"],["color","info",1,"ion-text-wrap"],["name","fas-asterisk","aria-hidden","true"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["contextLevel","module",3,"message","user","text","time","instanceId","courseId"]],template:function AddonModChatSessionMessagesPage_Template(e,t){1&e&&(h.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),h.nrm(3,"ion-back-button",1),h.nI1(4,"translate"),h.k0s(),h.j41(5,"ion-title")(6,"h1"),h.EFF(7),h.nI1(8,"translate"),h.k0s()()()(),h.j41(9,"ion-content")(10,"ion-refresher",2),h.bIt("ionRefresh",(function AddonModChatSessionMessagesPage_Template_ion_refresher_ionRefresh_10_listener(e){return t.refreshMessages(e.target)})),h.nrm(11,"ion-refresher-content",3),h.nI1(12,"translate"),h.k0s(),h.j41(13,"core-loading",4)(14,"ion-list",5),h.DNE(15,AddonModChatSessionMessagesPage_ng_container_15_Template,4,3,"ng-container",6),h.k0s()()()),2&e&&(h.R7$(3),h.Y8G("text",h.bMT(4,6,"core.back")),h.R7$(4),h.JRh(h.bMT(8,8,"addon.mod_chat.messages")),h.R7$(3),h.Y8G("disabled",!t.loaded),h.R7$(),h.FS9("pullingText",h.bMT(12,10,"core.pulltorefresh")),h.R7$(2),h.Y8G("hideUntil",t.loaded),h.R7$(2),h.Y8G("ngForOf",t.messages))},dependencies:[u.n,p.Sq,p.bT,f.In,f.QW,f.W9,f.eU,f.iq,f.nf,f.To,f.Ki,f.BC,f.ai,f.el,C.R,S.A,M.t,y.B,I.i,v.D9,b.f],styles:[".ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0px}ion-content[_ngcontent-%COMP%]{--content-background: var(--background-alternative);--background: var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}ion-content[_ngcontent-%COMP%]   core-empty-box[_ngcontent-%COMP%]{--core-empty-box-icon-color: var(--dark)}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}","[_nghost-%COMP%]   .addon-mod_chat-notice[_ngcontent-%COMP%]{margin-top:8px;margin-bottom:8px}"]}),AddonModChatSessionMessagesPage})()},35853:(e,t,s)=>{s.d(t,{V:()=>m});var n=s(10467),o=s(97254),a=s(98870),i=s(52749),r=s(79555),d=s(22535),c=s(74431),g=s(95384),l=s(54438);let _=(()=>{var e;class AddonModChatProvider{getChat(e,t,s={}){var o=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(s.siteId),a={courseids:[e]},r={cacheKey:o.getChatsCacheKey(e),updateFrequency:c.CoreCacheUpdateFrequency.RARELY,component:d.vz,...i.CoreSites.getReadingStrategyPreSets(s.readingStrategy)},l=yield n.read("mod_chat_get_chats_by_courses",a,r);return g.CoreCourseModuleHelper.getActivityByCmId(l.chats,t)}))()}loginUser(e,t){return(0,n.A)((function*(){const s=yield i.CoreSites.getSite(t),n={chatid:e};return(yield s.write("mod_chat_login_user",n)).chatsid}))()}logView(e,t){return(0,n.A)((function*(){const s={chatid:e};yield o.CoreCourseLogHelper.log("mod_chat_view_chat",s,d.vz,e,t)}))()}logViewSessions(e,t){return(0,n.A)((function*(){const s={cmid:e};t&&(s.start=t.start,s.end=t.end),yield o.CoreCourseLogHelper.log("mod_chat_view_sessions",s,d.vz,e)}))()}sendMessage(e,t,s,o){return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(o),a={chatsid:e,messagetext:t,beepid:String(s)};return(yield n.write("mod_chat_send_chat_message",a)).messageid}))()}getLatestMessages(e,t,s){return(0,n.A)((function*(){return(yield i.CoreSites.getSite(s)).write("mod_chat_get_chat_latest_messages",{chatsid:e,chatlasttime:t})}))()}getMessagesUserData(e,t,s){return(0,n.A)((function*(){const o=e;return yield Promise.all(o.map(function(){var e=(0,n.A)((function*(e){try{const n=yield a.CoreUser.getProfile(e.userid,t,!0,s);e.userfullname=n.fullname,e.userprofileimageurl=n.profileimageurl}catch{e.userfullname=`${r.HT.instant("core.deleteduser")} ${e.userid}`}}));return function(t){return e.apply(this,arguments)}}())),o}))()}getChatUsers(e,t={}){return(0,n.A)((function*(){t.readingStrategy=t.readingStrategy||3;const s=yield i.CoreSites.getSite(t.siteId),n={chatsid:e},o={component:d.vz,componentId:t.cmId,...i.CoreSites.getReadingStrategyPreSets(t.readingStrategy)};return s.read("mod_chat_get_chat_users",n,o)}))()}getSessions(e,t=0,s=!1,o={}){var a=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(o.siteId),r={chatid:e,groupid:t,showall:s},g={cacheKey:a.getSessionsCacheKey(e,t,s),updateFrequency:c.CoreCacheUpdateFrequency.SOMETIMES,component:d.vz,componentId:o.cmId,...i.CoreSites.getReadingStrategyPreSets(o.readingStrategy)};return(yield n.read("mod_chat_get_sessions",r,g)).sessions}))()}getSessionMessages(e,t,s,o=0,a={}){var r=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(a.siteId),g={chatid:e,sessionstart:t,sessionend:s,groupid:o},l={cacheKey:r.getSessionMessagesCacheKey(e,t,o),updateFrequency:c.CoreCacheUpdateFrequency.RARELY,component:d.vz,componentId:a.cmId,...i.CoreSites.getReadingStrategyPreSets(a.readingStrategy)};return(yield n.read("mod_chat_get_session_messages",g,l)).messages}))()}invalidateChats(e,t){var s=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(t);yield n.invalidateWsCacheForKey(s.getChatsCacheKey(e))}))()}invalidateSessions(e,t=0,s=!1,o){var a=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(o);yield n.invalidateWsCacheForKey(a.getSessionsCacheKey(e,t,s))}))()}invalidateAllSessions(e,t){var s=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(t);yield n.invalidateWsCacheForKeyStartingWith(s.getSessionsCacheKeyPrefix(e))}))()}invalidateSessionMessages(e,t,s=0,o){var a=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(o);yield n.invalidateWsCacheForKey(a.getSessionMessagesCacheKey(e,t,s))}))()}invalidateAllSessionMessages(e,t){var s=this;return(0,n.A)((function*(){const n=yield i.CoreSites.getSite(t);yield n.invalidateWsCacheForKeyStartingWith(s.getSessionMessagesCacheKeyPrefix(e))}))()}getChatsCacheKey(e){return`${AddonModChatProvider.ROOT_CACHE_KEY}chats:${e}`}getSessionsCacheKey(e,t,s){return this.getSessionsCacheKeyPrefix(e)+t+":"+(s?1:0)}getSessionsCacheKeyPrefix(e){return`${AddonModChatProvider.ROOT_CACHE_KEY}sessions:${e}:`}getSessionMessagesCacheKey(e,t,s){return this.getSessionMessagesCacheKeyPrefix(e)+t+":"+s}getSessionMessagesCacheKeyPrefix(e){return`${AddonModChatProvider.ROOT_CACHE_KEY}sessionsMessages:${e}:`}}return(e=AddonModChatProvider).ROOT_CACHE_KEY="AddonModChat:",e.ɵfac=function AddonModChatProvider_Factory(t){return new(t||e)},e.ɵprov=l.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModChatProvider})();const m=(0,r.Qd)(_)}}]);