"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[36553,80178],{80178:(e,o,s)=>{s.r(o),s.d(o,{AddonModWorkshopHelper:()=>b,AddonModWorkshopHelperProvider:()=>k});var r=s(10467),d=s(75629),n=s(16082),i=s(45507),t=s(88436),a=s(52749),l=s(75383),u=s(81690),c=s(79555),m=s(65964),p=s(67193),f=s(26327),h=s(81552),g=s(55554),A=s(58364),y=s(54438);let k=(()=>{var e;class AddonModWorkshopHelperProvider{getTask(e,o){return e.find((e=>e.code==o))}isTaskDone(e,o){const s=this.getTask(e,o);return!s||!!s.completed}canSubmit(e,o,s){const r=e.useexamples&&1==e.examplesmode,d=o.canmanageexamples||0==e.examplesmode||this.isTaskDone(s,"examples");return e.phase>10&&o.cansubmit&&(!r||d)}canAssess(e,o){return!(e.useexamples&&2==e.examplesmode)||o.canmanageexamples}canAddFeedback(e,o){return 40===e.phase&&o.canoverridegrades}canEditAssessments(e,o){return 30===e.phase&&this.canAssess(e,o)&&o.assessingallowed&&o.canpeerassess}getUserSubmission(e,o={}){return(0,r.A)((function*(){const s=o.userId||a.CoreSites.getCurrentSiteUserId();return(yield p.AddonModWorkshop.getSubmissions(e,o)).find((e=>e.authorid==s))}))()}getSubmissionById(e,o,s={}){return(0,r.A)((function*(){try{return yield p.AddonModWorkshop.getSubmission(e,o,s)}catch{const r=(yield p.AddonModWorkshop.getSubmissions(e,s)).find((e=>e.id==o));if(!r)throw new d.CoreError("Submission not found");return r}}))()}getReviewerAssessmentById(e,o,s={}){return(0,r.A)((function*(){let r;try{r=yield p.AddonModWorkshop.getAssessment(e,o,s)}catch(d){if(r=(yield p.AddonModWorkshop.getReviewerAssessments(e,s)).find((e=>e.id===o)),!r)throw d}return r.form=yield p.AddonModWorkshop.getAssessmentForm(e,o,{cmId:s.cmId,siteId:s.siteId}),r}))()}getReviewerAssessments(e,o={}){var s=this;return(0,r.A)((function*(){o.siteId=o.siteId||a.CoreSites.getCurrentSiteId();const r=yield p.AddonModWorkshop.getReviewerAssessments(e,o),d=[];return r.forEach((r=>{const n=A.T.without(o,["canAssess","filter"]);d.push(s.getSubmissionById(e,r.submissionid,n).then((e=>{r.submission=e}))),d.push(p.AddonModWorkshop.getAssessmentForm(e,r.id,n).then((e=>{r.form=e})))})),yield Promise.all(d),r}))()}deleteSubmissionStoredFiles(e,o){return(0,r.A)((function*(){const s=yield f.AddonModWorkshopOffline.getSubmissionFolder(e,o);yield g.g.ignoreErrors(i.CoreFile.removeDir(s))}))()}storeSubmissionFiles(e,o,s){return(0,r.A)((function*(){const r=yield f.AddonModWorkshopOffline.getSubmissionFolder(e,s);return n.CoreFileUploader.storeFilesToUpload(r,o)}))()}uploadOrStoreSubmissionFiles(e,o,s,r){return s?this.storeSubmissionFiles(e,o,r):n.CoreFileUploader.uploadOrReuploadFiles(o,h.Ug,e,r)}getStoredSubmissionFiles(e,o){return(0,r.A)((function*(){const s=yield f.AddonModWorkshopOffline.getSubmissionFolder(e,o);return g.g.ignoreErrors(n.CoreFileUploader.getStoredFiles(s),[])}))()}getSubmissionFilesFromOfflineFilesObject(e,o,s){return(0,r.A)((function*(){const r=yield f.AddonModWorkshopOffline.getSubmissionFolder(o,s);return n.CoreFileUploader.getStoredFilesFromOfflineFilesObject(e,r)}))()}deleteAssessmentStoredFiles(e,o,s){return(0,r.A)((function*(){const r=yield f.AddonModWorkshopOffline.getAssessmentFolder(e,o,s);yield g.g.ignoreErrors(i.CoreFile.removeDir(r))}))()}storeAssessmentFiles(e,o,s,d){return(0,r.A)((function*(){const r=yield f.AddonModWorkshopOffline.getAssessmentFolder(e,o,d);return n.CoreFileUploader.storeFilesToUpload(r,s)}))()}uploadOrStoreAssessmentFiles(e,o,s,r,d){return r?this.storeAssessmentFiles(e,o,s,d):n.CoreFileUploader.uploadOrReuploadFiles(s,h.Ug,e,d)}getStoredAssessmentFiles(e,o,s){return(0,r.A)((function*(){const r=yield f.AddonModWorkshopOffline.getAssessmentFolder(e,o,s);return g.g.ignoreErrors(n.CoreFileUploader.getStoredFiles(r),[])}))()}getAssessmentFilesFromOfflineFilesObject(e,o,s,d){return(0,r.A)((function*(){const r=yield f.AddonModWorkshopOffline.getAssessmentFolder(o,s,d);return n.CoreFileUploader.getStoredFilesFromOfflineFilesObject(e,r)}))()}applyOfflineData(e,o=[]){var s=this;return(0,r.A)((function*(){if(0===o.length)return e;const r=null!=e?e:{id:0,workshopid:0,title:"",content:"",timemodified:0,example:!1,authorid:0,timecreated:0,contenttrust:0,attachment:0,published:!1,late:0};let d;const n=o[0].workshopid;return o.forEach((o=>{switch(o.action){case"add":case"update":r.title=o.title,r.content=t.CoreFileHelper.replacePluginfileUrls(o.content,(null==e?void 0:e.contentfiles)||[]),r.courseid=o.courseid,r.submissionmodified=o.timemodified/1e3,r.offline=!0,d=o.attachmentsid;break;case"delete":r.deleted=!0,r.submissionmodified=o.timemodified/1e3}})),r.attachmentfiles=d?yield s.getSubmissionFilesFromOfflineFilesObject(d,n):[],r}))()}prepareAssessmentData(e,o,s,d,n=0){return(0,r.A)((function*(){var r;if(2==e.overallfeedbackmode&&!s){throw{feedbackauthor:c.HT.instant("core.err_required")}}const i=(yield m.AddonWorkshopAssessmentStrategyDelegate.prepareAssessmentData(null!==(r=e.strategy)&&void 0!==r?r:"",o,d))||{};return i.feedbackauthor=s,i.feedbackauthorformat=l.C9,i.feedbackauthorattachmentsid=n,i.nodims=d.dimenssionscount,i}))()}realGradeValueHelper(e,o=0,s=0){return"string"==typeof e?e:null!=e?0===o?"0":(e=l.Ni.roundToDecimals(o*e/100,s),u.j.formatFloat(e)):void 0}realGradeValue(e,o){return o.grade=this.realGradeValueHelper(o.grade,e.grade,e.gradedecimals),o.gradinggrade=this.realGradeValueHelper(o.gradinggrade,e.gradinggrade,e.gradedecimals),o.gradinggradeover=this.realGradeValueHelper(o.gradinggradeover,e.gradinggrade,e.gradedecimals),o}showGrade(e){return null!=e}}return(e=AddonModWorkshopHelperProvider).ɵfac=function AddonModWorkshopHelperProvider_Factory(o){return new(o||e)},e.ɵprov=y.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWorkshopHelperProvider})();const b=(0,c.Qd)(k)},36553:(e,o,s)=>{s.r(o),s.d(o,{AddonModWorkshopSync:()=>W,AddonModWorkshopSyncProvider:()=>b});var r=s(10467),d=s(42008),n=s(49446),i=s(97254),t=s(94455),a=s(52749),l=s(48966),u=s(49588),c=s(43411),m=s(79555),p=s(49882),f=s(67193),h=s(80178),g=s(26327),A=s(81552),y=s(55554),k=s(54438);let b=(()=>{var e;class AddonModWorkshopSyncProvider extends d.l{constructor(){super("AddonModWorkshopSyncProvider"),this.componentTranslatableString="workshop"}hasDataToSync(e,o){return g.AddonModWorkshopOffline.hasWorkshopOfflineData(e,o)}syncAllWorkshops(e,o){return this.syncOnSites("all workshops",(e=>this.syncAllWorkshopsFunc(!!o,e)),e)}syncAllWorkshopsFunc(e,o){var s=this;return(0,r.A)((function*(){const d=(yield g.AddonModWorkshopOffline.getAllWorkshops(o)).map(function(){var d=(0,r.A)((function*(r){const d=e?yield s.syncWorkshop(r,o):yield s.syncWorkshopIfNeeded(r,o);d&&d.updated&&p.z.trigger(A.N7,{workshopId:r,warnings:d.warnings},o)}));return function(e){return d.apply(this,arguments)}}());yield Promise.all(d)}))()}syncWorkshopIfNeeded(e,o){var s=this;return(0,r.A)((function*(){if(yield s.isSyncNeeded(e,o))return s.syncWorkshop(e,o)}))()}syncWorkshop(e,o){o=o||a.CoreSites.getCurrentSiteId();const s=this.getOngoingSync(e,o);if(s)return s;if(l.CoreSync.isBlocked(A.Ug,e,o))throw this.logger.debug(`Cannot sync workshop '${e}' because it is blocked.`),new d.D(m.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));this.logger.debug(`Try to sync workshop '${e}' in site ${o}'`);const r=this.performSyncWorkshop(e,o);return this.addOngoingSync(e,r,o)}performSyncWorkshop(e,o){var s=this;return(0,r.A)((function*(){const r={warnings:[],updated:!1};yield y.g.ignoreErrors(i.CoreCourseLogHelper.syncActivity(A.Ug,e,o));const d=yield Promise.all([y.g.ignoreErrors(g.AddonModWorkshopOffline.getSubmissions(e,o),[]),y.g.ignoreErrors(g.AddonModWorkshopOffline.getAssessments(e,o),[]),y.g.ignoreErrors(g.AddonModWorkshopOffline.getEvaluateSubmissions(e,o),[]),y.g.ignoreErrors(g.AddonModWorkshopOffline.getEvaluateAssessments(e,o),[])]);let a;for(const e in d)if(d[e].length>0&&d[e][0].courseid){a=d[e][0].courseid;break}if(!a)return yield y.g.ignoreErrors(s.setSyncTime(e,o)),r;if(!t.WE.isOnline())throw new n.CoreNetworkError;const l=yield f.AddonModWorkshop.getWorkshopById(a,e,{siteId:o}),u=d[1],c=d[2],m=d[3],p={},h=[];return d[0].forEach((e=>{p[e.submissionid]=p[e.submissionid]||[],p[e.submissionid].push(e)})),Object.keys(p).forEach((e=>{h.push(s.syncSubmission(l,p[e],r,o).then((()=>{r.updated=!0})))})),u.forEach((e=>{h.push(s.syncAssessment(l,e,r,o).then((()=>{r.updated=!0})))})),c.forEach((e=>{h.push(s.syncEvaluateSubmission(l,e,r,o).then((()=>{r.updated=!0})))})),m.forEach((e=>{h.push(s.syncEvaluateAssessment(l,e,r,o).then((()=>{r.updated=!0})))})),yield Promise.all(h),r.updated&&(yield y.g.ignoreErrors(f.AddonModWorkshop.invalidateContentById(e,a,o))),yield y.g.ignoreErrors(s.setSyncTime(e,o)),r}))()}syncSubmission(e,o,s,d){var n=this;return(0,r.A)((function*(){let i,t=0,a=(o=o.sort(((e,o)=>e.timemodified-o.timemodified)))[0].submissionid;if(a>0)try{t=(yield f.AddonModWorkshop.getSubmission(e.id,a,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o[0].timemodified)return s.updated=!0,i=m.HT.instant("addon.mod_workshop.warningsubmissionmodified"),yield g.AddonModWorkshopOffline.deleteAllSubmissionActions(e.id,d),n.addOfflineDataDeletedWarning(s.warnings,e.name,i),void 0;yield Promise.all(o.map(function(){var o=(0,r.A)((function*(o){a=o.submissionid>0?o.submissionid:a;try{let s;if(o.attachmentsid){const r=yield h.AddonModWorkshopHelper.getSubmissionFilesFromOfflineFilesObject(o.attachmentsid,e.id,d);s=yield h.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.id,r,!1,d)}else s=yield h.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.id,[],!1,d);switch(0==e.submissiontypefile&&(s=void 0),o.action){case"add":a=yield f.AddonModWorkshop.addSubmissionOnline(e.id,o.title,o.content,s,d);break;case"update":yield f.AddonModWorkshop.updateSubmissionOnline(a,o.title,o.content,s,d);break;case"delete":yield f.AddonModWorkshop.deleteSubmissionOnline(a,d)}}catch(e){throw c.CoreWSError.isWebServiceError(e)&&(i=u.CoreErrorHelper.getErrorMessageFromError(e)),e}if(s.updated=!0,yield g.AddonModWorkshopOffline.deleteSubmissionAction(o.workshopid,o.action,d),"add"==o.action||"update"==o.action)return h.AddonModWorkshopHelper.deleteSubmissionStoredFiles(o.workshopid,d)}));return function(e){return o.apply(this,arguments)}}())),i&&n.addOfflineDataDeletedWarning(s.warnings,e.name,i)}))()}syncAssessment(e,o,s,d){var n=this;return(0,r.A)((function*(){let r;const i=o.assessmentid;let t=0;try{t=(yield f.AddonModWorkshop.getAssessment(e.id,i,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o.timemodified)return s.updated=!0,r=m.HT.instant("addon.mod_workshop.warningassessmentmodified"),yield g.AddonModWorkshopOffline.deleteAssessment(e.id,i,d),n.addOfflineDataDeletedWarning(s.warnings,e.name,r),void 0;let a=0;const l=o.inputdata;try{let o=[];l.feedbackauthorattachmentsid&&"number"!=typeof l.feedbackauthorattachmentsid&&(o=yield h.AddonModWorkshopHelper.getAssessmentFilesFromOfflineFilesObject(l.feedbackauthorattachmentsid,e.id,i,d)),a=yield h.AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(e.id,i,o,!1,d),l.feedbackauthorattachmentsid=a||0,yield f.AddonModWorkshop.updateAssessmentOnline(i,l,d)}catch(e){if(!c.CoreWSError.isWebServiceError(e))throw e;r=u.CoreErrorHelper.getErrorMessageFromError(e)}s.updated=!0,yield g.AddonModWorkshopOffline.deleteAssessment(e.id,i,d),yield h.AddonModWorkshopHelper.deleteAssessmentStoredFiles(e.id,i,d),r&&n.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))()}syncEvaluateSubmission(e,o,s,d){var n=this;return(0,r.A)((function*(){let r;const i=o.submissionid;let t=0;try{t=(yield f.AddonModWorkshop.getSubmission(e.id,i,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o.timemodified)return s.updated=!0,r=m.HT.instant("addon.mod_workshop.warningsubmissionmodified"),yield g.AddonModWorkshopOffline.deleteEvaluateSubmission(e.id,i,d),n.addOfflineDataDeletedWarning(s.warnings,e.name,r),void 0;try{yield f.AddonModWorkshop.evaluateSubmissionOnline(i,o.feedbacktext,o.published,o.gradeover,d)}catch(e){if(!c.CoreWSError.isWebServiceError(e))throw e;r=u.CoreErrorHelper.getErrorMessageFromError(e)}s.updated=!0,yield g.AddonModWorkshopOffline.deleteEvaluateSubmission(e.id,i,d),r&&n.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))()}syncEvaluateAssessment(e,o,s,d){var n=this;return(0,r.A)((function*(){let r;const i=o.assessmentid;let t=0;try{t=(yield f.AddonModWorkshop.getAssessment(e.id,i,{cmId:e.coursemodule,siteId:d})).timemodified}catch{t=-1}if(t<0||t>=o.timemodified)return s.updated=!0,r=m.HT.instant("addon.mod_workshop.warningassessmentmodified"),g.AddonModWorkshopOffline.deleteEvaluateAssessment(e.id,i,d);try{yield f.AddonModWorkshop.evaluateAssessmentOnline(i,o.feedbacktext,o.weight,o.gradinggradeover,d)}catch(e){if(!c.CoreWSError.isWebServiceError(e))throw e;r=u.CoreErrorHelper.getErrorMessageFromError(e)}s.updated=!0,yield g.AddonModWorkshopOffline.deleteEvaluateAssessment(e.id,i,d),r&&n.addOfflineDataDeletedWarning(s.warnings,e.name,r)}))()}}return(e=AddonModWorkshopSyncProvider).ɵfac=function AddonModWorkshopSyncProvider_Factory(o){return new(o||e)},e.ɵprov=k.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWorkshopSyncProvider})();const W=(0,m.Qd)(b)}}]);