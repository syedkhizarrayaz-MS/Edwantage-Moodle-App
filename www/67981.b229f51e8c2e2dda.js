"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[67981],{59379:(e,i,t)=>{t.d(i,{W:()=>u});var r=t(10467),n=t(52749),o=t(79555),d=t(95531),s=t(54438);let a=(()=>{var e;class AddonModWikiOfflineProvider{convertToPositiveNumber(e){return(e=Number(e))>0?e:0}deleteNewPage(e,i,t,o,s,a){var u=this;return(0,r.A)((function*(){const r=yield n.CoreSites.getSite(a);i=u.convertToPositiveNumber(i),t=u.convertToPositiveNumber(t),o=u.convertToPositiveNumber(o),s=u.convertToPositiveNumber(s),yield r.getDb().deleteRecords(d.v,{subwikiid:i,wikiid:t,userid:o,groupid:s,title:e})}))()}getAllNewPages(e){return(0,r.A)((function*(){return(yield n.CoreSites.getSite(e)).getDb().getAllRecords(d.v)}))()}getNewPage(e,i,t,o,s,a){var u=this;return(0,r.A)((function*(){const r=yield n.CoreSites.getSite(a);return i=u.convertToPositiveNumber(i),t=u.convertToPositiveNumber(t),o=u.convertToPositiveNumber(o),s=u.convertToPositiveNumber(s),r.getDb().getRecord(d.v,{subwikiid:i,wikiid:t,userid:o,groupid:s,title:e})}))()}getSubwikiNewPages(e,i,t,o,s){var a=this;return(0,r.A)((function*(){const r=yield n.CoreSites.getSite(s);return e=a.convertToPositiveNumber(e),i=a.convertToPositiveNumber(i),t=a.convertToPositiveNumber(t),o=a.convertToPositiveNumber(o),r.getDb().getRecords(d.v,{subwikiid:e,wikiid:i,userid:t,groupid:o})}))()}getSubwikisNewPages(e,i){var t=this;return(0,r.A)((function*(){let n=[];return yield Promise.all(e.map(function(){var e=(0,r.A)((function*(e){const r=yield t.getSubwikiNewPages(e.id,e.wikiid,e.userid,e.groupid,i);n=n.concat(r)}));return function(i){return e.apply(this,arguments)}}())),n}))()}saveNewPage(e,i,t,o,s,a,u){var c=this;return(0,r.A)((function*(){const r=yield n.CoreSites.getSite(u),g=Date.now(),l={title:e,cachedcontent:i,subwikiid:c.convertToPositiveNumber(t),wikiid:c.convertToPositiveNumber(o),userid:c.convertToPositiveNumber(s),groupid:c.convertToPositiveNumber(a),contentformat:"html",timecreated:g,timemodified:g,caneditpage:1};yield r.getDb().insertRecord(d.v,l)}))()}subwikisHaveOfflineData(e,i){var t=this;return(0,r.A)((function*(){try{return!!(yield t.getSubwikisNewPages(e,i)).length}catch{return!1}}))()}}return(e=AddonModWikiOfflineProvider).ɵfac=function AddonModWikiOfflineProvider_Factory(i){return new(i||e)},e.ɵprov=s.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWikiOfflineProvider})();const u=(0,o.Qd)(a)},67981:(e,i,t)=>{t.d(i,{N:()=>P});var r=t(10467),n=t(75629),o=t(97254),d=t(94455),s=t(15324),a=t(52749),u=t(43411),c=t(79555),g=t(49882),l=t(59379),w=t(51069),k=t(74431),v=t(55554),y=t(95384),S=t(54438);let h=(()=>{var e;class AddonModWikiProvider{constructor(){this.subwikiListsCache={},this.wikiFirstViewedPage={},g.z.on(g.z.LOGIN,(()=>{this.clearSubwikiList()}))}clearSubwikiList(e){void 0===e?this.subwikiListsCache={}:delete this.subwikiListsCache[e]}consumeEditedPageData(){const e=this.editedPage;return delete this.editedPage,e}editPage(e,i,t,n){return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(n),o={pageid:e,content:i};t&&(o.section=t);return(yield r.write("mod_wiki_edit_page",o)).pageid}))()}getFirstWikiPageOpened(e,i){const t=s.CoreNavigator.getMainMenuTabFromPath(i);if(t)return this.wikiFirstViewedPage[t]&&this.wikiFirstViewedPage[t][e]!==i?this.wikiFirstViewedPage[t][e]:void 0}getPageContents(e,i={}){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i.siteId),n={pageid:e},o={cacheKey:t.getPageContentsCacheKey(e),updateFrequency:k.CoreCacheUpdateFrequency.SOMETIMES,component:w.dD,componentId:i.cmId,...a.CoreSites.getReadingStrategyPreSets(i.readingStrategy)};return(yield r.read("mod_wiki_get_page_contents",n,o)).page}))()}getPageContentsCacheKey(e){return`${AddonModWikiProvider.ROOT_CACHE_KEY}page:${e}`}getPageForEditing(e,i,t,n){return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(n),o={pageid:e};i&&(o.section=i),t&&(o.lockonly=!0);return(yield r.write("mod_wiki_get_page_for_editing",o)).pagesection}))()}getSubwikiFiles(e,i={}){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i.siteId),n=i.groupId||-1,o=i.userId||0,d={wikiid:e,groupid:n,userid:o},s={cacheKey:t.getSubwikiFilesCacheKey(e,n,o),updateFrequency:k.CoreCacheUpdateFrequency.SOMETIMES,component:w.dD,componentId:i.cmId,...a.CoreSites.getReadingStrategyPreSets(i.readingStrategy)};return(yield r.read("mod_wiki_get_subwiki_files",d,s)).files}))()}getSubwikiFilesCacheKey(e,i,t){return`${this.getSubwikiFilesCacheKeyPrefix(e)}:${i}:${t}`}getSubwikiFilesCacheKeyPrefix(e){return`${AddonModWikiProvider.ROOT_CACHE_KEY}subwikifiles:${e}`}getSubwikiList(e){return this.subwikiListsCache[e]}getSubwikiPages(e,i={}){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i.siteId),n=i.groupId||-1,o=i.userId||0,d={wikiid:e,groupid:n,userid:o,options:{sortby:i.sortBy||"title",sortdirection:i.sortDirection||"ASC",includecontent:i.includeContent?1:0}},s={cacheKey:t.getSubwikiPagesCacheKey(e,n,o),updateFrequency:k.CoreCacheUpdateFrequency.SOMETIMES,component:w.dD,componentId:i.cmId,...a.CoreSites.getReadingStrategyPreSets(i.readingStrategy)};return(yield r.read("mod_wiki_get_subwiki_pages",d,s)).pages}))()}getSubwikiPagesCacheKey(e,i,t){return`${this.getSubwikiPagesCacheKeyPrefix(e)}:${i}:${t}`}getSubwikiPagesCacheKeyPrefix(e){return`${AddonModWikiProvider.ROOT_CACHE_KEY}subwikipages:${e}`}getSubwikis(e,i={}){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i.siteId),n={wikiid:e},o={cacheKey:t.getSubwikisCacheKey(e),updateFrequency:k.CoreCacheUpdateFrequency.RARELY,component:w.dD,componentId:i.cmId,...a.CoreSites.getReadingStrategyPreSets(i.readingStrategy)};return(yield r.read("mod_wiki_get_subwikis",n,o)).subwikis.map((e=>({...e,groupid:Number(e.groupid)})))}))()}getSubwikisCacheKey(e){return`${AddonModWikiProvider.ROOT_CACHE_KEY}subwikis:${e}`}getWiki(e,i,t={}){var n=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(t.siteId),o={courseids:[e]},d={cacheKey:n.getWikiDataCacheKey(e),updateFrequency:k.CoreCacheUpdateFrequency.RARELY,component:w.dD,...a.CoreSites.getReadingStrategyPreSets(t.readingStrategy)},s=yield r.read("mod_wiki_get_wikis_by_courses",o,d);return y.CoreCourseModuleHelper.getActivityByCmId(s.wikis,i)}))()}getWikiDataCacheKey(e){return`${AddonModWikiProvider.ROOT_CACHE_KEY}wiki:${e}`}getWikiFileList(e,i={}){var t=this;return(0,r.A)((function*(){i.siteId=i.siteId||a.CoreSites.getCurrentSiteId();let n=[];const o={cmId:e.coursemodule,...i},d=yield t.getSubwikis(e.id,o);return yield Promise.all(d.map(function(){var e=(0,r.A)((function*(e){const i={groupId:e.groupid,userId:e.userid,...o},r=yield t.getSubwikiFiles(e.wikiid,i);n=n.concat(r)}));return function(i){return e.apply(this,arguments)}}())),n}))()}getWikiPageList(e,i={}){var t=this;return(0,r.A)((function*(){i.siteId=i.siteId||a.CoreSites.getCurrentSiteId();let n=[];const o={cmId:e.coursemodule,...i},d=yield t.getSubwikis(e.id,o);return yield Promise.all(d.map(function(){var e=(0,r.A)((function*(e){const i=yield t.getSubwikiPages(e.wikiid,{groupId:e.groupid,userId:e.userid,...o});n=n.concat(i)}));return function(i){return e.apply(this,arguments)}}())),n}))()}invalidateContent(e,i,t){var n=this;return(0,r.A)((function*(){t=t||a.CoreSites.getCurrentSiteId();const r=yield n.getWiki(i,e,{siteId:t});yield Promise.all([n.invalidateWikiData(i,t),n.invalidateSubwikis(r.id,t),n.invalidateSubwikiPages(r.id,t),n.invalidateSubwikiFiles(r.id,t)])}))()}invalidatePage(e,i){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKey(t.getPageContentsCacheKey(e))}))()}invalidateSubwikiFiles(e,i){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKeyStartingWith(t.getSubwikiFilesCacheKeyPrefix(e))}))()}invalidateSubwikiPages(e,i){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKeyStartingWith(t.getSubwikiPagesCacheKeyPrefix(e))}))()}invalidateSubwikis(e,i){var t=this;return(0,r.A)((function*(){t.clearSubwikiList(e);const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKey(t.getSubwikisCacheKey(e))}))()}invalidateWikiData(e,i){var t=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKey(t.getWikiDataCacheKey(e))}))()}isTitleUsed(e,i,t,n={}){var o=this;return(0,r.A)((function*(){try{const r=(yield o.getSubwikis(e,n)).find((e=>e.id==i));if(!r)return!1;const d=yield o.getSubwikiPages(e,{groupId:r.groupid,userId:r.userid,...n});return!!d.find((e=>e.title==t))}catch{return!1}}))()}logPageView(e,i,t){return o.CoreCourseLogHelper.log("mod_wiki_view_page",{pageid:e},w.dD,i,t)}logView(e,i){return o.CoreCourseLogHelper.log("mod_wiki_view_wiki",{wikiid:e},w.dD,e,i)}newPage(e,i,t={}){var o=this;return(0,r.A)((function*(){t.siteId=t.siteId||a.CoreSites.getCurrentSiteId();const s=function(){var d=(0,r.A)((function*(){if(t.wikiId&&t.subwikiId){if(yield v.g.ignoreErrors(o.isTitleUsed(t.wikiId,t.subwikiId,e,{cmId:t.cmId,readingStrategy:1,siteId:t.siteId})))throw new n.CoreError(c.HT.instant("addon.mod_wiki.pageexists"))}return yield l.W.saveNewPage(e,i,t.subwikiId,t.wikiId,t.userId,t.groupId,t.siteId),-1}));return function storeOffline(){return d.apply(this,arguments)}}();if(!d.WE.isOnline())return s();yield l.W.deleteNewPage(e,t.subwikiId,t.wikiId,t.userId,t.groupId,t.siteId);try{return yield o.newPageOnline(e,i,t)}catch(e){if(u.CoreWSError.isWebServiceError(e))throw e;return s()}}))()}newPageOnline(e,i,t={}){return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(t.siteId),n={title:e,content:i,contentformat:"html"},o=l.W.convertToPositiveNumber(t.subwikiId),d=l.W.convertToPositiveNumber(t.wikiId);o&&o>0?n.subwikiid=o:d&&(n.wikiid=d,n.userid=l.W.convertToPositiveNumber(t.userId),n.groupid=l.W.convertToPositiveNumber(t.groupId));return(yield r.write("mod_wiki_new_page",n)).pageid}))()}setEditedPageData(e){this.editedPage=e}setSubwikiList(e,i,t,r,n,o){this.subwikiListsCache[e]={count:t,subwikiSelected:r,userSelected:n,groupSelected:o,subwikis:i}}sortPagesByTitle(e,i){return e.sort(((e,t)=>{let r=e.title>=t.title?1:-1;return i&&(r=-r),r}))}wikiHasSubwiki(e,i,t={}){var n=this;return(0,r.A)((function*(){try{const r=yield n.getSubwikis(e,t);return!!r.find((e=>e.id==i))}catch{return!1}}))()}wikiPageClosed(e,i){const t=s.CoreNavigator.getMainMenuTabFromPath(i);t&&(this.wikiFirstViewedPage[t]=this.wikiFirstViewedPage[t]||{},this.wikiFirstViewedPage[t][e]===i&&delete this.wikiFirstViewedPage[t][e])}wikiPageOpened(e,i){const t=s.CoreNavigator.getMainMenuTabFromPath(i);t&&(this.wikiFirstViewedPage[t]=this.wikiFirstViewedPage[t]||{},this.wikiFirstViewedPage[t][e]||(this.wikiFirstViewedPage[t][e]=i))}}return(e=AddonModWikiProvider).ROOT_CACHE_KEY="mmaModWiki:",e.ɵfac=function AddonModWikiProvider_Factory(i){return new(i||e)},e.ɵprov=S.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWikiProvider})();const P=(0,c.Qd)(h)}}]);