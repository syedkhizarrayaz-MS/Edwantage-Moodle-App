"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[51877],{74339:(e,r,t)=>{t.d(r,{M:()=>c});var n=t(10467),s=t(52749),i=t(75383),o=t(79555),d=t(25191),u=t(54438);let y=(()=>{var e;class AddonModSurveyOfflineProvider{deleteSurveyAnswers(e,r,t){return(0,n.A)((function*(){const n=yield s.CoreSites.getSite(r);t=t||n.getUserId(),yield n.getDb().deleteRecords(d.K,{surveyid:e,userid:t})}))()}getAllData(e){return(0,n.A)((function*(){const r=yield s.CoreSites.getSite(e);return(yield r.getDb().getAllRecords(d.K)).map((e=>Object.assign(e,{answers:i.Ni.parseJSON(e.answers)})))}))()}getSurveyAnswers(e,r,t){var s=this;return(0,n.A)((function*(){try{return(yield s.getSurveyData(e,r,t)).answers||[]}catch{return[]}}))()}getSurveyData(e,r,t){return(0,n.A)((function*(){const n=yield s.CoreSites.getSite(r);t=t||n.getUserId();const o=yield n.getDb().getRecord(d.K,{surveyid:e,userid:t});return Object.assign(o,{answers:i.Ni.parseJSON(o.answers)})}))()}hasAnswers(e,r,t){var s=this;return(0,n.A)((function*(){return!!(yield s.getSurveyAnswers(e,r,t)).length}))()}saveAnswers(e,r,t,i,o,u){return(0,n.A)((function*(){const n=yield s.CoreSites.getSite(o);u=u||n.getUserId();const y={surveyid:e,name:r,courseid:t,userid:u,answers:JSON.stringify(i),timecreated:Date.now()};yield n.getDb().insertRecord(d.K,y)}))()}}return(e=AddonModSurveyOfflineProvider).ɵfac=function AddonModSurveyOfflineProvider_Factory(r){return new(r||e)},e.ɵprov=u.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModSurveyOfflineProvider})();const c=(0,o.Qd)(y)},51877:(e,r,t)=>{t.d(r,{o:()=>C});var n=t(10467),s=t(49446),i=t(37690),o=t(44682),d=t(97254),u=t(94455),y=t(52749),c=t(43411),a=t(79555),v=t(49882),l=t(72829),S=t(74339),g=t(67039),f=t(55554),A=t(54438);let h=(()=>{var e;class AddonModSurveySyncProvider extends i.L{constructor(){super("AddonModSurveySyncProvider"),this.componentTranslatableString="survey"}getSyncId(e,r){return`${e}#${r}`}syncAllSurveys(e,r){return this.syncOnSites("all surveys",(e=>this.syncAllSurveysFunc(!!r,e)),e)}syncAllSurveysFunc(e,r){var t=this;return(0,n.A)((function*(){const s=(yield S.M.getAllData(r)).map(function(){var s=(0,n.A)((function*(n){const s=yield e?t.syncSurvey(n.surveyid,n.userid,r):t.syncSurveyIfNeeded(n.surveyid,n.userid,r);s&&s.updated&&v.z.trigger(g.A9,{surveyId:n.surveyid,userId:n.userid,warnings:s.warnings},r)}));return function(e){return s.apply(this,arguments)}}());yield Promise.all(s)}))()}syncSurveyIfNeeded(e,r,t){var s=this;return(0,n.A)((function*(){const n=s.getSyncId(e,r);if(yield s.isSyncNeeded(n,t))return s.syncSurvey(e,r,t)}))()}syncSurvey(e,r,t){var s=this;return(0,n.A)((function*(){const n=yield y.CoreSites.getSite(t);t=n.getId(),r=r||n.getUserId();const i=s.getSyncId(e,r),o=s.getOngoingSync(i,t);if(o)return o;s.logger.debug(`Try to sync survey '${e}' for user '${r}'`);const d=s.performSyncSurvey(e,r,t);return s.addOngoingSync(i,d,t)}))()}performSyncSurvey(e,r,t){var i=this;return(0,n.A)((function*(){const n={warnings:[],updated:!1};f.g.ignoreErrors(d.CoreCourseLogHelper.syncActivity(g.Rw,e,t));let y,a=0;try{y=yield S.M.getSurveyData(e,t,r),a=y.answers.length}catch{}if(a>0&&y){if(!u.WE.isOnline())throw new s.CoreNetworkError;n.courseId=y.courseid;try{yield l.h.submitAnswersOnline(e,y.answers,t),n.updated=!0,yield S.M.deleteSurveyAnswers(e,t,r)}catch(s){if(!c.CoreWSError.isWebServiceError(s))throw s;n.updated=!0,yield S.M.deleteSurveyAnswers(e,t,r),i.addOfflineDataDeletedWarning(n.warnings,y.name,s)}if(n.courseId){yield l.h.invalidateSurveyData(n.courseId,t);const r=yield o.CoreCourse.getModuleBasicInfoByInstance(e,g.FY,{siteId:t});f.g.ignoreErrors(i.prefetchModuleAfterUpdate(r,n.courseId,void 0,t))}}const v=i.getSyncId(e,r);return f.g.ignoreErrors(i.setSyncTime(v,t)),n}))()}}return(e=AddonModSurveySyncProvider).ɵfac=function AddonModSurveySyncProvider_Factory(r){return new(r||e)},e.ɵprov=A.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModSurveySyncProvider})();const C=(0,a.Qd)(h)},72829:(e,r,t)=>{t.d(r,{h:()=>h});var n=t(10467),s=t(75629),i=t(97254),o=t(94455),d=t(88793),u=t(52749),y=t(43411),c=t(79555),a=t(74339),v=t(67039),l=t(74431),S=t(55554),g=t(95384),f=t(54438);let A=(()=>{var e;class AddonModSurveyProvider{getQuestions(e,r={}){var t=this;return(0,n.A)((function*(){const n=yield u.CoreSites.getSite(r.siteId),i={surveyid:e},o={cacheKey:t.getQuestionsCacheKey(e),updateFrequency:l.CoreCacheUpdateFrequency.RARELY,component:v.Rw,componentId:r.cmId,...u.CoreSites.getReadingStrategyPreSets(r.readingStrategy)},d=yield n.read("mod_survey_get_questions",i,o);if(d.questions)return d.questions;throw new s.CoreError("No questions were found.")}))()}getQuestionsCacheKey(e){return`${AddonModSurveyProvider.ROOT_CACHE_KEY}questions:${e}`}getSurveyCacheKey(e){return`${AddonModSurveyProvider.ROOT_CACHE_KEY}survey:${e}`}getSurvey(e,r,t={}){var s=this;return(0,n.A)((function*(){const n=yield u.CoreSites.getSite(t.siteId),i={courseids:[e]},o={cacheKey:s.getSurveyCacheKey(e),updateFrequency:l.CoreCacheUpdateFrequency.RARELY,component:v.Rw,...u.CoreSites.getReadingStrategyPreSets(t.readingStrategy)},d=yield n.read("mod_survey_get_surveys_by_courses",i,o);return g.CoreCourseModuleHelper.getActivityByCmId(d.surveys,r)}))()}invalidateContent(e,r,t){var s=this;return(0,n.A)((function*(){t=t||u.CoreSites.getCurrentSiteId();const i=[];i.push(s.getSurvey(r,e).then(function(){var e=(0,n.A)((function*(e){const n=[];n.push(s.invalidateSurveyData(r,t)),n.push(s.invalidateQuestions(e.id,t)),yield Promise.all(n)}));return function(r){return e.apply(this,arguments)}}())),i.push(d.CoreFilepool.invalidateFilesByComponent(t,v.Rw,e)),yield S.g.allPromises(i)}))()}invalidateQuestions(e,r){var t=this;return(0,n.A)((function*(){const n=yield u.CoreSites.getSite(r);yield n.invalidateWsCacheForKey(t.getQuestionsCacheKey(e))}))()}invalidateSurveyData(e,r){var t=this;return(0,n.A)((function*(){const n=yield u.CoreSites.getSite(r);yield n.invalidateWsCacheForKey(t.getSurveyCacheKey(e))}))()}logView(e,r){return(0,n.A)((function*(){const t={surveyid:e};yield i.CoreCourseLogHelper.log("mod_survey_view_survey",t,v.Rw,e,r)}))()}submitAnswers(e,r,t,s,i){var d=this;return(0,n.A)((function*(){const c=function(){var o=(0,n.A)((function*(){return yield a.M.saveAnswers(e,r,t,s,i),!1}));return function storeOffline(){return o.apply(this,arguments)}}();if(i=i||u.CoreSites.getCurrentSiteId(),!o.WE.isOnline())return c();try{return yield a.M.deleteSurveyAnswers(e,i),yield d.submitAnswersOnline(e,s,i),!0}catch(e){if(y.CoreWSError.isWebServiceError(e))throw e;return c()}}))()}submitAnswersOnline(e,r,t){return(0,n.A)((function*(){const n=yield u.CoreSites.getSite(t),i={surveyid:e,answers:r};if(!(yield n.write("mod_survey_submit_answers",i)).status)throw new s.CoreError("Error submitting answers.")}))()}}return(e=AddonModSurveyProvider).ROOT_CACHE_KEY="mmaModSurvey:",e.ɵfac=function AddonModSurveyProvider_Factory(r){return new(r||e)},e.ɵprov=f.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModSurveyProvider})();const h=(0,c.Qd)(A)}}]);