"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[57934],{57934:(e,t,r)=>{r.d(t,{r:()=>A});var i=r(10467),n=r(44682),a=r(16082),o=r(32440),d=r(52749),s=r(82907),l=r(75383),c=r(55554),u=r(79555),p=r(49882),g=r(23917),f=r(82622),y=r(57587),h=r(95209),m=r(47551),v=r(33014),E=r(25572),S=r(54438);let C=(()=>{var e;class AddonModDataHelperProvider{applyOfflineActions(e,t,r){var n=this;return(0,i.A)((function*(){const i=[];return t.forEach((t=>{e.timemodified=Math.max(e.timemodified,t.timemodified),e.hasOffline=!0;const a={};switch(t.action){case h.Z4.APPROVE:e.approved=!0;break;case h.Z4.DISAPPROVE:e.approved=!1;break;case h.Z4.DELETE:e.deleted=!0;break;case h.Z4.ADD:case h.Z4.EDIT:e.groupid=t.groupid,t.fields.forEach((e=>{void 0===a[e.fieldid]&&(a[e.fieldid]={}),e.subfield?a[e.fieldid][e.subfield]=l.Ni.parseJSON(e.value,""):a[e.fieldid][""]=l.Ni.parseJSON(e.value,"")})),r.forEach((t=>{f.R.hasFiles(t)?i.push(n.getStoredFiles(e.dataid,e.id,t.id).then((r=>{e.contents[t.id]=f.R.overrideData(t,e.contents[t.id],a[t.id],r),e.contents[t.id].fieldid=t.id}))):(e.contents[t.id]=f.R.overrideData(t,e.contents[t.id],a[t.id]),e.contents[t.id].fieldid=t.id)}))}})),yield Promise.all(i),e}))()}approveOrDisapproveEntry(e,t,r,n,a){var o=this;return(0,i.A)((function*(){a=a||d.CoreSites.getCurrentSiteId();const i=yield v.CoreLoadings.show("core.sending",!0);try{n=yield o.getActivityCourseIdIfNotSet(e,n,a);try{yield g.$.approveEntry(e,t,r,n,a)}catch(e){throw E.CoreAlerts.showError(e,{default:u.HT.instant("addon.mod_data.errorapproving")}),e}const i=[];i.push(g.$.invalidateEntryData(e,t,a)),i.push(g.$.invalidateEntriesData(e,a)),yield c.g.ignoreErrors(Promise.all(i)),p.z.trigger(h.bg,{dataId:e,entryId:t},a),m.CoreToasts.show({message:r?"addon.mod_data.recordapproved":"addon.mod_data.recorddisapproved",translateMessage:!0,duration:m.ToastDuration.LONG})}catch{}finally{i.dismiss()}}))()}displayShowFields(e,t,r,i,n,a={}){if(!e)return"";t.forEach((t=>{var n;let a=`[[${t.name}]]`;a=a.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&");let o=new RegExp(a,"gi");const d=new RegExp(">\\[\\["+t.name+"\\]\\]<","gi");if(null!==(n=e.match(d))&&void 0!==n&&n.length){e=e.replace(d,`><addon-mod-data-field-plugin [field]="fields[${t.id}]" mode="${i}" [database]="database"                     [value]="entries[${r.id}].contents[${t.id}]" [recordHasOffline]="${r.hasOffline?"true":"false"}"                     (gotoEntry)="gotoEntry($event)"></addon-mod-data-field-plugin><`).replace(o,r.contents[t.id].content)}else{e=e.replace(o,`<addon-mod-data-field-plugin [field]="fields[${t.id}]" mode="${i}" [database]="database"                 [value]="entries[${r.id}].contents[${t.id}]" [recordHasOffline]="${r.hasOffline?"true":"false"}"                 (gotoEntry)="gotoEntry($event)"></addon-mod-data-field-plugin>`)}a=`[[${t.name}#name]]`,a=a.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),o=new RegExp(a,"gi"),e=e.replace(o,t.name),a=`[[${t.name}#description]]`,a=a.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"),o=new RegExp(a,"gi"),e=e.replace(o,t.description)}));for(const t in n){const o=new RegExp(`##${t}##`,"gi");n[t]?e=e.replace(o,t!==h.Z4.MOREURL?t!==h.Z4.APPROVALSTATUS?t!==h.Z4.APPROVALSTATUSCLASS?t!==h.Z4.ID?`<addon-mod-data-action action="${t}" [entry]="entries[${r.id}]" mode="${i}" [database]="database" [access]="access" [title]="title" `+(void 0!==a.offset?`[offset]="${a.offset}" `:"")+(void 0!==a.sortBy?`[sortBy]="${a.sortBy}" `:"")+(void 0!==a.sortDirection?`sortDirection="${a.sortDirection}" `:"")+'[group]="group"></addon-mod-data-action>':r.id.toString():r.approved?"approved":"notapproved":r.approved?"":`<ion-badge color="warning">${u.HT.instant("addon.mod_data.notapproved")}</ion-badge>`:d.CoreSites.getRequiredCurrentSite().getURL()+`/mod/data/view.php?d={{database.id}}&rid=${r.id}`):e=e.replace(o,"")}const o=new RegExp("##otherfields##","gi");if(!e.match(o))return e;const s=t.filter((t=>!e.includes(`[field]="fields[${t.id}]`))).map((e=>`<p><strong>${e.name}</strong></p><p><addon-mod-data-field-plugin [field]="fields[`+e.id+']" [value]="entries['+r.id+"].contents["+e.id+']" mode="'+i+'" [database]="database" (gotoEntry)="gotoEntry($event)"></addon-mod-data-field-plugin></p>'));return e.replace(o,s.join(""))}fetchEntries(e,t,r={}){var n=this;return(0,i.A)((function*(){const i=yield d.CoreSites.getSite(r.siteId);r.groupId=r.groupId||0,r.page=r.page||0;const a={},s={entries:[],totalcount:0},l=[];r.siteId=i.id;const c=y.i.getDatabaseEntries(e.id,i.id).then((t=>{s.hasOfflineActions=!!t.length,t.forEach((t=>{var n;(void 0===a[t.entryid]&&(a[t.entryid]=[]),a[t.entryid].push(t),t.action!==h.Z4.ADD||0!==r.page||r.search||r.advSearch||t.groupid&&r.groupId&&t.groupid!==r.groupId)||l.push({id:t.entryid,canmanageentry:!0,approved:!e.approval||e.manageapproved,dataid:e.id,groupid:t.groupid,timecreated:t.timemodified,timemodified:t.timemodified,userid:i.getUserId(),fullname:null===(n=i.getInfo())||void 0===n?void 0:n.fullname,contents:{}})})),l.sort(((e,t)=>t.timecreated-e.timecreated))})),u=o.CoreRatingOffline.hasRatings("mod_data","entry","module",e.coursemodule).then((e=>{s.hasOfflineRatings=e}));let p;p=r.search||r.advSearch?g.$.searchEntries(e.id,r).then((e=>{s.entries=e.entries,s.totalcount=e.totalcount,s.maxcount=e.maxcount})):g.$.getEntries(e.id,r).then((e=>{s.entries=e.entries,s.totalcount=e.totalcount})),yield Promise.all([c,u,p]);const f=[];return s.entries.forEach((e=>{f.push(n.applyOfflineActions(e,a[e.id]||[],t))})),l.forEach((e=>{f.push(n.applyOfflineActions(e,a[e.id]||[],t))})),s.offlineEntries=l,yield Promise.all(f),s}))()}fetchEntry(e,t,r,n){var a=this;return(0,i.A)((function*(){const i=yield d.CoreSites.getSite(n),o=yield y.i.getEntryActions(e.id,r,i.id);let s;var l;r>0?s=yield g.$.getEntry(e.id,r,{cmId:e.coursemodule,siteId:i.id}):s={entry:{id:r,userid:i.getUserId(),groupid:0,dataid:e.id,timecreated:-r,timemodified:-r,approved:!e.approval||e.manageapproved,canmanageentry:!0,fullname:null===(l=i.getInfo())||void 0===l?void 0:l.fullname,contents:{}}};return yield a.applyOfflineActions(s.entry,o,t),s}))()}getActions(e,t,r,i){return{add:!1,more:!0,moreurl:!0,user:!0,userpicture:!0,timeadded:!0,timemodified:!0,tags:!0,id:!0,edit:r.canmanageentry&&!r.deleted,delete:r.canmanageentry,approve:e.approval&&t.canapprove&&!r.approved&&!r.deleted,disapprove:e.approval&&t.canapprove&&r.approved&&!r.deleted,approvalstatus:e.approval,approvalstatusclass:e.approval,comments:e.comments,actionsmenu:r.canmanageentry||e.approval&&t.canapprove&&!r.deleted||i===h.KP.LIST,delcheck:!1,export:!1}}getActivityCourseIdIfNotSet(e,t,r){return(0,i.A)((function*(){if(t)return t;return(yield n.CoreCourse.getModuleBasicInfoByInstance(e,h.t7,{siteId:r,readingStrategy:1})).course}))()}getDefaultTemplate(e,t){switch(e){case h.No.LIST:return this.getDefaultListTemplate(t);case h.No.SINGLE:return this.getDefaultSingleTemplate(t);case h.No.SEARCH:return this.getDefaultSearchTemplate(t);case h.No.ADD:return this.getDefaultAddTemplate(t)}return""}getDefaultListTemplate(e){const t=[];return t.push(`<ion-card class="defaulttemplate-listentry">\n            <ion-item class="ion-text-wrap" lines="full">\n                ##userpicture##\n                <ion-label>\n                    <p class="item-heading">##user##</p>\n                    <p class="data-timeinfo">##timeadded##</p>\n                    <p class="data-timeinfo">\n                        <strong>${u.HT.instant("addon.mod_data.datemodified")}</strong>&nbsp;##timemodified##\n                    </p>\n                </ion-label>\n                <div slot="end" class="ion-text-end">\n                    ##actionsmenu##\n                    <p class="ion-text-end ##approvalstatusclass##">##approvalstatus##</p>\n                </div>\n            </ion-item>\n\n            <ion-item class="ion-text-wrap defaulttemplate-list-body"><ion-label>`),e.forEach((e=>{t.push(`\n            <ion-row class="ion-margin-vertical ion-align-items-start ion-justify-content-start">\n                <ion-col size="4" size-lg="3"><strong>${e.name}</strong></ion-col>\n                <ion-col size="8" size-lg="9">[[${e.name}]]</ion-col>\n            </ion-row>`)})),t.push("##tags##</ion-label></ion-item></ion-card>"),t.join("")}getDefaultAddTemplate(e){const t=[];return t.push('<div class="defaulttemplate-addentry">'),e.forEach((e=>{t.push(`\n            <div class="ion-text-wrap edit-field">\n                <p><strong>${e.name}</strong></p>\n                [[${e.name}]]\n            </div>`)})),t.push("##otherfields## ##tags##</div>"),t.join("")}getDefaultSingleTemplate(e){const t=[];return t.push(`<div class="defaulttemplate-single">\n            <div class="defaulttemplate-single-body">\n            <ion-item class="ion-text-wrap" lines="full">\n                ##userpicture##\n                <ion-label>\n                    <p class="item-heading">##user##</p>\n                    <p class="data-timeinfo">##timeadded##</p>\n                    <p class="data-timeinfo">\n                        <strong>${u.HT.instant("addon.mod_data.datemodified")}</strong>&nbsp;##timemodified##\n                    </p>\n                </ion-label>\n                <div slot="end" class="ion-text-end">\n                    ##actionsmenu##\n                    <p class="ion-text-end ##approvalstatusclass##">##approvalstatus##</p>\n                </div>\n            </ion-item>`),e.forEach((e=>{t.push(`\n            <ion-item class="ion-text-wrap" lines="none"><ion-label>\n                <p class="item-heading"><strong>${e.name}</strong></p>\n                <p>[[${e.name}]]</p>\n            </ion-label></ion-item>`)})),t.push("##otherfields## ##tags##</ion-label></ion-item></div></div>"),t.join("")}getDefaultSearchTemplate(e){const t=[];return t.push('<div class="defaulttemplate-asearch">'),t.push(`\n            <div class="ion-text-wrap search-field">\n                <p><strong>${u.HT.instant("addon.mod_data.authorfirstname")}</strong></p>\n                ##firstname##\n            </div>`),t.push(`\n            <div class="ion-text-wrap search-field">\n                <p><strong>${u.HT.instant("addon.mod_data.authorlastname")}</strong></p>\n                ##lastname##\n            </div>`),e.forEach((e=>{t.push(`\n            <div class="ion-text-wrap search-field">\n                <p><strong>${e.name}</strong></p>\n                [[${e.name}]]\n            </div>`)})),t.push("##tags##</div>"),t.join("")}getEditDataFromForm(e,t,r,n,a,o=!1,s){var l=this;return(0,i.A)((function*(){if(!e)return[];s=s||d.CoreSites.getCurrentSiteId();const c=[],u=t.map(function(){var t=(0,i.A)((function*(t){const d=f.R.getFieldEditData(t,e,a[t.id]);if(!d)return;const u=d.map(function(){var e=(0,i.A)((function*(e){var t;let i=e.value;r&&e.files&&(i=yield l.uploadOrStoreFiles(r,0,n,e.fieldid,e.files,o,s)),c.push({fieldid:e.fieldid,subfield:null!==(t=e.subfield)&&void 0!==t?t:"",value:i||0===i?JSON.stringify(i):""})}));return function(t){return e.apply(this,arguments)}}());yield Promise.all(u)}));return function(e){return t.apply(this,arguments)}}());return yield Promise.all(u),c}))()}getEditTmpFiles(e,t,r){return(0,i.A)((function*(){if(!e)return[];const i=t.map((t=>f.R.getFieldEditFiles(t,e,r[t.id])));return(yield Promise.all(i)).reduce(((e,t)=>e.concat(t)),[])}))()}getStoredFiles(e,t,r,n){return(0,i.A)((function*(){const i=yield y.i.getEntryFieldFolder(e,t,r,n);try{return yield a.CoreFileUploader.getStoredFiles(i)}catch{return[]}}))()}getTemplate(e,t,r){let i=e[t]||this.getDefaultTemplate(t,r);return t!=h.No.LIST_HEADER&&t!=h.No.LIST_FOOTER&&(i=s.y.fixHtml(i)),i=i.replace(/<a ([^>]*href="[^>]*)>/gi,((e,t)=>`<a core-link capture="true" ${t}>`)),i=i.replace(/([{}]+)/g,"{{ '$1' }}"),i}hasEditDataChanged(e,t,r){return t.some((t=>f.R.hasFieldDataChanged(t,e,r[t.id])))}showDeleteEntryModal(e,t,r,n){var a=this;return(0,i.A)((function*(){n=n||d.CoreSites.getCurrentSiteId();try{yield E.CoreAlerts.confirmDelete(u.HT.instant("addon.mod_data.confirmdeleterecord"));const i=yield v.CoreLoadings.show();try{t>0&&(r=yield a.getActivityCourseIdIfNotSet(e,r,n)),r&&(yield g.$.deleteEntry(e,t,r,n))}catch(e){return E.CoreAlerts.showError(e,{default:u.HT.instant("addon.mod_data.errordeleting")}),i.dismiss(),void 0}try{yield g.$.invalidateEntryData(e,t,n),yield g.$.invalidateEntriesData(e,n)}catch{}p.z.trigger(h.bg,{dataId:e,entryId:t,deleted:!0},n),m.CoreToasts.show({message:"addon.mod_data.recorddeleted",translateMessage:!0,duration:m.ToastDuration.LONG}),i.dismiss()}catch{}}))()}storeFiles(e,t,r,n,o){return(0,i.A)((function*(){const i=yield y.i.getEntryFieldFolder(e,t,r,o);return a.CoreFileUploader.storeFilesToUpload(i,n)}))()}uploadOrStoreFiles(e,t=0,r,n,o,d,s){var l=this;return(0,i.A)((function*(){return d?l.storeFiles(e,r,n,o,s):o.length?a.CoreFileUploader.uploadOrReuploadFiles(o,h.$W,t,s):0}))()}getComponentsToCompile(){return(0,i.A)((function*(){const{AddonModDataFieldPluginComponent:e}=yield r.e(85788).then(r.bind(r,85788)),{AddonModDataActionComponent:t}=yield r.e(36488).then(r.bind(r,36488));return[e,t]}))()}}return(e=AddonModDataHelperProvider).ɵfac=function AddonModDataHelperProvider_Factory(t){return new(t||e)},e.ɵprov=S.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataHelperProvider})();const A=(0,u.Qd)(C)},57587:(e,t,r)=>{r.d(t,{i:()=>y});var i=r(10467),n=r(16082),a=r(45507),o=r(52749),d=r(75383),s=r(55554),l=r(79555),c=r(8756),u=r(15403),p=r(24742),g=r(54438);let f=(()=>{var e;class AddonModDataOfflineProvider{deleteAllEntryActions(e,t,r){var n=this;return(0,i.A)((function*(){const i=(yield n.getEntryActions(e,t,r)).map((i=>{n.deleteEntry(e,t,i.action,r)}));yield Promise.all(i)}))()}deleteEntry(e,t,r,n){var a=this;return(0,i.A)((function*(){const i=yield o.CoreSites.getSite(n);yield a.deleteEntryFiles(e,t,r,i.id),yield i.getDb().deleteRecords(u.T,{dataid:e,entryid:t,action:r})}))()}deleteEntryFiles(e,t,r,a){var l=this;return(0,i.A)((function*(){const i=yield o.CoreSites.getSite(a),c=yield s.g.ignoreErrors(l.getEntry(e,t,r,i.id));if(!c||!c.fields)return;const u=[];c.fields.forEach((r=>{const a=d.Ni.parseJSON(r.value,null);if(!a||!a.offline)return;const o=l.getEntryFieldFolder(e,t,r.fieldid,i.id).then((e=>n.CoreFileUploader.getStoredFiles(e))).then((e=>n.CoreFileUploader.clearTmpFiles(e))).catch((()=>{}));u.push(o)})),yield Promise.all(u)}))()}getAllEntries(e){var t=this;return(0,i.A)((function*(){const r=yield o.CoreSites.getSite(e);return(yield r.getDb().getAllRecords(u.T)).map((e=>t.parseRecord(e)))}))()}getDatabaseEntries(e,t){var r=this;return(0,i.A)((function*(){const i=yield o.CoreSites.getSite(t);return(yield i.getDb().getRecords(u.T,{dataid:e},"timemodified")).map((e=>r.parseRecord(e)))}))()}getEntry(e,t,r,n){var a=this;return(0,i.A)((function*(){const i=yield o.CoreSites.getSite(n),d=yield i.getDb().getRecord(u.T,{dataid:e,entryid:t,action:r});return a.parseRecord(d)}))()}getEntryActions(e,t,r){var n=this;return(0,i.A)((function*(){const i=yield o.CoreSites.getSite(r);return(yield i.getDb().getRecords(u.T,{dataid:e,entryid:t})).map((e=>n.parseRecord(e)))}))()}hasOfflineData(e,t){return(0,i.A)((function*(){const r=yield o.CoreSites.getSite(t);return s.g.promiseWorks(r.getDb().recordExists(u.T,{dataid:e}))}))()}getDatabaseFolder(e,t){return(0,i.A)((function*(){const r=yield o.CoreSites.getSite(t),i=a.CoreFile.getSiteFolder(r.getId());return c.$.concatenatePaths(i,`offlinedatabase/${e}`)}))()}getEntryFieldFolder(e,t,r,n){var a=this;return(0,i.A)((function*(){const i=yield a.getDatabaseFolder(e,n);return c.$.concatenatePaths(i,`${t}_${r}`)}))()}parseRecord(e){const t=p.j.ensureSeconds(e.timemodified);return Object.assign(e,{fields:d.Ni.parseJSON(e.fields),timemodified:t})}saveEntry(e,t,r,n,a=0,d,s,l){return(0,i.A)((function*(){const i=yield o.CoreSites.getSite(l);s=s||p.j.timestamp();const c={dataid:e,courseid:n,groupid:a,action:r,entryid:t=null==t?-s:t,fields:JSON.stringify(d||[]),timemodified:s};return yield i.getDb().insertRecord(u.T,c),c}))()}}return(e=AddonModDataOfflineProvider).ɵfac=function AddonModDataOfflineProvider_Factory(t){return new(t||e)},e.ɵprov=g.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataOfflineProvider})();const y=(0,l.Qd)(f)},23917:(e,t,r)=>{r.d(t,{$:()=>S});var i=r(10467),n=r(75629),a=r(97254),o=r(94455),d=r(88793),s=r(52749),l=r(24502),c=r(79555),u=r(82622),p=r(57587),g=r(95209),f=r(74431),y=r(55554),h=r(43411),m=r(95384),v=r(54438);let E=(()=>{var e;class AddonModDataProvider{addEntry(e,t,r,n,a=0,d,l,c=!1){var u=this;return(0,i.A)((function*(){l=l||s.CoreSites.getCurrentSiteId();const f=function(){var o=(0,i.A)((function*(){return{newentryid:(yield p.i.saveEntry(e,t,g.Z4.ADD,r,a,n,void 0,l)).entryid,sent:!1}}));return function storeOffline(){return o.apply(this,arguments)}}();if(!o.WE.isOnline()||c){const e=u.checkFields(d,n);if(e.length>0)return{fieldnotifications:e}}if(yield u.deleteEntryOfflineAction(e,t,g.Z4.ADD,l),!o.WE.isOnline()||c)return f();try{const t=yield u.addEntryOnline(e,n,a,l);return t.sent=!0,t}catch(e){if(h.CoreWSError.isWebServiceError(e))throw e;return f()}}))()}addEntryOnline(e,t,r,n){return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(n),a={databaseid:e,data:t};return void 0!==r&&(a.groupid=r),i.write("mod_data_add_entry",a)}))()}approveEntry(e,t,r,n,a){var d=this;return(0,i.A)((function*(){a=a||s.CoreSites.getCurrentSiteId();const l=function(){var o=(0,i.A)((function*(){const i=r?g.Z4.APPROVE:g.Z4.DISAPPROVE;return yield p.i.saveEntry(e,t,i,n,void 0,void 0,void 0,a),{sent:!1}}));return function storeOffline(){return o.apply(this,arguments)}}(),c=r?g.Z4.DISAPPROVE:g.Z4.APPROVE;if(!(yield d.deleteEntryOfflineAction(e,t,c,a))){if(!o.WE.isOnline())return l();try{return yield d.approveEntryOnline(t,r,a),{sent:!0}}catch(e){if(h.CoreWSError.isWebServiceError(e))throw e;return l()}}}))()}approveEntryOnline(e,t,r){return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(r),n={entryid:e,approve:t};yield i.write("mod_data_approve_entry",n)}))()}checkFields(e,t){const r=[],i=l.R.toObjectMultiple(t,"fieldid");return e.forEach((e=>{const t=u.R.getFieldsNotifications(e,i[e.id]);t&&r.push({fieldname:e.name,notification:t})})),r}deleteEntry(e,t,r,n){var a=this;return(0,i.A)((function*(){n=n||s.CoreSites.getCurrentSiteId();const d=function(){var a=(0,i.A)((function*(){yield p.i.saveEntry(e,t,g.Z4.DELETE,r,void 0,void 0,void 0,n)}));return function storeOffline(){return a.apply(this,arguments)}}();if(!(yield a.deleteEntryOfflineAction(e,t,g.Z4.ADD,n))){if(!o.WE.isOnline())return d();try{yield a.deleteEntryOnline(t,n)}catch(e){if(h.CoreWSError.isWebServiceError(e))throw e;return d()}}}))()}deleteEntryOnline(e,t){return(0,i.A)((function*(){const r=yield s.CoreSites.getSite(t),i={entryid:e};yield r.write("mod_data_delete_entry",i)}))()}deleteEntryOfflineAction(e,t,r,n){return(0,i.A)((function*(){try{return yield p.i.getEntry(e,t,r,n),yield p.i.deleteEntry(e,t,r,n),!0}catch{return!1}}))()}editEntry(e,t,r,n,a,d,l=!1){var c=this;return(0,i.A)((function*(){d=d||s.CoreSites.getCurrentSiteId();const u=function(){var a=(0,i.A)((function*(){return yield p.i.saveEntry(e,t,g.Z4.EDIT,r,void 0,n,void 0,d),{updated:!0,sent:!1}}));return function storeOffline(){return a.apply(this,arguments)}}();if(!o.WE.isOnline()||l){const e=c.checkFields(a,n);if(e.length>0)return{fieldnotifications:e}}if(yield c.deleteEntryOfflineAction(e,t,g.Z4.EDIT,d),!o.WE.isOnline()||l)return u();try{const e=yield c.editEntryOnline(t,n,d);return e.sent=!0,e}catch(e){if(h.CoreWSError.isWebServiceError(e))throw e;return u()}}))()}editEntryOnline(e,t,r){return(0,i.A)((function*(){return(yield s.CoreSites.getSite(r)).write("mod_data_update_entry",{entryid:e,data:t})}))()}fetchAllEntries(e,t={}){var r,i;t.siteId=t.siteId||s.CoreSites.getCurrentSiteId();const n={perPage:null!==(r=t.perPage)&&void 0!==r?r:g.uZ,page:null!==(i=t.page)&&void 0!==i?i:0};return this.fetchEntriesRecursive(e,[],t,n)}fetchEntriesRecursive(e,t,r,n){var a=this;return(0,i.A)((function*(){const i=yield a.getEntries(e,r);t=t.concat(i.entries);return n.perPage>0&&(n.page+1)*n.perPage<i.totalcount?(n.page++,a.fetchEntriesRecursive(e,t,r,n)):t}))()}getDatabaseDataCacheKey(e){return`${AddonModDataProvider.ROOT_CACHE_KEY}data:${e}`}getDatabaseDataPrefixCacheKey(e){return AddonModDataProvider.ROOT_CACHE_KEY+e}getDatabaseByKey(e,t,r,n={}){var a=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(n.siteId),o={courseids:[e]},d={cacheKey:a.getDatabaseDataCacheKey(e),updateFrequency:f.CoreCacheUpdateFrequency.RARELY,component:g.$W,...s.CoreSites.getReadingStrategyPreSets(n.readingStrategy)},l=yield i.read("mod_data_get_databases_by_courses",o,d);return m.CoreCourseModuleHelper.getActivityByField(l.databases,t,r)}))()}getDatabase(e,t,r={}){return this.getDatabaseByKey(e,"coursemodule",t,r)}getDatabaseById(e,t,r={}){return this.getDatabaseByKey(e,"id",t,r)}getDatabaseAccessInformationDataPrefixCacheKey(e){return this.getDatabaseDataPrefixCacheKey(e)+":access:"}getDatabaseAccessInformationDataCacheKey(e,t=0){return this.getDatabaseAccessInformationDataPrefixCacheKey(e)+t}getDatabaseAccessInformation(e,t={}){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t.siteId);t.groupId=t.groupId||0;const n={databaseid:e,groupid:t.groupId},a={cacheKey:r.getDatabaseAccessInformationDataCacheKey(e,t.groupId),component:g.$W,componentId:t.cmId,...s.CoreSites.getReadingStrategyPreSets(t.readingStrategy)};return i.read("mod_data_get_data_access_information",n,a)}))()}getEntries(e,t={}){var r=this;return(0,i.A)((function*(){t=Object.assign({groupId:0,sort:0,order:"DESC",page:0,perPage:g.uZ},t);const i=yield s.CoreSites.getSite(t.siteId),n={databaseid:e,returncontents:!0,page:t.page,perpage:t.perPage,groupid:t.groupId,sort:t.sort,order:t.order},a={cacheKey:r.getEntriesCacheKey(e,t.groupId),updateFrequency:f.CoreCacheUpdateFrequency.SOMETIMES,component:g.$W,componentId:t.cmId,...s.CoreSites.getReadingStrategyPreSets(t.readingStrategy)},o=yield i.read("mod_data_get_entries",n,a),d=o.entries.map((e=>r.formatEntryContents(e)));return Object.assign(o,{entries:d})}))()}getEntriesCacheKey(e,t=0){return this.getEntriesPrefixCacheKey(e)+t}getEntriesPrefixCacheKey(e){return this.getDatabaseDataPrefixCacheKey(e)+":entries:"}getEntry(e,t,r={}){var n=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(r.siteId),a={entryid:t,returncontents:!0},o={cacheKey:n.getEntryCacheKey(e,t),updateFrequency:f.CoreCacheUpdateFrequency.SOMETIMES,component:g.$W,componentId:r.cmId,...s.CoreSites.getReadingStrategyPreSets(r.readingStrategy)},d=yield i.read("mod_data_get_entry",a,o);return Object.assign(d,{entry:n.formatEntryContents(d.entry)})}))()}formatEntryContents(e){return Object.assign(e,{contents:l.R.toObject(e.contents,"fieldid")})}getEntryCacheKey(e,t){return`${this.getDatabaseDataPrefixCacheKey(e)}:entry:${t}`}getFields(e,t={}){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t.siteId),a={databaseid:e},o={cacheKey:r.getFieldsCacheKey(e),updateFrequency:f.CoreCacheUpdateFrequency.RARELY,component:g.$W,componentId:t.cmId,...s.CoreSites.getReadingStrategyPreSets(t.readingStrategy)},d=yield i.read("mod_data_get_fields",a,o);if(d.fields)return d.fields;throw new n.CoreError("No fields were returned.")}))()}getFieldsCacheKey(e){return`${this.getDatabaseDataPrefixCacheKey(e)}:fields`}invalidateContent(e,t,r){var n=this;return(0,i.A)((function*(){r=r||s.CoreSites.getCurrentSiteId();const a=[];a.push(n.getDatabase(t,e).then(function(){var e=(0,i.A)((function*(e){const i=[];i.push(n.invalidateDatabaseData(t,r)),i.push(n.invalidateDatabaseWSData(e.id,r)),i.push(n.invalidateFieldsData(e.id,r)),yield Promise.all(i)}));return function(t){return e.apply(this,arguments)}}())),a.push(n.invalidateFiles(e,r)),yield y.g.allPromises(a)}))()}invalidateDatabaseAccessInformationData(e,t){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t);yield i.invalidateWsCacheForKeyStartingWith(r.getDatabaseAccessInformationDataPrefixCacheKey(e))}))()}invalidateEntriesData(e,t){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t);yield i.invalidateWsCacheForKeyStartingWith(r.getEntriesPrefixCacheKey(e))}))()}invalidateFieldsData(e,t){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t);yield i.invalidateWsCacheForKey(r.getFieldsCacheKey(e))}))()}invalidateFiles(e,t){return(0,i.A)((function*(){yield d.CoreFilepool.invalidateFilesByComponent(t,g.$W,e)}))()}invalidateDatabaseData(e,t){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t);yield i.invalidateWsCacheForKey(r.getDatabaseDataCacheKey(e))}))()}invalidateDatabaseWSData(e,t){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t);yield i.invalidateWsCacheForKeyStartingWith(r.getDatabaseDataPrefixCacheKey(e))}))()}invalidateEntryData(e,t,r){var n=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(r);yield i.invalidateWsCacheForKey(n.getEntryCacheKey(e,t))}))()}logView(e,t){return(0,i.A)((function*(){const r={databaseid:e};yield a.CoreCourseLogHelper.log("mod_data_view_database",r,g.$W,e,t)}))()}searchEntries(e,t={}){var r=this;return(0,i.A)((function*(){const i=yield s.CoreSites.getSite(t.siteId);t.groupId=t.groupId||0,t.sort=t.sort||0,t.order=t.order||"DESC",t.page=t.page||0,t.perPage=t.perPage||g.uZ,t.readingStrategy=t.readingStrategy||3;const n={databaseid:e,groupid:t.groupId,returncontents:!0,page:t.page,perpage:t.perPage},a={component:g.$W,componentId:t.cmId,...s.CoreSites.getReadingStrategyPreSets(t.readingStrategy)};void 0!==t.sort&&(n.sort=t.sort),void 0!==t.order&&(n.order=t.order),void 0!==t.search&&(n.search=t.search),void 0!==t.advSearch&&(n.advsearch=t.advSearch);const o=yield i.read("mod_data_search_entries",n,a),d=o.entries.map((e=>r.formatEntryContents(e)));return Object.assign(o,{entries:d})}))()}}return(e=AddonModDataProvider).ROOT_CACHE_KEY="mmaModData:",e.ɵfac=function AddonModDataProvider_Factory(t){return new(t||e)},e.ɵprov=v.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataProvider})();const S=(0,c.Qd)(E)}}]);