"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[68379],{68379:(e,t,n)=>{n.r(t),n.d(t,{default:()=>H});var o=n(10467),r=n(49882),s=n(52749),i=n(54638),a=n(63540),m=n(2910),c=n(74431),l=n(15324),d=n(79555),C=n(55554),f=n(98870),u=n(75383),g=n(75629),_=n(62152),h=n(24742),I=n(94455),p=n(94339),v=n(89818),b=n(47551),w=n(33014),y=n(3716),D=n(25572),x=n(53794),T=n(82907),N=n(86654),P=n(67636),O=n(66110),L=n(54438),M=n(21182),V=n(60177),R=n(69502),A=n(17388),k=n(16986),G=n(66198),E=n(64422),S=n(28042),$=n(85122),j=n(86198),B=n(58197),U=n(88246),Y=n(43570),F=n(73955),X=n(59528);const _c0=e=>({$a:e});function CoreCommentsViewerPage_Conditional_9_Template(e,t){if(1&e&&(L.j41(0,"p",2),L.nrm(1,"core-format-text",15),L.k0s()),2&e){const e=L.XpG();L.R7$(),L.Y8G("text",e.title)("contextLevel",e.contextLevel)("contextInstanceId",e.instanceId)("courseId",e.courseId)}}function CoreCommentsViewerPage_ion_button_11_ion_icon_2_Template(e,t){1&e&&L.nrm(0,"ion-icon",19)}function CoreCommentsViewerPage_ion_button_11_ion_icon_3_Template(e,t){1&e&&L.nrm(0,"ion-icon",20)}function CoreCommentsViewerPage_ion_button_11_Template(e,t){if(1&e){const e=L.RV6();L.j41(0,"ion-button",16),L.nI1(1,"translate"),L.bIt("click",(function CoreCommentsViewerPage_ion_button_11_Template_ion_button_click_0_listener(){L.eBV(e);const t=L.XpG();return L.Njj(t.toggleDelete())})),L.DNE(2,CoreCommentsViewerPage_ion_button_11_ion_icon_2_Template,1,0,"ion-icon",17)(3,CoreCommentsViewerPage_ion_button_11_ion_icon_3_Template,1,0,"ion-icon",18),L.k0s()}if(2&e){const e=L.XpG();L.Y8G("ariaLabel",L.bMT(1,3,"core.toggledelete")),L.R7$(2),L.Y8G("ngIf",!e.showDelete),L.R7$(),L.Y8G("ngIf",e.showDelete)}}function CoreCommentsViewerPage_core_empty_box_22_Template(e,t){1&e&&(L.nrm(0,"core-empty-box",21),L.nI1(1,"translate")),2&e&&L.Y8G("message",L.bMT(1,1,"core.comments.nocomments"))}function CoreCommentsViewerPage_ng_container_25_p_1_Template(e,t){if(1&e&&(L.j41(0,"p",24),L.EFF(1),L.nI1(2,"coreFormatDate"),L.k0s()),2&e){const e=L.XpG().$implicit;L.R7$(),L.SpI(" ",L.i5U(2,1,1e3*e.timecreated,"strftimedayshort")," ")}}function CoreCommentsViewerPage_ng_container_25_Template(e,t){if(1&e){const e=L.RV6();L.qex(0),L.DNE(1,CoreCommentsViewerPage_ng_container_25_p_1_Template,3,4,"p",22),L.j41(2,"core-message",23),L.bIt("onDeleteMessage",(function CoreCommentsViewerPage_ng_container_25_Template_core_message_onDeleteMessage_2_listener(){const t=L.eBV(e).$implicit,n=L.XpG();return L.Njj(n.deleteComment(t))}))("onUndoDeleteMessage",(function CoreCommentsViewerPage_ng_container_25_Template_core_message_onUndoDeleteMessage_2_listener(){const t=L.eBV(e).$implicit,n=L.XpG();return L.Njj(n.undoDeleteComment(t))})),L.k0s(),L.bVm()}if(2&e){const e=t.$implicit,n=L.XpG();L.R7$(),L.Y8G("ngIf",e.showDate),L.R7$(),L.Y8G("message",e)("text",e.content)("time",1e3*e.timecreated)("user",e)("showDelete",n.showDelete)("contextLevel",n.contextLevel)("instanceId",n.instanceId)("courseId",n.courseId)}}function CoreCommentsViewerPage_ion_badge_26_Template(e,t){1&e&&(L.j41(0,"ion-badge",25),L.nrm(1,"ion-icon",26),L.EFF(2),L.nI1(3,"translate"),L.nI1(4,"lowercase"),L.nI1(5,"translate"),L.k0s()),2&e&&(L.R7$(2),L.SpI(" ",L.i5U(5,5,"core.thereisdatatosync",L.eq3(8,_c0,L.bMT(4,3,L.bMT(3,1,"core.comments.comments"))))," "))}function CoreCommentsViewerPage_Conditional_27_Template(e,t){if(1&e){const e=L.RV6();L.j41(0,"div")(1,"core-message",27),L.bIt("onDeleteMessage",(function CoreCommentsViewerPage_Conditional_27_Template_core_message_onDeleteMessage_1_listener(){L.eBV(e);const t=L.XpG();return L.Njj(t.deleteComment(t.offlineComment))})),L.k0s()()}if(2&e){const e=L.XpG();L.R7$(),L.Y8G("message",e.offlineComment)("text",e.offlineComment.content)("user",e.offlineComment)("showDelete",e.showDelete)("contextLevel",e.contextLevel)("instanceId",e.instanceId)("courseId",e.courseId)}}function CoreCommentsViewerPage_ion_footer_28_Template(e,t){if(1&e){const e=L.RV6();L.j41(0,"ion-footer",28)(1,"ion-toolbar")(2,"core-send-message-form",29),L.nI1(3,"translate"),L.bIt("onSubmit",(function CoreCommentsViewerPage_ion_footer_28_Template_core_send_message_form_onSubmit_2_listener(t){L.eBV(e);const n=L.XpG();return L.Njj(n.addComment(t))})),L.k0s()()()}if(2&e){const e=L.XpG();L.R7$(2),L.Y8G("sendDisabled",e.sending)("message",e.newComment)("placeholder",L.bMT(3,3,"core.comments.addcomment"))}}let H=(()=>{var e;class CoreCommentsViewerPage{constructor(e){this.route=e,this.comments=[],this.commentsLoaded=!1,this.itemId=0,this.area="",this.page=0,this.canLoadMore=!1,this.loadMoreError=!1,this.canAddComments=!1,this.canDeleteComments=!1,this.showDelete=!1,this.hasOffline=!1,this.refreshIcon=c.CoreConstants.ICON_LOADING,this.syncIcon=c.CoreConstants.ICON_LOADING,this.sending=!1,this.newComment="",this.addDeleteCommentsAvailable=!1,this.viewDestroyed=!1,this.scrollBottom=!0,this.currentUserId=s.CoreSites.getCurrentSiteUserId(),this.syncObserver=r.z.on(y.G,(e=>{e.contextLevel===this.contextLevel&&e.instanceId===this.instanceId&&e.componentName===this.componentName&&e.itemId===this.itemId&&e.area===this.area&&(this.showSyncWarnings(e.warnings),this.commentsLoaded=!1,this.refreshIcon=c.CoreConstants.ICON_LOADING,this.syncIcon=c.CoreConstants.ICON_LOADING,this.page=0,this.comments=[],this.fetchComments(!1))}),s.CoreSites.getCurrentSiteId()),this.isOnline=I.WE.isOnline(),this.onlineObserver=I.WE.onChange().subscribe((()=>{d.SK.run((()=>{this.isOnline=I.WE.isOnline()}))})),this.keyboardObserver=r.z.on(r.z.KEYBOARD_CHANGE,(e=>{this.scrollToBottom(e>0)}))}ngOnInit(){var e=this;return(0,o.A)((function*(){try{e.contextLevel=l.CoreNavigator.getRequiredRouteParam("contextLevel"),e.instanceId=l.CoreNavigator.getRequiredRouteNumberParam("instanceId"),e.componentName=l.CoreNavigator.getRequiredRouteParam("componentName"),e.itemId=l.CoreNavigator.getRequiredRouteNumberParam("itemId"),e.area=l.CoreNavigator.getRouteParam("area")||"",e.title=l.CoreNavigator.getRouteParam("title"),e.courseId=l.CoreNavigator.getRouteNumberParam("courseId")}catch(e){return D.CoreAlerts.showError(e),l.CoreNavigator.back(),void 0}e.addDeleteCommentsAvailable=yield i.CoreComments.isAddCommentsAvailable(),e.currentUserId=s.CoreSites.getCurrentSiteUserId(),e.commentsLoaded=!1,yield e.fetchComments(!0)}))()}ngAfterViewInit(){var e=this;return(0,o.A)((function*(){var t;e.scrollElement=yield null===(t=e.content)||void 0===t?void 0:t.getScrollElement()}))()}fetchComments(e,t=!1){var n=this;return(0,o.A)((function*(){if(n.loadMoreError=!1,e&&(yield C.g.ignoreErrors(n.syncComments(t))),!n.title)try{if("system"===n.contextLevel)n.title=yield s.CoreSites.getRequiredCurrentSite().getSiteName();else if("course"===n.contextLevel){const e=yield O.CoreCourses.getCourseByField("id",n.instanceId);n.title=e.fullname}}catch{}n.scrollBottom=T.y.scrollIsBottom(n.scrollElement,5);try{const e=yield i.CoreComments.getComments(n.contextLevel,n.instanceId,n.componentName,n.itemId,n.area,n.page);n.canAddComments=n.addDeleteCommentsAvailable&&!!e.canpost;let t=e.comments.sort(((e,t)=>e.timecreated-t.timecreated));n.canLoadMore=void 0!==e.count?n.comments.length+t.length<e.count:e.comments.length>0&&e.comments.length>=i.CoreCommentsProvider.pageSize,t=yield Promise.all(t.map((e=>n.loadCommentProfile(e)))),n.comments=t.concat(n.comments),n.comments.forEach(((e,t)=>n.calculateCommentData(e,n.comments[t-1]))),yield n.loadOfflineData(),n.calculateCanDelete()}catch(e){n.loadMoreError=!0,e&&n.componentName===P.t?D.CoreAlerts.show({header:d.HT.instant("core.notice"),message:d.HT.instant("core.comments.commentsnotworking")}):D.CoreAlerts.showError(e,{default:`${d.HT.instant("core.error")}: get_comments`})}finally{n.commentsLoaded=!0,n.refreshIcon=c.CoreConstants.ICON_REFRESH,n.syncIcon=c.CoreConstants.ICON_SYNC,n.scrollToBottom(0===n.page)}}))()}calculateCommentData(e,t){var n;e.showDate=this.showDate(e,t),e.showUserData=this.showUserData(e,t),e.showTail=this.showTail(e,t),e.delete=null!==(n=e.delete)&&void 0!==n&&n}loadPrevious(e){var t=this;return(0,o.A)((function*(){t.page++,t.canLoadMore=!1;try{yield t.fetchComments(!0)}finally{e&&e()}}))()}refreshComments(e,t){var n=this;return(0,o.A)((function*(){n.commentsLoaded=!1,n.refreshIcon=c.CoreConstants.ICON_LOADING,n.syncIcon=c.CoreConstants.ICON_LOADING,yield C.g.ignoreErrors(n.invalidateComments()),n.page=0,n.comments=[];try{yield n.fetchComments(!0,e)}finally{null==t||t.complete()}}))()}showSyncWarnings(e){const t=u.Ni.buildMessage(e);t&&D.CoreAlerts.show({message:t})}syncComments(e){var t=this;return(0,o.A)((function*(){try{const e=yield a.CoreCommentsSync.syncComments(t.contextLevel,t.instanceId,t.componentName,t.itemId,t.area);t.showSyncWarnings((null==e?void 0:e.warnings)||[])}catch(t){throw e&&D.CoreAlerts.showError(t,{default:d.HT.instant("core.errorsync")}),new g.CoreError(t)}}))()}addComment(e){var t=this;return(0,o.A)((function*(){const n=yield w.CoreLoadings.show("core.sending",!0);t.sending=!0;try{const n=yield i.CoreComments.addComment(e,t.contextLevel,t.instanceId,t.componentName,t.itemId,t.area);if(n){t.invalidateComments();const e=yield t.loadCommentProfile(n);t.calculateCommentData(e,t.comments[t.comments.length-1]),t.comments=t.comments.concat([e]),r.z.trigger(i.CoreCommentsProvider.COMMENTS_COUNT_CHANGED_EVENT,{contextLevel:t.contextLevel,instanceId:t.instanceId,component:t.componentName,itemId:t.itemId,area:t.area,countChange:1},s.CoreSites.getCurrentSiteId()),t.refreshInBackground()}else!1===n&&(t.newComment=e,yield t.loadOfflineData());t.calculateCanDelete()}catch(e){D.CoreAlerts.showError(e)}finally{t.sending=!1,yield n.dismiss(),t.scrollToBottom(!0)}}))()}deleteComment(e){var t=this;return(0,o.A)((function*(){const n=h.j.userDate(1e3*("lastmodified"in e?e.lastmodified:e.timecreated),"core.strftimerecentfull"),o={contextlevel:t.contextLevel,instanceid:t.instanceId,component:t.componentName,itemid:t.itemId,area:t.area,content:e.content,id:"id"in e?e.id:void 0};try{yield D.CoreAlerts.confirmDelete(d.HT.instant("core.comments.deletecommentbyon",{$a:{user:e.fullname||"",time:n}}))}catch{return}const a=yield w.CoreLoadings.show("core.sending",!0);try{const n=yield i.CoreComments.deleteComment(o);if(t.showDelete=!1,n&&"id"in e){const n=t.comments.findIndex((t=>t.id==e.id));n>=0&&(t.comments.splice(n,1),r.z.trigger(i.CoreCommentsProvider.COMMENTS_COUNT_CHANGED_EVENT,{contextLevel:t.contextLevel,instanceId:t.instanceId,component:t.componentName,itemId:t.itemId,area:t.area,countChange:-1},s.CoreSites.getCurrentSiteId()),t.refreshInBackground())}else yield t.loadOfflineData();t.invalidateComments(),t.calculateCanDelete(),b.CoreToasts.show({message:"core.comments.eventcommentdeleted",translateMessage:!0,duration:b.ToastDuration.LONG})}catch(e){D.CoreAlerts.showError(e,{default:"Delete comment failed."})}finally{a.dismiss()}}))()}calculateCanDelete(){this.canDeleteComments=this.addDeleteCommentsAvailable&&(this.hasOffline||this.comments.some((e=>!!e.delete)))}invalidateComments(){return i.CoreComments.invalidateCommentsData(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area)}loadCommentProfile(e){return(0,o.A)((function*(){if(!e.userid)return e;try{const t=yield f.CoreUser.getProfile(e.userid,void 0,!0);e.profileimageurl=t.profileimageurl,e.fullname=t.fullname}catch{}return e}))()}showUserData(e,t){return!(e.userid==this.currentUserId||t&&t.userid==e.userid&&!e.showDate)}showTail(e,t){return!t||t.userid!=e.userid||!!t.showDate}showDate(e,t){return!t||!(0,p.yf)(1e3*e.timecreated).isSame(1e3*t.timecreated,"day")}loadOfflineData(){var e=this;return(0,o.A)((function*(){const t=[];let n=!1;t.push(_.CoreCommentsOffline.getComment(e.contextLevel,e.instanceId,e.componentName,e.itemId,e.area).then(function(){var t=(0,o.A)((function*(t){e.offlineComment=t,e.offlineComment&&(""==e.newComment&&(e.newComment=e.offlineComment.content),e.offlineComment.userid=e.currentUserId,e.offlineComment.pending=!0)}));return function(e){return t.apply(this,arguments)}}())),t.push(_.CoreCommentsOffline.getDeletedComments(e.contextLevel,e.instanceId,e.componentName,e.itemId,e.area).then((t=>{n=t&&t.length>0,n&&t.forEach((t=>{const n=e.comments.find((e=>e.id==t.commentid));n&&(n.deleted=!!t.deleted)}))}))),yield Promise.all(t),e.hasOffline=!!e.offlineComment||n}))()}undoDeleteComment(e){var t=this;return(0,o.A)((function*(){yield _.CoreCommentsOffline.undoDeleteComment(e.id),e.deleted=!1,t.showDelete=!1}))()}scrollToBottom(e=!1){var t=this;return(0,o.A)((function*(){t.viewDestroyed||(t.scrollBottom||e)&&(yield x.H.nextTicks(5),!t.viewDestroyed&&t.content&&t.content.scrollToBottom(0))}))()}toggleDelete(){this.showDelete=!this.showDelete}refreshInBackground(){var e=this;return(0,o.A)((function*(){yield C.g.ignoreErrors(e.invalidateComments());const t=[];for(let n=0;n<=e.page;n++)t.push(i.CoreComments.getComments(e.contextLevel,e.instanceId,e.componentName,e.itemId,e.area,n));yield Promise.all(t)}))()}ngOnDestroy(){var e;null===(e=this.syncObserver)||void 0===e||e.off(),this.onlineObserver.unsubscribe(),this.viewDestroyed=!0,this.keyboardObserver.off()}}return(e=CoreCommentsViewerPage).ɵfac=function CoreCommentsViewerPage_Factory(t){return new(t||e)(L.rXU(M.nX))},e.ɵcmp=L.VBU({type:e,selectors:[["page-core-comments-viewer"]],viewQuery:function CoreCommentsViewerPage_Query(e,t){if(1&e&&L.GBs(m.W9,5),2&e){let e;L.mGM(e=L.lsd())&&(t.content=e.first)}},standalone:!0,features:[L.aNF],decls:29,vars:34,consts:[["slot","start"],[3,"text"],[1,"subheading"],["slot","end"],["slot","end","fill","clear",3,"ariaLabel","click",4,"ngIf"],[3,"action","hidden","priority","content","iconAction","closeOnClick"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"hideUntil"],["icon","fas-comments",3,"message",4,"ngIf"],["position","top",3,"action","enabled","error"],[1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["class","ion-text-wrap","color","info",4,"ngIf"],["class","footer-adjustable","id","viewer-footer",4,"ngIf"],[3,"text","contextLevel","contextInstanceId","courseId"],["slot","end","fill","clear",3,"click","ariaLabel"],["name","fas-pen","slot","icon-only","aria-hidden","true",4,"ngIf"],["name","fas-check","slot","icon-only","aria-hidden","true",4,"ngIf"],["name","fas-pen","slot","icon-only","aria-hidden","true"],["name","fas-check","slot","icon-only","aria-hidden","true"],["icon","fas-comments",3,"message"],["class","ion-text-center addon-messages-date",4,"ngIf"],[3,"onDeleteMessage","onUndoDeleteMessage","message","text","time","user","showDelete","contextLevel","instanceId","courseId"],[1,"ion-text-center","addon-messages-date"],["color","info",1,"ion-text-wrap"],["name","fas-triangle-exclamation","aria-hidden","true"],[3,"onDeleteMessage","message","text","user","showDelete","contextLevel","instanceId","courseId"],["id","viewer-footer",1,"footer-adjustable"],[3,"onSubmit","sendDisabled","message","placeholder"]],template:function CoreCommentsViewerPage_Template(e,t){1&e&&(L.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),L.nrm(3,"ion-back-button",1),L.nI1(4,"translate"),L.k0s(),L.j41(5,"ion-title")(6,"h1"),L.EFF(7),L.nI1(8,"translate"),L.k0s(),L.DNE(9,CoreCommentsViewerPage_Conditional_9_Template,2,4,"p",2),L.k0s(),L.j41(10,"ion-buttons",3),L.DNE(11,CoreCommentsViewerPage_ion_button_11_Template,4,5,"ion-button",4),L.j41(12,"core-context-menu")(13,"core-context-menu-item",5),L.nI1(14,"translate"),L.bIt("action",(function CoreCommentsViewerPage_Template_core_context_menu_item_action_13_listener(){return t.refreshComments(!1)})),L.k0s(),L.j41(15,"core-context-menu-item",5),L.nI1(16,"translate"),L.bIt("action",(function CoreCommentsViewerPage_Template_core_context_menu_item_action_15_listener(){return t.refreshComments(!0)})),L.k0s()()()()(),L.j41(17,"ion-content")(18,"ion-refresher",6),L.bIt("ionRefresh",(function CoreCommentsViewerPage_Template_ion_refresher_ionRefresh_18_listener(e){return t.refreshComments(!1,e.target)})),L.nrm(19,"ion-refresher-content",7),L.nI1(20,"translate"),L.k0s(),L.j41(21,"core-loading",8),L.DNE(22,CoreCommentsViewerPage_core_empty_box_22_Template,2,3,"core-empty-box",9),L.j41(23,"core-infinite-loading",10),L.bIt("action",(function CoreCommentsViewerPage_Template_core_infinite_loading_action_23_listener(e){return t.loadPrevious(e)})),L.k0s(),L.j41(24,"ion-list",11),L.DNE(25,CoreCommentsViewerPage_ng_container_25_Template,3,9,"ng-container",12)(26,CoreCommentsViewerPage_ion_badge_26_Template,6,10,"ion-badge",13)(27,CoreCommentsViewerPage_Conditional_27_Template,2,7,"div"),L.k0s()()(),L.DNE(28,CoreCommentsViewerPage_ion_footer_28_Template,4,5,"ion-footer",14)),2&e&&(L.R7$(3),L.Y8G("text",L.bMT(4,24,"core.back")),L.R7$(4),L.SpI(" ",L.bMT(8,26,"core.comments.comments")," "),L.R7$(2),L.vxM(9,t.title?9:-1),L.R7$(2),L.Y8G("ngIf",t.canDeleteComments),L.R7$(2),L.Y8G("hidden",!(t.commentsLoaded&&!t.hasOffline))("priority",100)("content",L.bMT(14,28,"core.refresh"))("iconAction",t.refreshIcon)("closeOnClick",!0),L.R7$(2),L.Y8G("hidden",!(t.commentsLoaded&&t.hasOffline&&t.isOnline))("priority",100)("content",L.bMT(16,30,"core.settings.synchronizenow"))("iconAction",t.syncIcon)("closeOnClick",!1),L.R7$(3),L.Y8G("disabled",!t.commentsLoaded),L.R7$(),L.FS9("pullingText",L.bMT(20,32,"core.pulltorefresh")),L.R7$(2),L.Y8G("hideUntil",t.commentsLoaded),L.R7$(),L.Y8G("ngIf",!(null!=t.comments&&t.comments.length||t.offlineComment)),L.R7$(),L.Y8G("enabled",t.canLoadMore)("error",t.loadMoreError),L.R7$(2),L.Y8G("ngForOf",t.comments),L.R7$(),L.Y8G("ngIf",t.hasOffline),L.R7$(),L.vxM(27,t.hasOffline&&t.offlineComment?27:-1),L.R7$(),L.Y8G("ngIf",t.commentsLoaded&&t.canAddComments))},dependencies:[N.n,V.Sq,V.bT,m.In,m.Jm,m.QW,m.W9,m.M0,m.eU,m.iq,m.nf,m.To,m.Ki,m.BC,m.ai,m.el,R.B,A.Q,k.h,G.b,E.R,S.A,$.u,j.t,B.B,U.i,Y.T,V.GH,F.D9,X.f],styles:[".ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0px}ion-content[_ngcontent-%COMP%]{--content-background: var(--background-alternative);--background: var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}ion-content[_ngcontent-%COMP%]   core-empty-box[_ngcontent-%COMP%]{--core-empty-box-icon-color: var(--dark)}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}","ion-badge[_ngcontent-%COMP%]{margin:8px auto}"],data:{animation:[v.d.SLIDE_IN_OUT]}}),CoreCommentsViewerPage})()}}]);