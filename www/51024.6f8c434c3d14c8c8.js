"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[51024],{51024:(e,o,r)=>{r.d(o,{A:()=>N});var s=r(10467),t=r(54438),n=r(2910),i=r(81690),a=r(66110),u=r(44682),l=r(94247),d=r(14001),c=r(8979),C=r(25044),m=r(89752),g=r(49882),p=r(15324),f=r(32867),h=r(83219),v=r(52749),y=r(53794),D=r(86123),R=r(55554),I=r(58364),E=r(25572),b=r(79555),_=r(86654),A=r(60177),S=r(64422),O=r(88246),w=r(73955);function CoreCourseContentsPage_core_course_format_5_Template(e,o){if(1&e&&t.nrm(0,"core-course-format",4),2&e){const e=t.XpG();t.ZvI("core-course-format-",e.course.format,""),t.Y8G("course",e.course)("sections",e.sections)("initialSectionId",e.sectionId)("initialSectionNumber",e.sectionNumber)("initialBlockInstanceId",e.blockInstanceId)("moduleId",e.moduleId)("isGuest",e.isGuest)}}let N=(()=>{var e;class CoreCourseContentsPage{constructor(e){this.changeDetectorRef=e,this.dataLoaded=!1,this.updatingData=!1,this.downloadCourseEnabled=!1,this.displayEnableDownload=!1,this.displayRefresher=!1,this.isDestroyed=!1,this.modulesHaveCompletion=!1}ngOnInit(){var e=this;return(0,s.A)((function*(){try{e.course=p.CoreNavigator.getRequiredRouteParam("course")}catch(e){return E.CoreAlerts.showError(e),p.CoreNavigator.back(),void 0}e.sectionId=p.CoreNavigator.getRouteNumberParam("sectionId"),e.sectionNumber=p.CoreNavigator.getRouteNumberParam("sectionNumber"),e.blockInstanceId=p.CoreNavigator.getRouteNumberParam("blockInstanceId"),e.moduleId=p.CoreNavigator.getRouteNumberParam("moduleId"),e.isGuest=p.CoreNavigator.getRouteBooleanParam("isGuest"),e.debouncedUpdateCachedCompletion=i.j.debounce((()=>{R.g.ignoreErrors(e.modulesHaveCompletion?u.CoreCourse.getSections(e.course.id,!1,!0):u.CoreCourse.getActivitiesCompletionStatus(e.course.id,void 0,void 0,!1,!1,!1))}),3e4),e.initListeners(),yield e.loadData(!1,!0),e.dataLoaded=!0}))()}initListeners(){var e=this;return(0,s.A)((function*(){if(e.completionObserver)return;(yield d.CoreCourseFormatDelegate.shouldRefreshWhenCompletionChanges(e.course))&&(e.completionObserver=g.z.on(g.z.COMPLETION_MODULE_VIEWED,(o=>{o&&o.courseId==e.course.id&&e.showLoadingAndRefresh(!0,!1)})),e.manualCompletionObserver=g.z.on(g.z.MANUAL_COMPLETION_CHANGED,(o=>{e.onCompletionChange(o.completion)})),e.syncObserver=g.z.on(D.CORE_COURSE_AUTO_SYNCED,(o=>{o&&o.courseId==e.course.id&&(e.showLoadingAndRefresh(!1,!1),o.warnings&&o.warnings[0]&&E.CoreAlerts.show({message:o.warnings[0].message}))})))}))()}loadData(e,o){var r=this;return(0,s.A)((function*(){const s=yield R.g.ignoreErrors(l.CoreCourseHelper.getCourse(r.course.id));if(s&&(r.course.id===s.course.id&&"displayname"in r.course&&!("displayname"in s.course)&&(s.course.displayname=r.course.displayname),r.course=s.course),o){var t;const e=yield R.g.ignoreErrors(C.CoreCourseSync.syncCourse(r.course.id,r.course.displayname||r.course.fullname));null!=e&&null!==(t=e.warnings)&&void 0!==t&&t.length&&E.CoreAlerts.show({message:e.warnings[0].message})}try{yield Promise.all([r.loadSections(e),r.loadCourseFormatOptions()])}catch(e){E.CoreAlerts.showError(e,{default:b.HT.instant("core.course.couldnotloadsectioncontent")})}}))()}loadSections(e){var o=this;return(0,s.A)((function*(){const r=yield u.CoreCourse.getSections(o.course.id,!1,!0);let s;e&&(s=u.CoreCourse.getSectionsModules(r),yield c.CoreCourseModulePrefetchDelegate.invalidateModules(s,o.course.id));let t={};var n;if(h.CoreCoursesHelper.isCompletionEnabledInCourse(o.course))if(s||(s=u.CoreCourse.getSectionsModules(r)),void 0!==(null===(n=s[0])||void 0===n?void 0:n.completion))o.modulesHaveCompletion=!0,yield R.g.ignoreErrors(l.CoreCourseHelper.loadOfflineCompletion(o.course.id,r));else{t=(yield R.g.ignoreErrors(u.CoreCourse.getActivitiesCompletionStatus(o.course.id)))||t}const i=yield l.CoreCourseHelper.addHandlerDataForModules(r,o.course.id,t,o.course.fullname,!0);o.sections=i.sections,d.CoreCourseFormatDelegate.canViewAllSections(o.course)&&o.sections.unshift(l.CoreCourseHelper.createAllSectionsSection()),o.displayRefresher=d.CoreCourseFormatDelegate.displayRefresher(o.course,o.sections)}))()}loadCourseFormatOptions(){var e=this;return(0,s.A)((function*(){if(!h.CoreCoursesHelper.isCompletionEnabledInCourse(e.course))return;if("courseformatoptions"in e.course&&e.course.courseformatoptions)return e.formatOptions=I.T.toKeyValueMap(e.course.courseformatoptions,"name","value"),void 0;const o=yield R.g.ignoreErrors(a.CoreCourses.getCourseByField("id",e.course.id));o&&Object.assign(e.course,o),null!=o&&o.courseformatoptions&&(e.formatOptions=I.T.toKeyValueMap(o.courseformatoptions,"name","value"))}))()}doRefresh(e){var o=this;return(0,s.A)((function*(){yield R.g.ignoreErrors(o.invalidateData());try{yield o.loadData(!0,!0)}finally{o.displayRefresher&&o.formatComponent&&(yield R.g.ignoreErrors(o.formatComponent.doRefresh(e))),null==e||e.complete()}}))()}onCompletionChange(e){var o=this;return(0,s.A)((function*(){var r;if(e.courseId!=(null===(r=o.course)||void 0===r?void 0:r.id))return;const s=v.CoreSites.getCurrentSiteId();if(!0===e.valueused)yield R.g.ignoreErrors(o.invalidateData()),yield o.showLoadingAndRefresh(!0,!1);else{var t;if(!o.course||!("progress"in o.course)||"number"!=typeof o.course.progress)return;if(o.sections){const r=100/(u.CoreCourse.getSectionsModules(o.sections).map((e=>e.completion&&e.completion>0?1:e.completion)).reduce(((e,o)=>(e||0)+(o||0)),0)||1);o.course.progress=1===e.state?Math.min(100,o.course.progress+r):Math.max(0,o.course.progress-r)}yield R.g.ignoreErrors(o.invalidateData()),null===(t=o.debouncedUpdateCachedCompletion)||void 0===t||t.call(o)}"progress"in o.course&&null!=o.course.progress&&g.z.trigger(D.CORE_COURSE_PROGRESS_UPDATED_EVENT,{courseId:o.course.id,progress:o.course.progress},s)}))()}invalidateData(){var e=this;return(0,s.A)((function*(){const o=[];o.push(u.CoreCourse.invalidateSections(e.course.id)),o.push(a.CoreCourses.invalidateUserCourses()),o.push(d.CoreCourseFormatDelegate.invalidateData(e.course,e.sections||[])),e.sections&&o.push(c.CoreCourseModulePrefetchDelegate.invalidateCourseUpdates(e.course.id)),yield Promise.all(o)}))()}showLoadingAndRefresh(e=!1,o=!0){var r=this;return(0,s.A)((function*(){var s,t;const n=yield R.g.ignoreErrors(null===(s=r.content)||void 0===s?void 0:s.getScrollElement()),i=null!==(t=null==n?void 0:n.scrollTop)&&void 0!==t?t:-1;r.updatingData=!0,r.changeDetectorRef.detectChanges();try{var a;o&&(yield R.g.ignoreErrors(r.invalidateData())),yield r.loadData(!0,e),yield null===(a=r.formatComponent)||void 0===a?void 0:a.doRefresh(void 0,void 0,!0)}finally{var u;if(r.updatingData=!1,r.changeDetectorRef.detectChanges(),i>0)yield y.H.nextTick(),null===(u=r.content)||void 0===u||u.scrollToPoint(0,i,0)}}))()}refreshContext(){var e=this;return(0,s.A)((function*(){yield e.showLoadingAndRefresh(!0,!0)}))()}ngOnDestroy(){var e,o,r;this.isDestroyed=!0,null===(e=this.completionObserver)||void 0===e||e.off(),null===(o=this.manualCompletionObserver)||void 0===o||o.off(),null===(r=this.syncObserver)||void 0===r||r.off()}ionViewDidEnter(){var e;null===(e=this.formatComponent)||void 0===e||e.ionViewDidEnter()}ionViewDidLeave(){var e;null===(e=this.formatComponent)||void 0===e||e.ionViewDidLeave()}}return(e=CoreCourseContentsPage).ɵfac=function CoreCourseContentsPage_Factory(o){return new(o||e)(t.rXU(t.gRc))},e.ɵcmp=t.VBU({type:e,selectors:[["page-core-course-contents"]],viewQuery:function CoreCourseContentsPage_Query(e,o){if(1&e&&(t.GBs(n.W9,5),t.GBs(m.CoreCourseFormatComponent,5)),2&e){let e;t.mGM(e=t.lsd())&&(o.content=e.first),t.mGM(e=t.lsd())&&(o.formatComponent=e.first)}},standalone:!0,features:[t.Jv_([{provide:f.g,useExisting:(0,t.Rfq)((()=>e))}]),t.aNF],decls:6,vars:6,consts:[["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],["placeholderType","column","placeholderHeight","128px",3,"hideUntil"],[3,"course","sections","initialSectionId","initialSectionNumber","initialBlockInstanceId","moduleId","class","isGuest",4,"ngIf"],[3,"course","sections","initialSectionId","initialSectionNumber","initialBlockInstanceId","moduleId","isGuest"]],template:function CoreCourseContentsPage_Template(e,o){1&e&&(t.j41(0,"ion-content")(1,"ion-refresher",0),t.bIt("ionRefresh",(function CoreCourseContentsPage_Template_ion_refresher_ionRefresh_1_listener(e){return o.doRefresh(e.target)})),t.nrm(2,"ion-refresher-content",1),t.nI1(3,"translate"),t.k0s(),t.j41(4,"core-loading",2),t.DNE(5,CoreCourseContentsPage_core_course_format_5_Template,1,10,"core-course-format",3),t.k0s()()),2&e&&(t.R7$(),t.Y8G("disabled",!o.dataLoaded||o.updatingData||!o.displayRefresher),t.R7$(),t.FS9("pullingText",t.bMT(3,4,"core.pulltorefresh")),t.R7$(2),t.Y8G("hideUntil",o.dataLoaded&&!o.updatingData),t.R7$(),t.Y8G("ngIf",o.dataLoaded&&o.sections))},dependencies:[_.n,A.bT,n.W9,n.To,n.Ki,S.R,O.i,w.D9,m.CoreCourseFormatComponent],encapsulation:2}),CoreCourseContentsPage})()}}]);