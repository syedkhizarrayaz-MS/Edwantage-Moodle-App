"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[9099],{6677:(e,t,r)=>{r.d(t,{C:()=>C});var n=r(10467),i=r(42008),a=r(49446),d=r(37690),o=r(97254),s=r(82308),c=r(94455),l=r(52749),u=r(48966),y=r(49588),f=r(58364),g=r(79555),p=r(49882),h=r(23917),m=r(57934),E=r(57587),D=r(95209),v=r(75383),b=r(55554),A=r(43411),I=r(54438);let S=(()=>{var e;class AddonModDataSyncProvider extends d.L{constructor(){super("AddonModDataSyncProvider"),this.componentTranslatableString="data"}hasDataToSync(e,t){return E.i.hasOfflineData(e,t)}syncAllDatabases(e,t){return this.syncOnSites("all databases",(e=>this.syncAllDatabasesFunc(!!t,e)),e)}syncAllDatabasesFunc(e,t){var r=this;return(0,n.A)((function*(){const i=[];i.push(E.i.getAllEntries(t).then(function(){var i=(0,n.A)((function*(i){let a=i.map((e=>e.dataid));a=a.filter(((e,t)=>a.indexOf(e)==t));const d=a.map(function(){var i=(0,n.A)((function*(n){const i=e?yield r.syncDatabase(n,t):yield r.syncDatabaseIfNeeded(n,t);i&&i.updated&&p.z.trigger(D.a9,{dataId:n,warnings:i.warnings},t)}));return function(e){return i.apply(this,arguments)}}());yield Promise.all(d)}));return function(e){return i.apply(this,arguments)}}())),i.push(r.syncRatings(void 0,e,t)),yield Promise.all(i)}))()}syncDatabaseIfNeeded(e,t){var r=this;return(0,n.A)((function*(){if(yield r.isSyncNeeded(e,t))return r.syncDatabase(e,t)}))()}syncDatabase(e,t){t=t||l.CoreSites.getCurrentSiteId();const r=this.getOngoingSync(e,t);if(r)return r;if(u.CoreSync.isBlocked(D.zc,e,t))throw this.logger.debug(`Cannot sync database '${e}' because it is blocked.`),new i.D(g.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));this.logger.debug(`Try to sync data '${e}' in site ${t}'`);const n=this.performSyncDatabase(e,t);return this.addOngoingSync(e,n,t)}performSyncDatabase(e,t){var r=this;return(0,n.A)((function*(){yield b.g.ignoreErrors(o.CoreCourseLogHelper.syncActivity(D.$W,e,t));const n={warnings:[],updated:!1},i=yield b.g.ignoreErrors(E.i.getDatabaseEntries(e,t),[]);if(!i.length)return yield b.g.ignoreErrors(r.setSyncTime(e,t)),n;if(!c.WE.isOnline())throw new a.CoreNetworkError;const d=i[0].courseid,s=yield h.$.getDatabaseById(d,e,{siteId:t}),l={};i.forEach((e=>{void 0===l[e.entryid]&&(l[e.entryid]=[]),l[e.entryid].push(e)}));const u=f.T.toArray(l).map((e=>r.syncEntry(s,e,n,t)));return yield Promise.all(u),n.updated&&(yield b.g.ignoreErrors(h.$.invalidateContent(s.coursemodule,d,t))),yield b.g.ignoreErrors(r.setSyncTime(e,t)),n}))()}syncEntry(e,t,r,i){var a=this;return(0,n.A)((function*(){const n=yield a.performSyncEntry(e,t,r,i);n.discardError&&a.addOfflineDataDeletedWarning(r.warnings,e.name,n.discardError),p.z.trigger(D.a9,{dataId:e.id,entryId:n.entryId,offlineEntryId:n.offlineId,warnings:r.warnings,deleted:n.deleted},i)}))()}performSyncEntry(e,t,r,i){return(0,n.A)((function*(){let a=t[0].entryid;const d={deleted:!1,entryId:a},o=t.find((e=>e.action==D.Z4.ADD||e.action==D.Z4.EDIT)),s=t.find((e=>e.action==D.Z4.APPROVE||e.action==D.Z4.DISAPPROVE)),c=t.find((e=>e.action==D.Z4.DELETE)),l={cmId:e.coursemodule,readingStrategy:2,siteId:i};let u=0;if(a>0)try{u=(yield h.$.getEntry(e.id,a,l)).entry.timemodified}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;u=-1}else o?(d.offlineId=a,u=0):u=-1;if(u<0||u>=t[0].timemodified)return r.updated=!0,d.discardError=g.HT.instant("addon.mod_data.warningsubmissionmodified"),yield E.i.deleteAllEntryActions(e.id,a,i),d;if(c){try{yield h.$.deleteEntryOnline(a,i),d.deleted=!0}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;d.discardError=y.CoreErrorHelper.getErrorMessageFromError(e)}return r.updated=!0,yield E.i.deleteAllEntryActions(c.dataid,c.entryid,i),d}if(o){try{if(yield Promise.all(o.fields.map(function(){var e=(0,n.A)((function*(e){const t=v.Ni.parseJSON(e.value||"",null);if(t&&(t.online||t.offline)){let r=t.online||[];const n=t.offline?yield m.r.getStoredFiles(o.dataid,a,e.fieldid):[];r=r.concat(n);const d=yield m.r.uploadOrStoreFiles(o.dataid,0,a,e.fieldid,r,!1,i);e.value=JSON.stringify(d)}}));return function(t){return e.apply(this,arguments)}}())),o.action==D.Z4.ADD){const e=yield h.$.addEntryOnline(o.dataid,o.fields,o.groupid,i);a=e.newentryid,d.entryId=a}else yield h.$.editEntryOnline(a,o.fields,i)}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;d.discardError=y.CoreErrorHelper.getErrorMessageFromError(e)}r.updated=!0,yield E.i.deleteEntry(o.dataid,o.entryid,o.action,i)}if(s){try{yield h.$.approveEntryOnline(a,s.action==D.Z4.APPROVE,i)}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;d.discardError=y.CoreErrorHelper.getErrorMessageFromError(e)}r.updated=!0,yield E.i.deleteEntry(s.dataid,s.entryid,s.action,i)}return d}))()}syncRatings(e,t,r){var i=this;return(0,n.A)((function*(){r=r||l.CoreSites.getCurrentSiteId();const n=yield s.CoreRatingSync.syncRatings("mod_data","entry","module",e,0,t,r);let a=!1;const d=[],o=n.map((e=>h.$.getDatabase(e.itemSet.courseId,e.itemSet.instanceId,{siteId:r}).then((t=>{const n=[];return e.updated.length&&(a=!0,e.updated.forEach((e=>{n.push(h.$.invalidateEntryData(t.id,e,r))}))),e.warnings.length&&e.warnings.forEach((e=>{i.addOfflineDataDeletedWarning(d,t.name,e)})),b.g.allPromises(n)}))));return yield Promise.all(o),{updated:a,warnings:d}}))()}}return(e=AddonModDataSyncProvider).ɵfac=function AddonModDataSyncProvider_Factory(t){return new(t||e)},e.ɵprov=I.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataSyncProvider})();const C=(0,g.Qd)(S)},9099:(e,t,r)=>{r.r(t),r.d(t,{AddonModDataPrefetchHandler:()=>v,AddonModDataPrefetchHandlerLazyService:()=>D});var n=r(10467),i=r(54638),a=r(44682),d=r(66110),o=r(88793),s=r(15221),c=r(52749),l=r(24742),u=r(58364),y=r(79555),f=r(23917),g=r(6677),p=r(96132),h=r(55554),m=r(95209),E=r(54438);let D=(()=>{var e;class AddonModDataPrefetchHandlerLazyService extends p.b{getAllUniqueEntries(e,t,r={}){return(0,n.A)((function*(){const n=t.map((t=>f.$.fetchAllEntries(e,{groupId:t.id,...r}))),i=yield Promise.all(n),a={};return i.forEach((e=>{e.forEach((e=>{a[e.id]=e}))})),u.T.toArray(a)}))()}getDatabaseInfoHelper(e,t,r,i={}){var a=this;return(0,n.A)((function*(){let n=[],d=[],o=[];i.cmId=i.cmId||e.id,i.siteId=i.siteId||c.CoreSites.getCurrentSiteId();const l=yield f.$.getDatabase(t,e.id,i);try{o=a.getIntroFilesFromInstance(e,l);const t=yield s.CoreGroups.getActivityGroupInfo(e.id,!1,void 0,i.siteId);return t.groups&&0!=t.groups.length||(t.groups=[{id:0,name:""}]),n=t.groups||[],d=yield a.getAllUniqueEntries(l.id,n,i),o=o.concat(a.getEntriesFiles(d)),{database:l,groups:n,entries:d,files:o}}catch(e){if(r)return{database:l,groups:n,entries:d,files:o};throw e}}))()}getEntriesFiles(e){let t=[];return e.forEach((e=>{u.T.toArray(e.contents).forEach((e=>{t=t.concat(e.files)}))})),t}getFiles(e,t){var r=this;return(0,n.A)((function*(){return r.getDatabaseInfoHelper(e,t,!0).then((e=>e.files))}))()}getIntroFiles(e,t){var r=this;return(0,n.A)((function*(){const n=yield h.g.ignoreErrors(f.$.getDatabase(t,e.id));return r.getIntroFilesFromInstance(e,n)}))()}invalidateContent(e,t){return(0,n.A)((function*(){yield f.$.invalidateContent(e,t)}))()}invalidateModule(e,t){return(0,n.A)((function*(){const r=[];r.push(f.$.invalidateDatabaseData(t)),r.push(f.$.invalidateDatabaseAccessInformationData(e.instance)),yield Promise.all(r)}))()}isDownloadable(e,t){return(0,n.A)((function*(){const r=yield f.$.getDatabase(t,e.id,{readingStrategy:1});if(!(yield f.$.getDatabaseAccessInformation(r.id,{cmId:e.id})).timeavailable){const e=l.j.timestamp();if(r.timeavailablefrom&&e<r.timeavailablefrom)return!1;if(r.timeavailableto&&e>r.timeavailableto)return!1}return!0}))()}prefetch(e,t){return this.prefetchPackage(e,t,(r=>this.prefetchDatabase(e,t,r)))}prefetchDatabase(e,t,r){var s=this;return(0,n.A)((function*(){const n={cmId:e.id,readingStrategy:2,siteId:r},c=yield s.getDatabaseInfoHelper(e,t,!1,n),l=c.database,u=i.CoreComments.areCommentsEnabledInSite(),y=[];y.push(f.$.getFields(l.id,n)),y.push(o.CoreFilepool.addFilesToQueue(r,c.files,s.component,e.id)),c.groups.forEach((e=>{y.push(f.$.getDatabaseAccessInformation(l.id,{groupId:e.id,...n}))})),c.entries.forEach((e=>{y.push(f.$.getEntry(l.id,e.id,n)),u&&l.comments&&y.push(i.CoreComments.getComments("module",l.coursemodule,"mod_data",e.id,"database_entry",0,r))})),y.push(a.CoreCourse.getModuleBasicInfoByInstance(l.id,m.t7,{siteId:r})),y.push(h.g.ignoreErrors(d.CoreCourses.getCourseByField("id",t,r))),yield Promise.all(y)}))()}sync(e,t,r){return(0,n.A)((function*(){const t=[g.C.syncDatabase(e.instance,r),g.C.syncRatings(e.id,!0,r)];return(yield Promise.all(t)).reduce(((e,t)=>({updated:e.updated||t.updated,warnings:(e.warnings||[]).concat(t.warnings||[])})),{updated:!1,warnings:[]})}))()}}return(e=AddonModDataPrefetchHandlerLazyService).ɵfac=(()=>{let t;return function AddonModDataPrefetchHandlerLazyService_Factory(r){return(t||(t=E.xGo(e)))(r||e)}})(),e.ɵprov=E.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataPrefetchHandlerLazyService})();const v=(0,y.Qd)(D)}}]);