"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[34735],{34735:(e,i,t)=>{t.r(i),t.d(i,{AddonModWikiPrefetchHandler:()=>h,AddonModWikiPrefetchHandlerLazyService:()=>w});var r=t(10467),n=t(44682),d=t(88793),o=t(15221),s=t(11361),c=t(52749),u=t(55554),a=t(79555),l=t(67981),g=t(22357),k=t(90784),y=t(51069),p=t(54438);let w=(()=>{var e;class AddonModWikiPrefetchHandlerLazyService extends k.X{getAllPages(e,i,t={}){return(0,r.A)((function*(){t.siteId=t.siteId||c.CoreSites.getCurrentSiteId();try{const r=yield l.N.getWiki(i,e.id,t);return yield l.N.getWikiPageList(r,t)}catch{return[]}}))()}getDownloadSize(e,i,t){var n=this;return(0,r.A)((function*(){const r=[],d=c.CoreSites.getCurrentSiteId();r.push(n.getFiles(e,i,t,d).then((e=>s.CorePluginFileDelegate.getFilesDownloadSize(e)))),r.push(n.getAllPages(e,i,{readingStrategy:2,siteId:d}).then((e=>{let i=0;return e.forEach((e=>{e.contentsize&&(i+=e.contentsize)})),{size:i,total:!0}})));const o=yield Promise.all(r);return{size:o[0].size+o[1].size,total:o[0].total&&o[1].total}}))()}getFiles(e,i,t,n){var d=this;return(0,r.A)((function*(){n=n||c.CoreSites.getCurrentSiteId();try{const t=yield l.N.getWiki(i,e.id,{siteId:n}),r=d.getIntroFilesFromInstance(e,t),o=yield l.N.getWikiFileList(t,{siteId:n});return r.concat(o)}catch{return[]}}))()}invalidateContent(e,i){return l.N.invalidateContent(e,i)}prefetch(e,i,t){var n=this;return(0,r.A)((function*(){const r=c.CoreSites.getCurrentSiteId(),o=yield u.g.ignoreErrors(d.CoreFilepool.getPackageData(r,n.component,e.id)),s=(null==o?void 0:o.downloadTime)||0;return n.prefetchPackage(e,i,(r=>n.prefetchWiki(e,i,!!t,s,r)),r)}))()}prefetchWiki(e,i,t,s,u){var a=this;return(0,r.A)((function*(){const r=c.CoreSites.getCurrentSiteUserId(),g={readingStrategy:2,siteId:u},k={cmId:e.id,...g},p=yield a.getAllPages(e,i,g),w=[];p.forEach((e=>{e.timemodified>s&&w.push(l.N.getPageContents(e.id,k))})),w.push(o.CoreGroups.getActivityGroupInfo(e.id,!1,r,u)),w.push(l.N.getWiki(i,e.id,{siteId:u}).then((e=>n.CoreCourse.getModuleBasicInfoByInstance(e.id,y.Pe,{siteId:u})))),w.push(a.getFiles(e,i,t,u).then((i=>d.CoreFilepool.addFilesToQueue(u,i,a.component,e.id)))),yield Promise.all(w)}))()}sync(e,i,t){return g.i.syncWiki(e.instance,e.course,e.id,t)}}return(e=AddonModWikiPrefetchHandlerLazyService).ɵfac=(()=>{let i;return function AddonModWikiPrefetchHandlerLazyService_Factory(t){return(i||(i=p.xGo(e)))(t||e)}})(),e.ɵprov=p.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWikiPrefetchHandlerLazyService})();const h=(0,a.Qd)(w)},22357:(e,i,t)=>{t.d(i,{i:()=>v});var r=t(10467),n=t(42008),d=t(49446),o=t(97254),s=t(94455),c=t(15221),u=t(52749),a=t(48966),l=t(43411),g=t(79555),k=t(49882),y=t(67981),p=t(59379),w=t(51069),h=t(55554),S=t(54438);let f=(()=>{var e;class AddonModWikiSyncProvider extends n.l{constructor(){super("AddonModWikiSyncProvider"),this.componentTranslatableString="wiki"}getSubwikiBlockId(e,i,t,r){return(e=p.W.convertToPositiveNumber(e))&&e>0?String(e):`${i=p.W.convertToPositiveNumber(i)}:${t=p.W.convertToPositiveNumber(t)}:${r=p.W.convertToPositiveNumber(r)}`}syncAllWikis(e,i){return this.syncOnSites("all wikis",(e=>this.syncAllWikisFunc(!!i,e)),e)}syncAllWikisFunc(e,i){var t=this;return(0,r.A)((function*(){const n=yield p.W.getAllNewPages(i),d={};yield Promise.all(n.map(function(){var n=(0,r.A)((function*(r){const n=t.getSubwikiBlockId(r.subwikiid,r.wikiid,r.userid,r.groupid);if(d[n])return;d[n]=!0;const o=e?yield t.syncSubwiki(r.subwikiid,r.wikiid,r.userid,r.groupid,i):yield t.syncSubwikiIfNeeded(r.subwikiid,r.wikiid,r.userid,r.groupid,i);null!=o&&o.updated&&k.z.trigger(w.mb,{siteId:i,subwikiId:r.subwikiid,wikiId:r.wikiid,userId:r.userid,groupId:r.groupid,created:o.created,discarded:o.discarded,warnings:o.warnings})}));return function(e){return n.apply(this,arguments)}}()))}))()}syncSubwikiIfNeeded(e,i,t,n,d){var o=this;return(0,r.A)((function*(){const r=o.getSubwikiBlockId(e,i,t,n);if(yield o.isSyncNeeded(r,d))return o.syncSubwiki(e,i,t,n,d)}))()}syncSubwiki(e,i,t,r,d){d=d||u.CoreSites.getCurrentSiteId();const o=this.getSubwikiBlockId(e,i,t,r),s=this.getOngoingSync(o,d);if(s)return s;if(a.CoreSync.isBlocked(w.Rv,o,d))throw this.logger.debug(`Cannot sync subwiki ${o} because it is blocked.`),new n.D(g.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));return this.logger.debug(`Try to sync subwiki ${o}`),this.addOngoingSync(o,this.performSyncSubwiki(e,i,t,r,d),d)}performSyncSubwiki(e,i,t,n,o){var c=this;return(0,r.A)((function*(){const u={warnings:[],updated:!1,created:[],discarded:[]},a=c.getSubwikiBlockId(e,i,t,n),g=yield h.g.ignoreErrors(p.W.getSubwikiNewPages(e,i,t,n,o),[]);if(!g||!g.length)return yield h.g.ignoreErrors(c.setSyncTime(a,o)),u;if(!s.WE.isOnline())throw new d.CoreNetworkError;return yield Promise.all(g.map(function(){var d=(0,r.A)((function*(r){try{const d=yield y.N.newPageOnline(r.title,r.cachedcontent,{subwikiId:e,wikiId:i,userId:t,groupId:n,siteId:o});u.updated=!0,u.created.push({pageId:d,title:r.title}),yield p.W.deleteNewPage(r.title,e,i,t,n,o)}catch(d){if(!l.CoreWSError.isWebServiceError(d))throw d;yield p.W.deleteNewPage(r.title,e,i,t,n,o),u.updated=!0;const s=c.getOfflineDataDeletedWarning(r.title,d);u.discarded.push({title:r.title,warning:s}),u.warnings.push(s)}}));return function(e){return d.apply(this,arguments)}}())),yield h.g.ignoreErrors(c.setSyncTime(a,o)),u}))()}syncWiki(e,i,t,n){var d=this;return(0,r.A)((function*(){n=n||u.CoreSites.getCurrentSiteId(),yield h.g.ignoreErrors(o.CoreCourseLogHelper.syncActivity(w.dD,e,n));const s=yield y.N.getSubwikis(e,{cmId:t,siteId:n}),a={warnings:[],updated:!1,subwikis:{},siteId:n};if(yield Promise.all(s.map(function(){var e=(0,r.A)((function*(e){const i=yield d.syncSubwiki(e.id,e.wikiid,e.userid,e.groupid,n);i&&i.updated&&(a.warnings=a.warnings.concat(i.warnings),a.updated=!0,a.subwikis[e.id]={created:i.created,discarded:i.discarded})}));return function(i){return e.apply(this,arguments)}}())),a.updated){const r=[];e&&(r.push(y.N.invalidateSubwikis(e)),r.push(y.N.invalidateSubwikiPages(e)),r.push(y.N.invalidateSubwikiFiles(e))),i&&r.push(y.N.invalidateWikiData(i)),t&&(r.push(c.CoreGroups.invalidateActivityAllowedGroups(t)),r.push(c.CoreGroups.invalidateActivityGroupMode(t))),yield h.g.ignoreErrors(Promise.all(r))}return a}))()}}return(e=AddonModWikiSyncProvider).ɵfac=function AddonModWikiSyncProvider_Factory(i){return new(i||e)},e.ɵprov=S.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWikiSyncProvider})();const v=(0,g.Qd)(f)}}]);