"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[93922],{93922:(e,t,s)=>{s.r(t),s.d(t,{default:()=>E});var o=s(10467),n=s(2401),i=s(83696),r=s(29492),a=s(15324),d=s(99522),l=s(98870),c=s(15221),u=s(55554),g=s(79555),h=s(35853);class AddonModChatSessionsSource extends d.F{constructor(e,t,s){super(),this.showAll=!1,this.groupId=0,this.COURSE_ID=e,this.CHAT_ID=t,this.CM_ID=s}invalidateCache(){var e=this;return(0,o.A)((function*(){yield u.g.allPromisesIgnoringErrors([c.CoreGroups.invalidateActivityGroupInfo(e.CM_ID),h.V.invalidateSessions(e.CHAT_ID,e.groupId,e.showAll)])}))()}loadPageItems(){var e=this;return(0,o.A)((function*(){e.groupInfo=yield c.CoreGroups.getActivityGroupInfo(e.CM_ID,!1),e.groupId=c.CoreGroups.validateGroupId(e.groupId,e.groupInfo);const t=yield h.V.getSessions(e.CHAT_ID,e.groupId,e.showAll,{cmId:e.CM_ID}),s=[],o=t.map((t=>(t.duration=t.sessionend-t.sessionstart,t.sessionusers.forEach((t=>{s.push(e.loadUserFullname(t))})),t.allsessionusers=t.sessionusers,t.sessionusers.length>4&&(t.sessionusers=t.allsessionusers.slice(0,3)),t)));return yield Promise.all(s),{items:o}}))()}getItemPath(e){return`${e.sessionstart}/${e.sessionend}`}getItemQueryParams(){return{chatId:this.CHAT_ID,groupId:this.groupId}}loadUserFullname(e){var t=this;return(0,o.A)((function*(){if(!e.userfullname)try{const s=yield l.CoreUser.getProfile(e.userid,t.COURSE_ID,!0);e.userfullname=s.fullname}catch{e.userfullname=`${g.HT.instant("core.deleteduser")} ${e.userid}`}}))()}}var _=s(22693),p=s(24742),m=s(33014),C=s(25572),S=s(86654),f=s(54438),y=s(60177),I=s(89417),v=s(2910),A=s(16986),M=s(97818),R=s(64422),w=s(88246),P=s(43570),b=s(73955),T=s(49780),F=s(59528);function AddonModChatSessionsPage_ion_card_20_p_6_Template(e,t){if(1&e&&(f.j41(0,"p"),f.EFF(1),f.nI1(2,"coreDuration"),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.JRh(f.bMT(2,1,e.duration))}}function AddonModChatSessionsPage_ion_card_20_ion_item_8_span_3_Template(e,t){if(1&e&&(f.j41(0,"span"),f.EFF(1),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.SpI("(",e.messagecount,")")}}function AddonModChatSessionsPage_ion_card_20_ion_item_8_Template(e,t){if(1&e&&(f.j41(0,"ion-item")(1,"ion-label"),f.EFF(2),f.DNE(3,AddonModChatSessionsPage_ion_card_20_ion_item_8_span_3_Template,2,1,"span",12),f.k0s()()),2&e){const e=t.$implicit;f.R7$(2),f.SpI(" ",e.userfullname," "),f.R7$(),f.Y8G("ngIf",e.messagecount)}}function AddonModChatSessionsPage_ion_card_20_ion_button_9_Template(e,t){if(1&e){const e=f.RV6();f.j41(0,"ion-button",15),f.bIt("click",(function AddonModChatSessionsPage_ion_card_20_ion_button_9_Template_ion_button_click_0_listener(t){f.eBV(e);const s=f.XpG().$implicit,o=f.XpG();return f.Njj(o.showMoreUsers(s,t))})),f.EFF(1),f.nI1(2,"translate"),f.k0s()}2&e&&(f.R7$(),f.SpI(" ",f.bMT(2,1,"core.showmore")," "))}function AddonModChatSessionsPage_ion_card_20_Template(e,t){if(1&e){const e=f.RV6();f.j41(0,"ion-card",10),f.bIt("click",(function AddonModChatSessionsPage_ion_card_20_Template_ion_card_click_0_listener(){const t=f.eBV(e).$implicit,s=f.XpG();return f.Njj(s.sessions.select(t))})),f.j41(1,"ion-item",6)(2,"ion-label")(3,"p",11),f.EFF(4),f.nI1(5,"coreFormatDate"),f.k0s(),f.DNE(6,AddonModChatSessionsPage_ion_card_20_p_6_Template,3,3,"p",12),f.k0s()(),f.j41(7,"ion-card-content"),f.DNE(8,AddonModChatSessionsPage_ion_card_20_ion_item_8_Template,4,2,"ion-item",13),f.k0s(),f.DNE(9,AddonModChatSessionsPage_ion_card_20_ion_button_9_Template,3,3,"ion-button",14),f.k0s()}if(2&e){const e=t.$implicit,s=f.XpG();f.AVh("addon-mod-chat-session-show-more",e.sessionusers.length<e.allsessionusers.length),f.BMQ("aria-current",s.sessions.getItemAriaCurrent(e)),f.R7$(4),f.JRh(f.bMT(5,7,1e3*e.sessionstart)),f.R7$(2),f.Y8G("ngIf",e.duration),f.R7$(2),f.Y8G("ngForOf",e.sessionusers),f.R7$(),f.Y8G("ngIf",e.sessionusers.length<e.allsessionusers.length)}}function AddonModChatSessionsPage_core_empty_box_21_Template(e,t){1&e&&(f.nrm(0,"core-empty-box",16),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.mod_chat.nosessionsfound"))}let E=(()=>{var e;class AddonModChatSessionsPage{constructor(){var e=this;this.logView=p.j.once((0,o.A)((function*(){const t=e.sessions.getSource();yield u.g.ignoreErrors(h.V.logViewSessions(e.sessions.getSource().CM_ID)),_.OF.logEvent({type:_.qr.VIEW_ITEM_LIST,ws:"mod_chat_view_sessions",name:g.HT.instant("addon.mod_chat.chatreport"),data:{chatid:t.CHAT_ID,category:"chat"},url:`/mod/chat/report.php?id=${t.CM_ID}`})})))}ngOnInit(){try{this.courseId=a.CoreNavigator.getRequiredRouteNumberParam("courseId");const e=a.CoreNavigator.getRequiredRouteNumberParam("chatId"),t=a.CoreNavigator.getRequiredRouteNumberParam("cmId"),s=i.u.getOrCreateSource(AddonModChatSessionsSource,[this.courseId,e,t]);this.sessions=new n.R(s,AddonModChatSessionsPage)}catch(e){return C.CoreAlerts.showError(e),a.CoreNavigator.back(),void 0}}get groupId(){return this.sessions.getSource().groupId}set groupId(e){this.sessions.getSource().groupId=e}get showAll(){return this.sessions.getSource().showAll}set showAll(e){this.sessions.getSource().showAll=e}get groupInfo(){return this.sessions.getSource().groupInfo}ngAfterViewInit(){var e=this;return(0,o.A)((function*(){yield e.fetchSessions(),e.sessions.start(e.splitView)}))()}fetchSessions(){var e=this;return(0,o.A)((function*(){try{yield e.sessions.load(),e.logView()}catch(e){C.CoreAlerts.showError(e,{default:g.HT.instant("core.errorloadingcontent")})}}))()}reloadSessions(){var e=this;return(0,o.A)((function*(){const t=yield m.CoreLoadings.show();try{yield e.sessions.reload()}catch(e){C.CoreAlerts.showError(e,{default:g.HT.instant("core.errorloadingcontent")})}finally{t.dismiss()}}))()}refreshSessions(e){var t=this;return(0,o.A)((function*(){try{t.sessions.getSource().setDirty(!0),yield t.sessions.getSource().invalidateCache(),yield t.fetchSessions()}finally{e.complete()}}))()}showMoreUsers(e,t){e.allsessionusers&&(e.sessionusers=e.allsessionusers),t.stopPropagation()}ngOnDestroy(){this.sessions.destroy()}}return(e=AddonModChatSessionsPage).ɵfac=function AddonModChatSessionsPage_Factory(t){return new(t||e)},e.ɵcmp=f.VBU({type:e,selectors:[["page-addon-mod-chat-sessions"]],viewQuery:function AddonModChatSessionsPage_Query(e,t){if(1&e&&f.GBs(r.M,5),2&e){let e;f.mGM(e=f.lsd())&&(t.splitView=e.first)}},standalone:!0,features:[f.aNF],decls:22,vars:20,consts:[["slot","start"],[3,"text"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"hideUntil"],[3,"selectedChange","groupInfo","selected","courseId"],[1,"ion-text-wrap"],[3,"ngModelChange","ionChange","ngModel"],["button","",3,"addon-mod-chat-session-show-more","click",4,"ngFor","ngForOf"],["icon","far-comments",3,"message",4,"ngIf"],["button","",3,"click"],[1,"item-heading"],[4,"ngIf"],[4,"ngFor","ngForOf"],["fill","clear","expand","block",3,"click",4,"ngIf"],["fill","clear","expand","block",3,"click"],["icon","far-comments",3,"message"]],template:function AddonModChatSessionsPage_Template(e,t){1&e&&(f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),f.nrm(3,"ion-back-button",1),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.EFF(7),f.nI1(8,"translate"),f.k0s()()()(),f.j41(9,"ion-content")(10,"core-split-view")(11,"ion-refresher",2),f.bIt("ionRefresh",(function AddonModChatSessionsPage_Template_ion_refresher_ionRefresh_11_listener(e){return t.refreshSessions(e.target)})),f.nrm(12,"ion-refresher-content",3),f.nI1(13,"translate"),f.k0s(),f.j41(14,"core-loading",4)(15,"core-group-selector",5),f.mxI("selectedChange",(function AddonModChatSessionsPage_Template_core_group_selector_selectedChange_15_listener(e){return f.DH7(t.groupId,e)||(t.groupId=e),e})),f.bIt("selectedChange",(function AddonModChatSessionsPage_Template_core_group_selector_selectedChange_15_listener(){return t.reloadSessions()})),f.k0s(),f.j41(16,"ion-item",6)(17,"ion-toggle",7),f.mxI("ngModelChange",(function AddonModChatSessionsPage_Template_ion_toggle_ngModelChange_17_listener(e){return f.DH7(t.showAll,e)||(t.showAll=e),e})),f.bIt("ionChange",(function AddonModChatSessionsPage_Template_ion_toggle_ionChange_17_listener(){return t.reloadSessions()})),f.EFF(18),f.nI1(19,"translate"),f.k0s()(),f.DNE(20,AddonModChatSessionsPage_ion_card_20_Template,10,9,"ion-card",8)(21,AddonModChatSessionsPage_core_empty_box_21_Template,2,3,"core-empty-box",9),f.k0s()()()),2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,12,"core.back")),f.R7$(4),f.JRh(f.bMT(8,14,"addon.mod_chat.chatreport")),f.R7$(4),f.Y8G("disabled",!t.sessions.loaded),f.R7$(),f.FS9("pullingText",f.bMT(13,16,"core.pulltorefresh")),f.R7$(2),f.Y8G("hideUntil",t.sessions.loaded),f.R7$(),f.Y8G("groupInfo",t.groupInfo),f.R50("selected",t.groupId),f.Y8G("courseId",t.courseId),f.R7$(2),f.R50("ngModel",t.showAll),f.R7$(),f.SpI(" ",f.bMT(19,18,"addon.mod_chat.showincompletesessions")," "),f.R7$(2),f.Y8G("ngForOf",t.sessions.items),f.R7$(),f.Y8G("ngIf",t.sessions.empty))},dependencies:[S.n,y.Sq,y.bT,I.BC,I.vS,v.Jm,v.QW,v.b_,v.I9,v.W9,v.eU,v.uz,v.he,v.To,v.Ki,v.BC,v.BY,v.ai,v.hB,v.el,A.h,M.F,R.R,r.M,w.i,P.T,b.D9,T.S,F.f],encapsulation:2}),AddonModChatSessionsPage})()},35853:(e,t,s)=>{s.d(t,{V:()=>h});var o=s(10467),n=s(97254),i=s(98870),r=s(52749),a=s(79555),d=s(22535),l=s(74431),c=s(95384),u=s(54438);let g=(()=>{var e;class AddonModChatProvider{getChat(e,t,s={}){var n=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(s.siteId),i={courseids:[e]},a={cacheKey:n.getChatsCacheKey(e),updateFrequency:l.CoreCacheUpdateFrequency.RARELY,component:d.vz,...r.CoreSites.getReadingStrategyPreSets(s.readingStrategy)},u=yield o.read("mod_chat_get_chats_by_courses",i,a);return c.CoreCourseModuleHelper.getActivityByCmId(u.chats,t)}))()}loginUser(e,t){return(0,o.A)((function*(){const s=yield r.CoreSites.getSite(t),o={chatid:e};return(yield s.write("mod_chat_login_user",o)).chatsid}))()}logView(e,t){return(0,o.A)((function*(){const s={chatid:e};yield n.CoreCourseLogHelper.log("mod_chat_view_chat",s,d.vz,e,t)}))()}logViewSessions(e,t){return(0,o.A)((function*(){const s={cmid:e};t&&(s.start=t.start,s.end=t.end),yield n.CoreCourseLogHelper.log("mod_chat_view_sessions",s,d.vz,e)}))()}sendMessage(e,t,s,n){return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(n),i={chatsid:e,messagetext:t,beepid:String(s)};return(yield o.write("mod_chat_send_chat_message",i)).messageid}))()}getLatestMessages(e,t,s){return(0,o.A)((function*(){return(yield r.CoreSites.getSite(s)).write("mod_chat_get_chat_latest_messages",{chatsid:e,chatlasttime:t})}))()}getMessagesUserData(e,t,s){return(0,o.A)((function*(){const n=e;return yield Promise.all(n.map(function(){var e=(0,o.A)((function*(e){try{const o=yield i.CoreUser.getProfile(e.userid,t,!0,s);e.userfullname=o.fullname,e.userprofileimageurl=o.profileimageurl}catch{e.userfullname=`${a.HT.instant("core.deleteduser")} ${e.userid}`}}));return function(t){return e.apply(this,arguments)}}())),n}))()}getChatUsers(e,t={}){return(0,o.A)((function*(){t.readingStrategy=t.readingStrategy||3;const s=yield r.CoreSites.getSite(t.siteId),o={chatsid:e},n={component:d.vz,componentId:t.cmId,...r.CoreSites.getReadingStrategyPreSets(t.readingStrategy)};return s.read("mod_chat_get_chat_users",o,n)}))()}getSessions(e,t=0,s=!1,n={}){var i=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(n.siteId),a={chatid:e,groupid:t,showall:s},c={cacheKey:i.getSessionsCacheKey(e,t,s),updateFrequency:l.CoreCacheUpdateFrequency.SOMETIMES,component:d.vz,componentId:n.cmId,...r.CoreSites.getReadingStrategyPreSets(n.readingStrategy)};return(yield o.read("mod_chat_get_sessions",a,c)).sessions}))()}getSessionMessages(e,t,s,n=0,i={}){var a=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(i.siteId),c={chatid:e,sessionstart:t,sessionend:s,groupid:n},u={cacheKey:a.getSessionMessagesCacheKey(e,t,n),updateFrequency:l.CoreCacheUpdateFrequency.RARELY,component:d.vz,componentId:i.cmId,...r.CoreSites.getReadingStrategyPreSets(i.readingStrategy)};return(yield o.read("mod_chat_get_session_messages",c,u)).messages}))()}invalidateChats(e,t){var s=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(t);yield o.invalidateWsCacheForKey(s.getChatsCacheKey(e))}))()}invalidateSessions(e,t=0,s=!1,n){var i=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(n);yield o.invalidateWsCacheForKey(i.getSessionsCacheKey(e,t,s))}))()}invalidateAllSessions(e,t){var s=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(t);yield o.invalidateWsCacheForKeyStartingWith(s.getSessionsCacheKeyPrefix(e))}))()}invalidateSessionMessages(e,t,s=0,n){var i=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(n);yield o.invalidateWsCacheForKey(i.getSessionMessagesCacheKey(e,t,s))}))()}invalidateAllSessionMessages(e,t){var s=this;return(0,o.A)((function*(){const o=yield r.CoreSites.getSite(t);yield o.invalidateWsCacheForKeyStartingWith(s.getSessionMessagesCacheKeyPrefix(e))}))()}getChatsCacheKey(e){return`${AddonModChatProvider.ROOT_CACHE_KEY}chats:${e}`}getSessionsCacheKey(e,t,s){return this.getSessionsCacheKeyPrefix(e)+t+":"+(s?1:0)}getSessionsCacheKeyPrefix(e){return`${AddonModChatProvider.ROOT_CACHE_KEY}sessions:${e}:`}getSessionMessagesCacheKey(e,t,s){return this.getSessionMessagesCacheKeyPrefix(e)+t+":"+s}getSessionMessagesCacheKeyPrefix(e){return`${AddonModChatProvider.ROOT_CACHE_KEY}sessionsMessages:${e}:`}}return(e=AddonModChatProvider).ROOT_CACHE_KEY="AddonModChat:",e.ɵfac=function AddonModChatProvider_Factory(t){return new(t||e)},e.ɵprov=u.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModChatProvider})();const h=(0,a.Qd)(g)},2401:(e,t,s)=>{s.d(t,{R:()=>CoreListItemsManager});var o=s(10467),n=s(21182),i=s(15324),r=s(93417),a=s(81690),d=s(95990),l=s(82907),c=s(24742),u=s(55554);class CoreListItemsManager extends d.u{constructor(e,t){super(e);const s=a.j.debounce((()=>this.scrollToCurrentElement()),300);this.pageRouteLocator=t,this.addListener({onSelectedItemUpdated:s}),this.finishSuccessfulFetch=c.j.once((()=>u.g.ignoreErrors(this.logActivity())))}get items(){return this.getSource().getItems()||[]}get loaded(){return null!==this.itemsMap}get completed(){return this.getSource().isCompleted()}get empty(){const e=this.getSource().getItems();return null===e||0===e.length}start(e){var t=this;return(0,o.A)((function*(){e&&t.watchSplitViewOutlet(e),t.updateSelectedItem()}))()}destroy(){var e;super.destroy(),null===(e=this.splitViewOutletSubscription)||void 0===e||e.unsubscribe()}watchSplitViewOutlet(e){var t;this.splitView=e,this.splitViewOutletSubscription=e.outletRouteObservable.subscribe((e=>this.updateSelectedItem(this.getPageRouteFromSplitViewOutlet(e)))),this.updateSelectedItem(null!==(t=this.getPageRouteFromSplitViewOutlet(e.outletRoute))&&void 0!==t?t:null)}isSelected(e){return this.selectedItem===e}getItemAriaCurrent(e){return this.isSelected(e)?"page":"false"}select(e){var t=this;return(0,o.A)((function*(){if(!e)return yield t.navigateToIndex({reset:t.resetNavigation()}),void 0;yield t.navigateToItem(e,{reset:t.resetNavigation()})}))()}reset(){this.getSource().reset()}reload(){var e=this;return(0,o.A)((function*(){yield e.getSource().reload(),e.finishSuccessfulFetch()}))()}load(){var e=this;return(0,o.A)((function*(){yield e.getSource().load(),e.finishSuccessfulFetch()}))()}logActivity(){return(0,o.A)((function*(){}))()}resetNavigation(){var e;return!!r.CoreScreen.isTablet&&!(!this.splitView||null!==(e=this.splitView)&&void 0!==e&&e.isNested)}updateSelectedItem(e=null){super.updateSelectedItem(e);this.select(r.CoreScreen.isTablet&&null===this.selectedItem&&this.splitView&&!this.splitView.isNested?this.getDefaultItem():this.selectedItem)}scrollToCurrentElement(){var e=this;return(0,o.A)((function*(){var t,s,o;if(r.CoreScreen.isMobile)return;const n=(null!==(t=null===(s=e.splitView)||void 0===s?void 0:s.nativeElement)&&void 0!==t?t:document).querySelector('[aria-current="page"]');if(!n)return;l.y.isElementInViewport(n,1,null===(o=e.splitView)||void 0===o?void 0:o.nativeElement)||n.scrollIntoView({behavior:"smooth"})}))()}getDefaultItem(){return this.items[0]||null}getCurrentPageRoute(){return this.pageRouteLocator instanceof n.nX?i.CoreNavigator.isRouteActive(this.pageRouteLocator)?this.pageRouteLocator:null:i.CoreNavigator.getCurrentRoute({pageComponent:this.pageRouteLocator})}getSelectedItemPathFromRoute(e){const t=[];for(;e.firstChild;)t.push(...i.CoreNavigator.getRouteUrl(e=e.firstChild));return t.map((e=>e.path)).join("/").replace(/\/+/,"/").trim()||null}getPageRouteFromSplitViewOutlet(e){const t=this.buildRouteMatcher();for(;e&&!t(e);)e=e.parent;return e}buildRouteMatcher(){if(this.pageRouteLocator instanceof n.nX){const e=i.CoreNavigator.getRouteFullPath(this.pageRouteLocator);return t=>i.CoreNavigator.getRouteFullPath(t)===e}return e=>e.component===this.pageRouteLocator}}}}]);