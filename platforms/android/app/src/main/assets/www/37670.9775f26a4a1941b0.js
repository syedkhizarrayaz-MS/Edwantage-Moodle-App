"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[37670],{37670:(e,t,o)=>{o.r(t),o.d(t,{default:()=>_});var r=o(10467),n=o(15324),i=o(49882),a=o(1717),d=o(8214),c=o(86654),s=o(94455),m=o(79555),l=o(75629),u=o(53794),f=o(7476),g=o(25572),p=o(54438),h=o(60177),I=o(2910),A=o(64422),v=o(58197),y=o(88246),S=o(73955);function AddonModScormOnlinePlayerPage_core_format_text_7_Template(e,t){if(1&e&&p.nrm(0,"core-format-text",7),2&e){const e=p.XpG();p.Y8G("text",e.scorm.name)("contextInstanceId",e.cmId)("courseId",e.courseId)}}function AddonModScormOnlinePlayerPage_core_iframe_11_Template(e,t){if(1&e){const e=p.RV6();p.j41(0,"core-iframe",8),p.bIt("loaded",(function AddonModScormOnlinePlayerPage_core_iframe_11_Template_core_iframe_loaded_0_listener(){p.eBV(e);const t=p.XpG();return p.Njj(t.iframeLoaded())})),p.k0s()}if(2&e){const e=p.XpG();p.Y8G("src",e.src)("iframeWidth",e.scormWidth)("iframeHeight",e.scormHeight)("showFullscreenOnToolbar",!0)("autoFullscreenOnRotate",e.enableFullScreenOnRotate)}}function AddonModScormOnlinePlayerPage_p_12_Template(e,t){if(1&e&&(p.j41(0,"p"),p.EFF(1),p.nI1(2,"translate"),p.k0s()),2&e){const e=p.XpG();p.R7$(),p.JRh(p.bMT(2,1,e.errorMessage))}}let _=(()=>{var e;class AddonModScormOnlinePlayerPage{constructor(){this.loaded=!1,this.enableFullScreenOnRotate=!1,this.newAttempt=!1,this.attempt=0,this.isDestroyed=!1;let e=s.WE.isOnline();this.onlineObserver=s.WE.onChange().subscribe((()=>{m.SK.run((()=>{const t=e;if(e=s.WE.isOnline(),!e&&t)return g.CoreAlerts.showError(new l.CoreError(m.HT.instant("core.course.changesofflinemaybelost"),{title:m.HT.instant("core.youreoffline")})),void 0}))}))}ngOnInit(){var e=this;return(0,r.A)((function*(){try{e.cmId=n.CoreNavigator.getRequiredRouteNumberParam("cmId"),e.courseId=n.CoreNavigator.getRequiredRouteNumberParam("courseId"),e.mode=n.CoreNavigator.getRouteParam("mode")||"normal",e.moduleUrl=n.CoreNavigator.getRouteParam("moduleUrl")||"",e.newAttempt=!!n.CoreNavigator.getRouteBooleanParam("newAttempt"),e.organizationId=n.CoreNavigator.getRouteParam("organizationId"),e.initialScoId=n.CoreNavigator.getRouteNumberParam("scoId")}catch(e){return g.CoreAlerts.showError(e),n.CoreNavigator.back(),void 0}try{if(yield e.fetchData(),!e.src)return n.CoreNavigator.back(),void 0}finally{e.loaded=!0}}))()}initialize(){var e=this;return(0,r.A)((function*(){e.scorm=yield a.v.getScorm(e.courseId,e.cmId,{moduleUrl:e.moduleUrl,readingStrategy:1}),!e.scorm.popup||!e.scorm.width||e.scorm.width<=100||(e.scormWidth=e.scorm.width,e.scorm.height&&e.scorm.height>100&&(e.scormHeight=e.scorm.height))}))()}determineAttemptAndMode(e,t){var o=this;return(0,r.A)((function*(){const r=yield d.V.determineAttemptToContinue(o.scorm,e);let n=!1;o.attempt=r.num,o.attempt>0&&(n=yield a.v.isAttemptIncomplete(o.scorm.id,o.attempt,{cmId:o.cmId}));const i=a.v.determineAttemptAndMode(o.scorm,o.mode,o.attempt,o.newAttempt,n,t.cansavetrack);i.attempt>o.attempt&&(yield a.v.getScormUserData(o.scorm.id,i.attempt,{cmId:o.cmId,readingStrategy:2})),o.mode=i.mode,o.newAttempt=i.newAttempt,o.attempt=i.attempt}))()}fetchData(){var e=this;return(0,r.A)((function*(){yield e.initialize();try{const[t,o]=yield Promise.all([a.v.getAttemptCount(e.scorm.id,{cmId:e.cmId}),a.v.getAccessInformation(e.scorm.id,{cmId:e.cmId})]);yield e.determineAttemptAndMode(t,o);const r=yield e.getScoToLoad();if(!r)return e.errorMessage="addon.mod_scorm.errornovalidsco",void 0;e.src=yield a.v.getScoSrcForOnlinePlayer(e.scorm,r,{mode:e.mode,organization:e.organizationId,newAttempt:e.newAttempt})}catch(e){g.CoreAlerts.showError(e,{default:m.HT.instant("addon.mod_scorm.errorgetscorm")})}}))()}getScoToLoad(){var e=this;return(0,r.A)((function*(){const t=yield a.v.isAttemptIncomplete(e.scorm.id,e.attempt,{cmId:e.cmId}),o=yield d.V.getToc(e.scorm.id,e.attempt,t,{organization:e.organizationId,cmId:e.cmId});let r;return e.newAttempt&&(e.initialScoId=e.scorm.launch),e.initialScoId&&e.initialScoId>0&&(r=d.V.getScoFromToc(o,e.initialScoId)),r||(yield d.V.getFirstSco(e.scorm.id,e.attempt,{toc:o,organization:e.organizationId,mode:e.mode,cmId:e.cmId}))}))()}ngOnDestroy(){this.isDestroyed=!0,this.onlineObserver.unsubscribe(),this.src="",i.z.trigger(i.z.ACTIVITY_DATA_SENT,{module:"scorm"})}iframeLoaded(){var e=this;return(0,r.A)((function*(){var t;yield u.H.wait(1e3),e.isDestroyed||(null===(t=e.iframe)||void 0===t||t.toggleFullscreen(!0),e.enableFullScreenOnRotate=!0)}))()}}return(e=AddonModScormOnlinePlayerPage).ɵfac=function AddonModScormOnlinePlayerPage_Factory(t){return new(t||e)},e.ɵcmp=p.VBU({type:e,selectors:[["page-addon-mod-scorm-online-player"]],viewQuery:function AddonModScormOnlinePlayerPage_Query(e,t){if(1&e&&p.GBs(f.l,5),2&e){let e;p.mGM(e=p.lsd())&&(t.iframe=e.first)}},standalone:!0,features:[p.aNF],decls:13,vars:7,consts:[["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId",4,"ngIf"],["slot","end"],[3,"hideUntil"],["id","scorm_object",3,"src","iframeWidth","iframeHeight","showFullscreenOnToolbar","autoFullscreenOnRotate","loaded",4,"ngIf"],[4,"ngIf"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["id","scorm_object",3,"loaded","src","iframeWidth","iframeHeight","showFullscreenOnToolbar","autoFullscreenOnRotate"]],template:function AddonModScormOnlinePlayerPage_Template(e,t){1&e&&(p.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),p.nrm(3,"ion-back-button",1),p.nI1(4,"translate"),p.k0s(),p.j41(5,"ion-title")(6,"h1"),p.DNE(7,AddonModScormOnlinePlayerPage_core_format_text_7_Template,1,3,"core-format-text",2),p.k0s()(),p.nrm(8,"ion-buttons",3),p.k0s()(),p.j41(9,"ion-content")(10,"core-loading",4),p.DNE(11,AddonModScormOnlinePlayerPage_core_iframe_11_Template,1,5,"core-iframe",5)(12,AddonModScormOnlinePlayerPage_p_12_Template,3,3,"p",6),p.k0s()()),2&e&&(p.R7$(3),p.Y8G("text",p.bMT(4,5,"core.back")),p.R7$(4),p.Y8G("ngIf",t.scorm),p.R7$(3),p.Y8G("hideUntil",t.loaded),p.R7$(),p.Y8G("ngIf",t.loaded),p.R7$(),p.Y8G("ngIf",!t.src&&t.errorMessage))},dependencies:[c.n,h.bT,I.QW,I.W9,I.eU,I.BC,I.ai,I.el,f.l,A.R,v.B,y.i,S.D9],encapsulation:2}),AddonModScormOnlinePlayerPage})()},8214:(e,t,o)=>{o.d(t,{V:()=>p});var r=o(10467),n=o(75629),i=o(52749),a=o(81690),d=o(79555),c=o(1717),s=o(85387),m=o(55554),l=o(25572),u=o(54438);const f=["status","score_raw","total_time","session_time","student_id","student_name","credit","mode","entry"];let g=(()=>{var e;class AddonModScormHelperProvider{confirmDownload(e,t){return(0,r.A)((function*(){if(!(yield c.v.shouldDownloadMainFile(e,t)))return;let o=e.packagesize;return o||(o=yield c.v.calculateScormSize(e),e.packagesize=o),l.CoreAlerts.confirmDownloadSize({size:o,total:!0})}))()}convertAttemptToOffline(e,t,o){return(0,r.A)((function*(){o=o||i.CoreSites.getCurrentSiteId();const r=yield m.g.ignoreErrors(c.v.getScormUserData(e.id,t,{cmId:e.coursemodule,siteId:o}));if(!r)throw new n.CoreError(d.HT.instant("addon.mod_scorm.errorcreateofflineattempt"));const l=yield m.g.ignoreErrors(s.o.getScormUserData(e.id,t,void 0,o)),u=a.j.clone(r);for(const e in u){const t=u[e];if(f.forEach((e=>{delete t.userdata[e]})),l&&l[t.scoid]&&l[t.scoid].userdata){const e={};for(const o in t.userdata)l[t.scoid].userdata[o]||(e[o]=t.userdata[o]);t.userdata=e}}yield s.o.createNewAttempt(e,t,u,r,o)}))()}createOfflineAttempt(e,t,o,a){var c=this;return(0,r.A)((function*(){a=a||i.CoreSites.getCurrentSiteId();const r=yield m.g.ignoreErrors(c.searchOnlineAttemptUserData(e.id,o,{cmId:e.coursemodule,siteId:a}));if(!r)throw new n.CoreError(d.HT.instant("addon.mod_scorm.errorcreateofflineattempt"));for(const e in r){const t=r[e],o={};for(const e in t.userdata)-1==e.indexOf(".")&&-1==f.indexOf(e)&&(o[e]=t.userdata[e]);t.userdata=o}return s.o.createNewAttempt(e,t,r,void 0,a)}))()}determineAttemptToContinue(e,t,o){var n=this;return(0,r.A)((function*(){let r;if(t.online.length&&(r=Math.max.apply(Math,t.online)),!r)return n.getLastBeforeMax(e,t);const i=t.offline.indexOf(r)>-1;return(yield c.v.isAttemptIncomplete(e.id,r,{offline:i,cmId:e.coursemodule,siteId:o}))?{num:r,offline:i}:n.getLastBeforeMax(e,t)}))()}getFirstSco(e,t,o={}){return(0,r.A)((function*(){const r="normal"===(o.mode||"normal");let n=o.toc;n&&n.length||(n=yield c.v.getScosWithData(e,t,o));return n.find((e=>e.isvisible&&e.launch&&e.prereq&&(!r||c.v.isStatusIncomplete(e.status))))||n[0]}))()}getLastBeforeMax(e,t){return e.maxattempt&&t.lastAttempt.num>e.maxattempt?{num:e.maxattempt,offline:t.offline.indexOf(e.maxattempt)>-1}:{num:t.lastAttempt.num,offline:t.lastAttempt.offline}}getNextScoFromToc(e,t){for(let o=e.findIndex((e=>e.id==t))+1;o<e.length;o++)if(e[o].isvisible&&e[o].prereq&&e[o].launch)return e[o]}getPreviousScoFromToc(e,t){for(let o=e.findIndex((e=>e.id==t))-1;o>=0;o--)if(e[o].isvisible&&e[o].prereq&&e[o].launch)return e[o]}getScoFromToc(e,t){return e.find((e=>e.id==t))}getToc(e,t,o,n={}){return(0,r.A)((function*(){const r=yield c.v.getOrganizationToc(e,t,n),i=c.v.formatTocToArray(r);return i.forEach((e=>{e.icon=c.v.getScoStatusIcon(e,o)})),i}))()}searchOnlineAttemptUserData(e,t,o={}){var n=this;return(0,r.A)((function*(){o.siteId=o.siteId||i.CoreSites.getCurrentSiteId();try{return yield c.v.getScormUserData(e,t,o)}catch(r){if(t<=0)throw r;try{return yield n.searchOnlineAttemptUserData(e,t-1,o)}catch{throw r}}}))()}}return(e=AddonModScormHelperProvider).ɵfac=function AddonModScormHelperProvider_Factory(t){return new(t||e)},e.ɵprov=u.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModScormHelperProvider})();const p=(0,d.Qd)(g)}}]);