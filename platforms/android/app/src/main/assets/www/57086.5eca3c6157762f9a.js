"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[57086],{57086:(e,t,o)=>{o.r(t),o.d(t,{default:()=>H});var n=o(10467),i=o(2910),r=o(58529),a=o(69319),d=o(15324),s=o(52749),c=o(48966),u=o(55554),l=o(79555),m=o(49882),_=o(84412),g=o(6787),p=o(64766),f=o(24813);class AddonModQuizAutoSave{constructor(e,t){this.formName=e,this.buttonSelector=t,this.CHECK_CHANGES_INTERVAL=5e3,this.popoverShown=!1,this.logger=g.CoreLogger.getInstance("AddonModQuizAutoSave"),this.errorObservable=new _.t(!1)}cancelAutoSave(){clearTimeout(this.autoSaveTimeout),this.autoSaveTimeout=void 0}checkChanges(e,t,o,n){if(this.autoSaveTimeout)return;const i=this.getAnswers();if(!this.previousAnswers)return this.previousAnswers=i,void 0;let r=!0;for(const e in i)if(this.previousAnswers[e]!=i[e]){r=!1;break}r||this.setAutoSaveTimer(e,t,o,n),this.previousAnswers=i}getAnswers(){return a.CoreQuestionHelper.getAnswersFromForm(document.forms[this.formName])}hideAutoSaveError(){var e;this.errorObservable.next(!1),null===(e=this.popover)||void 0===e||e.dismiss()}onError(){return this.errorObservable}setAutoSaveTimer(e,t,o,i){var r=this;!e.autosaveperiod||this.autoSaveTimeout||p.AddonModQuiz.isAttemptTimeNearlyOver(e,t)||(this.autoSaveTimeout=window.setTimeout((0,n.A)((function*(){const n=r.getAnswers();r.cancelAutoSave(),r.previousAnswers=n;try{yield p.AddonModQuiz.saveAttempt(e,t,n,o,i),r.hideAutoSaveError()}catch(n){r.logger.warn("Error auto-saving data.",n),r.errorObservable.getValue()||(r.errorObservable.next(!0),r.showAutoSaveError()),r.setAutoSaveTimer(e,t,o,i)}})),1e3*e.autosaveperiod))}showAutoSaveError(e){var t=this;return(0,n.A)((function*(){if(t.popoverShown)return;const n=e||{target:document.querySelector(t.buttonSelector),stopPropagation:()=>{},preventDefault:()=>{}};t.popoverShown=!0;const{AddonModQuizConnectionErrorComponent:i}=yield o.e(80245).then(o.bind(o,80245));t.popover=yield f.CorePopovers.openWithoutResult({component:i,event:n}),t.popoverShown=!1}))()}startCheckChangesProcess(e,t,o,n){!this.checkChangesInterval&&e.autosaveperiod&&(this.previousAnswers=void 0,this.loadPreviousAnswersTimeout=window.setTimeout((()=>{this.checkChanges(e,t,o,n)}),2500),this.checkChangesInterval=window.setInterval((()=>{this.checkChanges(e,t,o,n)}),this.CHECK_CHANGES_INTERVAL))}stopCheckChangesProcess(){clearTimeout(this.loadPreviousAnswersTimeout),clearInterval(this.checkChangesInterval),this.loadPreviousAnswersTimeout=void 0,this.checkChangesInterval=void 0}}var h=o(93918),A=o(74149),P=o(63153),y=o(82907),v=o(24742),z=o(62393),b=o(43411),q=o(22693),M=o(20860),I=o(53794),T=o(93589),w=o(33014),S=o(25572),C=o(65377),Q=o(86654),k=o(54438),R=o(60177),x=o(89417),E=o(64422),G=o(34198),O=o(86198),$=o(58197),N=o(23007),j=o(66731),F=o(88246),D=o(43570),Y=o(73955);const V=["quizForm"],_c1=e=>({$a:e});function AddonModQuizPlayerPage_core_format_text_7_Template(e,t){if(1&e&&k.nrm(0,"core-format-text",17),2&e){const e=k.XpG();k.Y8G("text",e.quiz.name)("contextInstanceId",e.quiz.coursemodule)("courseId",e.courseId)}}function AddonModQuizPlayerPage_ion_button_12_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-button",18),k.nI1(1,"translate"),k.bIt("click",(function AddonModQuizPlayerPage_ion_button_12_Template_ion_button_click_0_listener(){k.eBV(e);const t=k.XpG();return k.Njj(t.openNavigation())})),k.nrm(2,"ion-icon",19),k.k0s()}2&e&&k.Y8G("ariaLabel",k.bMT(1,1,"addon.mod_quiz.opentoc"))}function AddonModQuizPlayerPage_core_timer_13_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"core-timer",20),k.nI1(1,"translate"),k.bIt("finished",(function AddonModQuizPlayerPage_core_timer_13_Template_core_timer_finished_0_listener(){k.eBV(e);const t=k.XpG();return k.Njj(t.timeUp())})),k.k0s()}if(2&e){const e=k.XpG();k.Y8G("endTime",e.endTime)("timerText",k.bMT(1,4,"addon.mod_quiz.timeleft"))("hidable",!0)("hidden",!e.loaded)}}function AddonModQuizPlayerPage_ion_button_16_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-button",21),k.bIt("click",(function AddonModQuizPlayerPage_ion_button_16_Template_ion_button_click_0_listener(){k.eBV(e);const t=k.XpG();return k.Njj(t.start())})),k.EFF(1),k.nI1(2,"translate"),k.k0s()}2&e&&(k.R7$(),k.SpI(" ",k.bMT(2,1,"addon.mod_quiz.startattempt")," "))}function AddonModQuizPlayerPage_form_17_ng_container_2_Template(e,t){if(1&e){const e=k.RV6();k.qex(0),k.j41(1,"addon-mod-quiz-question-card",24)(2,"core-question",25),k.bIt("onAbort",(function AddonModQuizPlayerPage_form_17_ng_container_2_Template_core_question_onAbort_2_listener(){k.eBV(e);const t=k.XpG(2);return k.Njj(t.abortQuiz())}))("buttonClicked",(function AddonModQuizPlayerPage_form_17_ng_container_2_Template_core_question_buttonClicked_2_listener(t){k.eBV(e);const o=k.XpG(2);return k.Njj(o.behaviourButtonClicked(t))})),k.k0s()(),k.bVm()}if(2&e){const e=t.$implicit,o=k.XpG(2);k.R7$(),k.Y8G("question",e),k.R7$(),k.Y8G("question",e)("component",o.component)("componentId",o.cmId)("attemptId",o.attempt.id)("usageId",o.attempt.uniqueid)("offlineEnabled",o.offline)("contextInstanceId",o.cmId)("courseId",o.courseId)("preferredBehaviour",o.quiz.preferredbehaviour)("review",!1)}}function AddonModQuizPlayerPage_form_17_Template(e,t){if(1&e&&(k.j41(0,"form",22,0),k.DNE(2,AddonModQuizPlayerPage_form_17_ng_container_2_Template,3,11,"ng-container",23),k.k0s()),2&e){const e=k.XpG();k.R7$(2),k.Y8G("ngForOf",e.questions)}}function AddonModQuizPlayerPage_ion_row_18_ion_col_1_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-col")(1,"ion-button",27),k.bIt("click",(function AddonModQuizPlayerPage_ion_row_18_ion_col_1_Template_ion_button_click_1_listener(){k.eBV(e);const t=k.XpG(2);return k.Njj(t.changePage(t.previousPage))})),k.nrm(2,"ion-icon",28),k.EFF(3),k.nI1(4,"translate"),k.k0s()()}2&e&&(k.R7$(3),k.SpI(" ",k.bMT(4,1,"core.previous")," "))}function AddonModQuizPlayerPage_ion_row_18_ion_col_2_ion_button_1_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-button",30),k.bIt("click",(function AddonModQuizPlayerPage_ion_row_18_ion_col_2_ion_button_1_Template_ion_button_click_0_listener(){k.eBV(e);const t=k.XpG(3);return k.Njj(t.changePage(t.nextPage))})),k.EFF(1),k.nI1(2,"translate"),k.nrm(3,"ion-icon",31),k.k0s()}2&e&&(k.R7$(),k.SpI(" ",k.bMT(2,1,"core.next")," "))}function AddonModQuizPlayerPage_ion_row_18_ion_col_2_ion_button_2_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-button",30),k.bIt("click",(function AddonModQuizPlayerPage_ion_row_18_ion_col_2_ion_button_2_Template_ion_button_click_0_listener(){k.eBV(e);const t=k.XpG(3);return k.Njj(t.changePage(t.nextPage))})),k.EFF(1),k.nI1(2,"translate"),k.k0s()}2&e&&(k.R7$(),k.SpI(" ",k.bMT(2,1,"core.submit")," "))}function AddonModQuizPlayerPage_ion_row_18_ion_col_2_Template(e,t){if(1&e&&(k.j41(0,"ion-col"),k.DNE(1,AddonModQuizPlayerPage_ion_row_18_ion_col_2_ion_button_1_Template,4,3,"ion-button",29)(2,AddonModQuizPlayerPage_ion_row_18_ion_col_2_ion_button_2_Template,3,3,"ion-button",29),k.k0s()),2&e){const e=k.XpG(2);k.R7$(),k.Y8G("ngIf",e.nextPage>0),k.R7$(),k.Y8G("ngIf",-1===e.nextPage)}}function AddonModQuizPlayerPage_ion_row_18_Template(e,t){if(1&e&&(k.j41(0,"ion-row",26),k.DNE(1,AddonModQuizPlayerPage_ion_row_18_ion_col_1_Template,5,3,"ion-col",15)(2,AddonModQuizPlayerPage_ion_row_18_ion_col_2_Template,3,2,"ion-col",15),k.k0s()),2&e){const e=k.XpG();k.R7$(),k.Y8G("ngIf",e.previousPage>=0),k.R7$(),k.Y8G("ngIf",e.nextPage>=-1)}}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_7_Template(e,t){1&e&&k.nrm(0,"ion-icon",45)}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_8_Template(e,t){if(1&e&&k.nrm(0,"ion-icon",46),2&e){const e=k.XpG(4);k.Y8G("name",e.correctIcon)}}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_9_Template(e,t){if(1&e&&k.nrm(0,"ion-icon",47),2&e){const e=k.XpG(4);k.Y8G("name",e.partialCorrectIcon)}}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_10_Template(e,t){if(1&e&&k.nrm(0,"ion-icon",48),2&e){const e=k.XpG(4);k.Y8G("name",e.incorrectIcon)}}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_11_Template(e,t){1&e&&k.nrm(0,"ion-icon",49)}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-item",38),k.bIt("click",(function AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_Template_ion_item_click_0_listener(){k.eBV(e);const t=k.XpG().$implicit,o=k.XpG(2);return k.Njj(!o.isSequential&&o.canReturn&&o.changePage(t.page,!1,t.slot))})),k.j41(1,"ion-label",33)(2,"p",39),k.EFF(3),k.nI1(4,"translate"),k.k0s(),k.j41(5,"p"),k.EFF(6),k.k0s()(),k.DNE(7,AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_7_Template,1,0,"ion-icon",40)(8,AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_8_Template,1,1,"ion-icon",41)(9,AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_9_Template,1,1,"ion-icon",42)(10,AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_10_Template,1,1,"ion-icon",43)(11,AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_ion_icon_11_Template,1,0,"ion-icon",44),k.k0s()}if(2&e){const e=k.XpG().$implicit,t=k.XpG(2);k.HbH("ion-text-wrap "+e.stateClass),k.Y8G("detail",!t.isSequential&&t.canReturn)("button",!t.isSequential&&t.canReturn),k.R7$(3),k.SpI(" ",k.i5U(4,11,"core.question.questionno",k.eq3(14,_c1,e.questionnumber))," "),k.R7$(3),k.JRh(e.status),k.R7$(),k.Y8G("ngIf","requiresgrading"===e.stateclass),k.R7$(),k.Y8G("ngIf","correct"===e.stateclass),k.R7$(),k.Y8G("ngIf","partiallycorrect"===e.stateclass),k.R7$(),k.Y8G("ngIf","incorrect"===e.stateclass||"notanswered"===e.stateclass),k.R7$(),k.Y8G("ngIf","invalidanswer"===e.stateclass)}}function AddonModQuizPlayerPage_ion_card_19_ng_container_5_Template(e,t){if(1&e&&(k.qex(0),k.DNE(1,AddonModQuizPlayerPage_ion_card_19_ng_container_5_ion_item_1_Template,12,16,"ion-item",37),k.bVm()),2&e){const e=t.$implicit;k.R7$(),k.Y8G("ngIf","description"!==e.type&&e.questionnumber)}}function AddonModQuizPlayerPage_ion_card_19_ion_item_6_Template(e,t){if(1&e&&(k.j41(0,"ion-item",50),k.nrm(1,"ion-icon",51),k.j41(2,"ion-label"),k.EFF(3),k.k0s()()),2&e){const e=k.XpG(2);k.R7$(3),k.JRh(e.dueDateWarning)}}function AddonModQuizPlayerPage_ion_card_19_core_timer_7_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"core-timer",52),k.nI1(1,"translate"),k.bIt("finished",(function AddonModQuizPlayerPage_ion_card_19_core_timer_7_Template_core_timer_finished_0_listener(){k.eBV(e);const t=k.XpG(2);return k.Njj(t.timeUp())})),k.k0s()}if(2&e){const e=k.XpG(2);k.Y8G("endTime",e.endTime)("timerText",k.bMT(1,2,"addon.mod_quiz.timeleft"))}}function AddonModQuizPlayerPage_ion_card_19_ion_item_8_p_5_Template(e,t){if(1&e&&(k.j41(0,"p"),k.EFF(1),k.k0s()),2&e){const e=t.$implicit;k.R7$(),k.JRh(e)}}function AddonModQuizPlayerPage_ion_card_19_ion_item_8_Template(e,t){if(1&e&&(k.j41(0,"ion-item",33)(1,"ion-label")(2,"p",39),k.EFF(3),k.nI1(4,"translate"),k.k0s(),k.DNE(5,AddonModQuizPlayerPage_ion_card_19_ion_item_8_p_5_Template,2,1,"p",23),k.k0s()()),2&e){const e=k.XpG(2);k.R7$(3),k.JRh(k.bMT(4,2,"addon.mod_quiz.cannotsubmitquizdueto")),k.R7$(2),k.Y8G("ngForOf",e.preventSubmitMessages)}}function AddonModQuizPlayerPage_ion_card_19_Template(e,t){if(1&e&&(k.j41(0,"ion-card",32)(1,"ion-card-header",33)(2,"ion-card-title"),k.EFF(3),k.nI1(4,"translate"),k.k0s()(),k.DNE(5,AddonModQuizPlayerPage_ion_card_19_ng_container_5_Template,2,1,"ng-container",23)(6,AddonModQuizPlayerPage_ion_card_19_ion_item_6_Template,4,1,"ion-item",34)(7,AddonModQuizPlayerPage_ion_card_19_core_timer_7_Template,2,4,"core-timer",35)(8,AddonModQuizPlayerPage_ion_card_19_ion_item_8_Template,6,4,"ion-item",36),k.k0s()),2&e){const e=k.XpG();k.R7$(3),k.JRh(k.bMT(4,5,"addon.mod_quiz.summaryofattempt")),k.R7$(2),k.Y8G("ngForOf",e.attemptSummary),k.R7$(),k.Y8G("ngIf",e.dueDateWarning),k.R7$(),k.Y8G("ngIf",e.endTime),k.R7$(),k.Y8G("ngIf",e.preventSubmitMessages.length)}}function AddonModQuizPlayerPage_ion_card_20_ion_button_5_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-button",54),k.bIt("click",(function AddonModQuizPlayerPage_ion_card_20_ion_button_5_Template_ion_button_click_0_listener(){k.eBV(e);const t=k.XpG(2);return k.Njj(t.changePage(t.attempt.currentpage))})),k.EFF(1),k.nI1(2,"translate"),k.k0s()}2&e&&(k.R7$(),k.SpI(" ",k.bMT(2,1,"addon.mod_quiz.returnattempt")," "))}function AddonModQuizPlayerPage_ion_card_20_Template(e,t){if(1&e&&(k.j41(0,"ion-card")(1,"ion-item",33)(2,"ion-label"),k.EFF(3),k.nI1(4,"translate"),k.k0s()(),k.DNE(5,AddonModQuizPlayerPage_ion_card_20_ion_button_5_Template,3,3,"ion-button",53),k.k0s()),2&e){const e=k.XpG();k.R7$(3),k.JRh(k.bMT(4,2,"addon.mod_quiz.errorparsequestions")),k.R7$(2),k.Y8G("ngIf",e.canReturn)}}function AddonModQuizPlayerPage_div_21_ion_button_2_Template(e,t){if(1&e&&(k.j41(0,"ion-button",59),k.EFF(1),k.nI1(2,"translate"),k.nrm(3,"ion-icon",60),k.k0s()),2&e){const e=k.XpG(2);k.Y8G("href",e.moduleUrl)("showBrowserWarning",!1),k.R7$(),k.SpI(" ",k.bMT(2,3,"core.openinbrowser")," ")}}function AddonModQuizPlayerPage_div_21_ion_button_3_Template(e,t){if(1&e){const e=k.RV6();k.j41(0,"ion-button",61),k.bIt("click",(function AddonModQuizPlayerPage_div_21_ion_button_3_Template_ion_button_click_0_listener(){k.eBV(e);const t=k.XpG(2);return k.Njj(t.finishAttempt(!0))})),k.EFF(1),k.nI1(2,"translate"),k.k0s()}2&e&&(k.R7$(),k.SpI(" ",k.bMT(2,1,"addon.mod_quiz.submitallandfinish")," "))}function AddonModQuizPlayerPage_div_21_Template(e,t){if(1&e&&(k.j41(0,"div",55)(1,"div",56),k.DNE(2,AddonModQuizPlayerPage_div_21_ion_button_2_Template,4,5,"ion-button",57)(3,AddonModQuizPlayerPage_div_21_ion_button_3_Template,3,3,"ion-button",58),k.k0s()()),2&e){const e=k.XpG();k.R7$(2),k.Y8G("ngIf",e.preventSubmitMessages.length),k.R7$(),k.Y8G("ngIf",!e.attempt.finishedOffline&&!e.preventSubmitMessages.length)}}let H=(()=>{var e;class AddonModQuizPlayerPage{constructor(e,t){this.changeDetector=e,this.elementRef=t,this.component=M.Ar,this.loaded=!1,this.quizAborted=!1,this.offline=!1,this.attemptSummary=[],this.questions=[],this.nextPage=-2,this.previousPage=-1,this.showSummary=!1,this.canReturn=!1,this.preventSubmitMessages=[],this.autoSaveError=!1,this.isSequential=!1,this.correctIcon="",this.incorrectIcon="",this.partialCorrectIcon="",this.preflightData={},this.newAttempt=!1,this.quizDataLoaded=!1,this.timeUpCalled=!1,this.forceLeave=!1,this.reloadNavigation=!1}ngOnInit(){try{this.cmId=d.CoreNavigator.getRequiredRouteNumberParam("cmId"),this.courseId=d.CoreNavigator.getRequiredRouteNumberParam("courseId"),this.moduleUrl=d.CoreNavigator.getRouteParam("moduleUrl")}catch(e){return S.CoreAlerts.showError(e),d.CoreNavigator.back(),void 0}this.autoSave=new AddonModQuizAutoSave("addon-mod_quiz-player-form","#addon-mod_quiz-connection-error-button"),this.start(),this.autoSaveErrorSubscription=this.autoSave.onError().subscribe((e=>{this.autoSaveError=e,this.changeDetector.detectChanges()}))}ngOnDestroy(){this.stopAutoSave(),this.quiz&&c.CoreSync.unblockOperation(M.Qs,this.quiz.id)}canLeave(){var e=this;return(0,n.A)((function*(){if(e.forceLeave||e.quizAborted||!e.questions.length||e.showSummary)return!0;const t=yield w.CoreLoadings.show("core.sending",!0);try{yield e.processAttempt(!1,!1),t.dismissWithStatus("core.sent",!0)}catch(o){t.dismiss(),yield S.CoreAlerts.confirm(l.HT.instant("addon.mod_quiz.confirmleavequizonerror")),P.R.triggerFormCancelledEvent(e.formElement,s.CoreSites.getCurrentSiteId())}return!0}))()}ionViewWillLeave(){return(0,n.A)((function*(){const e=yield l.W3.getTop();null==e||e.dismiss()}))()}abortQuiz(){this.quizAborted=!0}behaviourButtonClicked(e){var t=this;return(0,n.A)((function*(){if(!t.quiz||!t.attempt)return;let o;try{var n,i;yield S.CoreAlerts.confirm(l.HT.instant("core.areyousure")),o=yield w.CoreLoadings.show("core.sending",!0);const a=yield t.prepareAnswers(t.quiz.coursemodule);a[e.name]=e.value,yield p.AddonModQuiz.processAttempt(t.quiz,t.attempt,a,t.preflightData),t.reloadNavigation=!0;const d=yield null===(n=t.content)||void 0===n?void 0:n.getScrollElement(),s=(null==d?void 0:d.scrollTop)||-1;t.loaded=!1,null===(i=t.content)||void 0===i||i.scrollToTop();try{var r;yield t.loadPage(null!==(r=t.attempt.currentpage)&&void 0!==r?r:0)}finally{t.loaded=!0,-1!=s&&setTimeout((()=>{var e;null===(e=t.content)||void 0===e||e.scrollToPoint(0,s)}),50)}o.dismissWithStatus("core.sent",!0)}catch(e){var a;null===(a=o)||void 0===a||a.dismiss(),S.CoreAlerts.showError(e,{default:"Error performing action."})}}))()}changePage(e,t,o){var i=this;return(0,n.A)((function*(){var n;if(i.attempt&&(-1===e||"overdue"!==i.attempt.state&&!i.attempt.finishedOffline)){if(e===i.attempt.currentpage&&!i.showSummary&&void 0!==o)return yield i.scrollToQuestion(o),void 0;if(!(e===i.attempt.currentpage&&!i.showSummary||t&&i.isSequential&&e!==i.attempt.currentpage&&e!==i.nextPage||-1===e&&i.showSummary)){if(null===(n=i.content)||void 0===n||n.scrollToTop(),!i.showSummary){const e=yield w.CoreLoadings.show("core.sending",!0);try{yield i.processAttempt(!1,!1),e.dismissWithStatus("core.sent",!0)}catch(t){return S.CoreAlerts.showError(t,{default:l.HT.instant("addon.mod_quiz.errorsaveattempt")}),e.dismiss(),void 0}i.reloadNavigation=!0}i.loaded=!1;try{i.autoSave.stopCheckChangesProcess(),-1===e?yield i.loadSummary():yield i.loadPage(e)}catch(e){!i.showSummary&&i.quiz&&i.autoSave.startCheckChangesProcess(i.quiz,i.attempt,i.preflightData,i.offline),S.CoreAlerts.showError(e,{default:l.HT.instant("addon.mod_quiz.errorgetquestions")})}finally{i.loaded=!0,void 0!==o&&(yield i.scrollToQuestion(o))}}}}))()}fetchData(){var e=this;return(0,n.A)((function*(){e.quiz=yield p.AddonModQuiz.getQuiz(e.courseId,e.cmId),c.CoreSync.blockOperation(M.Qs,e.quiz.id),yield A.AddonModQuizSync.waitForSync(e.quiz.id),e.isSequential=p.AddonModQuiz.isNavigationSequential(e.quiz),e.offline=!!p.AddonModQuiz.isQuizOffline(e.quiz)||(yield p.AddonModQuiz.isLastAttemptOfflineUnfinished(e.quiz)),e.quiz.timelimit&&e.quiz.timelimit>0&&(e.readableTimeLimit=v.j.formatTime(e.quiz.timelimit)),e.quizAccessInfo=yield p.AddonModQuiz.getQuizAccessInformation(e.quiz.id,{cmId:e.quiz.coursemodule,readingStrategy:e.offline?1:2});const t=yield p.AddonModQuiz.getUserAttempts(e.quiz.id,{cmId:e.quiz.coursemodule,readingStrategy:e.offline?1:2});if(!t.length)return e.newAttempt=!0,void 0;e.lastAttempt=t[t.length-1],e.lastAttempt.finishedOffline=yield p.AddonModQuiz.isAttemptFinishedOffline(e.lastAttempt.id),e.newAttempt=p.AddonModQuiz.isAttemptCompleted(e.lastAttempt.state)}))()}finishAttempt(e,t){var o=this;return(0,n.A)((function*(){if(!o.quiz||!o.attempt)return;let i;try{if(!t&&"inprogress"===o.attempt.state){let e=l.HT.instant("addon.mod_quiz.confirmclose");const t=o.attemptSummary.filter((e=>p.AddonModQuiz.isQuestionUnanswered(e))).length;if(!o.isSequential&&t>0){e+=`\n                        <ion-card class="core-warning-card">\n                            <ion-item>\n                                <ion-label>\n                                    ${l.HT.instant("addon.mod_quiz.submission_confirmation_unanswered",{$a:t})}\n                                </ion-label>\n                            </ion-item>\n                        </ion-card>\n                    `}yield S.CoreAlerts.confirm(e,{header:l.HT.instant("addon.mod_quiz.submitallandfinish"),okText:l.HT.instant("core.submit")})}i=yield w.CoreLoadings.show("core.sending",!0),yield o.processAttempt(e,t),m.z.trigger(M.I5,{quizId:o.quiz.id,attemptId:o.attempt.id,synced:!o.offline},s.CoreSites.getCurrentSiteId()),m.z.trigger(m.z.ACTIVITY_DATA_SENT,{module:"quiz"}),t&&o.quiz.graceperiod?(o.stopAutoSave(),o.clearTimer(),yield o.refreshAttempt(),yield o.loadSummary()):(o.forceLeave=!0,d.CoreNavigator.back()),i.dismissWithStatus("core.sent",!0)}catch(e){var r;null===(r=i)||void 0===r||r.dismiss(),S.CoreAlerts.showError(e,{default:l.HT.instant("addon.mod_quiz.errorsaveattempt")}).then(function(){var t=(0,n.A)((function*(t){yield null==t?void 0:t.onWillDismiss(),e instanceof b.CoreWSError&&"attemptalreadyclosed"===e.errorcode&&d.CoreNavigator.back()}));return function(e){return t.apply(this,arguments)}}())}}))()}fixSequenceChecks(){var e=this;return(0,n.A)((function*(){var t,o,n;if(!e.attempt)return;const i=yield p.AddonModQuiz.getAttemptData(e.attempt.id,null!==(t=e.attempt.currentpage)&&void 0!==t?t:0,e.preflightData,{cmId:null===(o=e.quiz)||void 0===o?void 0:o.coursemodule,readingStrategy:e.offline?1:2}),r={};i.questions.forEach((e=>{const t=a.CoreQuestionHelper.getQuestionSequenceCheckFromHtml(e.html);t&&(r[e.slot]=t)})),null===(n=e.questionComponents)||void 0===n||n.forEach((e=>{e.updateSequenceCheck(r)}))}))()}getAnswers(){return a.CoreQuestionHelper.getAnswersFromForm(document.forms["addon-mod_quiz-player-form"])}initTimer(){var e;if(!this.quizAccessInfo||!this.attempt||null===(e=this.attemptAccessInfo)||void 0===e||!e.endtime||this.attemptAccessInfo.endtime<0)return;p.AddonModQuiz.shouldShowTimeLeft(this.quizAccessInfo.activerulenames,this.attempt,this.attemptAccessInfo.endtime)?this.endTime=this.attemptAccessInfo.endtime:delete this.endTime}clearTimer(){delete this.endTime}loadPage(e){var t=this;return(0,n.A)((function*(){if(!t.quiz||!t.attempt)return;t.isSequential&&(yield t.logViewPage(e));const o=yield p.AddonModQuiz.getAttemptData(t.attempt.id,e,t.preflightData,{cmId:t.quiz.coursemodule,readingStrategy:t.offline?1:2});t.attempt=o.attempt,t.attempt.currentpage=e,t.questions=o.questions,t.nextPage=o.nextpage,t.previousPage=t.isSequential?-1:e-1,t.showSummary=!1,t.questions.forEach((e=>{e.readableMark=h.AddonModQuizHelper.getQuestionMarkFromHtml(e.html),a.CoreQuestionHelper.extractQuestionInfoBox(e,".info"),p.AddonModQuiz.isQuestionBlocked(e)&&(e.type="description")})),t.isSequential||(yield t.logViewPage(e)),t.autoSave.startCheckChangesProcess(t.quiz,t.attempt,t.preflightData,t.offline)}))()}logViewPage(e){var t=this;return(0,n.A)((function*(){t.quiz&&t.attempt&&(yield u.g.ignoreErrors(p.AddonModQuiz.logViewAttempt(t.attempt.id,e,t.preflightData,t.offline)),q.OF.logEvent({type:q.qr.VIEW_ITEM,ws:"mod_quiz_view_attempt",name:t.quiz.name,data:{id:t.attempt.id,quizid:t.quiz.id,page:e,category:"quiz"},url:`/mod/quiz/attempt.php?attempt=${t.attempt.id}&cmid=${t.cmId}`+(e>0?`&page=${e}`:"")}))}))()}logViewSummary(){var e=this;return(0,n.A)((function*(){e.quiz&&e.attempt&&(yield u.g.ignoreErrors(p.AddonModQuiz.logViewAttemptSummary(e.attempt.id,e.preflightData,e.quiz.id)),q.OF.logEvent({type:q.qr.VIEW_ITEM,ws:"mod_quiz_view_attempt_summary",name:e.quiz.name,data:{id:e.attempt.id,quizid:e.quiz.id,category:"quiz"},url:`/mod/quiz/summary.php?attempt=${e.attempt.id}&cmid=${e.cmId}`}))}))()}refreshAttempt(){var e=this;return(0,n.A)((function*(){if(!e.quiz)return;const t=yield p.AddonModQuiz.getUserAttempts(e.quiz.id,{cmId:e.quiz.coursemodule,readingStrategy:e.offline?1:2});e.attempt=t.find((t=>{var o;return t.id===(null===(o=e.attempt)||void 0===o?void 0:o.id)}))}))()}loadSummary(){var e=this;return(0,n.A)((function*(){e.quiz&&e.attempt&&(e.correctIcon||(e.correctIcon=a.CoreQuestionHelper.getCorrectIcon().fullName,e.incorrectIcon=a.CoreQuestionHelper.getIncorrectIcon().fullName,e.partialCorrectIcon=a.CoreQuestionHelper.getPartiallyCorrectIcon().fullName),yield e.loadAttemptSummary(),e.showSummary=!0,e.canReturn="inprogress"===e.attempt.state&&!e.attempt.finishedOffline,e.preventSubmitMessages=p.AddonModQuiz.getPreventSubmitMessages(e.attemptSummary),e.dueDateWarning=p.AddonModQuiz.getAttemptDueDateWarning(e.quiz,e.attempt),e.logViewSummary())}))()}loadAttemptSummary(){var e=this;return(0,n.A)((function*(){e.quiz&&e.attempt&&(e.attemptSummary=yield p.AddonModQuiz.getAttemptSummary(e.attempt.id,e.preflightData,{cmId:e.quiz.coursemodule,loadLocal:e.offline,readingStrategy:e.offline?1:2}),e.attemptSummary.forEach((e=>{a.CoreQuestionHelper.populateQuestionStateClass(e)})))}))()}openNavigation(){var e=this;return(0,n.A)((function*(){var t;if(e.reloadNavigation){const t=yield w.CoreLoadings.show();yield u.g.ignoreErrors(e.loadAttemptSummary()),t.dismiss(),e.reloadNavigation=!1}const{AddonModQuizNavigationModalComponent:n}=yield o.e(12423).then(o.bind(o,12423)),i=yield T.I.openSideModal({component:n,componentProps:{navigation:e.attemptSummary,summaryShown:e.showSummary,currentPage:null===(t=e.attempt)||void 0===t?void 0:t.currentpage,nextPage:e.nextPage,isReview:!1,isSequential:e.isSequential}});i&&e.changePage(i.page,!0,i.slot)}))()}prepareAnswers(e){return a.CoreQuestionHelper.prepareAnswers(this.questions,this.getAnswers(),this.offline,this.component,e)}processAttempt(e,t,o){var i=this;return(0,n.A)((function*(){if(!i.quiz||!i.attempt)return;let n={};i.showSummary||(n=yield i.prepareAnswers(i.quiz.coursemodule));try{yield p.AddonModQuiz.processAttempt(i.quiz,i.attempt,n,i.preflightData,e,t,i.offline)}catch(n){if(!n||"submissionoutofsequencefriendlymessage"!=n.errorcode)throw n;try{yield i.fixSequenceChecks()}catch{throw n}if(o)throw n;return yield i.processAttempt(e,t,!0),void 0}i.autoSave.cancelAutoSave(),i.autoSave.hideAutoSaveError(),i.formElement&&P.R.triggerFormSubmittedEvent(i.formElement,!i.offline,s.CoreSites.getCurrentSiteId()),yield a.CoreQuestionHelper.clearTmpData(i.questions,i.component,i.quiz.coursemodule)}))()}scrollToQuestion(e){var t=this;return(0,n.A)((function*(){yield I.H.nextTick(),yield z.D.waitDirectivesReady(t.elementRef.nativeElement,"core-question"),yield y.y.scrollToElement(t.elementRef.nativeElement,`#addon-mod_quiz-question-${e}`)}))()}showConnectionError(e){this.autoSave.showAutoSaveError(e)}start(){var e=this;return(0,n.A)((function*(){try{e.loaded=!1,e.quizDataLoaded||(yield e.fetchData(),e.quizDataLoaded=!0),yield e.startOrContinueAttempt()}catch(e){S.CoreAlerts.showError(e,{default:l.HT.instant("addon.mod_quiz.errorgetquiz")})}finally{e.loaded=!0}}))()}startOrContinueAttempt(){var e=this;return(0,n.A)((function*(){var t;if(!e.quiz||!e.quizAccessInfo)return;let o=e.newAttempt?void 0:e.lastAttempt;var n;(o=yield h.AddonModQuizHelper.getAndCheckPreflightData(e.quiz,e.quizAccessInfo,e.preflightData,{attempt:o,offline:e.offline,finishedOffline:null===(t=o)||void 0===t?void 0:t.finishedOffline,title:"addon.mod_quiz.startattempt"}),e.attemptAccessInfo=yield p.AddonModQuiz.getAttemptAccessInformation(e.quiz.id,o.id,{cmId:e.quiz.coursemodule,readingStrategy:e.offline?1:2}),e.attempt=o,yield e.loadAttemptSummary(),"overdue"===e.attempt.state||e.attempt.finishedOffline)?yield e.loadSummary():(yield e.loadPage(null!==(n=e.attempt.currentpage)&&void 0!==n?n:0),e.initTimer())}))()}timeUp(){this.timeUpCalled||(this.timeUpCalled=!0,this.finishAttempt(!1,!0))}stopAutoSave(){var e;this.autoSave.cancelAutoSave(),this.autoSave.stopCheckChangesProcess(),null===(e=this.autoSaveErrorSubscription)||void 0===e||e.unsubscribe()}}return(e=AddonModQuizPlayerPage).ɵfac=function AddonModQuizPlayerPage_Factory(t){return new(t||e)(k.rXU(k.gRc),k.rXU(k.aKT))},e.ɵcmp=k.VBU({type:e,selectors:[["page-addon-mod-quiz-player"]],viewQuery:function AddonModQuizPlayerPage_Query(e,t){if(1&e&&(k.GBs(i.W9,5),k.GBs(V,5),k.GBs(r.CoreQuestionComponent,5)),2&e){let e;k.mGM(e=k.lsd())&&(t.content=e.first),k.mGM(e=k.lsd())&&(t.formElement=e.first),k.mGM(e=k.lsd())&&(t.questionComponents=e)}},standalone:!0,features:[k.aNF],decls:22,vars:18,consts:[["quizForm",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId",4,"ngIf"],["slot","end"],["fill","clear","id","addon-mod_quiz-connection-error-button","aria-haspopup","dialog",3,"click","ariaLabel"],["name","fas-circle-exclamation","slot","icon-only","aria-hidden","true"],[3,"ariaLabel","click",4,"ngIf"],["timerHiddenPreferenceName","quiz_timerhidden",3,"endTime","timerText","hidable","hidden","finished",4,"ngIf"],[1,"limited-width"],[1,"has-spacer",3,"hideUntil"],["expand","block","class","ion-margin",3,"click",4,"ngIf"],["name","addon-mod_quiz-player-form",4,"ngIf"],["class","spacer-top",4,"ngIf"],["class","addon-mod_quiz-table",4,"ngIf"],[4,"ngIf"],["collapsible-footer","","appearOnBottom","","slot","fixed",4,"ngIf"],["contextLevel","module",3,"text","contextInstanceId","courseId"],[3,"click","ariaLabel"],["name","fas-list-ul","slot","icon-only","aria-hidden","true"],["timerHiddenPreferenceName","quiz_timerhidden",3,"finished","endTime","timerText","hidable","hidden"],["expand","block",1,"ion-margin",3,"click"],["name","addon-mod_quiz-player-form"],[4,"ngFor","ngForOf"],[3,"question"],["contextLevel","module",1,"ion-text-wrap",3,"onAbort","buttonClicked","question","component","componentId","attemptId","usageId","offlineEnabled","contextInstanceId","courseId","preferredBehaviour","review"],[1,"spacer-top"],["expand","block","fill","outline",1,"ion-text-wrap",3,"click"],["name","fas-chevron-left","slot","start","aria-hidden","true"],["expand","block","class","ion-text-wrap",3,"click",4,"ngIf"],["expand","block",1,"ion-text-wrap",3,"click"],["name","fas-chevron-right","slot","end","aria-hidden","true"],[1,"addon-mod_quiz-table"],[1,"ion-text-wrap"],["class","ion-text-wrap core-warning-item",4,"ngIf"],[3,"endTime","timerText","finished",4,"ngIf"],["class","ion-text-wrap",4,"ngIf"],[3,"detail","button","class","click",4,"ngIf"],[3,"click","detail","button"],[1,"item-heading"],["name","fas-circle-question","aria-hidden","true","slot","end",4,"ngIf"],["color","success","aria-hidden","true","slot","end",3,"name",4,"ngIf"],["color","warning","aria-hidden","true","slot","end",3,"name",4,"ngIf"],["color","danger","aria-hidden","true","slot","end",3,"name",4,"ngIf"],["name","fas-triangle-exclamation","color","danger","aria-hidden","true","slot","end",4,"ngIf"],["name","fas-circle-question","aria-hidden","true","slot","end"],["color","success","aria-hidden","true","slot","end",3,"name"],["color","warning","aria-hidden","true","slot","end",3,"name"],["color","danger","aria-hidden","true","slot","end",3,"name"],["name","fas-triangle-exclamation","color","danger","aria-hidden","true","slot","end"],[1,"ion-text-wrap","core-warning-item"],["slot","start","name","fas-triangle-exclamation","color","warning","aria-hidden","true"],[3,"finished","endTime","timerText"],["expand","block","class","ion-margin ion-text-wrap","fill","outline",3,"click",4,"ngIf"],["expand","block","fill","outline",1,"ion-margin","ion-text-wrap",3,"click"],["collapsible-footer","","appearOnBottom","","slot","fixed"],[1,"list-item-limited-width"],["expand","block","class","ion-margin ion-text-wrap","core-link","",3,"href","showBrowserWarning",4,"ngIf"],["expand","block","class","ion-margin ion-text-wrap",3,"click",4,"ngIf"],["expand","block","core-link","",1,"ion-margin","ion-text-wrap",3,"href","showBrowserWarning"],["name","fas-up-right-from-square","slot","end","aria-hidden","true"],["expand","block",1,"ion-margin","ion-text-wrap",3,"click"]],template:function AddonModQuizPlayerPage_Template(e,t){1&e&&(k.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),k.nrm(3,"ion-back-button",2),k.nI1(4,"translate"),k.k0s(),k.j41(5,"ion-title")(6,"h1"),k.DNE(7,AddonModQuizPlayerPage_core_format_text_7_Template,1,3,"core-format-text",3),k.k0s()(),k.j41(8,"ion-buttons",4)(9,"ion-button",5),k.nI1(10,"translate"),k.bIt("click",(function AddonModQuizPlayerPage_Template_ion_button_click_9_listener(e){return t.showConnectionError(e)})),k.nrm(11,"ion-icon",6),k.k0s(),k.DNE(12,AddonModQuizPlayerPage_ion_button_12_Template,3,3,"ion-button",7),k.k0s()(),k.DNE(13,AddonModQuizPlayerPage_core_timer_13_Template,2,6,"core-timer",8),k.k0s(),k.j41(14,"ion-content",9)(15,"core-loading",10),k.DNE(16,AddonModQuizPlayerPage_ion_button_16_Template,3,3,"ion-button",11)(17,AddonModQuizPlayerPage_form_17_Template,3,1,"form",12)(18,AddonModQuizPlayerPage_ion_row_18_Template,3,2,"ion-row",13)(19,AddonModQuizPlayerPage_ion_card_19_Template,9,7,"ion-card",14)(20,AddonModQuizPlayerPage_ion_card_20_Template,6,4,"ion-card",15)(21,AddonModQuizPlayerPage_div_21_Template,4,2,"div",16),k.k0s()()),2&e&&(k.R7$(3),k.Y8G("text",k.bMT(4,14,"core.back")),k.R7$(4),k.Y8G("ngIf",t.quiz),k.R7$(2),k.AVh("hidden",!t.autoSaveError),k.Y8G("ariaLabel",k.bMT(10,16,"addon.mod_quiz.connectionerror")),k.R7$(3),k.Y8G("ngIf",t.attemptSummary.length&&!t.showSummary),k.R7$(),k.Y8G("ngIf",t.endTime&&t.questions.length&&!t.quizAborted&&!t.showSummary),k.R7$(2),k.Y8G("hideUntil",t.loaded),k.R7$(),k.Y8G("ngIf",!t.attempt),k.R7$(),k.Y8G("ngIf",t.questions.length&&!t.quizAborted&&!t.showSummary),k.R7$(),k.Y8G("ngIf",t.questions.length&&!t.quizAborted&&!t.showSummary),k.R7$(),k.Y8G("ngIf",!t.quizAborted&&t.showSummary&&t.attemptSummary.length),k.R7$(),k.Y8G("ngIf",t.attempt&&(!t.questions.length&&!t.showSummary||t.quizAborted)),k.R7$(),k.Y8G("ngIf",!t.quizAborted&&t.showSummary&&t.attemptSummary.length&&t.loaded))},dependencies:[Q.n,R.Sq,R.bT,x.qT,x.cb,x.cV,i.Jm,i.QW,i.b_,i.ME,i.tN,i.hU,i.W9,i.eU,i.iq,i.uz,i.he,i.ln,i.BC,i.ai,i.el,E.R,G.G,O.t,$.B,N.j,j.i,F.i,D.T,Y.D9,C.P,r.CoreQuestionComponent],styles:["[_nghost-%COMP%]   core-timer.core-timer-timeleft-0[_ngcontent-%COMP%]{--timer-background: #ca3120;--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-1[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .9333333333);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-2[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .8666666667);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-3[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .8);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-4[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .7333333333);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-5[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .6666666667);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-6[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .6);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-7[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .5333333333);--timer-text-color: var(--white)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-8[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .4666666667)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-9[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .4)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-10[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .3333333333)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-11[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .2666666667)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-12[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .2)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-13[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .1333333333)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-14[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, .0666666667)}[_nghost-%COMP%]   core-timer.core-timer-timeleft-15[_ngcontent-%COMP%]{--timer-background: rgba(202, 49, 32, 0)}[_nghost-%COMP%]   ion-item.core-question-blocked[_ngcontent-%COMP%], [_nghost-%COMP%]   ion-item.core-question-complete[_ngcontent-%COMP%], [_nghost-%COMP%]   ion-item.core-question-answersaved[_ngcontent-%COMP%], [_nghost-%COMP%]   ion-item.core-question-requiresgrading[_ngcontent-%COMP%]{--background: var(--gray-300)}"]}),AddonModQuizPlayerPage})()}}]);