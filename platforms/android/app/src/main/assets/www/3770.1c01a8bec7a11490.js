"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3770],{3770:(e,o,s)=>{s.r(o),s.d(o,{AddonModWorkshopPrefetchHandler:()=>v,AddonModWorkshopPrefetchHandlerLazyService:()=>y});var r=s(10467),d=s(44682),i=s(66110),n=s(98870),t=s(88793),a=s(15221),c=s(52749),l=s(58364),p=s(79555),h=s(67193),u=s(80178),f=s(36553),m=s(34751),A=s(81552),k=s(55554),g=s(54438);let y=(()=>{var e;class AddonModWorkshopPrefetchHandlerLazyService extends m.w{getFiles(e,o){var s=this;return(0,r.A)((function*(){return(yield s.getWorkshopInfoHelper(e,o,{omitFail:!0})).files}))()}getWorkshopInfoHelper(e,o,s={}){var d=this;return(0,r.A)((function*(){var i;let n,t,l=[],p=[];const f={cmId:e.id,...s},m=yield c.CoreSites.getSite(s.siteId);s.siteId=null!==(i=s.siteId)&&void 0!==i?i:m.getId();const A=m.getUserId();try{n=yield h.AddonModWorkshop.getWorkshop(o,e.id,s)}catch(e){if(s.omitFail)return{groups:[],files:[]};throw e}try{if(p=d.getIntroFilesFromInstance(e,n),p=p.concat(n.instructauthorsfiles||[]).concat(n.instructreviewersfiles||[]),t=yield h.AddonModWorkshop.getWorkshopAccessInformation(n.id,f),t.canviewallsubmissions){const o=yield a.CoreGroups.getActivityGroupInfo(e.id,!1,void 0,s.siteId);o.groups&&0!=o.groups.length||(o.groups=[{id:0,name:""}]),l=o.groups}const o=yield h.AddonModWorkshop.getUserPlanPhases(n.id,f),i=u.AddonModWorkshopHelper.canSubmit(n,t,o[20].tasks),c=u.AddonModWorkshopHelper.canAssess(n,t),m=[];return i&&m.push(u.AddonModWorkshopHelper.getUserSubmission(n.id,{userId:A,cmId:e.id,canEdit:t.modifyingsubmissionallowed}).then((e=>{e&&(p=p.concat(e.contentfiles||[]).concat(e.attachmentfiles||[]))}))),t.canviewallsubmissions&&n.phase>=20&&m.push(h.AddonModWorkshop.getSubmissions(n.id,f).then(function(){var o=(0,r.A)((function*(o){yield Promise.all(o.map(function(){var o=(0,r.A)((function*(o){p=p.concat(o.contentfiles||[]).concat(o.attachmentfiles||[]);const s=yield h.AddonModWorkshop.getSubmissionAssessments(n.id,o.id,{cmId:e.id});s.forEach((e=>{p=p.concat(e.feedbackattachmentfiles).concat(e.feedbackcontentfiles)})),n.phase>=30&&c&&(yield Promise.all(s.map((e=>u.AddonModWorkshopHelper.getReviewerAssessmentById(n.id,e.id,{...f,canAssess:t&&u.AddonModWorkshopHelper.canEditAssessments(n,t)})))))}));return function(e){return o.apply(this,arguments)}}()))}));return function(e){return o.apply(this,arguments)}}())),n.phase>=30&&c&&m.push(u.AddonModWorkshopHelper.getReviewerAssessments(n.id,{...f,canAssess:u.AddonModWorkshopHelper.canEditAssessments(n,t)}).then((e=>{e.forEach((e=>{p=p.concat(e.feedbackattachmentfiles).concat(e.feedbackcontentfiles)}))}))),yield Promise.all(m),{workshop:n,groups:l,files:p.filter((e=>void 0!==e))}}catch(e){if(s.omitFail)return{workshop:n,groups:l,files:p.filter((e=>void 0!==e))};throw e}}))()}invalidateContent(e,o){return(0,r.A)((function*(){yield h.AddonModWorkshop.invalidateContent(e,o)}))()}isDownloadable(e,o){return(0,r.A)((function*(){const s=yield h.AddonModWorkshop.getWorkshop(o,e.id,{readingStrategy:1});return(yield h.AddonModWorkshop.getWorkshopAccessInformation(s.id,{cmId:e.id})).canswitchphase||s.phase>10}))()}prefetch(e,o){return this.prefetchPackage(e,o,(s=>this.prefetchWorkshop(e,o,s)))}getAllGradesReport(e,o,s,d){return(0,r.A)((function*(){const r=[];o.forEach((o=>{r.push(h.AddonModWorkshop.fetchAllGradeReports(e,{groupId:o.id,cmId:s,siteId:d}))}));const i=yield Promise.all(r),n={};return i.forEach((e=>{e.forEach((e=>{e.submissionid&&(n[e.submissionid]=e)}))})),l.T.toArray(n)}))()}prefetchWorkshop(e,o,s){var a=this;return(0,r.A)((function*(){const l=[],p={readingStrategy:2,siteId:s},f={cmId:e.id,...p},m=(yield c.CoreSites.getSite(s)).getUserId(),g=yield a.getWorkshopInfoHelper(e,o,p);if(!g.workshop)return;const y=g.workshop,v=[],W=[];v.push(t.CoreFilepool.addFilesToQueue(s,g.files,a.component,e.id)),v.push(h.AddonModWorkshop.getWorkshopAccessInformation(y.id,f).then(function(){var o=(0,r.A)((function*(o){const d=yield h.AddonModWorkshop.getUserPlanPhases(y.id,f),i=u.AddonModWorkshopHelper.canSubmit(y,o,d[20].tasks),n=u.AddonModWorkshopHelper.canAssess(y,o),c=[];i&&(c.push(h.AddonModWorkshop.getSubmissions(y.id,{...f,canEdit:o.modifyingsubmissionallowed})),l.push(m));let p=Promise.resolve();o.canviewallsubmissions&&y.phase>=20&&(p=a.getAllGradesReport(y.id,g.groups,e.id,s).then((e=>{e.forEach((e=>{l.push(e.userid),e.submissiongradeoverby&&l.push(e.submissiongradeoverby),e.reviewedby&&e.reviewedby.forEach((e=>{l.push(e.userid),W[e.assessmentid]=e.assessmentid})),e.reviewerof&&e.reviewerof.forEach((e=>{l.push(e.userid),W[e.assessmentid]=e.assessmentid}))}))}))),y.phase>=30&&n&&(p=p.finally((0,r.A)((function*(){const r=yield u.AddonModWorkshopHelper.getReviewerAssessments(y.id,{userId:m,canAssess:u.AddonModWorkshopHelper.canEditAssessments(y,o),cmId:e.id,siteId:s});let d=[];r.forEach((e=>{var s,r,i;(null===(s=e.submission)||void 0===s?void 0:s.authorid)==m&&v.push(h.AddonModWorkshop.getAssessment(y.id,e.id,{...f,canAssess:u.AddonModWorkshopHelper.canEditAssessments(y,o)})),l.push(e.reviewerid),l.push(e.gradinggradeoverby),W[e.id]=e.id,d=d.concat((null===(r=e.submission)||void 0===r?void 0:r.attachmentfiles)||[]).concat((null===(i=e.submission)||void 0===i?void 0:i.contentfiles)||[])})),yield t.CoreFilepool.addFilesToQueue(s,d,a.component,e.id)})))),p=p.finally((()=>{if(W.length>0)return Promise.all(W.map((e=>h.AddonModWorkshop.getAssessmentForm(y.id,e,f))))})),c.push(p),50==y.phase&&(c.push(h.AddonModWorkshop.getGrades(y.id,f)),o.canviewpublishedsubmissions&&c.push(h.AddonModWorkshop.getSubmissions(y.id,f))),yield Promise.all(c)}));return function(e){return o.apply(this,arguments)}}())),v.push(d.CoreCourse.getModuleBasicInfoByInstance(y.id,A.ar,{siteId:s})),v.push(d.CoreCourse.getModuleBasicGradeInfo(e.id,s)),v.push(k.g.ignoreErrors(i.CoreCourses.getCourseByField("id",o,s))),yield Promise.all(v),yield n.CoreUser.prefetchProfiles(l,o,s)}))()}sync(e,o,s){return(0,r.A)((function*(){return f.AddonModWorkshopSync.syncWorkshop(e.instance,s)}))()}}return(e=AddonModWorkshopPrefetchHandlerLazyService).ɵfac=(()=>{let o;return function AddonModWorkshopPrefetchHandlerLazyService_Factory(s){return(o||(o=g.xGo(e)))(s||e)}})(),e.ɵprov=g.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWorkshopPrefetchHandlerLazyService})();const v=(0,p.Qd)(y)}}]);