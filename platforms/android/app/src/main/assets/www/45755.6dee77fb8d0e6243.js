"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[45755,58841],{58841:(n,i,s)=>{s.r(i),s.d(i,{AddonModAssignSubmissionPluginComponent:()=>h});var e=s(10467),t=s(68162),o=s(5505),d=s(20218),a=s(95790),r=s(66016),m=s(91416),l=s(86654),u=s(54438),g=s(60177),c=s(2910),p=s(6128),_=s(64422),f=s(58197),A=s(35407),b=s(73955);function AddonModAssignSubmissionPluginComponent_ion_item_2_ion_badge_4_Template(n,i){1&n&&(u.j41(0,"ion-badge",7),u.EFF(1),u.nI1(2,"translate"),u.k0s()),2&n&&(u.R7$(),u.SpI(" ",u.bMT(2,1,"addon.mod_assign.submissionnotsupported")," "))}function AddonModAssignSubmissionPluginComponent_ion_item_2_p_5_Template(n,i){if(1&n&&(u.j41(0,"p"),u.nrm(1,"core-format-text",8),u.k0s()),2&n){const n=u.XpG(2);u.R7$(),u.Y8G("component",n.component)("componentId",n.assign.cmid)("text",n.text)("contextInstanceId",n.assign.cmid)("courseId",n.assign.course)}}function AddonModAssignSubmissionPluginComponent_ion_item_2_core_file_6_Template(n,i){if(1&n&&u.nrm(0,"core-file",9),2&n){const n=i.$implicit,s=u.XpG(2);u.Y8G("file",n)("component",s.component)("componentId",s.assign.cmid)("alwaysDownload",!0)}}function AddonModAssignSubmissionPluginComponent_ion_item_2_Template(n,i){if(1&n&&(u.j41(0,"ion-item",3)(1,"ion-label")(2,"h2"),u.EFF(3),u.k0s(),u.DNE(4,AddonModAssignSubmissionPluginComponent_ion_item_2_ion_badge_4_Template,3,3,"ion-badge",4)(5,AddonModAssignSubmissionPluginComponent_ion_item_2_p_5_Template,2,5,"p",5)(6,AddonModAssignSubmissionPluginComponent_ion_item_2_core_file_6_Template,1,4,"core-file",6),u.k0s()()),2&n){const n=u.XpG();u.R7$(3),u.JRh(n.plugin.name),u.R7$(),u.Y8G("ngIf",n.notSupported),u.R7$(),u.Y8G("ngIf",n.text),u.R7$(),u.Y8G("ngForOf",n.files)}}let h=(()=>{var n;class AddonModAssignSubmissionPluginComponent{constructor(){this.edit=!1,this.allowOffline=!1,this.component=r.It,this.text="",this.files=[],this.notSupported=!1,this.pluginLoaded=!1}ngOnChanges(n){var i=this;return(0,e.A)((function*(){if(!i.plugin)return i.pluginLoaded=!0,void 0;const s=a.AddonModAssignSubmissionDelegate.getPluginName(i.plugin);if(!s)return i.pluginLoaded=!0,void 0;i.plugin.name=s,(n.plugin||n.edit)&&(i.pluginComponent=yield a.AddonModAssignSubmissionDelegate.getComponentForPlugin(i.plugin,i.edit),i.pluginLoaded=!i.pluginComponent,i.pluginComponent||(i.text=o.AddonModAssign.getSubmissionPluginText(i.plugin),i.files=o.AddonModAssign.getSubmissionPluginAttachments(i.plugin),i.notSupported=a.AddonModAssignSubmissionDelegate.isPluginSupported(i.plugin.type))),i.pluginComponent&&(i.data={assign:i.assign,submission:i.submission,plugin:i.plugin,configs:d.AddonModAssignHelper.getPluginConfig(i.assign,"assignsubmission",i.plugin.type),edit:i.edit,allowOffline:i.allowOffline})}))()}invalidate(){var n=this;return(0,e.A)((function*(){yield n.dynamicComponent.callComponentMethod("invalidate")}))()}}return(n=AddonModAssignSubmissionPluginComponent).ɵfac=function AddonModAssignSubmissionPluginComponent_Factory(i){return new(i||n)},n.ɵcmp=u.VBU({type:n,selectors:[["addon-mod-assign-submission-plugin"]],viewQuery:function AddonModAssignSubmissionPluginComponent_Query(n,i){if(1&n&&u.GBs(t.m,5),2&n){let n;u.mGM(n=u.lsd())&&(i.dynamicComponent=n.first)}},inputs:{assign:"assign",submission:"submission",plugin:"plugin",edit:[u.Mj6.HasDecoratorInputTransform,"edit","edit",m.G],allowOffline:[u.Mj6.HasDecoratorInputTransform,"allowOffline","allowOffline",m.G]},standalone:!0,features:[u.GFd,u.OA$,u.aNF],decls:3,vars:4,consts:[[3,"component","data"],[3,"hideUntil"],["class","ion-text-wrap",4,"ngIf"],[1,"ion-text-wrap"],["color","primary",4,"ngIf"],[4,"ngIf"],[3,"file","component","componentId","alwaysDownload",4,"ngFor","ngForOf"],["color","primary"],["collapsible-item","","contextLevel","module",3,"component","componentId","text","contextInstanceId","courseId"],[3,"file","component","componentId","alwaysDownload"]],template:function AddonModAssignSubmissionPluginComponent_Template(n,i){1&n&&(u.j41(0,"core-dynamic-component",0)(1,"core-loading",1),u.DNE(2,AddonModAssignSubmissionPluginComponent_ion_item_2_Template,7,4,"ion-item",2),u.k0s()()),2&n&&(u.Y8G("component",i.pluginComponent)("data",i.data),u.R7$(),u.Y8G("hideUntil",i.pluginLoaded),u.R7$(),u.Y8G("ngIf",i.text.length>0||i.files.length>0))},dependencies:[l.n,g.Sq,g.bT,c.In,c.uz,c.he,t.m,p.t,_.R,f.B,A.K,b.D9],encapsulation:2}),AddonModAssignSubmissionPluginComponent})()},45755:(n,i,s)=>{s.r(i),s.d(i,{default:()=>Y});var e=s(10467),t=s(75629),o=s(64847),d=s(15324),a=s(52749),r=s(48966),m=s(63153),l=s(79555),u=s(49882),g=s(5505),c=s(20218),p=s(4175),_=s(75217),f=s(43411),A=s(22693),b=s(66016),h=s(47551),S=s(33014),I=s(55554),C=s(25572),M=s(58841),v=s(86654),T=s(54438),y=s(21182),E=s(60177),P=s(89417),x=s(2910),G=s(6128),w=s(64422),O=s(34198),k=s(58197),D=s(88246),F=s(43570),R=s(73955);const $=["editSubmissionForm"],_c1=()=>[300,900];function AddonModAssignEditPage_ion_list_14_core_timer_1_Template(n,i){if(1&n){const n=T.RV6();T.j41(0,"core-timer",12),T.nI1(1,"translate"),T.bIt("finished",(function AddonModAssignEditPage_ion_list_14_core_timer_1_Template_core_timer_finished_0_listener(){T.eBV(n);const i=T.XpG(2);return T.Njj(i.timeUp())})),T.k0s()}if(2&n){const n=T.XpG(2);T.Y8G("endTime",n.timeLimitEndTime)("timerText",T.bMT(1,5,"addon.mod_assign.assigntimeleft"))("align","center")("timeLeftClassThreshold",-1)("underTimeClassThresholds",T.lJ4(7,_c1))}}function AddonModAssignEditPage_ion_list_14_ion_item_2_Template(n,i){if(1&n&&(T.j41(0,"ion-item",13)(1,"ion-label"),T.nrm(2,"core-format-text",14),T.k0s()()),2&n){const n=T.XpG(2);T.R7$(2),T.Y8G("text",n.activityInstructions)("component",n.component)("componentId",n.moduleId)("contextInstanceId",n.moduleId)("courseId",n.courseId)}}function AddonModAssignEditPage_ion_list_14_ng_container_3_core_file_1_Template(n,i){if(1&n&&T.nrm(0,"core-file",16),2&n){const n=i.$implicit,s=T.XpG(3);T.Y8G("file",n)("component",s.component)("componentId",s.moduleId)}}function AddonModAssignEditPage_ion_list_14_ng_container_3_Template(n,i){if(1&n&&(T.qex(0),T.DNE(1,AddonModAssignEditPage_ion_list_14_ng_container_3_core_file_1_Template,1,3,"core-file",15),T.bVm()),2&n){const n=T.XpG(2);T.R7$(),T.Y8G("ngForOf",n.introAttachments)}}function AddonModAssignEditPage_ion_list_14_ion_item_6_Template(n,i){if(1&n){const n=T.RV6();T.j41(0,"ion-item",13)(1,"ion-checkbox",17),T.mxI("ngModelChange",(function AddonModAssignEditPage_ion_list_14_ion_item_6_Template_ion_checkbox_ngModelChange_1_listener(i){T.eBV(n);const s=T.XpG(2);return T.DH7(s.submissionStatementAccepted,i)||(s.submissionStatementAccepted=i),T.Njj(i)})),T.nrm(2,"core-format-text",18),T.k0s(),T.nrm(3,"input",19),T.k0s()}if(2&n){const n=T.XpG(2);T.R7$(),T.R50("ngModel",n.submissionStatementAccepted),T.R7$(),T.Y8G("text",n.submissionStatement)("filter",!1),T.R7$(),T.Y8G("ngModel",n.submissionStatementAccepted)}}function AddonModAssignEditPage_ion_list_14_addon_mod_assign_submission_plugin_7_Template(n,i){if(1&n&&T.nrm(0,"addon-mod-assign-submission-plugin",20),2&n){const n=i.$implicit,s=T.XpG(2);T.Y8G("assign",s.assign)("submission",s.userSubmission)("plugin",n)("edit",!0)("allowOffline",!0)}}function AddonModAssignEditPage_ion_list_14_Template(n,i){if(1&n&&(T.j41(0,"ion-list"),T.DNE(1,AddonModAssignEditPage_ion_list_14_core_timer_1_Template,2,8,"core-timer",8)(2,AddonModAssignEditPage_ion_list_14_ion_item_2_Template,3,5,"ion-item",9)(3,AddonModAssignEditPage_ion_list_14_ng_container_3_Template,2,1,"ng-container",7),T.j41(4,"form",10,0),T.DNE(6,AddonModAssignEditPage_ion_list_14_ion_item_6_Template,4,4,"ion-item",9)(7,AddonModAssignEditPage_ion_list_14_addon_mod_assign_submission_plugin_7_Template,1,5,"addon-mod-assign-submission-plugin",11),T.k0s()()),2&n){const n=T.XpG();T.R7$(),T.Y8G("ngIf",n.timeLimitEndTime>0),T.R7$(),T.Y8G("ngIf",n.activityInstructions),T.R7$(),T.Y8G("ngIf",null==n.assign?null:n.assign.submissionattachments),T.R7$(3),T.Y8G("ngIf",n.submissionStatement),T.R7$(),T.Y8G("ngForOf",n.userSubmission.plugins)}}let Y=(()=>{var n;class AddonModAssignEditPage{constructor(n){this.route=n,this.submissionStatementAccepted=!1,this.loaded=!1,this.timeLimitEndTime=0,this.component=b.It,this.isBlind=!1,this.saveOffline=!1,this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.userId=a.CoreSites.getCurrentSiteUserId(),this.editText=l.HT.instant("addon.mod_assign.editsubmission"),this.title=this.editText}ngOnInit(){try{this.moduleId=d.CoreNavigator.getRequiredRouteNumberParam("cmId"),this.courseId=d.CoreNavigator.getRequiredRouteNumberParam("courseId"),this.isBlind=!!d.CoreNavigator.getRouteNumberParam("blindId")}catch(n){return C.CoreAlerts.showError(n),d.CoreNavigator.back(),void 0}this.fetchAssignment().finally((()=>{this.loaded=!0}))}canLeave(){var n=this;return(0,e.A)((function*(){if(n.forceLeave)return!0;return(yield n.hasDataChanged())&&(yield C.CoreAlerts.confirmLeaveWithChanges()),c.AddonModAssignHelper.clearSubmissionPluginTmpData(n.assign,n.userSubmission,n.getInputData()),m.R.triggerFormCancelledEvent(n.formElement,a.CoreSites.getCurrentSiteId()),!0}))()}fetchAssignment(){var n=this;return(0,e.A)((function*(){const i=a.CoreSites.getCurrentSiteUserId();try{var s,e,o,d,m;n.assign=yield g.AddonModAssign.getAssignment(n.courseId,n.moduleId),n.title=n.assign.name||n.title,n.isDestroyed||r.CoreSync.blockOperation(b.AC,n.assign.id),yield _.AddonModAssignSync.waitForSync(n.assign.id);const a={userId:n.userId,isBlind:n.isBlind,cmId:n.assign.cmid,filter:!0,readingStrategy:3,checkFetchOriginal:!1};let f=yield g.AddonModAssign.getSubmissionStatus(n.assign,a);const h=f;let S=g.AddonModAssign.getSubmissionObjectFromAttempt(n.assign,f.lastattempt);if((yield c.AddonModAssignHelper.shouldFetchUnfilteredSubmissionToEdit(n.assign,S))&&(f=yield g.AddonModAssign.getSubmissionStatus(n.assign,{...a,filter:!1}),S=g.AddonModAssign.getSubmissionObjectFromAttempt(n.assign,f.lastattempt)),n.userSubmission=S,null===(s=f.lastattempt)||void 0===s||!s.canedit)throw new t.CoreError(l.HT.instant("core.nopermissions",{$a:n.editText}));var u;if(f=yield n.startSubmissionIfNeeded(f,a),null!==(e=h.assignmentdata)&&void 0!==e&&e.activity)n.activityInstructions=null===(u=h.assignmentdata)||void 0===u?void 0:u.activity.replace(/mod_assign\/activityattachment\/(?!0\/)/g,"mod_assign/activityattachment/0/");n.introAttachments=null!==(o=null===(d=f.assignmentdata)||void 0===d||null===(d=d.attachments)||void 0===d?void 0:d.intro)&&void 0!==o?o:n.assign.introattachments,n.assign.submissionstatement||void 0===n.assign.submissionstatement||(n.assign.requiresubmissionstatement=0),n.submissionStatement=n.assign.requiresubmissionstatement&&!n.assign.submissiondrafts&&n.userId==i?n.assign.submissionstatement:void 0,n.timeLimitEndTime=n.assign.timelimit&&null!==(m=n.userSubmission)&&void 0!==m&&m.timestarted?c.AddonModAssignHelper.calculateEndTime(n.assign,n.userSubmission):0,n.hasOffline=yield I.g.promiseWorks(p.AddonModAssignOffline.getSubmission(n.assign.id,n.userId)),A.OF.logEvent({type:A.qr.VIEW_ITEM,ws:"mod_assign_save_submission",name:l.HT.instant("addon.mod_assign.subpagetitle",{contextname:n.assign.name,subpage:l.HT.instant("addon.mod_assign.editsubmission")}),data:{id:n.assign.id,category:b.KZ},url:`/mod/assign/view.php?action=editsubmission&id=${n.moduleId}`})}catch(i){C.CoreAlerts.showError(i,{default:"Error getting assigment data."}),n.leaveWithoutCheck()}}))()}startSubmissionIfNeeded(n,i){var s=this;return(0,e.A)((function*(){if(!s.assign||!s.assign.timelimit)return n;if(s.userSubmission&&!g.AddonModAssign.isNewOrReopenedSubmission(s.userSubmission.status))return n;yield g.AddonModAssign.startSubmission(s.assign.id),u.z.trigger(b.dl,{assignmentId:s.assign.id},a.CoreSites.getCurrentSiteId());const e=yield g.AddonModAssign.getSubmissionStatus(s.assign,{...i,readingStrategy:2});return s.userSubmission=g.AddonModAssign.getSubmissionObjectFromAttempt(s.assign,e.lastattempt),e}))()}getInputData(){return m.R.getDataFromForm(document.forms["addon-mod_assign-edit-form"])}hasDataChanged(){var n=this;return(0,e.A)((function*(){const i=yield S.CoreLoadings.show(),s=n.getInputData();return c.AddonModAssignHelper.hasSubmissionDataChanged(n.assign,n.userSubmission,s).finally((()=>{i.dismiss()}))}))()}leaveWithoutCheck(){this.forceLeave=!0,d.CoreNavigator.back()}prepareSubmissionData(n){var i=this;return(0,e.A)((function*(){i.saveOffline=i.hasOffline;try{return yield c.AddonModAssignHelper.prepareSubmissionPluginData(i.assign,i.userSubmission,n,i.hasOffline)}catch(s){if(!i.saveOffline&&!f.CoreWSError.isWebServiceError(s))return i.saveOffline=!0,c.AddonModAssignHelper.prepareSubmissionPluginData(i.assign,i.userSubmission,n,!0);throw s}}))()}save(){var n=this;return(0,e.A)((function*(){if(!(yield n.hasDataChanged()))return n.leaveWithoutCheck(),void 0;try{yield n.saveSubmission(),n.leaveWithoutCheck()}catch(n){C.CoreAlerts.showError(n,{default:"Error saving submission."})}}))()}saveSubmission(){var n=this;return(0,e.A)((function*(){const i=n.getInputData();if(n.submissionStatement&&(!i.submissionstatement||"false"===i.submissionstatement))throw l.HT.instant("addon.mod_assign.acceptsubmissionstatement");if(c.AddonModAssignHelper.isSubmissionEmptyForEdit(n.assign,n.userSubmission,i))throw l.HT.instant("addon.mod_assign.submissionempty");let s=yield S.CoreLoadings.show(),e=-1;try{e=yield c.AddonModAssignHelper.getSubmissionSizeForEdit(n.assign,n.userSubmission,i)}catch(n){e=-1}s.dismiss();try{yield o.CoreFileUploaderHelper.confirmUploadFile(e,!0,!0),s=yield S.CoreLoadings.show("core.sending",!0);const t=yield n.prepareSubmissionData(i);if(!Object.keys(t).length)return;let d;n.saveOffline?(d=!1,yield p.AddonModAssignOffline.saveSubmission(n.assign.id,n.courseId,t,n.userSubmission.timemodified,!n.assign.submissiondrafts,n.userId)):d=yield g.AddonModAssign.saveSubmission(n.assign.id,n.courseId,t,n.userSubmission.timemodified,!!n.assign.submissiondrafts,n.userId),c.AddonModAssignHelper.clearSubmissionPluginTmpData(n.assign,n.userSubmission,i),d&&u.z.trigger(u.z.ACTIVITY_DATA_SENT,{module:b.KZ}),m.R.triggerFormSubmittedEvent(n.formElement,d,a.CoreSites.getCurrentSiteId()),u.z.trigger(b.Ad,{assignmentId:n.assign.id,submissionId:n.userSubmission.id,userId:n.userId},a.CoreSites.getCurrentSiteId()),n.assign.submissiondrafts||u.z.trigger(b._K,{assignmentId:n.assign.id,submissionId:n.userSubmission.id,userId:n.userId},a.CoreSites.getCurrentSiteId())}finally{s.dismiss()}}))()}timeUp(){var n=this;return(0,e.A)((function*(){n.timeUpToast=yield h.CoreToasts.show({message:l.HT.instant("addon.mod_assign.caneditsubmission"),duration:h.ToastDuration.STICKY,buttons:[l.HT.instant("core.dismiss")],cssClass:"core-danger-toast"})}))()}ngOnDestroy(){var n;this.isDestroyed=!0,null===(n=this.timeUpToast)||void 0===n||n.dismiss(),this.assign&&r.CoreSync.unblockOperation(b.AC,this.assign.id)}}return(n=AddonModAssignEditPage).ɵfac=function AddonModAssignEditPage_Factory(i){return new(i||n)(T.rXU(y.nX))},n.ɵcmp=T.VBU({type:n,selectors:[["page-addon-mod-assign-edit"]],viewQuery:function AddonModAssignEditPage_Query(n,i){if(1&n&&T.GBs($,5),2&n){let n;T.mGM(n=T.lsd())&&(i.formElement=n.first)}},standalone:!0,features:[T.aNF],decls:15,vars:11,consts:[["editSubmissionForm",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[4,"ngIf"],["timeUpText","00:00:00",3,"endTime","timerText","align","timeLeftClassThreshold","underTimeClassThresholds","finished",4,"ngIf"],["class","ion-text-wrap",4,"ngIf"],["name","addon-mod_assign-edit-form"],[3,"assign","submission","plugin","edit","allowOffline",4,"ngFor","ngForOf"],["timeUpText","00:00:00",3,"finished","endTime","timerText","align","timeLeftClassThreshold","underTimeClassThresholds"],[1,"ion-text-wrap"],["contextLevel","module",3,"text","component","componentId","contextInstanceId","courseId"],[3,"file","component","componentId",4,"ngFor","ngForOf"],[3,"file","component","componentId"],["name","submissionstatement",3,"ngModelChange","ngModel"],[3,"text","filter"],["type","hidden","name","submissionstatement",3,"ngModel"],[3,"assign","submission","plugin","edit","allowOffline"]],template:function AddonModAssignEditPage_Template(n,i){1&n&&(T.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),T.nrm(3,"ion-back-button",2),T.nI1(4,"translate"),T.k0s(),T.j41(5,"ion-title")(6,"h1"),T.nrm(7,"core-format-text",3),T.k0s()(),T.j41(8,"ion-buttons",4)(9,"ion-button",5),T.bIt("click",(function AddonModAssignEditPage_Template_ion_button_click_9_listener(){return i.save()})),T.EFF(10),T.nI1(11,"translate"),T.k0s()()()(),T.j41(12,"ion-content")(13,"core-loading",6),T.DNE(14,AddonModAssignEditPage_ion_list_14_Template,8,5,"ion-list",7),T.k0s()()),2&n&&(T.R7$(3),T.Y8G("text",T.bMT(4,7,"core.back")),T.R7$(4),T.Y8G("text",i.title)("contextInstanceId",i.moduleId)("courseId",i.courseId),T.R7$(3),T.SpI(" ",T.bMT(11,9,"core.save")," "),T.R7$(3),T.Y8G("hideUntil",i.loaded),T.R7$(),T.Y8G("ngIf",i.userSubmission&&i.userSubmission.plugins&&i.userSubmission.plugins.length))},dependencies:[v.n,E.Sq,E.bT,P.qT,P.me,P.BC,P.cb,P.vS,P.cV,x.Jm,x.QW,x.eY,x.W9,x.eU,x.uz,x.he,x.nf,x.BC,x.ai,x.hB,x.el,G.t,w.R,O.G,k.B,D.i,F.T,R.D9,M.AddonModAssignSubmissionPluginComponent],styles:["[_nghost-%COMP%]   core-timer.core-timer-under-300[_ngcontent-%COMP%]{--timer-background: var(--danger-tint);--timer-text-color: var(--danger-shade)}[_nghost-%COMP%]   core-timer.core-timer-under-900[_ngcontent-%COMP%]{--timer-background: var(--warning-tint);--timer-text-color: var(--warning-shade)}"]}),AddonModAssignEditPage})()}}]);