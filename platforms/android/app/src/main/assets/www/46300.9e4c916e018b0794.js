"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[46300],{6677:(e,r,n)=>{n.d(r,{C:()=>I});var t=n(10467),i=n(42008),a=n(49446),d=n(37690),o=n(97254),s=n(82308),c=n(94455),l=n(52749),y=n(48966),u=n(49588),f=n(58364),g=n(79555),E=n(49882),p=n(23917),S=n(57934),h=n(57587),D=n(95209),v=n(75383),m=n(55554),A=n(43411),b=n(54438);let C=(()=>{var e;class AddonModDataSyncProvider extends d.L{constructor(){super("AddonModDataSyncProvider"),this.componentTranslatableString="data"}hasDataToSync(e,r){return h.i.hasOfflineData(e,r)}syncAllDatabases(e,r){return this.syncOnSites("all databases",(e=>this.syncAllDatabasesFunc(!!r,e)),e)}syncAllDatabasesFunc(e,r){var n=this;return(0,t.A)((function*(){const i=[];i.push(h.i.getAllEntries(r).then(function(){var i=(0,t.A)((function*(i){let a=i.map((e=>e.dataid));a=a.filter(((e,r)=>a.indexOf(e)==r));const d=a.map(function(){var i=(0,t.A)((function*(t){const i=e?yield n.syncDatabase(t,r):yield n.syncDatabaseIfNeeded(t,r);i&&i.updated&&E.z.trigger(D.a9,{dataId:t,warnings:i.warnings},r)}));return function(e){return i.apply(this,arguments)}}());yield Promise.all(d)}));return function(e){return i.apply(this,arguments)}}())),i.push(n.syncRatings(void 0,e,r)),yield Promise.all(i)}))()}syncDatabaseIfNeeded(e,r){var n=this;return(0,t.A)((function*(){if(yield n.isSyncNeeded(e,r))return n.syncDatabase(e,r)}))()}syncDatabase(e,r){r=r||l.CoreSites.getCurrentSiteId();const n=this.getOngoingSync(e,r);if(n)return n;if(y.CoreSync.isBlocked(D.zc,e,r))throw this.logger.debug(`Cannot sync database '${e}' because it is blocked.`),new i.D(g.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));this.logger.debug(`Try to sync data '${e}' in site ${r}'`);const t=this.performSyncDatabase(e,r);return this.addOngoingSync(e,t,r)}performSyncDatabase(e,r){var n=this;return(0,t.A)((function*(){yield m.g.ignoreErrors(o.CoreCourseLogHelper.syncActivity(D.$W,e,r));const t={warnings:[],updated:!1},i=yield m.g.ignoreErrors(h.i.getDatabaseEntries(e,r),[]);if(!i.length)return yield m.g.ignoreErrors(n.setSyncTime(e,r)),t;if(!c.WE.isOnline())throw new a.CoreNetworkError;const d=i[0].courseid,s=yield p.$.getDatabaseById(d,e,{siteId:r}),l={};i.forEach((e=>{void 0===l[e.entryid]&&(l[e.entryid]=[]),l[e.entryid].push(e)}));const y=f.T.toArray(l).map((e=>n.syncEntry(s,e,t,r)));return yield Promise.all(y),t.updated&&(yield m.g.ignoreErrors(p.$.invalidateContent(s.coursemodule,d,r))),yield m.g.ignoreErrors(n.setSyncTime(e,r)),t}))()}syncEntry(e,r,n,i){var a=this;return(0,t.A)((function*(){const t=yield a.performSyncEntry(e,r,n,i);t.discardError&&a.addOfflineDataDeletedWarning(n.warnings,e.name,t.discardError),E.z.trigger(D.a9,{dataId:e.id,entryId:t.entryId,offlineEntryId:t.offlineId,warnings:n.warnings,deleted:t.deleted},i)}))()}performSyncEntry(e,r,n,i){return(0,t.A)((function*(){let a=r[0].entryid;const d={deleted:!1,entryId:a},o=r.find((e=>e.action==D.Z4.ADD||e.action==D.Z4.EDIT)),s=r.find((e=>e.action==D.Z4.APPROVE||e.action==D.Z4.DISAPPROVE)),c=r.find((e=>e.action==D.Z4.DELETE)),l={cmId:e.coursemodule,readingStrategy:2,siteId:i};let y=0;if(a>0)try{y=(yield p.$.getEntry(e.id,a,l)).entry.timemodified}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;y=-1}else o?(d.offlineId=a,y=0):y=-1;if(y<0||y>=r[0].timemodified)return n.updated=!0,d.discardError=g.HT.instant("addon.mod_data.warningsubmissionmodified"),yield h.i.deleteAllEntryActions(e.id,a,i),d;if(c){try{yield p.$.deleteEntryOnline(a,i),d.deleted=!0}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;d.discardError=u.CoreErrorHelper.getErrorMessageFromError(e)}return n.updated=!0,yield h.i.deleteAllEntryActions(c.dataid,c.entryid,i),d}if(o){try{if(yield Promise.all(o.fields.map(function(){var e=(0,t.A)((function*(e){const r=v.Ni.parseJSON(e.value||"",null);if(r&&(r.online||r.offline)){let n=r.online||[];const t=r.offline?yield S.r.getStoredFiles(o.dataid,a,e.fieldid):[];n=n.concat(t);const d=yield S.r.uploadOrStoreFiles(o.dataid,0,a,e.fieldid,n,!1,i);e.value=JSON.stringify(d)}}));return function(r){return e.apply(this,arguments)}}())),o.action==D.Z4.ADD){const e=yield p.$.addEntryOnline(o.dataid,o.fields,o.groupid,i);a=e.newentryid,d.entryId=a}else yield p.$.editEntryOnline(a,o.fields,i)}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;d.discardError=u.CoreErrorHelper.getErrorMessageFromError(e)}n.updated=!0,yield h.i.deleteEntry(o.dataid,o.entryid,o.action,i)}if(s){try{yield p.$.approveEntryOnline(a,s.action==D.Z4.APPROVE,i)}catch(e){if(!A.CoreWSError.isWebServiceError(e))throw e;d.discardError=u.CoreErrorHelper.getErrorMessageFromError(e)}n.updated=!0,yield h.i.deleteEntry(s.dataid,s.entryid,s.action,i)}return d}))()}syncRatings(e,r,n){var i=this;return(0,t.A)((function*(){n=n||l.CoreSites.getCurrentSiteId();const t=yield s.CoreRatingSync.syncRatings("mod_data","entry","module",e,0,r,n);let a=!1;const d=[],o=t.map((e=>p.$.getDatabase(e.itemSet.courseId,e.itemSet.instanceId,{siteId:n}).then((r=>{const t=[];return e.updated.length&&(a=!0,e.updated.forEach((e=>{t.push(p.$.invalidateEntryData(r.id,e,n))}))),e.warnings.length&&e.warnings.forEach((e=>{i.addOfflineDataDeletedWarning(d,r.name,e)})),m.g.allPromises(t)}))));return yield Promise.all(o),{updated:a,warnings:d}}))()}}return(e=AddonModDataSyncProvider).ɵfac=function AddonModDataSyncProvider_Factory(r){return new(r||e)},e.ɵprov=b.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataSyncProvider})();const I=(0,g.Qd)(C)},46300:(e,r,n)=>{n.r(r),n.d(r,{AddonModDataSyncCronHandler:()=>s,AddonModDataSyncCronHandlerLazyService:()=>o});var t=n(79555),i=n(6677),a=n(92145),d=n(54438);let o=(()=>{var e;class AddonModDataSyncCronHandlerLazyService extends a.F{execute(e,r){return i.C.syncAllDatabases(e,r)}getInterval(){return i.C.syncInterval}}return(e=AddonModDataSyncCronHandlerLazyService).ɵfac=(()=>{let r;return function AddonModDataSyncCronHandlerLazyService_Factory(n){return(r||(r=d.xGo(e)))(n||e)}})(),e.ɵprov=d.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModDataSyncCronHandlerLazyService})();const s=(0,t.Qd)(o)}}]);