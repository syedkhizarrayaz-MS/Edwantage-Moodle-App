"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[41450,73312],{41450:(t,e,n)=>{n.r(e),n.d(e,{CoreEditorRichTextEditorComponent:()=>A});var r=n(10467),o=n(54438),i=n(86654),a=n(68162),s=n(49882),l=n(53794),d=n(82907),c=n(91416),u=n(52749),m=n(64502),f=n(73312),h=n(79555),C=n(8014),v=n(81690),g=n(88793),p=n(62393),y=n(64422),E=n(47551),I=n(55554),x=n(35161),D=n(2910),b=n(89417);let A=(()=>{var t;class CoreEditorRichTextEditorComponent{constructor(t,e){this.content=t,this.placeholder="",this.name="core-rich-text-editor",this.autoSave=!0,this.contentChanged=new o.bkB,this.editorComponentData={},this.setContentId=0,this.lastDraft="",this.draftWasRestored=!1,this.pageInstance=`app_${Date.now()}`,this.element=e.nativeElement}clearText(){var t;this.setContent(""),null===(t=this.control)||void 0===t||t.setValue(null,{emitEvent:!1}),this.contentChanged.emit(null)}ngOnInit(){var t=this;return(0,r.A)((function*(){t.editorComponentClass=yield m.a.getEditorComponentClass(),t.editorComponentData={name:t.name,placeholder:t.placeholder,component:t.component,componentId:t.componentId,contextLevel:t.contextLevel,contextInstanceId:t.contextInstanceId,onChange:t.onChange.bind(t)}}))()}onChange(t){h.SK.run((()=>{if(d.y.htmlIsBlank(t)){var e;null===(e=this.control)||void 0===e||e.setValue(null,{emitEvent:!1}),this.contentChanged.emit(null)}else{var n,r;const e=document.createElement("template");e.innerHTML=t,this.restoreExternalContent(e.content),t=e.innerHTML,null===(n=this.control)||void 0===n||n.setValue(t,{emitEvent:!1}),null===(r=this.control)||void 0===r||r.markAsDirty(),this.contentChanged.emit(t)}}))}ngAfterViewInit(){var t=this;return(0,r.A)((function*(){var e,n,r;t.elementId&&(t.elementId="id_"+t.elementId,t.element.setAttribute("id",t.elementId)),t.maximizeEditorSize(),t.setupIonItem(),t.setContent(null!==(e=null===(n=t.control)||void 0===n?void 0:n.value)&&void 0!==e?e:""),t.shouldAutoSaveDrafts()&&(t.restoreDraft(),t.autoSaveDrafts(),t.deleteDraftOnSubmitOrCancel()),t.resizeListener=d.y.onWindowResize((()=>{t.onWindowResize()}),50),t.controlSubscription=null===(r=t.control)||void 0===r?void 0:r.valueChanges.subscribe((e=>{t.onControlValueChange(e)})),t.keyboardObserver=s.z.on(s.z.KEYBOARD_CHANGE,(()=>{t.maximizeEditorSize()}))}))()}ngOnDestroy(){var t,e,n,r,o;null===(t=this.resizeListener)||void 0===t||t.off(),null===(e=this.keyboardObserver)||void 0===e||e.off(),null===(n=this.controlSubscription)||void 0===n||n.unsubscribe(),null===(r=this.resetObserver)||void 0===r||r.off(),null===(o=this.labelObserver)||void 0===o||o.disconnect(),clearInterval(this.autoSaveInterval)}onWindowResize(){var t=this;return(0,r.A)((function*(){yield l.H.waitForResizeDone(),yield t.maximizeEditorSize(),yield t.dynamicComponent.ready(),yield t.dynamicComponent.callComponentMethod("onResize")}))()}onControlValueChange(t){var e;if(this.draftWasRestored&&this.originalContent===t)return null===(e=this.control)||void 0===e||e.setValue(this.lastDraft,{emitEvent:!1}),this.contentChanged.emit(this.lastDraft),void 0;this.setContent(null!=t?t:""),this.originalContent=null!=t?t:void 0,this.lastDraft=null!=t?t:"",f.CoreEditorOffline.saveDraft(this.contextLevel||"system",this.contextInstanceId||0,this.elementId||"",this.draftExtraParams||{},this.pageInstance,this.lastDraft,this.originalContent)}shouldAutoSaveDrafts(){return!!u.CoreSites.getCurrentSite()&&this.autoSave&&void 0!==this.contextLevel&&void 0!==this.contextInstanceId&&void 0!==this.elementId}restoreDraft(){var t=this;return(0,r.A)((function*(){var e;let n;try{n=yield f.CoreEditorOffline.resumeDraft(t.contextLevel||"system",t.contextInstanceId||0,t.elementId||"",t.draftExtraParams||{},t.pageInstance,t.originalContent)}catch{}if(void 0===n)return;let r=null!==(e=n.drafttext)&&void 0!==e?e:"";d.y.htmlIsBlank(r)&&(r=""),""!==r&&t.control&&r!=t.control.value&&(t.setContent(r),t.control.setValue(r,{emitEvent:!1}),t.contentChanged.emit(r),t.lastDraft=r,t.draftWasRestored=!0,t.originalContent=n.originalcontent,n.drafttext!=n.originalcontent&&E.CoreToasts.show({message:"core.editor.textrecovered",translateMessage:!0}))}))()}autoSaveDrafts(){var t=this;this.autoSaveInterval=window.setInterval((0,r.A)((function*(){var e;if(!t.control)return;const n=null!==(e=t.control.value)&&void 0!==e?e:"";if(t.lastDraft!==n)try{yield f.CoreEditorOffline.saveDraft(t.contextLevel||"system",t.contextInstanceId||0,t.elementId||"",t.draftExtraParams||{},t.pageInstance,n,t.originalContent),t.lastDraft=n,E.CoreToasts.show({message:"core.editor.autosavesucceeded",translateMessage:!0})}catch{}})),CoreEditorRichTextEditorComponent.DRAFT_AUTOSAVE_FREQUENCY)}deleteDraftOnSubmitOrCancel(){var t=this;this.resetObserver=s.z.on(s.z.FORM_ACTION,function(){var e=(0,r.A)((function*(e){const n=t.element.closest("form");if(e.form&&n&&e.form===n)try{yield f.CoreEditorOffline.deleteDraft(t.contextLevel||"system",t.contextInstanceId||0,t.elementId||"",t.draftExtraParams||{})}catch(t){}}));return function(t){return e.apply(this,arguments)}}(),u.CoreSites.getCurrentSiteId())}maximizeEditorSize(){var t=this;return(0,r.A)((function*(){yield t.waitLoadingsDone();const e=(yield t.getBlankHeightInContent())+t.element.getBoundingClientRect().height;e>CoreEditorRichTextEditorComponent.MIN_HEIGHT?t.element.style.setProperty("--core-rte-height",e-1+"px"):t.element.style.removeProperty("--core-rte-height")}))()}getBlankHeightInContent(){var t=this;return(0,r.A)((function*(){yield d.y.waitToBeInDOM(t.element),yield l.H.nextTicks(10);let e=t.element.closest("ion-content");const n=yield d.y.getContentHeight(t.content);let r=0;if(e)for(;0===r&&null!==(o=e)&&void 0!==o&&o.children;){var o;const t=Array.from(e.children).filter((t=>"fixed"!==t.slot&&!t.classList.contains("core-loading-container")));r=t.map((t=>t.getBoundingClientRect().height)).reduce(((t,e)=>t+e),0),e=t[0]}return n-r}))()}setContent(t){var e=this;return(0,r.A)((function*(){const n=++e.setContentId,r=(0,x.B)(t);d.y.replaceTags(r,["b","i"],["strong","em"]);try{yield e.treatExternalContent(r)}finally{yield e.dynamicComponent.ready(),n===e.setContentId&&e.dynamicComponent.callComponentMethod("setContent",r.innerHTML)}}))()}treatExternalContent(t){var e=this;return(0,r.A)((function*(){if(!u.CoreSites.isLoggedIn())return;const n=Array.from(t.querySelectorAll("img")),o=u.CoreSites.getCurrentSite(),i=u.CoreSites.getCurrentSiteId(),a=!o||o.canDownloadFiles(),s=n.map(function(){var t=(0,r.A)((function*(t){if(t.getAttribute("data-original-src"))return;const n=t.src;if(!n||!C.F.isDownloadableUrl(n)||!a&&null!=o&&o.isSitePluginFileUrl(n))return;const r=yield g.CoreFilepool.getSrcByUrl(i,n,e.component,e.componentId);t.getAttribute("data-original-src")||(t.setAttribute("data-original-src",t.src),t.setAttribute("src",r))}));return function(e){return t.apply(this,arguments)}}());yield I.g.allPromises(s)}))()}restoreExternalContent(t){if(!u.CoreSites.isLoggedIn())return;Array.from(t.querySelectorAll("img")).forEach((t=>{const e=t.getAttribute("data-original-src");e&&(t.setAttribute("src",e),t.removeAttribute("data-original-src"))}))}waitLoadingsDone(){var t=this;return(0,r.A)((function*(){const e=t.element.closest(".ion-page");e&&(yield p.D.waitDirectivesReady(e,"core-loading",y.R))}))()}setupIonItem(){var t=this;const e=this.element.closest("ion-item");if(!e)return;e.classList.add("item-rte");const n=e.querySelector("ion-label");if(!n)return;const o=function(){var e=(0,r.A)((function*(){var e;yield t.dynamicComponent.ready(),t.editorComponentData.ariaLabelledBy=null!==(e=n.getAttribute("id"))&&void 0!==e?e:void 0}));return function updateArialabelledBy(){return e.apply(this,arguments)}}();this.labelObserver=new MutationObserver(o),this.labelObserver.observe(n,{attributes:!0,attributeFilter:["id"]}),n.getAttribute("id")||n.setAttribute("id","rte-"+v.j.getUniqueId("CoreEditorRichTextEditor")),o()}}return(t=CoreEditorRichTextEditorComponent).MIN_HEIGHT=200,t.DRAFT_AUTOSAVE_FREQUENCY=3e4,t.ɵfac=function CoreEditorRichTextEditorComponent_Factory(e){return new(e||t)(o.rXU(D.W9,8),o.rXU(o.aKT))},t.ɵcmp=o.VBU({type:t,selectors:[["core-rich-text-editor"]],viewQuery:function CoreEditorRichTextEditorComponent_Query(t,e){if(1&t&&o.GBs(a.m,5),2&t){let t;o.mGM(t=o.lsd())&&(e.dynamicComponent=t.first)}},inputs:{placeholder:"placeholder",control:"control",name:"name",component:"component",componentId:"componentId",autoSave:[o.Mj6.HasDecoratorInputTransform,"autoSave","autoSave",c.G],contextLevel:"contextLevel",contextInstanceId:"contextInstanceId",elementId:"elementId",draftExtraParams:"draftExtraParams"},outputs:{contentChanged:"contentChanged"},standalone:!0,features:[o.GFd,o.aNF],decls:3,vars:4,consts:[["dynamicComponent",""],[3,"component","data"],["type","hidden",3,"name","formControl"]],template:function CoreEditorRichTextEditorComponent_Template(t,e){1&t&&o.nrm(0,"core-dynamic-component",1,0)(2,"input",2),2&t&&(o.Y8G("component",e.editorComponentClass)("data",e.editorComponentData),o.R7$(2),o.Y8G("name",e.name)("formControl",e.control))},dependencies:[i.n,b.me,b.BC,b.l_,a.m],styles:["[_nghost-%COMP%]{display:flex;flex-direction:column;justify-content:stretch;align-items:stretch;width:100%;height:var(--core-rte-height, auto);min-height:40vh}.keyboard-is-open[_nghost-%COMP%], .keyboard-is-open   [_nghost-%COMP%]{min-height:200px}.item[_nghost-%COMP%], .item   [_nghost-%COMP%]{margin-bottom:12px}.item-label-stacked[_nghost-%COMP%], .item-label-stacked   [_nghost-%COMP%]{margin-top:12px}"]}),CoreEditorRichTextEditorComponent})()},73312:(t,e,n)=>{n.r(e),n.d(e,{CoreEditorOffline:()=>m,CoreEditorOfflineProvider:()=>u});var r=n(10467),o=n(75629),i=n(52749),a=n(58364),s=n(79555),l=n(6787),d=n(63316),c=n(54438);let u=(()=>{var t;class CoreEditorOfflineProvider{constructor(){this.logger=l.CoreLogger.getInstance("CoreEditorOfflineProvider")}deleteDraft(t,e,n,o,a){var s=this;return(0,r.A)((function*(){try{const r=yield i.CoreSites.getSiteDb(a),l=s.fixDraftPrimaryData(t,e,n,o);yield r.deleteRecords(d.T,l)}catch{}}))()}fixDraftPrimaryData(t,e,n,r){return{contextlevel:t,contextinstanceid:e,elementid:n,extraparams:a.T.sortAndStringify(r||{})}}getDraft(t,e,n,o,a){var s=this;return(0,r.A)((function*(){const r=yield i.CoreSites.getSiteDb(a),l=s.fixDraftPrimaryData(t,e,n,o);return r.getRecord(d.T,l)}))()}resumeDraft(t,e,n,o,a,s,l){var c=this;return(0,r.A)((function*(){try{const r=yield c.getDraft(t,e,n,o,l);try{const t=yield i.CoreSites.getSiteDb(l);r.pageinstance=a,r.timemodified=Date.now(),s&&r.originalcontent!=s&&(r.originalcontent=s,r.drafttext=""),yield t.insertRecord(d.T,r)}catch{}return r}catch{yield c.saveDraft(t,e,n,o,a,"",s,l)}}))()}saveDraft(t,e,n,a,s,l,c,u){var m=this;return(0,r.A)((function*(){let r,f=Date.now();try{r=yield m.getDraft(t,e,n,a,u),f=r.timecreated||f}catch(t){}if(r){if(r.pageinstance!=s)throw m.logger.warn(`Discarding draft because of pageinstance. Context '${t}' '${e}', element '${n}'`),new o.CoreError("Draft was discarded because it was modified in another page.");c||(c=r.originalcontent)}const h=yield i.CoreSites.getSiteDb(u),C=m.fixDraftPrimaryData(t,e,n,a);C.drafttext=(l||"").trim(),C.pageinstance=s,C.timecreated=f,C.timemodified=Date.now(),c&&(C.originalcontent=c),yield h.insertRecord(d.T,C)}))()}}return(t=CoreEditorOfflineProvider).ɵfac=function CoreEditorOfflineProvider_Factory(e){return new(e||t)},t.ɵprov=c.jDH({token:t,factory:t.ɵfac,providedIn:"root"}),CoreEditorOfflineProvider})();const m=(0,s.Qd)(u)},64502:(t,e,n)=>{n.d(e,{a:()=>s});var r=n(10467),o=n(79555),i=n(54438);let a=(()=>{var t;class CoreEditorServiceProvider{getEditorComponentClass(){return(0,r.A)((function*(){return(yield n.e(31777).then(n.bind(n,31777))).CoreEditorClassicEditorComponent}))()}getLicenseInformation(){return(0,r.A)((function*(){return[]}))()}getSettingsComponentClass(){return(0,r.A)((function*(){}))()}}return(t=CoreEditorServiceProvider).ɵfac=function CoreEditorServiceProvider_Factory(e){return new(e||t)},t.ɵprov=i.jDH({token:t,factory:t.ɵfac,providedIn:"root"}),CoreEditorServiceProvider})();const s=(0,o.Qd)(a)}}]);