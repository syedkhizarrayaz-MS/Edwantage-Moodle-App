"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[61781,80178],{61781:(e,o,t)=>{t.r(o),t.d(o,{default:()=>U});var s=t(10467),i=t(89417),r=t(75629),n=t(16082),d=t(45507),a=t(88436),l=t(15324),u=t(52749),m=t(48966),c=t(75383),h=t(43411),p=t(79555),f=t(49882),g=t(63153),b=t(67193),k=t(80178),A=t(26327),I=t(22693),v=t(81552),F=t(33014),w=t(82907),S=t(25572),y=t(41450),C=t(86654),_=t(55554),M=t(54438),E=t(60177),W=t(2910),T=t(95638),x=t(64422),R=t(17778),O=t(88246),P=t(43570),D=t(73955);const H=["editFormEl"];function AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template(e,o){if(1&e&&(M.j41(0,"ion-item")(1,"ion-label",13)(2,"div",14),M.EFF(3),M.nI1(4,"translate"),M.k0s()(),M.nrm(5,"core-rich-text-editor",15),M.nI1(6,"translate"),M.k0s()),2&e){const e=M.XpG(2);M.R7$(2),M.Y8G("core-mark-required",e.textRequired),M.R7$(),M.SpI(" ",M.bMT(4,9,"addon.mod_workshop.submissioncontent")," "),M.R7$(2),M.Y8G("control",e.editForm.controls.content)("placeholder",M.bMT(6,11,"addon.mod_workshop.submissioncontent"))("component",e.component)("componentId",e.componentId)("autoSave",!0)("contextInstanceId",e.module.id)("draftExtraParams",e.editorExtraParams)}}function AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template(e,o){if(1&e&&M.nrm(0,"core-attachments",16),2&e){const e=M.XpG(2);M.Y8G("files",e.attachments)("maxSize",e.workshop.maxbytes)("maxSubmissions",e.workshop.nattachments)("component",e.component)("componentId",e.workshop.coursemodule)("acceptedTypes",e.workshop.submissionfiletypes)("required",e.fileRequired)("courseId",e.workshop.course)}}function AddonModWorkshopEditSubmissionPage_form_16_Template(e,o){if(1&e&&(M.j41(0,"form",7,0)(2,"ion-item",8)(3,"ion-input",9),M.nI1(4,"translate"),M.j41(5,"div",10),M.EFF(6),M.nI1(7,"translate"),M.k0s()()(),M.DNE(8,AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template,7,13,"ion-item",11)(9,AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template,1,8,"core-attachments",12),M.k0s()),2&e){const e=M.XpG();M.Y8G("formGroup",e.editForm),M.R7$(3),M.Y8G("placeholder",M.bMT(4,6,"addon.mod_workshop.submissiontitle")),M.R7$(2),M.Y8G("core-mark-required",!0),M.R7$(),M.SpI(" ",M.bMT(7,8,"addon.mod_workshop.submissiontitle")," "),M.R7$(2),M.Y8G("ngIf",e.textAvailable),M.R7$(),M.Y8G("ngIf",e.fileAvailable)}}let U=(()=>{var e;class AddonModWorkshopEditSubmissionPage{constructor(e){this.fb=e,this.loaded=!1,this.component=v.Ug,this.editorExtraParams={},this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.attachments=[],this.submissionId=0,this.originalData={title:"",content:"",attachmentfiles:[]},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.userId=u.CoreSites.getCurrentSiteUserId(),this.siteId=u.CoreSites.getCurrentSiteId(),this.editForm=new i.gE({}),this.editForm.addControl("title",this.fb.control("",i.k0.required)),this.editForm.addControl("content",this.fb.control(""))}ngOnInit(){try{this.module=l.CoreNavigator.getRequiredRouteParam("module"),this.courseId=l.CoreNavigator.getRequiredRouteNumberParam("courseId"),this.access=l.CoreNavigator.getRequiredRouteParam("access"),this.submissionId=l.CoreNavigator.getRouteNumberParam("submissionId")||0}catch(e){return S.CoreAlerts.showError(e),l.CoreNavigator.back(),void 0}this.submissionId>0&&(this.editorExtraParams.id=this.submissionId),this.workshopId=this.module.instance,this.componentId=this.module.id,this.isDestroyed||m.CoreSync.blockOperation(v.Ug,this.workshopId),this.fetchSubmissionData()}canLeave(){var e=this;return(0,s.A)((function*(){var o;return e.forceLeave||(e.hasDataChanged()&&(yield S.CoreAlerts.confirmLeaveWithChanges()),null!==(o=e.submission)&&void 0!==o&&o.attachmentfiles&&n.CoreFileUploader.clearTmpFiles(e.submission.attachmentfiles),g.R.triggerFormCancelledEvent(e.formElement,e.siteId)),!0}))()}fetchSubmissionData(){var e=this;return(0,s.A)((function*(){try{if(e.workshop=yield b.AddonModWorkshop.getWorkshop(e.courseId,e.module.id),e.textAvailable=0!=e.workshop.submissiontypetext,e.textRequired=2==e.workshop.submissiontypetext,e.fileAvailable=0!=e.workshop.submissiontypefile,e.fileRequired=2==e.workshop.submissiontypefile,e.editForm.controls.content.setValidators(e.textRequired?i.k0.required:null),e.submissionId>0){e.editing=!0,e.submission=yield k.AddonModWorkshopHelper.getSubmissionById(e.workshopId,e.submissionId,{cmId:e.module.id,filter:!1,readingStrategy:3});if(!(e.userId==e.submission.authorid&&e.access.cansubmit&&e.access.modifyingsubmissionallowed))return e.forceLeavePage(),void 0}else if(!e.access.cansubmit||!e.access.creatingsubmissionallowed)return e.forceLeavePage(),void 0;const o=yield A.AddonModWorkshopOffline.getSubmissions(e.workshopId);o&&o.length?(e.hasOffline=!0,e.submission=yield k.AddonModWorkshopHelper.applyOfflineData(e.submission,o)):e.hasOffline=!1,e.submission&&(e.editForm.controls.title.setValue(e.submission.title),e.editForm.controls.content.setValue(a.CoreFileHelper.replacePluginfileUrls(e.submission.content,e.submission.contentfiles||[])),e.attachments=e.submission.attachmentfiles||[],e.originalData.title=e.editForm.controls.title.value,e.originalData.content=e.editForm.controls.content.value,e.originalData.attachmentfiles=[],(e.submission.attachmentfiles||[]).forEach((o=>{let t=d.CoreFile.getFileName(o);t||(t=a.CoreFileHelper.getFilenameFromPath(o)||""),e.originalData.attachmentfiles.push({filename:t,fileurl:"fileurl"in o?o.fileurl:""})}))),e.loaded=!0,e.logView()}catch(o){e.loaded=!1,S.CoreAlerts.showError(o,{default:p.HT.instant("core.course.errorgetmodule")}),e.forceLeavePage()}}))()}logView(){this.workshop&&I.OF.logEvent({type:I.qr.VIEW_ITEM,ws:this.editing?"mod_workshop_update_submission":"mod_workshop_add_submission",name:this.workshop.name,data:{id:this.workshop.id,submissionid:this.submissionId,category:"workshop"},url:`/mod/workshop/submission.php?cmid=${this.module.id}&id=${this.submissionId}&edit=on`})}forceLeavePage(){this.forceLeave=!0,l.CoreNavigator.back()}getInputData(){const e={title:this.editForm.value.title,content:"",attachmentfiles:[]};return this.textAvailable&&(e.content=this.editForm.value.content||""),this.fileAvailable&&(e.attachmentfiles=this.attachments),e}hasDataChanged(){if(!this.loaded)return!1;const e=this.getInputData();return!!(this.originalData.title!=e.title||this.textAvailable&&this.originalData.content!=e.content)||!!this.fileAvailable&&n.CoreFileUploader.areFileListDifferent(e.attachmentfiles,this.originalData.attachmentfiles)}save(){var e=this;return(0,s.A)((function*(){if(e.hasDataChanged())try{yield e.saveSubmission(),e.forceLeavePage()}catch{}else e.forceLeavePage()}))()}saveSubmission(){var e=this;return(0,s.A)((function*(){var o,t;const s=e.getInputData();if(!s.title)throw S.CoreAlerts.show({header:p.HT.instant("core.notice"),message:p.HT.instant("addon.mod_workshop.submissionrequiredtitle")}),new r.CoreError(p.HT.instant("addon.mod_workshop.submissionrequiredtitle"));const i=w.y.htmlIsBlank(s.content),d=!s.attachmentfiles.length;if(e.textRequired&&i||e.fileRequired&&d||i&&d)throw S.CoreAlerts.show({header:p.HT.instant("core.notice"),message:p.HT.instant("addon.mod_workshop.submissionrequiredcontent")}),new r.CoreError(p.HT.instant("addon.mod_workshop.submissionrequiredcontent"));let l=!1;const u=yield F.CoreLoadings.show("core.sending",!0),m=null===(o=e.submission)||void 0===o?void 0:o.id;s.content=a.CoreFileHelper.restorePluginfileUrls(s.content,(null===(t=e.submission)||void 0===t?void 0:t.contentfiles)||[]),e.textAvailable&&(s.content=c.Ni.formatHtmlLines(s.content));let I=!s.attachmentfiles.length;try{let o,t,i;try{o=yield k.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,s.attachmentfiles,!1)}catch(o){if(h.CoreWSError.isWebServiceError(o))throw o;l=!0,I=!0,t=yield k.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,s.attachmentfiles,!0)}if(l||e.fileAvailable||(o=void 0),e.editing)if(l)yield A.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,s.title,s.content,t,m,"update"),i=!1;else{if(!m)throw new r.CoreError("Submission cannot be updated without a submissionId");i=yield b.AddonModWorkshop.updateSubmission(e.workshopId,m,e.courseId,s.title,s.content,o,void 0,I)}else l?(yield A.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,s.title,s.content,t,void 0,"add"),i=!1):i=yield b.AddonModWorkshop.addSubmission(e.workshopId,e.courseId,s.title,s.content,o,void 0,I);g.R.triggerFormSubmittedEvent(e.formElement,!!i,e.siteId);const d={workshopId:e.workshopId};i&&(A.AddonModWorkshopOffline.deleteSubmissionAction(e.workshopId,e.editing?"update":"add"),k.AddonModWorkshopHelper.deleteSubmissionStoredFiles(e.workshopId,e.siteId),d.submissionId=i),f.z.trigger(f.z.ACTIVITY_DATA_SENT,{module:"workshop"}),i&&(yield _.g.ignoreErrors(b.AddonModWorkshop.invalidateSubmissionData(e.workshopId,i))),f.z.trigger(v.AZ,d,e.siteId),n.CoreFileUploader.clearTmpFiles(s.attachmentfiles)}catch(e){S.CoreAlerts.showError(e,{default:"Cannot save submission"})}finally{u.dismiss()}}))()}getFilesComponentId(){return`${this.workshopId}_${this.submissionId>0?this.submissionId:"newsub"}`}ngOnDestroy(){this.isDestroyed=!0,m.CoreSync.unblockOperation(v.Ug,this.workshopId)}}return(e=AddonModWorkshopEditSubmissionPage).ɵfac=function AddonModWorkshopEditSubmissionPage_Factory(o){return new(o||e)(M.rXU(i.ok))},e.ɵcmp=M.VBU({type:e,selectors:[["page-addon-mod-workshop-edit-submission"]],viewQuery:function AddonModWorkshopEditSubmissionPage_Query(e,o){if(1&e&&M.GBs(H,5),2&e){let e;M.mGM(e=M.lsd())&&(o.formElement=e.first)}},standalone:!0,features:[M.aNF],decls:17,vars:14,consts:[["editFormEl",""],["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click","ariaLabel"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"ion-text-wrap"],["labelPlacement","stacked","name","title","type","text","formControlName","title",3,"placeholder"],["slot","label",3,"core-mark-required"],[4,"ngIf"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId",4,"ngIf"],["position","stacked"],[3,"core-mark-required"],["name","content","contextLevel","module","elementId","content_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId"]],template:function AddonModWorkshopEditSubmissionPage_Template(e,o){1&e&&(M.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),M.nrm(3,"ion-back-button",2),M.nI1(4,"translate"),M.k0s(),M.j41(5,"ion-title")(6,"h1"),M.EFF(7),M.nI1(8,"translate"),M.k0s()(),M.j41(9,"ion-buttons",3)(10,"ion-button",4),M.nI1(11,"translate"),M.bIt("click",(function AddonModWorkshopEditSubmissionPage_Template_ion_button_click_10_listener(){return o.save()})),M.EFF(12),M.nI1(13,"translate"),M.k0s()()()(),M.j41(14,"ion-content")(15,"core-loading",5),M.DNE(16,AddonModWorkshopEditSubmissionPage_form_16_Template,10,10,"form",6),M.k0s()()),2&e&&(M.R7$(3),M.Y8G("text",M.bMT(4,6,"core.back")),M.R7$(4),M.JRh(M.bMT(8,8,"addon.mod_workshop.editsubmission")),M.R7$(3),M.Y8G("ariaLabel",M.bMT(11,10,"core.save")),M.R7$(2),M.SpI(" ",M.bMT(13,12,"core.save")," "),M.R7$(3),M.Y8G("hideUntil",o.loaded),M.R7$(),M.Y8G("ngIf",o.workshop))},dependencies:[C.n,E.bT,i.qT,i.BC,i.cb,W.Jm,W.QW,W.W9,W.eU,W.$w,W.uz,W.he,W.BC,W.ai,W.Gw,W.el,i.j4,i.JD,T.V,x.R,R.j,O.i,P.T,D.D9,y.CoreEditorRichTextEditorComponent],encapsulation:2}),AddonModWorkshopEditSubmissionPage})()},80178:(e,o,t)=>{t.r(o),t.d(o,{AddonModWorkshopHelper:()=>I,AddonModWorkshopHelperProvider:()=>A});var s=t(10467),i=t(75629),r=t(16082),n=t(45507),d=t(88436),a=t(52749),l=t(75383),u=t(81690),m=t(79555),c=t(65964),h=t(67193),p=t(26327),f=t(81552),g=t(55554),b=t(58364),k=t(54438);let A=(()=>{var e;class AddonModWorkshopHelperProvider{getTask(e,o){return e.find((e=>e.code==o))}isTaskDone(e,o){const t=this.getTask(e,o);return!t||!!t.completed}canSubmit(e,o,t){const s=e.useexamples&&1==e.examplesmode,i=o.canmanageexamples||0==e.examplesmode||this.isTaskDone(t,"examples");return e.phase>10&&o.cansubmit&&(!s||i)}canAssess(e,o){return!(e.useexamples&&2==e.examplesmode)||o.canmanageexamples}canAddFeedback(e,o){return 40===e.phase&&o.canoverridegrades}canEditAssessments(e,o){return 30===e.phase&&this.canAssess(e,o)&&o.assessingallowed&&o.canpeerassess}getUserSubmission(e,o={}){return(0,s.A)((function*(){const t=o.userId||a.CoreSites.getCurrentSiteUserId();return(yield h.AddonModWorkshop.getSubmissions(e,o)).find((e=>e.authorid==t))}))()}getSubmissionById(e,o,t={}){return(0,s.A)((function*(){try{return yield h.AddonModWorkshop.getSubmission(e,o,t)}catch{const s=(yield h.AddonModWorkshop.getSubmissions(e,t)).find((e=>e.id==o));if(!s)throw new i.CoreError("Submission not found");return s}}))()}getReviewerAssessmentById(e,o,t={}){return(0,s.A)((function*(){let s;try{s=yield h.AddonModWorkshop.getAssessment(e,o,t)}catch(i){if(s=(yield h.AddonModWorkshop.getReviewerAssessments(e,t)).find((e=>e.id===o)),!s)throw i}return s.form=yield h.AddonModWorkshop.getAssessmentForm(e,o,{cmId:t.cmId,siteId:t.siteId}),s}))()}getReviewerAssessments(e,o={}){var t=this;return(0,s.A)((function*(){o.siteId=o.siteId||a.CoreSites.getCurrentSiteId();const s=yield h.AddonModWorkshop.getReviewerAssessments(e,o),i=[];return s.forEach((s=>{const r=b.T.without(o,["canAssess","filter"]);i.push(t.getSubmissionById(e,s.submissionid,r).then((e=>{s.submission=e}))),i.push(h.AddonModWorkshop.getAssessmentForm(e,s.id,r).then((e=>{s.form=e})))})),yield Promise.all(i),s}))()}deleteSubmissionStoredFiles(e,o){return(0,s.A)((function*(){const t=yield p.AddonModWorkshopOffline.getSubmissionFolder(e,o);yield g.g.ignoreErrors(n.CoreFile.removeDir(t))}))()}storeSubmissionFiles(e,o,t){return(0,s.A)((function*(){const s=yield p.AddonModWorkshopOffline.getSubmissionFolder(e,t);return r.CoreFileUploader.storeFilesToUpload(s,o)}))()}uploadOrStoreSubmissionFiles(e,o,t,s){return t?this.storeSubmissionFiles(e,o,s):r.CoreFileUploader.uploadOrReuploadFiles(o,f.Ug,e,s)}getStoredSubmissionFiles(e,o){return(0,s.A)((function*(){const t=yield p.AddonModWorkshopOffline.getSubmissionFolder(e,o);return g.g.ignoreErrors(r.CoreFileUploader.getStoredFiles(t),[])}))()}getSubmissionFilesFromOfflineFilesObject(e,o,t){return(0,s.A)((function*(){const s=yield p.AddonModWorkshopOffline.getSubmissionFolder(o,t);return r.CoreFileUploader.getStoredFilesFromOfflineFilesObject(e,s)}))()}deleteAssessmentStoredFiles(e,o,t){return(0,s.A)((function*(){const s=yield p.AddonModWorkshopOffline.getAssessmentFolder(e,o,t);yield g.g.ignoreErrors(n.CoreFile.removeDir(s))}))()}storeAssessmentFiles(e,o,t,i){return(0,s.A)((function*(){const s=yield p.AddonModWorkshopOffline.getAssessmentFolder(e,o,i);return r.CoreFileUploader.storeFilesToUpload(s,t)}))()}uploadOrStoreAssessmentFiles(e,o,t,s,i){return s?this.storeAssessmentFiles(e,o,t,i):r.CoreFileUploader.uploadOrReuploadFiles(t,f.Ug,e,i)}getStoredAssessmentFiles(e,o,t){return(0,s.A)((function*(){const s=yield p.AddonModWorkshopOffline.getAssessmentFolder(e,o,t);return g.g.ignoreErrors(r.CoreFileUploader.getStoredFiles(s),[])}))()}getAssessmentFilesFromOfflineFilesObject(e,o,t,i){return(0,s.A)((function*(){const s=yield p.AddonModWorkshopOffline.getAssessmentFolder(o,t,i);return r.CoreFileUploader.getStoredFilesFromOfflineFilesObject(e,s)}))()}applyOfflineData(e,o=[]){var t=this;return(0,s.A)((function*(){if(0===o.length)return e;const s=null!=e?e:{id:0,workshopid:0,title:"",content:"",timemodified:0,example:!1,authorid:0,timecreated:0,contenttrust:0,attachment:0,published:!1,late:0};let i;const r=o[0].workshopid;return o.forEach((o=>{switch(o.action){case"add":case"update":s.title=o.title,s.content=d.CoreFileHelper.replacePluginfileUrls(o.content,(null==e?void 0:e.contentfiles)||[]),s.courseid=o.courseid,s.submissionmodified=o.timemodified/1e3,s.offline=!0,i=o.attachmentsid;break;case"delete":s.deleted=!0,s.submissionmodified=o.timemodified/1e3}})),s.attachmentfiles=i?yield t.getSubmissionFilesFromOfflineFilesObject(i,r):[],s}))()}prepareAssessmentData(e,o,t,i,r=0){return(0,s.A)((function*(){var s;if(2==e.overallfeedbackmode&&!t){throw{feedbackauthor:m.HT.instant("core.err_required")}}const n=(yield c.AddonWorkshopAssessmentStrategyDelegate.prepareAssessmentData(null!==(s=e.strategy)&&void 0!==s?s:"",o,i))||{};return n.feedbackauthor=t,n.feedbackauthorformat=l.C9,n.feedbackauthorattachmentsid=r,n.nodims=i.dimenssionscount,n}))()}realGradeValueHelper(e,o=0,t=0){return"string"==typeof e?e:null!=e?0===o?"0":(e=l.Ni.roundToDecimals(o*e/100,t),u.j.formatFloat(e)):void 0}realGradeValue(e,o){return o.grade=this.realGradeValueHelper(o.grade,e.grade,e.gradedecimals),o.gradinggrade=this.realGradeValueHelper(o.gradinggrade,e.gradinggrade,e.gradedecimals),o.gradinggradeover=this.realGradeValueHelper(o.gradinggradeover,e.gradinggrade,e.gradedecimals),o}showGrade(e){return null!=e}}return(e=AddonModWorkshopHelperProvider).ɵfac=function AddonModWorkshopHelperProvider_Factory(o){return new(o||e)},e.ɵprov=k.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWorkshopHelperProvider})();const I=(0,m.Qd)(A)}}]);