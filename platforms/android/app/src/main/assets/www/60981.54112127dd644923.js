"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[60981],{60981:(e,o,t)=>{t.r(o),t.d(o,{default:()=>U});var a=t(10467),n=t(74431),r=t(47423),s=t(86123),i=t(44682),d=t(94247),l=t(66110),u=t(87455),c=t(70526),g=t(33014),C=t(15324),p=t(52749),S=t(79555),m=t(24502),_=t(49882),f=t(25572),h=t(49588),w=t(86654),b=t(23803),y=t(26556),D=t(54438),I=t(60177),T=t(2910),A=t(64422),M=t(86198),R=t(58197),k=t(88246),E=t(43570),P=t(73955),v=t(78913);const _c0=e=>({name:e});function AddonStorageManagerCoursesStoragePage_div_11_Template(e,o){1&e&&(D.j41(0,"div",6)(1,"h2"),D.EFF(2),D.nI1(3,"translate"),D.k0s()()),2&e&&(D.R7$(2),D.JRh(D.bMT(3,1,"addon.storagemanager.alldata")))}function AddonStorageManagerCoursesStoragePage_ion_card_12_ion_badge_6_Template(e,o){if(1&e&&(D.j41(0,"ion-badge",9),D.EFF(1),D.nI1(2,"coreBytesToSize"),D.k0s()),2&e){const e=D.XpG(2);D.R7$(),D.JRh(D.bMT(2,1,e.spaceUsage.spaceUsage))}}function AddonStorageManagerCoursesStoragePage_ion_card_12_Template(e,o){if(1&e){const e=D.RV6();D.j41(0,"ion-card")(1,"ion-item",13)(2,"ion-label")(3,"p",14),D.EFF(4),D.nI1(5,"translate"),D.k0s(),D.DNE(6,AddonStorageManagerCoursesStoragePage_ion_card_12_ion_badge_6_Template,3,3,"ion-badge",15),D.k0s(),D.j41(7,"ion-button",16),D.nI1(8,"translate"),D.bIt("click",(function AddonStorageManagerCoursesStoragePage_ion_card_12_Template_ion_button_click_7_listener(o){D.eBV(e);const t=D.XpG();return D.Njj(t.deleteSiteStorage(o))})),D.nrm(9,"ion-icon",11),D.k0s()()()}if(2&e){const e=D.XpG();D.R7$(4),D.JRh(D.bMT(5,4,"addon.storagemanager.totalspaceusage")),D.R7$(2),D.Y8G("ngIf",e.spaceUsage.spaceUsage),D.R7$(),D.Y8G("hidden",e.spaceUsage.spaceUsage+e.spaceUsage.cacheEntries<=0),D.BMQ("aria-label",D.bMT(8,6,"addon.storagemanager.deleteallsitedata"))}}function AddonStorageManagerCoursesStoragePage_ion_item_29_p_4_Template(e,o){1&e&&(D.j41(0,"p",22),D.EFF(1),D.nI1(2,"translate"),D.k0s()),2&e&&(D.R7$(),D.SpI(" ",D.bMT(2,1,"core.downloading")," "))}function AddonStorageManagerCoursesStoragePage_ion_item_29_Template(e,o){if(1&e){const e=D.RV6();D.j41(0,"ion-item",17),D.bIt("click",(function AddonStorageManagerCoursesStoragePage_ion_item_29_Template_ion_item_click_0_listener(){const o=D.eBV(e).$implicit,t=D.XpG();return D.Njj(t.openCourse(o.id,o.title))})),D.j41(1,"ion-label",18)(2,"p",8),D.nrm(3,"core-format-text",19),D.k0s(),D.DNE(4,AddonStorageManagerCoursesStoragePage_ion_item_29_p_4_Template,3,3,"p",20),D.j41(5,"ion-badge",9),D.EFF(6),D.nI1(7,"coreBytesToSize"),D.k0s()(),D.j41(8,"ion-button",21),D.nI1(9,"translate"),D.bIt("click",(function AddonStorageManagerCoursesStoragePage_ion_item_29_Template_ion_button_click_8_listener(o){const t=D.eBV(e).$implicit,a=D.XpG();return D.Njj(a.deleteCourse(o,t))})),D.nrm(10,"ion-icon",11),D.k0s()()}if(2&e){const e=o.$implicit;D.Y8G("detail",!0),D.R7$(3),D.Y8G("text",e.title)("contextInstanceId",e.id)("adaptImg",!1),D.R7$(),D.Y8G("ngIf",e.isDownloading),D.R7$(2),D.SpI(" ",D.bMT(7,8,e.totalSize)," "),D.R7$(2),D.Y8G("disabled",e.isDownloading)("ariaLabel",D.i5U(9,10,"addon.storagemanager.deletedatafrom",D.eq3(13,_c0,e.title)))}}let U=(()=>{var e;class AddonStorageManagerCoursesStoragePage{constructor(){this.userCourses=[],this.downloadedCourses=[],this.completelyDownloadedCourses=[],this.totalSize=0,this.loaded=!1,this.spaceUsage={cacheEntries:0,spaceUsage:0},this.downloadedCoursesQueue=new r.r,this.siteId=p.CoreSites.getCurrentSiteId()}ngOnInit(){var e=this;return(0,a.A)((function*(){e.userCourses=yield l.CoreCourses.getUserCourses(),e.courseStatusObserver=_.z.on(s.COURSE_STATUS_CHANGED_EVENT,(({courseId:o,status:t})=>e.onCourseUpdated(o,t)));const o=yield b.CoreCourseDownloadStatusHelper.getDownloadedCourseIds(),t=yield Promise.all(e.userCourses.filter((e=>-1!==o.indexOf(e.id))).map((o=>e.getDownloadedCourse(o))));if(yield c.CoreSiteHome.isAvailable(e.siteId)){const o=p.CoreSites.getCurrentSiteHomeId(),a=yield e.calculateDownloadedCourseSize(o);if(a>0){const e=yield b.CoreCourseDownloadStatusHelper.getCourseStatus(o);t.push({id:o,title:S.HT.instant("core.sitehome.sitehome"),totalSize:a,isDownloading:e===n.DownloadStatus.DOWNLOADING})}}yield e.downloadedCoursesQueue.run((()=>e.setDownloadedCourses(t))),e.loaded=!0}))()}ngOnDestroy(){var e;null===(e=this.courseStatusObserver)||void 0===e||e.off()}deleteCompletelyDownloadedCourses(e){var o=this;return(0,a.A)((function*(){e.preventDefault(),e.stopPropagation();try{yield f.CoreAlerts.confirmDelete(S.HT.instant("addon.storagemanager.confirmdeletecourses"))}catch(e){if(!h.CoreErrorHelper.isCanceledError(e))throw e;return}const t=yield g.CoreLoadings.show("core.deleting",!0),n=o.completelyDownloadedCourses.map((e=>e.id));try{yield Promise.all(n.map((e=>d.CoreCourseHelper.deleteCourseFiles(e)))),yield o.downloadedCoursesQueue.run((0,a.A)((function*(){yield o.setDownloadedCourses(o.downloadedCourses.filter((e=>!n.includes(e.id))))})))}catch(e){f.CoreAlerts.showError(e,{default:S.HT.instant("core.errordeletefile")})}finally{t.dismiss()}}))()}deleteCourse(e,o){var t=this;return(0,a.A)((function*(){e.preventDefault(),e.stopPropagation();try{yield f.CoreAlerts.confirmDelete(S.HT.instant("addon.storagemanager.confirmdeletedatafrom",{name:o.title}))}catch(e){if(!h.CoreErrorHelper.isCanceledError(e))throw e;return}const n=yield g.CoreLoadings.show("core.deleting",!0);try{yield d.CoreCourseHelper.deleteCourseFiles(o.id),yield t.downloadedCoursesQueue.run((0,a.A)((function*(){yield t.setDownloadedCourses(m.R.withoutItem(t.downloadedCourses,o))})))}catch(e){f.CoreAlerts.showError(e,{default:S.HT.instant("core.errordeletefile")})}finally{n.dismiss()}}))()}onCourseUpdated(e,o){var t=this;return(0,a.A)((function*(){if(e==s.CORE_COURSE_ALL_COURSES_CLEARED)return yield t.downloadedCoursesQueue.run((()=>t.setDownloadedCourses([]))),void 0;const a=t.downloadedCourses.find((o=>o.id===e));a&&(a.isDownloading=o===n.DownloadStatus.DOWNLOADING,a.totalSize=yield t.calculateDownloadedCourseSize(a.id),yield t.downloadedCoursesQueue.run((()=>t.setDownloadedCourses(t.downloadedCourses))))}))()}setDownloadedCourses(e){var o=this;return(0,a.A)((function*(){o.spaceUsage=yield u.CoreSettingsHelper.getSiteSpaceUsage(o.siteId),o.downloadedCourses=e.sort(((e,o)=>o.totalSize-e.totalSize)),o.completelyDownloadedCourses=e.filter((e=>!e.isDownloading)),o.totalSize=o.downloadedCourses.reduce(((e,o)=>e+o.totalSize),0)}))()}getDownloadedCourse(e){var o=this;return(0,a.A)((function*(){const t=yield o.calculateDownloadedCourseSize(e.id),a=yield b.CoreCourseDownloadStatusHelper.getCourseStatus(e.id);return{id:e.id,title:e.displayname||e.fullname,totalSize:t,isDownloading:a===n.DownloadStatus.DOWNLOADING}}))()}calculateDownloadedCourseSize(e){return(0,a.A)((function*(){const o=yield i.CoreCourse.getSections(e),t=i.CoreCourse.getSectionsModules(o);return d.CoreCourseHelper.getModulesDownloadedSize(t,e)}))()}openCourse(e,o){C.CoreNavigator.navigateToSitePath(`/${y.P}/${e}`,{params:{title:o}})}deleteSiteStorage(e){var o=this;return(0,a.A)((function*(){e.preventDefault(),e.stopPropagation();try{const e=p.CoreSites.getRequiredCurrentSite(),t=yield e.getSiteName();o.spaceUsage=yield u.CoreSettingsHelper.deleteSiteStorage(t,o.siteId)}catch{}}))()}}return(e=AddonStorageManagerCoursesStoragePage).ɵfac=function AddonStorageManagerCoursesStoragePage_Factory(o){return new(o||e)},e.ɵcmp=D.VBU({type:e,selectors:[["page-addon-storagemanager-courses-storage"]],standalone:!0,features:[D.aNF],decls:30,vars:23,consts:[["slot","start"],[3,"text"],[1,"limited-width"],["placeholderType","column","placeholderHeight","84px",3,"hideUntil"],["class","ion-padding-horizontal ion-text-wrap",4,"ngIf"],[4,"ngIf"],[1,"ion-padding-horizontal","ion-text-wrap"],["lines","full",1,"size","courses","ion-text-wrap"],[1,"item-heading"],["color","light"],["slot","end","color","danger","fill","clear",3,"click","disabled"],["name","fas-trash","slot","icon-only","aria-hidden","true"],["class","course","button","",3,"detail","click",4,"ngFor","ngForOf"],[1,"ion-text-wrap","total"],[1,"item-heading","ion-text-wrap"],["color","light",4,"ngIf"],["fill","clear","color","danger","slot","end",3,"click","hidden"],["button","",1,"course",3,"click","detail"],[1,"ion-text-wrap"],["contextLevel","course",3,"text","contextInstanceId","adaptImg"],["class","item-heading item-heading-secondary",4,"ngIf"],["slot","end","color","danger","fill","clear",3,"click","disabled","ariaLabel"],[1,"item-heading","item-heading-secondary"]],template:function AddonStorageManagerCoursesStoragePage_Template(e,o){1&e&&(D.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),D.nrm(3,"ion-back-button",1),D.nI1(4,"translate"),D.k0s(),D.j41(5,"ion-title")(6,"h1"),D.EFF(7),D.nI1(8,"translate"),D.k0s()()()(),D.j41(9,"ion-content",2)(10,"core-loading",3),D.DNE(11,AddonStorageManagerCoursesStoragePage_div_11_Template,4,3,"div",4)(12,AddonStorageManagerCoursesStoragePage_ion_card_12_Template,10,8,"ion-card",5),D.j41(13,"div",6)(14,"h2"),D.EFF(15),D.nI1(16,"translate"),D.k0s()(),D.j41(17,"ion-card")(18,"ion-item",7)(19,"ion-label")(20,"p",8),D.EFF(21),D.nI1(22,"translate"),D.k0s(),D.j41(23,"ion-badge",9),D.EFF(24),D.nI1(25,"coreBytesToSize"),D.k0s()(),D.j41(26,"ion-button",10),D.nI1(27,"translate"),D.bIt("click",(function AddonStorageManagerCoursesStoragePage_Template_ion_button_click_26_listener(e){return o.deleteCompletelyDownloadedCourses(e)})),D.nrm(28,"ion-icon",11),D.k0s()(),D.DNE(29,AddonStorageManagerCoursesStoragePage_ion_item_29_Template,11,15,"ion-item",12),D.k0s()()()),2&e&&(D.R7$(3),D.Y8G("text",D.bMT(4,11,"core.back")),D.R7$(4),D.JRh(D.bMT(8,13,"addon.storagemanager.managedownloads")),D.R7$(3),D.Y8G("hideUntil",o.loaded),D.R7$(),D.Y8G("ngIf",o.spaceUsage),D.R7$(),D.Y8G("ngIf",o.spaceUsage),D.R7$(3),D.JRh(D.bMT(16,15,"addon.storagemanager.downloadedcourses")),D.R7$(6),D.JRh(D.bMT(22,17,"addon.storagemanager.totalspaceusage")),D.R7$(3),D.JRh(D.bMT(25,19,o.totalSize)),D.R7$(2),D.Y8G("disabled",0===o.completelyDownloadedCourses.length),D.BMQ("aria-label",D.bMT(27,21,"addon.storagemanager.deletecourses")),D.R7$(3),D.Y8G("ngForOf",o.downloadedCourses))},dependencies:[w.n,I.Sq,I.bT,T.In,T.Jm,T.QW,T.b_,T.W9,T.eU,T.iq,T.uz,T.he,T.BC,T.ai,T.el,A.R,M.t,R.B,k.i,E.T,P.D9,v.b],styles:["ion-item.courses[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%], ion-item.total[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]{font-weight:700}"]}),AddonStorageManagerCoursesStoragePage})()}}]);