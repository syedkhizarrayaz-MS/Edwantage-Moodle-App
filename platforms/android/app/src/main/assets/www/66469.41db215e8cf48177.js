"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[66469],{66469:(e,n,o)=>{o.r(n),o.d(n,{AddonModAssignEditFeedbackModalComponent:()=>N});var d=o(10467),i=o(79555),t=o(5505),a=o(86654),s=o(29905),l=o(20523),r=o(81690),g=o(66016),m=o(44682),_=o(20218),c=o(75629),p=o(33014),u=o(49882),f=o(52749),b=o(75217),M=o(25572),A=o(48966),C=o(4175),k=o(55554),F=o(97383),I=o(72881),h=o(75383),E=o(63153),T=o(54438),G=o(60177),y=o(89417),v=o(2910),R=o(64422),$=o(86198),j=o(88246),S=o(43570),x=o(73955);const D=["editFeedbackForm"],_c1=e=>({$a:e}),_c2=e=>({header:e}),_c3=(e,n)=>({current:e,total:n}),_c4=e=>({$a:e});function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_2_ion_input_1_Template(e,n){if(1&e){const e=T.RV6();T.j41(0,"ion-input",12),T.nI1(1,"translate"),T.nI1(2,"translate"),T.mxI("ngModelChange",(function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_2_ion_input_1_Template_ion_input_ngModelChange_0_listener(n){T.eBV(e);const o=T.XpG(3);return T.DH7(o.grade.grade,n)||(o.grade.grade=n),T.Njj(n)})),T.k0s()}if(2&e){const e=T.XpG(3);T.R50("ngModel",e.grade.grade),T.Y8G("max",e.gradeInfo.grade)("lang",e.grade.lang)("label",T.i5U(1,5,"addon.mod_assign.gradeoutof",T.eq3(10,_c1,e.gradeInfo.grade)))("helperText",e.grade.disabled?T.bMT(2,8,"addon.mod_assign.gradelocked"):null)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_2_Template(e,n){if(1&e&&(T.j41(0,"ion-item",10),T.DNE(1,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_2_ion_input_1_Template,3,12,"ion-input",11),T.k0s()),2&e){const e=T.XpG(2);T.R7$(),T.Y8G("ngIf",!e.grade.disabled)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_3_ion_select_option_7_Template(e,n){if(1&e&&(T.j41(0,"ion-select-option",16),T.EFF(1),T.k0s()),2&e){const e=n.$implicit;T.Y8G("value",e.value),T.R7$(),T.SpI(" ",e.label," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_3_Template(e,n){if(1&e){const e=T.RV6();T.j41(0,"ion-item",10)(1,"ion-select",13),T.nI1(2,"translate"),T.nI1(3,"translate"),T.mxI("ngModelChange",(function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_3_Template_ion_select_ngModelChange_1_listener(n){T.eBV(e);const o=T.XpG(2);return T.DH7(o.grade.grade,n)||(o.grade.grade=n),T.Njj(n)})),T.j41(4,"p",14),T.EFF(5),T.nI1(6,"translate"),T.k0s(),T.DNE(7,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_3_ion_select_option_7_Template,2,2,"ion-select-option",15),T.k0s()()}if(2&e){const e=T.XpG(2);T.R7$(),T.R50("ngModel",e.grade.grade),T.Y8G("disabled",e.grade.disabled)("cancelText",T.bMT(2,6,"core.cancel"))("interfaceOptions",T.eq3(12,_c2,T.bMT(3,8,"core.gradenoun"))),T.R7$(4),T.JRh(T.bMT(6,10,"core.gradenoun")),T.R7$(2),T.Y8G("ngForOf",e.grade.scale)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_ion_select_1_ion_select_option_4_Template(e,n){if(1&e&&(T.j41(0,"ion-select-option",16),T.EFF(1),T.k0s()),2&e){const e=n.$implicit;T.Y8G("value",e.value),T.R7$(),T.SpI(" ",e.label," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_ion_select_1_Template(e,n){if(1&e){const e=T.RV6();T.j41(0,"ion-select",19),T.nI1(1,"translate"),T.mxI("ngModelChange",(function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_ion_select_1_Template_ion_select_ngModelChange_0_listener(n){T.eBV(e);const o=T.XpG().$implicit;return T.DH7(o.selectedId,n)||(o.selectedId=n),T.Njj(n)})),T.j41(2,"p",14),T.EFF(3),T.k0s(),T.DNE(4,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_ion_select_1_ion_select_option_4_Template,2,2,"ion-select-option",15),T.k0s()}if(2&e){const e=T.XpG().$implicit,n=T.XpG(2);T.R50("ngModel",e.selectedId),T.Y8G("disabled",!!n.gradeInfo.disabled)("cancelText",T.bMT(1,6,"core.cancel"))("interfaceOptions",T.eq3(8,_c2,e.name)),T.R7$(3),T.JRh(e.name),T.R7$(),T.Y8G("ngForOf",e.options)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_p_2_Template(e,n){if(1&e&&(T.j41(0,"p"),T.EFF(1),T.k0s()),2&e){const e=T.XpG().$implicit;T.R7$(),T.JRh(e.selected)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_Template(e,n){if(1&e&&(T.j41(0,"ion-item",10),T.DNE(1,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_ion_select_1_Template,5,10,"ion-select",17)(2,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_p_2_Template,2,1,"p",18),T.k0s()),2&e){const e=n.$implicit;T.R7$(),T.Y8G("ngIf",e.itemNumber),T.R7$(),T.Y8G("ngIf",!e.itemNumber)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_5_p_5_Template(e,n){if(1&e&&(T.j41(0,"p"),T.EFF(1),T.k0s()),2&e){const e=T.XpG(3);T.R7$(),T.Lme("",e.grade.unreleasedGrade," / ",e.gradeInfo.grade,"")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_5_p_6_Template(e,n){if(1&e&&(T.j41(0,"p"),T.EFF(1),T.k0s()),2&e){const e=T.XpG(3);T.R7$(),T.JRh(e.grade.unreleasedGrade)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_5_Template(e,n){if(1&e&&(T.j41(0,"ion-item",10)(1,"ion-label")(2,"p",20),T.EFF(3),T.nI1(4,"translate"),T.k0s(),T.DNE(5,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_5_p_5_Template,2,2,"p",18)(6,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_5_p_6_Template,2,1,"p",18),T.k0s()()),2&e){const e=T.XpG(2);T.R7$(3),T.JRh(T.bMT(4,3,"addon.mod_assign.currentassigngrade")),T.R7$(2),T.Y8G("ngIf","simple"!==e.grade.method||!e.grade.scale),T.R7$(),T.Y8G("ngIf","simple"===e.grade.method&&e.grade.scale)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Conditional_0_Template(e,n){1&e&&T.nrm(0,"ion-icon",23)}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Conditional_2_Template(e,n){if(1&e&&T.EFF(0),2&e){const e=T.XpG(4);T.SpI(" ",e.grade.scale[e.grade.gradebookGrade].label," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Conditional_3_Template(e,n){if(1&e&&T.EFF(0),2&e){const e=T.XpG(4);T.SpI(" ",e.grade.gradebookGrade," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Template(e,n){if(1&e&&(T.DNE(0,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Conditional_0_Template,1,0,"ion-icon",23),T.j41(1,"span"),T.DNE(2,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Conditional_2_Template,1,1)(3,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Conditional_3_Template,1,1),T.k0s()),2&e){const e=T.XpG(3);T.vxM(0,e.grade.penalty?0:-1),T.R7$(2),T.vxM(2,e.grade.scale?2:3)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_7_Template(e,n){1&e&&T.EFF(0," - ")}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_8_Template(e,n){if(1&e&&(T.j41(0,"p",22),T.EFF(1),T.k0s()),2&e){const e=T.XpG(3);T.R7$(),T.SpI(" ",e.grade.penalty," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Template(e,n){if(1&e&&(T.j41(0,"ion-item",10)(1,"ion-label")(2,"p",20),T.EFF(3),T.nI1(4,"translate"),T.k0s(),T.j41(5,"p",21),T.DNE(6,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_6_Template,4,2,"span")(7,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_7_Template,1,0),T.k0s(),T.DNE(8,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Conditional_8_Template,2,1,"p",22),T.k0s()()),2&e){const e=T.XpG(2);T.R7$(3),T.JRh(T.bMT(4,3,"addon.mod_assign.currentgrade")),T.R7$(3),T.vxM(6,e.grade.gradebookGrade?6:7),T.R7$(2),T.vxM(8,e.grade.penalty?8:-1)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_7_addon_mod_assign_feedback_plugin_0_Template(e,n){if(1&e&&T.nrm(0,"addon-mod-assign-feedback-plugin",8),2&e){const e=n.$implicit,o=T.XpG(3);T.Y8G("assign",o.assign)("submission",o.userSubmission)("userId",o.submitId)("plugin",e)("canEdit",!0)("edit",!0)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_7_Template(e,n){if(1&e&&T.DNE(0,AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_7_addon_mod_assign_feedback_plugin_0_Template,1,6,"addon-mod-assign-feedback-plugin",24),2&e){const e=T.XpG(2);T.Y8G("ngForOf",e.feedback.plugins)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_8_Template(e,n){if(1&e){const e=T.RV6();T.j41(0,"ion-item",10)(1,"ion-toggle",25),T.mxI("ngModelChange",(function AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_8_Template_ion_toggle_ngModelChange_1_listener(n){T.eBV(e);const o=T.XpG(2);return T.DH7(o.grade.applyToAll,n)||(o.grade.applyToAll=n),T.Njj(n)})),T.j41(2,"p",20),T.EFF(3),T.nI1(4,"translate"),T.k0s(),T.j41(5,"p"),T.EFF(6),T.nI1(7,"translate"),T.k0s()()()}if(2&e){const e=T.XpG(2);T.R7$(),T.R50("ngModel",e.grade.applyToAll),T.R7$(2),T.JRh(T.bMT(4,3,"addon.mod_assign.groupsubmissionsettings")),T.R7$(3),T.JRh(T.bMT(7,5,"addon.mod_assign.applytoteam"))}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_p_5_Template(e,n){if(1&e&&(T.j41(0,"p"),T.EFF(1),T.nI1(2,"translate"),T.k0s()),2&e){const e=T.XpG(3);T.R7$(),T.SpI(" ",T.i5U(2,1,"addon.mod_assign.outof",T.eq3(7,_c4,T.l_i(4,_c3,e.currentAttemptNumber,e.maxAttemptsText)))," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_p_6_Template(e,n){if(1&e&&(T.j41(0,"p"),T.EFF(1),T.nI1(2,"translate"),T.k0s()),2&e){const e=T.XpG(3);T.R7$(),T.SpI(" ",T.i5U(2,1,"addon.mod_assign.outof",T.eq3(7,_c4,T.l_i(4,_c3,e.currentAttemptNumber,e.assign.maxattempts)))," ")}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_ion_item_11_Template(e,n){if(1&e){const e=T.RV6();T.j41(0,"ion-item")(1,"ion-toggle",26),T.mxI("ngModelChange",(function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_ion_item_11_Template_ion_toggle_ngModelChange_1_listener(n){T.eBV(e);const o=T.XpG(3);return T.DH7(o.grade.addAttempt,n)||(o.grade.addAttempt=n),T.Njj(n)})),T.j41(2,"p"),T.EFF(3),T.nI1(4,"translate"),T.k0s()()()}if(2&e){const e=T.XpG(3);T.R7$(),T.R50("ngModel",e.grade.addAttempt),T.R7$(2),T.JRh(T.bMT(4,2,"addon.mod_assign.addattempt"))}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_Template(e,n){if(1&e&&(T.j41(0,"ion-item",10)(1,"ion-label")(2,"p",20),T.EFF(3),T.nI1(4,"translate"),T.k0s(),T.DNE(5,AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_p_5_Template,3,9,"p",18)(6,AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_p_6_Template,3,9,"p",18),T.j41(7,"p"),T.EFF(8),T.nI1(9,"translate"),T.nI1(10,"translate"),T.k0s()()(),T.DNE(11,AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_ion_item_11_Template,5,4,"ion-item",18)),2&e){const e=T.XpG(2);T.R7$(3),T.JRh(T.bMT(4,6,"addon.mod_assign.attemptsettings")),T.R7$(2),T.Y8G("ngIf",e.assign.maxattempts===e.unlimitedAttempts),T.R7$(),T.Y8G("ngIf",e.assign.maxattempts!==e.unlimitedAttempts),T.R7$(2),T.Lme(" ",T.bMT(9,8,"addon.mod_assign.attemptreopenmethod"),": ",T.bMT(10,10,"addon.mod_assign.attemptreopenmethod_"+e.assign.attemptreopenmethod)," "),T.R7$(3),T.Y8G("ngIf",e.allowAddAttempt)}}function AddonModAssignEditFeedbackModalComponent_Conditional_12_Template(e,n){if(1&e){const e=T.RV6();T.j41(0,"form",5,0),T.DNE(2,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_2_Template,2,1,"ion-item",6)(3,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_3_Template,8,14,"ion-item",6)(4,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_4_Template,3,2,"ion-item",7)(5,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_5_Template,7,5,"ion-item",6)(6,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_6_Template,9,5,"ion-item",6)(7,AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_7_Template,1,1,"addon-mod-assign-feedback-plugin",8)(8,AddonModAssignEditFeedbackModalComponent_Conditional_12_ion_item_8_Template,8,7,"ion-item",6)(9,AddonModAssignEditFeedbackModalComponent_Conditional_12_Conditional_9_Template,12,12),T.j41(10,"ion-button",9),T.bIt("click",(function AddonModAssignEditFeedbackModalComponent_Conditional_12_Template_ion_button_click_10_listener(){T.eBV(e);const n=T.XpG();return T.Njj(n.submitGrade())})),T.EFF(11),T.nI1(12,"translate"),T.k0s()()}if(2&e){const e=T.XpG();T.R7$(2),T.Y8G("ngIf","simple"===e.grade.method&&!e.grade.scale),T.R7$(),T.Y8G("ngIf","simple"===e.grade.method&&e.grade.scale),T.R7$(),T.Y8G("ngForOf",e.gradeInfo.outcomes),T.R7$(),T.Y8G("ngIf",e.gradeInfo&&void 0!==e.grade.unreleasedGrade),T.R7$(),T.Y8G("ngIf","simple"===e.grade.method),T.R7$(),T.vxM(7,e.feedback?7:-1),T.R7$(),T.Y8G("ngIf",e.assign.teamsubmission),T.R7$(),T.vxM(9,1!==e.assign.maxattempts?9:-1),T.R7$(2),T.SpI(" ",T.bMT(12,9,"core.gradeverb")," ")}}let N=(()=>{var e;class AddonModAssignEditFeedbackModalComponent{constructor(){this.grade={method:"",modified:0,addAttempt:!1,applyToAll:!1,lang:"en",disabled:!1},this.loaded=!1,this.allowAddAttempt=!1,this.unlimitedAttempts=g.Bq,this.currentAttemptNumber=0,this.maxAttemptsText="",this.hasOfflineGrade=!1,this.isDestroyed=!1,this.originalGrades={addAttempt:!1,applyToAll:!1,outcomes:{}},this.siteId=f.CoreSites.getCurrentSiteId(),this.currentUserId=f.CoreSites.getCurrentSiteUserId(),this.maxAttemptsText=i.HT.instant("addon.mod_assign.unlimitedattempts")}ngOnInit(){this.setGradeSyncBlocked(!0),this.fetchData()}fetchData(){var e=this;return(0,d.A)((function*(){try{var n;if(e.userSubmission&&(e.currentAttemptNumber=e.userSubmission.attemptnumber+1),e.grade={method:"",modified:0,addAttempt:!1,applyToAll:!1,lang:"",disabled:!1},e.originalGrades={addAttempt:!1,applyToAll:!1,outcomes:{}},null!==(n=e.feedback)&&void 0!==n&&null!==(n=n.grade)&&void 0!==n&&n.grade&&!e.grade.grade){const n=parseFloat(e.feedback.grade.grade);e.grade.grade=n>=0?n:void 0,e.grade.gradebookGrade=r.j.formatFloat(e.grade.grade),e.originalGrades.grade=e.grade.grade}e.gradeInfo=yield m.CoreCourse.getModuleBasicGradeInfo(e.moduleId);const o=e.assign;yield e.treatGradeInfo(o);e.allowAddAttempt="manual"==o.attemptreopenmethod&&(!e.userSubmission||o.maxattempts===g.Bq||!!e.userSubmission&&e.userSubmission.attemptnumber<o.maxattempts-1),o.teamsubmission&&(e.grade.applyToAll=!0,e.originalGrades.applyToAll=!0),yield e.loadFeedbackData()}catch(n){M.CoreAlerts.showError(n),e.closeModal(!0)}finally{e.loaded=!0}}))()}loadFeedbackData(){var e=this;return(0,d.A)((function*(){e.hasOfflineGrade=!1;const n=yield k.g.ignoreErrors(C.AddonModAssignOffline.getSubmissionGrade(e.assign.id,e.submitId));if(!n&&e.feedback){if(yield _.AddonModAssignHelper.shouldFetchUnfilteredFeedbackToEdit(e.assign,e.submitId,e.feedback)){const n=yield t.AddonModAssign.getSubmissionStatus(e.assign,{userId:e.submitId,isBlind:!!e.blindId,cmId:e.assign.cmid,filter:!1,readingStrategy:2,checkFetchOriginal:!1});e.feedback=n.feedback}}var o;(e.feedback||(e.feedback=_.AddonModAssignHelper.createEmptyFeedback(),e.feedback.plugins=_.AddonModAssignHelper.getPluginsEnabled(e.assign,"assignfeedback")),n&&(!e.feedback.gradeddate||e.feedback.gradeddate<n.timemodified))&&((e.grade.modified||0)<n.timemodified&&(e.hasOfflineGrade=!0,e.grade.grade=e.grade.scale?n.grade:r.j.formatFloat(n.grade),e.originalGrades.grade=e.grade.grade),e.grade.applyToAll=!!n.applytoall,e.grade.addAttempt=!!n.addattempt,e.originalGrades.applyToAll=!!e.grade.applyToAll,e.originalGrades.addAttempt=!!e.grade.addAttempt,n.outcomes&&Object.keys(n.outcomes).length&&null!==(o=e.gradeInfo)&&void 0!==o&&o.outcomes&&e.gradeInfo.outcomes.forEach((o=>{void 0!==o.itemNumber&&void 0!==n.outcomes[o.itemNumber]&&(o.modified||0)<n.timemodified&&(o.selectedId=n.outcomes[o.itemNumber],e.originalGrades.outcomes[o.id]=o.selectedId)})))}))()}treatGradeInfo(e){var n=this;return(0,d.A)((function*(){var o;if(!n.gradeInfo)return n.closeModal(!0),void 0;const d=n.gradeInfo;if(d.outcomes=d.outcomes||[],n.grade.method=d.advancedgrading&&d.advancedgrading[0]&&void 0!==d.advancedgrading[0].method&&d.advancedgrading[0].method||"simple","simple"!==n.grade.method)return n.closeModal(!0),void 0;const a=e.markingworkflow&&"released"!==n.gradingStatus,[s,g]=yield Promise.all([F.CoreGradesHelper.getGradeModuleItems(n.courseId,n.moduleId,n.submitId),a?k.g.ignoreErrors(t.AddonModAssign.getAssignmentGrades(e.id,{cmId:e.cmid})):void 0]),m=Number(null==g||null===(o=g.find((e=>e.userid===n.submitId)))||void 0===o?void 0:o.grade);var _;if(n.grade.unreleasedGrade=void 0,d.scale){if(n.grade.scale=r.j.makeMenuFromList(d.scale,i.HT.instant("core.nograde")),(0,l.L)(m)){var c;const e=n.grade.scale.find((e=>e.value===m));n.grade.unreleasedGrade=null==e?void 0:e.label,n.grade.grade=null===(c=null!=e?e:n.grade.scale[0])||void 0===c?void 0:c.value,n.originalGrades.grade=n.grade.grade}}else n.grade.unreleasedGrade=(0,l.L)(m)?m:void 0,n.grade.grade=r.j.formatFloat(null!==(_=n.grade.unreleasedGrade)&&void 0!==_?_:n.grade.grade),n.originalGrades.grade=n.grade.grade,n.grade.lang=yield I.CoreLang.getCurrentLanguage();d.outcomes&&d.outcomes.forEach((e=>{e.scale&&(e.options=r.j.makeMenuFromList(e.scale,i.HT.instant("core.grades.nooutcome"))),e.selectedId=0,n.originalGrades.outcomes[e.id]=e.selectedId}));const p=[];s.forEach((e=>{if(e.outcomeid||e.scaleid){if(e.outcomeid){var o;null===(o=d.outcomes)||void 0===o||o.forEach((o=>{o.id==String(e.outcomeid)&&(o.selected=h.Ni.cleanTags(e.gradeformatted||""),o.modified=e.gradedategraded,o.options&&(o.selectedId=F.CoreGradesHelper.getGradeValueFromLabel(o.options,o.selected),n.originalGrades.outcomes[o.id]=o.selectedId,o.itemNumber=e.itemnumber),p.push(o))})),d.disabled=e.gradeislocked||e.gradeisoverridden}}else{const o=h.Ni.cleanTags(e.gradeformatted||"");if(n.grade.scale)n.grade.gradebookGrade=r.j.formatFloat(F.CoreGradesHelper.getGradeValueFromLabel(n.grade.scale,o));else{const e=parseFloat(o);n.grade.gradebookGrade=e||0==e?r.j.formatFloat(e):void 0}n.grade.disabled=!!e.gradeislocked||!!e.gradeisoverridden,n.grade.modified=e.gradedategraded}n.grade.penalty=F.CoreGradesHelper.getPenaltyFromGrade(e.gradeformatted)})),d.outcomes=p}))()}closeModal(e=!1){var n=this;return(0,d.A)((function*(){(e||(yield n.canLeave()))&&n.dismissModal(!1)}))()}hasDataToSave(e=!1){var n=this;return(0,d.A)((function*(){var o,d;if(!n.assign)return!1;if(e&&n.hasOfflineGrade)return!0;if(n.originalGrades.grade!==n.grade.grade||n.originalGrades.addAttempt!==n.grade.addAttempt||n.originalGrades.applyToAll!==n.grade.applyToAll)return!0;if(null!==(o=n.gradeInfo)&&void 0!==o&&o.outcomes)for(const e in n.gradeInfo.outcomes){const o=n.gradeInfo.outcomes[e];if(void 0===n.originalGrades.outcomes[o.id]||n.originalGrades.outcomes[o.id]!=o.selectedId)return!0}if(null===(d=n.feedback)||void 0===d||!d.plugins)return!1;try{const e=n.getInputData();return _.AddonModAssignHelper.hasFeedbackDataChanged(n.assign,n.userSubmission,n.feedback,n.submitId,e)}catch{return!1}}))()}submitGrade(){var e=this;return(0,d.A)((function*(){var n;if(!(yield e.hasDataToSave(!0))||!e.assign)return e.dismissModal(!1),void 0;const o=e.userSubmission?e.userSubmission.attemptnumber:-1,d={},a=e.grade.scale&&0==e.grade.grade?-1:r.j.unformatFloat(e.grade.grade,!0);if(!1===a)throw new c.CoreError(i.HT.instant("core.grades.badgrade"));const s=yield p.CoreLoadings.show("core.sending",!0);((null===(n=e.gradeInfo)||void 0===n?void 0:n.outcomes)||[]).forEach((e=>{e.itemNumber&&e.selectedId&&(d[e.itemNumber]=e.selectedId)}));const l=e.getInputData();let m={};try{e.feedback&&e.feedback.plugins&&(m=yield _.AddonModAssignHelper.prepareFeedbackPluginData(e.assign.id,e.submitId,e.feedback,l));try{const n=yield t.AddonModAssign.submitGradingForm(e.assign.id,e.submitId,e.courseId,a||0,o,e.grade.addAttempt,e.gradingStatus||"",e.grade.applyToAll,d,m);yield e.discardDrafts(),e.dismissModal(!0,n)}finally{u.z.trigger(g.$P,{assignmentId:e.assign.id,submissionId:e.submitId,userId:e.currentUserId},e.siteId)}}finally{s.dismiss()}}))()}getInputData(){return E.R.getDataFromForm(document.forms["addon-mod_assign-edit-feedback-form"])}discardDrafts(){var e=this;return(0,d.A)((function*(){e.assign&&e.feedback&&e.feedback.plugins&&(yield _.AddonModAssignHelper.discardFeedbackPluginData(e.assign.id,e.submitId,e.feedback))}))()}canLeave(){var e=this;return(0,d.A)((function*(){if(yield e.hasDataToSave()){if(!(yield k.g.promiseWorks(M.CoreAlerts.confirmLeaveWithChanges())))return!1;yield e.discardDrafts()}return!0}))()}ngOnDestroy(){this.setGradeSyncBlocked(!1),this.isDestroyed=!0}setGradeSyncBlocked(e=!1){if(this.isDestroyed)return;const n=b.AddonModAssignSync.getGradeSyncId(this.assign.id,this.submitId);e?A.CoreSync.blockOperation(g.AC,n):A.CoreSync.unblockOperation(g.AC,n)}dismissModal(e,n){e?E.R.triggerFormSubmittedEvent(this.formElement,n,f.CoreSites.getCurrentSiteId()):E.R.triggerFormCancelledEvent(this.formElement,f.CoreSites.getCurrentSiteId()),i.W3.dismiss(e)}}return(e=AddonModAssignEditFeedbackModalComponent).ɵfac=function AddonModAssignEditFeedbackModalComponent_Factory(n){return new(n||e)},e.ɵcmp=T.VBU({type:e,selectors:[["addon-mod-assign-edit-feedback-modal"]],viewQuery:function AddonModAssignEditFeedbackModalComponent_Query(e,n){if(1&e&&T.GBs(D,5),2&e){let e;T.mGM(e=T.lsd())&&(n.formElement=e.first)}},inputs:{courseId:"courseId",moduleId:"moduleId",assign:"assign",submitId:"submitId",blindId:"blindId",gradingStatus:"gradingStatus",feedback:"feedback",userSubmission:"userSubmission"},standalone:!0,features:[T.aNF],decls:13,vars:8,consts:[["editFeedbackForm",""],["slot","end"],["fill","clear",3,"click","ariaLabel"],["slot","icon-only","name","fas-xmark","aria-hidden","true"],[3,"hideUntil"],["name","addon-mod_assign-edit-feedback-form"],["class","ion-text-wrap",4,"ngIf"],["class","ion-text-wrap",4,"ngFor","ngForOf"],[3,"assign","submission","userId","plugin","canEdit","edit"],["expand","block","type","submit",3,"click"],[1,"ion-text-wrap"],["name","grade","type","text","min","0","labelPlacement","stacked",3,"ngModel","max","lang","label","helperText","ngModelChange",4,"ngIf"],["name","grade","type","text","min","0","labelPlacement","stacked",3,"ngModelChange","ngModel","max","lang","label","helperText"],["name","grade","interface","action-sheet",3,"ngModelChange","ngModel","disabled","cancelText","interfaceOptions"],["slot","label",1,"item-heading"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["name","outcome","interface","action-sheet",3,"ngModel","disabled","cancelText","interfaceOptions","ngModelChange",4,"ngIf"],[4,"ngIf"],["name","outcome","interface","action-sheet",3,"ngModelChange","ngModel","disabled","cancelText","interfaceOptions"],[1,"item-heading"],[1,"core-grading-summary-grade"],[1,"core-grading-summary-penalty"],["name","fas-triangle-exclamation","color","danger","aria-hidden","true"],[3,"assign","submission","userId","plugin","canEdit","edit",4,"ngFor","ngForOf"],["name","applyToAll",3,"ngModelChange","ngModel"],["name","addAttempt",3,"ngModelChange","ngModel"]],template:function AddonModAssignEditFeedbackModalComponent_Template(e,n){1&e&&(T.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title")(3,"h1"),T.EFF(4),T.nI1(5,"translate"),T.k0s()(),T.j41(6,"ion-buttons",1)(7,"ion-button",2),T.nI1(8,"translate"),T.bIt("click",(function AddonModAssignEditFeedbackModalComponent_Template_ion_button_click_7_listener(){return n.closeModal()})),T.nrm(9,"ion-icon",3),T.k0s()()()(),T.j41(10,"ion-content")(11,"core-loading",4),T.DNE(12,AddonModAssignEditFeedbackModalComponent_Conditional_12_Template,13,11,"form",5),T.k0s()()),2&e&&(T.R7$(4),T.JRh(T.bMT(5,4,"core.gradenoun")),T.R7$(3),T.Y8G("ariaLabel",T.bMT(8,6,"core.close")),T.R7$(4),T.Y8G("hideUntil",n.loaded),T.R7$(),T.vxM(12,n.gradeInfo?12:-1))},dependencies:[a.n,G.Sq,G.bT,y.qT,y.BC,y.cb,y.vS,y.cV,v.Jm,v.QW,v.W9,v.eU,v.iq,v.$w,v.uz,v.he,v.Nm,v.Ip,v.BC,v.BY,v.ai,v.hB,v.Je,v.Gw,R.R,$.t,j.i,S.T,x.D9,s.AddonModAssignFeedbackPluginComponent],styles:["[_nghost-%COMP%]   .core-grading-summary-grade[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem}[_nghost-%COMP%]   .core-grading-summary-grade[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{flex-shrink:0}[_nghost-%COMP%]   .core-grading-summary-grade[_ngcontent-%COMP%]   .penalty-indicator-icon[_ngcontent-%COMP%]{display:none}[_nghost-%COMP%]   .core-grading-summary-penalty[_ngcontent-%COMP%]{color:var(--danger);font-size:.75em}"]}),AddonModAssignEditFeedbackModalComponent})()}}]);